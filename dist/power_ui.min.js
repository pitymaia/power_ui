"use strict";function getIdAndCreateIfDontHave(e){let t=e.id;return t||(t=_Unique.domID(e.tagName.toLowerCase())),e.setAttribute("id",t),t}function asDataSet(e){const t=e.split("-").filter(e=>"data"!=e);let i="";for(let e=0;e<t.length;e++)i+=0===e?t[e]:t[e].replace(/\b\w/g,e=>e.toUpperCase());return i}function powerClassAsCamelCase(e){return`${e.split("-")[0]}${e.split("-")[1].charAt(0).toUpperCase()}${e.split("-")[1].slice(1)}`}class SharedScope{constructor({id:e,main:t,view:i,rootCompiler:s,parent:n,ctx:r}){this.id=e,this.tempMainEl=t,this.tempViewEl=i,this.tempRootCompilerEl=s,this.tempParent=n||{node:null,datasetKey:null},this.ctx=r,this.cached={}}get element(){return document.getElementById(this.id)}get main(){return this.tempMainEl?document.getElementById(this.tempMainEl.id):null}get view(){return this.tempViewEl?document.getElementById(this.tempViewEl.id):null}get rootCompiler(){return this.tempRootCompilerEl?document.getElementById(this.tempRootCompilerEl.id):null}get parentNode(){return this.tempParent.node?document.getElementById(this.tempParent.node.id):null}get parentDatasetKey(){return this.tempParent.datasetKey}get parentObj(){if(!this.parentNode)return null;const e=this.parentNode.id,t=this.parentDatasetKey;return this.ctx.allPowerObjsById[e]&&this.ctx.allPowerObjsById[e][t]?this.ctx.allPowerObjsById[e][t]:null}get mainObj(){return this.cached.isMain||this.getTarget(this.main.id,"isMain")}get viewObj(){return this.cached.isView||this.getTarget(this.view.id,"isView")}get rootCompilerObj(){const e="isRootCompiler";return this.cached[e]||this.getTarget(this.rootCompiler.id,e)}getTarget(e,t){if(!e)return!1;if(null!=this.cached[t])return this.cached[t];for(const i of Object.keys(this.ctx.allPowerObjsById[e]||{}))if(this.ctx.allPowerObjsById[e][i][t])return this.cached[t]=this.ctx.allPowerObjsById[e][i],this.cached[t];this.cached[t]=!1}removeInnerElementsFromPower(){const e=this.element.children;for(const t of e)this.removeElementAndInnersFromPower(t),this.element.removeChild(t);delete this.element.dataset.pwhascomp}removeElementAndInnersFromPower(e){(e=e||this.element).id&&this.ctx.allPowerObjsById[e.id]&&(this.ctx.removeEventsOfObject(e.id),delete this.ctx.allPowerObjsById[e.id]);const t=e.children;for(const e of t)this.removeElementAndInnersFromPower(e)}}class _PowerUiBase{constructor(){this._tempScope={}}_createPowerTree(){this.powerTree=new PowerTree(this,_PowerUiBase),this.powerTree._callInit()}}_PowerUiBase._powAttrsConfig=[],_PowerUiBase.injectPow=function(e){e.datasetKey=asDataSet(e.name),_PowerUiBase._powAttrsConfig.push(e)},_PowerUiBase._pwcAttrsConfig=[],_PowerUiBase.injectPwc=function(e){powAttr.datasetKey=asDataSet(powAttr.name),_PowerUiBase._pwcAttrsConfig.push(e)},_PowerUiBase._powerElementsConfig=[],_PowerUiBase.injectPowerCss=function(e){e.datasetKey=asDataSet(e.name),e.isMain?_PowerUiBase._powerElementsConfig.unshift(e):_PowerUiBase._powerElementsConfig.push(e)};const _Unique={n:0,next:()=>++_Unique.n,domID:e=>`_pow${e?"_"+e:"er"}_${_Unique.next()}`,scopeID:()=>`_scope_${_Unique.next()}`,last:()=>_Unique.n};class UEvent{constructor(e){this.observers=[],e&&(UEvent.index[e]=this)}subscribe(e,t,i){this.unsubscribe(e),this.observers.push({fn:e,ctx:t,arguments:arguments})}unsubscribe(e){this.observers=this.observers.filter(t=>t.fn!==e)}broadcast(){for(const e of this.observers)e.fn.apply(e.ctx,e.arguments)}popBroadcast(){if(this.observers.length>0){const e=this.observers[this.observers.length-1];e.fn.apply(e.ctx,e.arguments)}}}UEvent.index={};class _PowerBasicElement{constructor(e){this.tempEl=e,this._$pwActive=!1}get id(){return this.element.id||null}set id(e){this.element.id=e}get element(){return this.$shared?this.$shared.element:this.tempEl}get $pwMain(){return this.$shared?this.$shared.mainObj:null}get $pwView(){return this.$shared?this.$shared.viewObj:null}get parent(){return this.$shared?this.$shared.parentObj:null}get children(){return this._cachedChildren||this._getChildren()}_getChildren(){this._cachedChildren=[];const e=this.element;for(const t of e.children)if(t.className.includes("power-"))for(const e of Object.keys(this.$powerUi.powerTree.allPowerObjsById[t.id]||{}))e.startsWith("power")&&this._cachedChildren.push(this.$powerUi.powerTree.allPowerObjsById[t.id][e]);return this._cachedChildren}get innerPowerCss(){return this._cachedInnerPowerCss||this._getInnerPowerCss()}_getInnerPowerCss(){return this._cachedInnerPowerCss=this.$powerUi.powerTree._getAllInnerPowerCss(this.element),this._cachedInnerPowerCss}}class _PowerBasicElementWithEvents extends _PowerBasicElement{constructor(e){super(e),this._events={},this._DOMEvents={},this._events_fn={}}toggle(){this._$pwActive=!this._$pwActive,this.broadcast("toggle",!0)}subscribe({event:e,fn:t,useCapture:i=!0,...s}){this.unsubscribe({event:e,fn:t,useCapture:i,params:s});const n=this;this._events[e]||(this._events[e]=new UEvent(this.id),this._DOMEvents[e]||(this._DOMEvents[e]=new CustomEvent(e,{bubbles:i})),this._events_fn[e]=function(t){n._events[e].broadcast(n,t,s)},this.addEventListener(e,this._events_fn[e],i)),this._events[e].subscribe(t,n,s)}unsubscribe({event:e,fn:t,useCapture:i=!0,...s}){this._events[e]&&(this._events[e].unsubscribe(t),0===this._events[e].observers.length&&(delete this._events[e],this.removeEventListener(e,this._events_fn[e],i)))}broadcast(e,t){void 0!==document.body[e]||t?this._DOMEvents[e]&&this.element.dispatchEvent(this._DOMEvents[e]):(this._DOMEvents[e]&&this.element.dispatchEvent(this._DOMEvents[e]),this.dispatch(e))}dispatch(e){this[e]&&this[e]()}addEventListener(e,t,i=!1){this.element.addEventListener(e,t,i)}removeEventListener(e,t,i=!1){this.element&&this.element.removeEventListener(e,t,i)}getChildrenByPowerCss(e){return this.children.filter(t=>t.$powerCss===e)}getInnerByPowerCss(e){return this.innerPowerCss.filter(t=>t.$powerCss===e)}getInnerWithoutChildrenByPowerCss(e){return this.innerPowerCss.filter(t=>t.$powerCss===e&&t.parent.id!==this.id)}}class PowerTarget extends _PowerBasicElementWithEvents{constructor(e){super(e),this.powerTarget=!0}}class PowerTree{constructor(e,t){this.$powerUi=e,this.allPowerObjsById={},this.attrsConfig={};for(const e of _PowerUiBase._powAttrsConfig){e.callback(document.createElement("div")).compile&&(e.isCompiler=!0),this.attrsConfig[e.datasetKey]=e}for(const e of _PowerUiBase._pwcAttrsConfig){e.callback(document.createElement("div")).compile&&(e.isCompiler=!0),this.attrsConfig[e.datasetKey]=e}this.rootDatasetKeys=Object.keys(this.attrsConfig||{}).filter(e=>this.attrsConfig[e].isCompiler),this.mainDatasetKeys=this.getMainDatasetKeys(),this.buildAndInterpolate(document)}removeAllEvents(){for(const e of Object.keys(this.allPowerObjsById||{}))this.removeEventsOfObject(e);UEvent.index={}}removeEventsOfObject(e){for(const t of Object.keys(this.allPowerObjsById[e]||{}))if("$shared"!==t)for(const i of Object.keys(this.allPowerObjsById[e][t]._events))for(const s of this.allPowerObjsById[e][t]._events[i].observers)s.ctx.unsubscribe({event:i,fn:s.fn})}getMainDatasetKeys(){const e=[];for(const t of PowerUi._powerElementsConfig)t.isMain&&e.push(t.datasetKey);for(const t of Object.keys(this.attrsConfig||{}))this.attrsConfig[t].isMain&&e.push(this.attrsConfig[t].datasetKey);return e}datasetIsCompiler(e){for(const t of Object.keys(e||{}))if(this.rootDatasetKeys.includes(t))return!0;return!1}datasetIsMain(e){for(const t of Object.keys(e||{}))if(this.mainDatasetKeys.includes(t))return!0;return!1}buildAndInterpolate(e,t){if(this.sweepDOM({entryNode:e,callback:this.buildPowerObjects.bind(this),isInnerCompiler:!1}),!t){const e=document.getElementsByTagName("BODY")[0];e.innerHTML=this.$powerUi.interpolation.replaceInterpolation(e.innerHTML,this)}}buildPowerObjects({currentNode:e,main:t,view:i,isInnerCompiler:s,saved:n,rootCompiler:r,parent:o}){let a=!1,l=[];s=s||!1;let h=o=o||!1;n=n||{pending:[]};const c=t=t||!1,u=i=i||!1;let d=!1,p=!1;if(e.dataset)for(const n of Object.keys(e.dataset||{}))for(const h of["pwc","pow"]){n.startsWith(h)&&(a=this._compile({currentNode:e,datasetKey:n,isInnerCompiler:s,view:i}),a&&!s&&(r=e,p=!0),this.attrsConfig[n]&&this.attrsConfig[n].isMain&&(t=e,d=!0),l.push({datasetKey:n,currentElement:e,main:c,view:u,rootCompiler:s?r:null,isMain:d,isRootCompiler:p,parent:o,originalInnerHTML:a}))}if(e.className&&e.className.includes("power-"))for(const n of PowerUi._powerElementsConfig)e.classList.contains(n.name)&&(n.isMain&&(t=e,d=!0),"powerView"===n.datasetKey&&(i=e),l.push({datasetKey:n.datasetKey,currentElement:e,main:c,view:u,rootCompiler:s?r:null,isMain:d,parent:o}),h={node:e,datasetKey:n.datasetKey});if(!!e.children&&!!e.children.length&&(a||s?this.sweepDOM({entryNode:e,callback:this.buildPowerObjects.bind(this),isInnerCompiler:!0,main:t,view:i,rootCompiler:r,saved:n,parent:h}):this.sweepDOM({entryNode:e,callback:this.buildPowerObjects.bind(this),isInnerCompiler:!1,main:t,view:i,rootCompiler:r,saved:n,parent:h})),a&&!s){e.innerHTML=this.$powerUi.interpolation.compile({template:e.innerHTML,view:i});for(const e of n.pending)this._instanciateObj(e);n.pending=[]}if(l.length>0&&!a||a&&!s){for(const e of l)this._instanciateObj(e);l=[]}else for(const e of l)n.pending.push(e)}getEntryNodeWithParentsAndConfig(e){const t=document.getElementById(e),i=this._getParentElementFromChildElement(t),s=this._getMainElementFromChildElement(t),n=this.datasetIsMain(t.dataset),r=this._getViewElementFromChildElement(t),o=this._getRootCompilerElementFromChildElement(t,this);return{currentNode:t,parent:i,main:s,isMain:n,view:r,isInnerCompiler:o&&this.datasetIsCompiler(t.dataset),rootCompiler:o}}createAndInitObjectsFromCurrentNode({id:e}){const t=this.getEntryNodeWithParentsAndConfig(e);this.buildPowerObjects(t);const i=document.getElementById(e);i.innerHTML=this.$powerUi.interpolation.replaceInterpolation(i.innerHTML,this),this._callInitForObjectAndInners(document.getElementById(e))}_compile({currentNode:e,datasetKey:t,isInnerCompiler:i,view:s}){let n=!1;if(this.attrsConfig[t]&&this.attrsConfig[t].isCompiler&&!0==!e.getAttribute("data-pwhascomp")){const r=getIdAndCreateIfDontHave(e),o=this.attrsConfig[t].callback(e);o.id=r,o.$powerUi=this.$powerUi,n=!!i||(e.innerHTML||!0),o.compile({view:s}),o.element.setAttribute("data-pwhascomp",!0)}return n}_instanciateObj({currentElement:e,datasetKey:t,main:i,view:s,rootCompiler:n,isMain:r,isRootCompiler:o,parent:a,originalInnerHTML:l}){const h=getIdAndCreateIfDontHave(e),c=this.$powerUi[`_${t}`]?`_${t}`:"powerAttrs";let u;if("powerAttrs"===c){if(!this.attrsConfig[t])return;u=this.attrsConfig[t].callback(document.getElementById(h))}else u=this.$powerUi[c](document.getElementById(h));u.isMain=r||null,u.isRootCompiler=o||null,u.originalInnerHTML=l&&!0!==l?l:"",this._addToObjectsById({powerObject:u,id:h,datasetKey:t,main:i,view:s,rootCompiler:n,parent:a})}_addToObjectsById({powerObject:e,id:t,datasetKey:i,main:s,view:n,rootCompiler:r,parent:o}){if(this.allPowerObjsById[t]){const e=document.querySelectorAll(`[id=${t}]`);if(e.length>1)throw console.error("DUPLICATED IDs:",e),`HTML element can't have duplicated IDs: ${t}`}else this.allPowerObjsById[t]={};this.allPowerObjsById[t][i]||(this.allPowerObjsById[t][i]={}),this.allPowerObjsById[t][i]=e,this.allPowerObjsById[t][i].id=t,this.allPowerObjsById[t][i].datasetKey=i,this.allPowerObjsById[t][i].$powerCss=i,this.allPowerObjsById[t][i].$powerUi=this.$powerUi,this.allPowerObjsById[t].$shared||(this.allPowerObjsById[t].$shared=new SharedScope({id:t,main:s,view:n,rootCompiler:r,parent:o,ctx:this})),e.isRootCompiler&&(this.allPowerObjsById[t].$shared.isRootCompiler=e.isRootCompiler,this.allPowerObjsById[t].$shared.originalInnerHTML=e.originalInnerHTML),this.allPowerObjsById[t][i].$shared=this.allPowerObjsById[t].$shared}sweepDOM({entryNode:e,callback:t,isInnerCompiler:i,main:s,view:n,rootCompiler:r,saved:o,parent:a}){const l=!!e&&!!e.nodeType,h=!!e.children&&!!e.children.length;if(l&&h){e.children;for(const l of e.children)t({currentNode:l,callback:t,isInnerCompiler:i,main:s,view:n,rootCompiler:r,saved:o,parent:a})}else t({currentNode:e,callback:t,isInnerCompiler:i,main:s,view:n,rootCompiler:r,saved:o,parent:a})}_getAllInnerPowerCss(e){const t=[];for(const i of _PowerUiBase._powerElementsConfig){const s=e.getElementsByClassName(i.name);for(const e of s){const s=this.allPowerObjsById[e.id][i.datasetKey];t.push(s)}}return t}_getParentElementFromChildElement(e){const t=PowerTree._searchUpDOM(e,PowerTree._checkIfhavePowerParentElement);if(t.conditionResult)return t.powerElement}_getMainElementFromChildElement(e){const t=PowerTree._searchUpDOM(e,this._checkIfIsMainElement);if(t.conditionResult)return t.powerElement}_getViewElementFromChildElement(e){const t=PowerTree._searchUpDOM(e,this._checkIfIsViewElement);if(t.conditionResult)return t.powerElement}_getRootCompilerElementFromChildElement(e,t){const i=PowerTree._searchUpDOM(e,this._checkIfIsCompilerElement,t);if(i.conditionResult)return i.powerElement}_checkIfIsCompilerElement(e,t){let i=!1;return e&&e.dataset&&t.datasetIsCompiler(e.dataset)&&(i=!0),i}_checkIfIsMainElement(e){let t=!1;if(e&&e.className)for(const i of PowerUi._powerElementsConfig.filter(e=>!0===e.isMain))if(e.classList.contains(i.name)){t=!0;break}return t}_checkIfIsViewElement(e){return e&&e.className&&e.classList.contains("power-view")}_callInit(){for(const e of Object.keys(this.allPowerObjsById||{}))this._callInitOfObject(e)}_callInitOfObject(e){for(const t of Object.keys(this.allPowerObjsById[e]||{}))this.allPowerObjsById[e][t].init&&this.allPowerObjsById[e][t].init()}_callInitForObjectAndInners(e){e.id&&this._callInitOfObject(e.id);const t=e?e.children:[];for(const e of t)this._callInitForObjectAndInners(e)}}PowerTree._searchUpDOM=function(e,t,i){let s=e.className.includes("power-")?e:null,n=e.parentElement,r=!1,o=!n;for(;!o;)r=t(n,i),r&&(o=!0),n.className.includes("power-")&&(s=n),n.parentElement&&!o?n=n.parentElement:o=!0;return{powerElement:s,conditionResult:r}},PowerTree._checkIfhavePowerParentElement=function(e){let t=!1;return e.className.includes("power-")&&(t=!0),t};class _pwBasicHover extends _PowerBasicElementWithEvents{constructor(e){super(e),this._$pwActive=!1}init(){this.$_pwDefaultValue||(this.$_pwDefaultValue=this.element[this.$_target]),this.$_pwHoverValue||(this.$_pwHoverValue=this.element.getAttribute(this.$_pwAttrName)||""),this.subscribe({event:"mouseover",fn:this.mouseover}),this.subscribe({event:"mouseout",fn:this.mouseout})}mouseover(){this._$pwActive||(this.element[this.$_target]=this.$_pwHoverValue,this.toggle(),this.$shared._priorityActive=!0)}mouseout(){this._$pwActive&&(this.element[this.$_target]=this.$_pwDefaultValue||"",this.toggle(),this.$shared._priorityActive=!1)}}class _pwMainBasicHover extends _pwBasicHover{constructor(e,t,i){super(e,t,i)}mouseover(){this._$pwActive||this.$shared._priorityActive||(this.element[this.$_target]=this.$_pwHoverValue,this.toggle())}mouseout(){this._$pwActive&&(this.element[this.$_target]=this.$_pwDefaultValue||"",this.toggle())}addEventListener(e,t,i){this.$pwMain.subscribe({event:e,fn:t,useCapture:i})}removeEventListener(e,t,i){this.$pwMain.unsubscribe({event:e,fn:t,useCapture:i})}}class PowCssHover extends _PowerBasicElementWithEvents{constructor(e){super(e),this._$pwActive=!1,this.$_pwAttrName="data-pow-css-hover"}init(){this.$_pwHoverValues||(this.$_pwHoverValues=this.element.getAttribute(this.$_pwAttrName).split(" ")||[]),this.subscribe({event:"mouseover",fn:this.mouseover}),this.subscribe({event:"mouseout",fn:this.mouseout})}mouseover(){if(!this._$pwActive&&!this.$shared._priorityActive){for(const e of this.$_pwHoverValues)this.element.classList.add(e);this.toggle(),this.$shared._priorityActive=!0}}mouseout(){if(this._$pwActive){for(const e of this.$_pwHoverValues)this.element.classList.remove(e);this.toggle(),this.$shared._priorityActive=!1}}}_PowerUiBase.injectPow({name:"data-pow-css-hover",callback:function(e){return new PowCssHover(e)}});class PowMainCssHover extends PowCssHover{constructor(e){super(e),this.$_pwAttrName="data-pow-main-css-hover"}mouseover(){if(!this._$pwActive&&!this.$shared._priorityActive){for(const e of this.$_pwHoverValues)this.element.classList.add(e);this.toggle()}}mouseout(){if(this._$pwActive){this.toggle();for(const e of this.$_pwHoverValues)this.element.classList.remove(e)}}addEventListener(e,t,i){this.$pwMain.subscribe({event:e,fn:t,useCapture:i})}removeEventListener(e,t,i){this.$pwMain.unsubscribe({event:e,fn:t,useCapture:i})}}_PowerUiBase.injectPow({name:"data-pow-main-css-hover",isMain:!0,callback:function(e){return new PowMainCssHover(e)}});class PowSrcHover extends _pwBasicHover{constructor(e){super(e),this.$_pwAttrName="data-pow-src-hover",this.$_target="src"}}_PowerUiBase.injectPow({name:"data-pow-src-hover",callback:function(e){return new PowSrcHover(e)}});class PowMainSrcHover extends _pwMainBasicHover{constructor(e){super(e),this.$_pwAttrName="data-pow-main-src-hover",this.$_target="src"}}_PowerUiBase.injectPow({name:"data-pow-main-src-hover",isMain:!0,callback:function(e){return new PowMainSrcHover(e)}});class PowCssHoverRemove extends PowCssHover{constructor(e){super(e),this.$_pwAttrName="data-pow-css-hover-remove"}mouseover(){if(!this._$pwActive){for(const e of this.$_pwHoverValues)this.element.classList.remove(e);this.toggle(),this.$shared._priorityActive=!0}}mouseout(){if(this._$pwActive){for(const e of this.$_pwHoverValues)this.element.classList.add(e);this.toggle(),this.$shared._priorityActive=!1}}}_PowerUiBase.injectPow({name:"data-pow-css-hover-remove",callback:function(e){return new PowCssHoverRemove(e)}});class PowMainCssHoverRemove extends PowMainCssHover{constructor(e){super(e),this.$_pwAttrName="data-pow-main-css-hover-remove"}mouseover(){if(!this._$pwActive&&!this.$shared._priorityActive){for(const e of this.$_pwHoverValues)this.element.classList.remove(e);this.toggle()}}mouseout(){if(this._$pwActive&&!this.$shared._priorityActive){for(const e of this.$_pwHoverValues)this.element.classList.add(e);this.toggle()}}}_PowerUiBase.injectPow({name:"data-pow-main-css-hover-remove",isMain:!0,callback:function(e){return new PowMainCssHoverRemove(e)}});class PowEval extends _PowerBasicElementWithEvents{constructor(e){super(e),this._$pwActive=!1}compile({view:e}){const t=!!(e&&e.id&&this.$powerUi.controllers[e.id])&&this.$powerUi.controllers[e.id].instance;this.element.innerHTML=this.$powerUi.interpolation.getDatasetResult(this.element.dataset.powEval,t)}}_PowerUiBase.injectPow({name:"data-pow-eval",callback:function(e){return new PowEval(e)}});class PowEvent extends _PowerBasicElementWithEvents{constructor(e){super(e),this._$pwActive=!1}compile({view:e}){!!(e&&e.id&&this.$powerUi.controllers[e.id])&&this.$powerUi.controllers[e.id].instance;for(const t of this.element.attributes)if(t.name.includes("on")){const i=t.name.slice(2,t.name.length);this.element.setAttribute(`data-pow-${i}`,this.$powerUi.interpolation.encodeHtml(t.value)),t.value=`window._$dispatchPowerEvent(event, this, '${e.id}', '${i}')`}}}_PowerUiBase.injectPow({name:"data-pow-event",callback:function(e){return new PowEvent(e)}});class PowFor extends _PowerBasicElementWithEvents{constructor(e){super(e),this._$pwActive=!1,this._pwEvaluateValue=""}compile({view:e}){if(!this.element.dataset.powFor)return;const t=this.$powerUi.interpolation.decodeHtml(this.element.dataset.powFor).split(" "),i=`\\b(${t[0]})\\b`,s=t[1];t.shift(),t.shift();let n=t.join(" ");const r=!!(e&&e.id&&this.$powerUi.controllers[e.id])&&this.$powerUi.controllers[e.id].instance;n=this.$powerUi.safeEval({text:n,$powerUi:this.$powerUi,scope:r}),"of"===s?this.forOf(i,n):this.forIn(i,n)}forOf(e,t){let i="",s=0;for(const n of t||[]){const t=_Unique.scopeID();let r=this.$powerUi.interpolation.replaceWith({entry:this.element.innerHTML,oldValue:"\\$pwIndex",newValue:s});s+=1,this.$powerUi._tempScope[t]=n,i+=this.$powerUi.interpolation.replaceWith({entry:r,oldValue:e,newValue:this.$powerUi.interpolation.encodeHtml(`_tempScope['${t}']`)})}this.element.innerHTML=i}forIn(e,t){let i="",s=0;for(const n of Object.keys(t||{})){const r=_Unique.scopeID();let o=this.$powerUi.interpolation.replaceWith({entry:this.element.innerHTML,oldValue:"\\$pwKey",newValue:`'${n}'`});o=this.$powerUi.interpolation.replaceWith({entry:o,oldValue:"\\$pwIndex",newValue:s}),s+=1,this.$powerUi._tempScope[r]=t[n],i+=this.$powerUi.interpolation.replaceWith({entry:o,oldValue:e,newValue:this.$powerUi.interpolation.encodeHtml(`_tempScope['${r}']`)})}this.element.innerHTML=i}}_PowerUiBase.injectPow({name:"data-pow-for",callback:function(e){return new PowFor(e)}});class PowIf extends _PowerBasicElementWithEvents{constructor(e){super(e),this._$pwActive=!1,this.originalHTML=e.innerHTML}compile({view:e}){const t=!!(e&&e.id&&this.$powerUi.controllers[e.id])&&this.$powerUi.controllers[e.id].instance;!1===this.$powerUi.safeEval({text:this.$powerUi.interpolation.decodeHtml(this.element.dataset.powIf),$powerUi:this.$powerUi,scope:t})?(this.element.style.display="none",this.element.innerHTML=""):(this.element.style.display=null,this.element.innerHTML=this.originalHTML)}}function defineInnerDropmenusPosition(e,t){["right-bottom","bottom-right","bottom","right"].includes(e.defaultPosition)?t.defaultPosition="right-bottom":["left-bottom","bottom-left","left"].includes(e.defaultPosition)?t.defaultPosition="left-bottom":["right-top","top-right","top","right"].includes(e.defaultPosition)?t.defaultPosition="right-top":["left-top","top-left"].includes(e.defaultPosition)?t.defaultPosition="left-top":t.defaultPosition="right-bottom"}function defineRootDropmenusPosition(e,t){["right-bottom","bottom-right","left-bottom","bottom-left","right-top","top-right","left-top","top-left"].includes(e.defaultPosition)?t.defaultPosition=e.defaultPosition:"top"===e.defaultPosition?t.defaultPosition="top-right":"bottom"===e.defaultPosition?t.defaultPosition="bottom-right":"right"===e.defaultPosition?t.defaultPosition="bottom-right":"left"===e.defaultPosition?t.defaultPosition="bottom-left":e.element.classList.contains("power-horizontal")?e.defaultPosition="bottom-right":e.defaultPosition="right-bottom"}_PowerUiBase.injectPow({name:"data-pow-if",callback:function(e){return new PowIf(e)}});class KeyboardManager{constructor(e){document.onkeydown=this.checkKey.bind(this),document.onkeyup=this.checkKey.bind(this),this.$powerUi=e,this.keyModeIsOn=!1}getRootElements(){return this.$powerUi.powerTree.rootElements}setKeyModeOn(){if(!1===this.keyModeIsOn){this.keyModeIsOn=!0,this.createBackDrop();for(const e of this.getRootElements()){const t=getComputedStyle(e.element);console.log("styles",t.position),"static"===t.position&&e.element.classList.add("power-keyboard-position"),e.element.classList.add("power-keyboard-mode")}console.log("Keyboard mode ON")}}createBackDrop(){this.backdrop=document.createElement("DIV"),this.backdrop.classList.add("power-keyboard-backdrop"),document.body.appendChild(this.backdrop)}removeBackdrop(){document.body.removeChild(this.backdrop)}setKeyModeOff(){if(this.keyModeIsOn){this.removeBackdrop(),this._17=!1,this._48=!1,this._96=!1,this.keyModeIsOn=!1,console.log("Keyboard mode OFF");for(const e of this.getRootElements())e.element.classList.remove("power-keyboard-mode"),e.element.classList.remove("power-keyboard-position"),console.log("element",e)}}checkKey(e){27===(e=e||window.event).keyCode&&this.setKeyModeOff(),"keydown"===e.type?this[`_${e.keyCode}`]=!0:this[`_${e.keyCode}`]=!1,this._17&&(this._48||this._96)&&this.setKeyModeOn()}}class PowerUi extends _PowerUiBase{constructor(e){super(),window._$dispatchPowerEvent=this._$dispatchPowerEvent,this.controllers={$routeSharedScope:{$waitingToDelete:[]}},this._Unique=_Unique,this.addScopeEventListener(),this.numberOfopenModals=0,this.ctrlWaitingToRun=[],this.config=e,this.waitingViews=0,this.waitingInit=[],this.initAlreadyRun=!1,this._services=e.services||{},this._addServices(),this.interpolation=new PowerInterpolation(e,this),this._events={},this._events.ready=new UEvent,this._events.Escape=new UEvent,this.request=new Request({config:e,$powerUi:this}),this.router=new Router(e,this),document.addEventListener("keyup",this._keyUp.bind(this),!1)}getCookie(e){const t=e+"=",i=document.cookie.split(";");for(var s=0;s<i.length;s++){for(var n=i[s];" "==n.charAt(0);)n=n.substring(1,n.length);if(0==n.indexOf(t))return n.substring(t.length,n.length)}return null}setCookie({name:e,value:t,days:i,domain:s,path:n}){var r="";if(i){var o=new Date;o.setTime(o.getTime()+24*i*60*60*1e3),r=";expires="+o.toUTCString()}document.cookie=e+"="+(t||"")+r+`;${s?"domain="+s+";":""}path=${n||"/"};`}removeCookie({name:e,value:t,domain:i,path:s}){document.cookie=`${e}=${t||""};${i?"domain="+i+";":""}Max-Age=-99999999;path=${s||"/"};`}_addService(e,t){this._services[e]=t}_addServices(){this._addService("widget",{component:WidgetService})}_$dispatchPowerEvent(e,t,i,s){document.dispatchEvent(new CustomEvent("pwScope",{detail:{viewId:i,elementId:t.id,attrName:s,event:e}}))}_keyUp(e){"Escape"!=e.key&&27!=e.keyCode||this._events.Escape.popBroadcast()}addScopeEventListener(){document.removeEventListener("pwScope",this.pwScope.bind(this),!1),document.addEventListener("pwScope",this.pwScope.bind(this),!1)}pwScope(e){const t=this,i=!!(e&&e.detail&&e.detail.viewId&&t.controllers[e.detail.viewId])&&t.controllers[e.detail.viewId].instance;if(!1===i)return;i.event=e.detail.event;const s=!!(e&&e.detail&&e.detail.elementId)&&document.getElementById(e.detail.elementId),n=!!(e&&e.detail&&e.detail.attrName)&&`data-pow-${e.detail.attrName}`,r=!(!s||!n)&&this.interpolation.decodeHtml(s.getAttribute(n));r&&t.safeEval({text:r,$powerUi:t,scope:i})}safeEval({text:e,scope:t}){return new ParserEval({text:e,scope:t,$powerUi:this}).currentValue}initAll({template:e,routeId:t,viewId:i}){const s=performance.now();this.initAlreadyRun&&this.powerTree.removeAllEvents(),this._createPowerTree(),this.truth={},this.tmp={dropmenu:{}},this.touchdevice=!!(navigator.maxTouchPoints||"ontouchstart"in document.documentElement),this.touchdevice||(this.keyboardManager=new KeyboardManager(this)),this.initAlreadyRun=!0;for(const e of this.waitingInit)document.getElementById(e.node.id).style.visibility=null;this.waitingInit=[];for(const e of Object.keys(this.controllers||{}))"$routeSharedScope"!==e&&this.callOnViewLoad(this,e);const n=performance.now();console.log("PowerUi init run in "+(n-s)+" milliseconds.")}pwReload(){this.initAlreadyRun=!1,this.router._reload()}callOnViewLoad(e,t){e.controllers[t]&&e.controllers[t].instance&&(e.controllers[t].instance.onViewLoad&&e.controllers[t].instance.onViewLoad(e.powerTree.allPowerObjsById[t].$shared.element),e.controllers[t].instance._onViewLoad&&e.controllers[t].instance._onViewLoad(e.powerTree.allPowerObjsById[t].$shared.element))}initNodes({template:e,routeId:t,viewId:i}){const s=performance.now();for(const e of this.waitingInit)this.powerTree.createAndInitObjectsFromCurrentNode({id:e.node.id}),document.getElementById(e.node.id).style.visibility=null;this.callOnViewLoad(this,i);const n=performance.now();console.log("PowerUi init run in "+(n-s)+" milliseconds.",this.waitingInit),this.waitingInit=[]}prepareViewToLoad({viewId:e,routeId:t}){const i=document.getElementById(e);return this.addSpinnerAndHideView(i),this.waitingInit.push({node:i,viewId:e}),i}addSpinnerAndHideView(e){if(!document.getElementById("_power-spinner")){const e=document.createElement("div");e.classList.add("pw-spinner-backdrop"),e.id="_power-spinner";const t=document.createElement("p");t.classList.add("pw-spinner-label"),t.innerText=this.config.spinnerLabel||"LOADING",e.appendChild(t);const i=document.createElement("div");i.classList.add("pw-spinner"),e.appendChild(i),document.body.appendChild(e)}e&&(e.style.visibility="hidden",this.waitingViews=this.waitingViews+1)}runRouteController(){let e=1;for(const t of this.ctrlWaitingToRun)e+=1,this.controllers[t.viewId]&&this.controllers[t.viewId].instance&&this.controllers[t.viewId].instance.ctrl(this.controllers[t.viewId].params);this.ctrlWaitingToRun=[]}loadTemplateUrl({template:e,viewId:t,currentRoutes:i,routeId:s,routes:n,title:r}){const o=this,a=this.prepareViewToLoad({viewId:t,routeId:s});this.request({url:e,method:"GET",status:"Loading page",withCredentials:!1}).then((function(i,l){e=l.responseText,o.buildViewTemplateAndMayCallInit({self:o,view:a,template:e,routeId:s,viewId:t,title:r});const h=n[s];!0!==h.avoidCacheTemplate?(h.template=l.responseText,h.templateIsCached=!0):h.templateIsCached=!1})).catch((function(e,i){o.ifNotWaitingServerCallInit({template:e,routeId:s,viewId:t})}))}loadTemplate({template:e,viewId:t,currentRoutes:i,routeId:s,routes:n,title:r}){const o=this.prepareViewToLoad({viewId:t,routeId:s});this.buildViewTemplateAndMayCallInit({self:this,view:o,template:e,routeId:s,viewId:t,title:r})}buildViewTemplateAndMayCallInit({self:e,view:t,template:i,routeId:s,viewId:n,title:r,refreshing:o}){e.controllers[n]&&e.controllers[n].instance&&e.controllers[n].instance.isWidget&&(!o&&e.controllers[n].instance.init&&e.controllers[n].instance.init(),i=e.controllers[n].instance.$buildTemplate({template:i,title:r})),t.innerHTML=i,e.ifNotWaitingServerCallInit({template:i,routeId:s,viewId:n,refreshing:o})}ifNotWaitingServerCallInit({template:e,routeId:t,viewId:i,refreshing:s}){const n=this;s||n.ctrlWaitingToRun.push({viewId:i,routeId:t}),setTimeout((function(){n.waitingViews=n.waitingViews-1,0===n.waitingViews&&(n.runRouteController(),n.initAlreadyRun?n.initNodes({template:e,routeId:t,viewId:i}):n.initAll({template:e,routeId:t,viewId:i}),n.removeSpinner(),n._events.ready.broadcast("ready"))}),10)}removeSpinner(){const e=document.getElementById("_power-spinner");e.parentNode.removeChild(e)}sanitizeHTML(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}_powerView(e){return new PowerView(e,this)}_powerMenu(e){return new PowerMenu(e,this)}_powerMain(e){return new PowerMain(e,this)}_powerBrand(e){return new PowerBrand(e,this)}_powerItem(e){return new PowerItem(e,this)}_powerAccordion(e){return new PowerAccordion(e,this)}_powerAccordionSection(e){return new PowerAccordionSection(e,this)}_powerAction(e){return new PowerAction(e,this)}_powerToggle(e){return new PowerToggle(e,this)}_powerDropmenu(e){return new PowerDropmenu(e,this)}_powerStatus(e){return new PowerStatus(e,this)}_powerBasicElement(e){return new _PowerBasicElement(e,this)}_offsetComputedStyles(e){return parseInt(e.left.split("px")[0]||0)+parseInt(e["margin-left"].split("px")[0]||0)+parseInt(e["border-left-width"].split("px")[0]||0)}_offsetComputedRootElementStyles(e){return parseInt(e["margin-left"].split("px")[0]||0)}}export{PowerUi};class PowerServices{constructor({$powerUi:e,$ctrl:t}){this.$powerUi=e,this.$ctrl=t}}class WidgetService extends PowerServices{mayAddCtrlParams({params:e,onCommit:t,onCancel:i,onCancelError:s,onCommitError:n}){return void 0===e&&(e={}),t&&(e.onCommit=t),i&&(e.onCancel=i),n&&(e.onCommitError=n),s&&(e.onCancelError=s),e}alert(e){e.kind="alert",this.open(e)}confirm(e){e.kind="confirm",this.open(e)}modal(e){e.kind="modal",this.open(e)}window(e){e.kind="window",this.open(e)}open({title:e,template:t,ctrl:i,target:s,params:n,controller:r,kind:o,onCommit:a,onCommitError:l,onCancel:h,onCancelError:c,templateUrl:u}){i||r||(r=function(){}),!i&&r&&"function"==typeof r&&(i={component:wrapFunctionInsideDialog({controller:r,kind:o,params:n=this.mayAddCtrlParams({params:n,onCommit:a,onCancel:h,onCommitError:l,onCancelError:c})})}),void 0===i.params&&(i.params={});const d=`pow_route_${this.$powerUi._Unique.next()}`;this.$ctrl.volatileRouteIds.push(d),this._open({routeId:d,target:s||"_blank",title:e,template:t,templateUrl:u,ctrl:i,params:n})}_open({routeId:e,params:t,target:i,title:s,template:n,ctrl:r,templateUrl:o}){const a={id:e,title:s,route:this.$powerUi.router.config.rootRoute+e,template:o||n,templateUrl:o,hidden:!0,ctrl:r,isVolatile:!0};this.$powerUi.router.routes[e]=a,this.$powerUi.router.openRoute({routeId:e||this.$ctrl._routeId,currentRouteId:this.$ctrl._routeId,currentViewId:this.$ctrl._viewId,params:t,target:i,title:s||null})}}class PowerController{constructor({$powerUi:e}){this.$powerUi=e,this._servicesInstances={},this.volatileRouteIds=[]}get router(){return this.$powerUi.router}refresh(){const e=document.getElementById(this._viewId),t=e.getElementsByClassName("pw-container")[0],i=e.getElementsByClassName("pw-body")[0];t&&(this._containerScrollTop=t.scrollTop||0,this._containerScrollLeft=t.scrollLeft||0),i&&(this._bodyScrollTop=i.scrollTop||0,this._bodyScrollLeft=i.scrollLeft||0),this.router._refresh(this._viewId)}openRoute({routeId:e,params:t,target:i}){const s=this.$powerUi.router.getOpenedRoute({routeId:this._routeId,viewId:this._viewId});this.router.openRoute({routeId:e||this._routeId,currentRouteId:this._routeId,currentViewId:this._viewId,params:t,target:i,title:s.title||null})}$service(e){return this._servicesInstances[e]?this._servicesInstances[e]:(this._servicesInstances[e]=new this.$powerUi._services[e].component({$powerUi:this.$powerUi,$ctrl:this,params:this.$powerUi._services[e].params}),this._servicesInstances[e])}closeCurrentRoute(){const e=this.router.getOpenedRoute({routeId:this._routeId,viewId:this._viewId});console.log("current route",e);const t=decodeURI(this.router.locationHashWithHiddenRoutes()).split("?");let i=0,s="";for(let n of t)n.includes(e.route)||(n=0!==i?"?"+n:n.replace(this.router.config.rootRoute,""),s+=n,i+=1);this.router.navigate({hash:s,title:e.title||null})}safeEval(e){return this.$powerUi.safeEval({text:e,scope:this})}}export{PowerController};class Request{constructor({config:e,$powerUi:t}){this.$powerUi=t;const i=this;return function(t){t.withCredentials=void 0===t.withCredentials||t.withCredentials,t.headers=t.headers||e.headers||{},e.authCookie&&(t.headers.Authorization=i.$powerUi.getCookie(e.authCookie)||null);const s={then:function(e){return this.onsucess=e,this},catch:function(e){return this.onerror=e,this}};return i.ajaxRequest({method:t.method,url:t.url,data:t,onsucess:function(e){if(s.onsucess)try{return s.onsucess(JSON.parse(e.response),e)}catch{return s.onsucess(e.response,e)}return s},onerror:function(e){if(s.onerror)try{return s.onerror(JSON.parse(e.response),e)}catch{return s.onerror(e.response,e)}}}),s}}encodedParams(e){var t="";for(var i in e)e.hasOwnProperty(i)&&(t.length>0&&(t+="&"),t+=encodeURI(i+"="+e[i]));return t}ajaxRequest({method:e,url:t,onsucess:i,onerror:s,async:n,data:r}){null==n&&(n=!0);const o=new XMLHttpRequest;return o.open(e,t,n),o.onload=function(){200===o.status&&i?i(o):200!==o.status&&s?s(o):window.console("Request failed.  Returned status of "+o.status)},e&&"POST"===e.toUpperCase()?o.setRequestHeader("Content-Type","application/json"):o.setRequestHeader("Content-Type","text/html"),r.headers&&r.headers["Content-Type"]&&o.setRequestHeader("Content-Type",r.headers["Content-Type"]),r&&r.body?o.send(JSON.stringify(r.body)):o.send(),o}}function getEmptyRouteObjetc(){return{params:[],id:"",viewId:"",route:"",secundaryRoutes:[],hiddenRoutes:[]}}class Router{constructor(e={},t){if(this.config=e,this.$powerUi=t,this.routes={},this.oldRoutes=getEmptyRouteObjetc(),this.currentRoutes=getEmptyRouteObjetc(),this.config.rootRoute||(this.config.rootRoute="#!/"),e.routes)for(const t of e.routes)this.add(t);this.init(),window.onhashchange=this.hashChange.bind(this)}add({id:e,route:t,template:i,templateUrl:s,avoidCacheTemplate:n,callback:r,viewId:o,ctrl:a,title:l,hidden:h}){if(i=s||i,!this.config.routerMainViewId&&!1!==this.config.routerMainViewId&&(this.config.routerMainViewId="main-view",!document.getElementById(this.config.routerMainViewId)))throw new Error('The router needs a element with an ID to render views, you can define some HTML element with the id "main-view" or set your on id in the config using the key "routerMainViewId" with the choosen id. If you not want render any view in a main view, set the config key "routerMainViewId" to false and a "viewId" flag to each route with a view.');if(!this.config.routerSecundaryViewId&&!1!==this.config.routerSecundaryViewId&&(this.config.routerSecundaryViewId="secundary-view",!document.getElementById(this.config.routerSecundaryViewId)))throw new Error('The router needs a element with an ID to render views, you can define some HTML element with the id "secundary-view" or set your on id in the config using the key "routerSecundaryViewId" with the choosen id. If you not want render any view in a secundary view, set the config key "routerSecundaryViewId" to false and a "viewId" flag to each route with a view.');if(!e)throw new Error("A route ID must be given");if(!t&&!i&&!r)throw new Error("route, template, templateUrl or callback must be given");if(!1===this.config.routerMainViewId&&i&&!o)throw new Error(`You set the config flag "routerMainViewId" to false, but do not provide a custom "viewId" to the route "${t}" and id "${e}". Please define some element with some id to render the template, templateUrl, and pass it as "viewId" paramenter to the router.`);if(!1===this.config.routerSecundaryViewId&&i&&!o)throw new Error(`You set the config flag "routerSecundaryViewId" to false, but do not provide a custom "viewId" to the route "${t}" and id "${e}". Please define some element with some id to render the template, templateUrl, and pass it as "viewId" paramenter to the router.`);if("string"!=typeof t)throw new TypeError("typeof route must be a string");if(r&&"function"!=typeof r)throw new TypeError("typeof callback must be a function");"/"===t&&(t="");const c={title:l,route:this.config.rootRoute+t,callback:r||null,template:i||null,templateUrl:s||null,avoidCacheTemplate:!0===n,templateIsCached:!s,viewId:o||null,ctrl:a||null,hidden:h||null};if("otherwise"!==e||i)for(const i of Object.keys(this.routes||{}))if(this.routes[i].route===c.route&&("otherwise"!==i||this.routes[i].template))throw"otherwise"===i||"otherwise"===e?new Error(`the route "${t||"/"}" already exists, so "${e}" can't use it if you use a template. You can remove the template or use another route.`):new Error(`the route "${t||"/"}" already exists, so "${e}" can't use it.`);if(this.routes[e])throw new Error(`the id ${t.id} already exists`);this.routes[e]=c}hashChange(e,t){this.oldRoutes=this.cloneRoutes({source:this.currentRoutes}),this.currentRoutes=getEmptyRouteObjetc(),this.init({onHashChange:e,reloading:t})}cloneRoutes({source:e}){const t={params:[],id:e.id,viewId:e.viewId,route:e.route,secundaryRoutes:[],hiddenRoutes:[]};for(const i of e.params)t.params.push({key:i.key,value:i.value});for(const i of e.secundaryRoutes){const e={id:i.id,viewId:i.viewId,route:i.route,params:[]};for(const t of i.params)e.params.push({key:t.key,value:t.value});t.secundaryRoutes.push(e)}for(const i of e.hiddenRoutes){const e={id:i.id,viewId:i.viewId,route:i.route,params:[]};for(const t of i.params)e.params.push({key:t.key,value:t.value});t.hiddenRoutes.push(e)}return t}_reload(){const e=this.currentRoutes.viewId;this.savedOldRoutes=this.cloneRoutes({source:this.oldRoutes}),this.oldRoutes=this.cloneRoutes({source:this.currentRoutes}),this.currentRoutes=getEmptyRouteObjetc(),this.removeMainView({viewId:e,reloading:!0}),this.closeOldSecundaryAndHiddenViews({reloading:!0}),this.hashChange(null,!0),this.oldRoutes=this.cloneRoutes({source:this.savedOldRoutes}),delete this.savedOldRoutes}_refresh(e){let t=this.getOpenedRoutesRefreshData();e&&(t=t.filter(t=>t.viewId===e));for(const e of t)this.raplaceViewContent(e)}raplaceViewContent({view:e,viewId:t,routeId:i,title:s,template:n}){this.$powerUi.powerTree.allPowerObjsById[t]&&this.$powerUi.powerTree.allPowerObjsById[t].$shared.removeInnerElementsFromPower(),this.$powerUi.addSpinnerAndHideView(e),this.$powerUi.waitingInit.push({node:e,viewId:t}),this.$powerUi.buildViewTemplateAndMayCallInit({self:this.$powerUi,view:e,template:n,routeId:i,viewId:t,title:s,refreshing:!0})}getOpenedRoutesRefreshData(){const e=[];e.push({view:document.getElementById(this.currentRoutes.viewId),routeId:this.currentRoutes.id,viewId:this.currentRoutes.viewId,title:this.currentRoutes.title,template:this.routes[this.currentRoutes.id].template});for(const t of this.currentRoutes.secundaryRoutes)e.push({view:document.getElementById(t.viewId),routeId:t.id,viewId:t.viewId,title:t.title,template:this.routes[t.id].template});for(const t of this.currentRoutes.hiddenRoutes)e.push({view:document.getElementById(t.viewId),routeId:t.id,viewId:t.viewId,title:t.title,template:this.routes[t.id].template});return e}locationHashWithHiddenRoutes(){return decodeURI(window.location.hash+(this.hiddenLocationHash||""))}init({secundaryRoute:e,hiddenRoute:t,reloading:i,onHashChange:s}={}){const n=this.extractRouteParts(e||t||this.locationHashWithHiddenRoutes()||this.config.rootRoute);for(const s of Object.keys(this.routes||{}))if("otherwise"!==s||this.routes[s].template){const r=this.getRouteParamKeys(this.routes[s].route);let o=this.buildRegExPatternToRoute(s,r);if(n.path.match(o)){if(this.routes[s]&&this.routes[s].title&&(document.title=this.routes[s].title),!e&&!t){this.oldRoutes.id&&this.oldRoutes.route===n.path.replace(this.config.rootRoute,"")||(this.removeMainView({viewId:this.routes[s].viewId||this.config.routerMainViewId,reloading:i}),this.loadRoute({routeId:s,paramKeys:r,viewId:this.config.routerMainViewId,ctrl:this.routes[s].ctrl,title:this.routes[s].title})),this.setMainRouteState({routeId:s,paramKeys:r,route:n.path,viewId:this.config.routerMainViewId,title:this.routes[s].title});for(const e of n.secundaryRoutes)this.init({secundaryRoute:e,reloading:i});for(const e of n.hiddenRoutes)this.init({hiddenRoute:e,reloading:i});return this.closeOldSecundaryAndHiddenViews({reloading:i}),!0}if(e){const t=e.replace(this.config.rootRoute,""),i=this.oldRoutes.secundaryRoutes.find(e=>e&&e.route===t),n=this.currentRoutes.secundaryRoutes.find(e=>e&&e.route===t);if(i||n)n||this.currentRoutes.secundaryRoutes.push(i);else{const t=this.loadSecundaryOrHiddenRoute({routeId:s,paramKeys:r,routeViewId:this.config.routerSecundaryViewId,ctrl:this.routes[s].ctrl});this.currentRoutes.secundaryRoutes.push(this.setSecundaryOrHiddenRouteState({routeId:s,paramKeys:r,route:e,viewId:t,title:this.routes[s].title}))}}else if(t){const e=t.replace(this.config.rootRoute,""),i=this.oldRoutes.hiddenRoutes.find(t=>t&&t.route===e),n=this.currentRoutes.hiddenRoutes.find(t=>t&&t.route===e);if(i||n)n||this.currentRoutes.hiddenRoutes.push(i);else{const e=this.loadSecundaryOrHiddenRoute({routeId:s,paramKeys:r,routeViewId:this.config.routerSecundaryViewId,ctrl:this.routes[s].ctrl});this.currentRoutes.hiddenRoutes.push(this.setSecundaryOrHiddenRouteState({routeId:s,paramKeys:r,route:t,viewId:e,title:this.routes[s].title}))}}}}if(!e&&!t){const e=this.routes.otherwise?this.routes.otherwise.route:this.config.rootRoute;window.location.replace(encodeURI(e))}}closeOldSecundaryAndHiddenViews({reloading:e}){for(const t of this.oldRoutes.secundaryRoutes)this.currentRoutes.secundaryRoutes.find(e=>e.route===t.route)||this.removeSecundaryOrHiddenView({viewId:t.viewId,routeId:t.id,reloading:e});for(const t of this.oldRoutes.hiddenRoutes)this.currentRoutes.hiddenRoutes.find(e=>e.route===t.route)||this.removeSecundaryOrHiddenView({viewId:t.viewId,routeId:t.id,reloading:e});this.clearRouteSharedScopes(),0===document.body.getElementsByClassName("pw-modal-backdrop").length&&document.body.classList.remove("modal-open")}clearRouteSharedScopes(){for(const e of this.$powerUi.controllers.$routeSharedScope.$waitingToDelete)this.$powerUi.controllers.$routeSharedScope[e]&&0===this.$powerUi.controllers.$routeSharedScope[e]._instances&&delete this.$powerUi.controllers.$routeSharedScope[e];this.$powerUi.controllers.$routeSharedScope.$waitingToDelete=[]}removeSecundaryOrHiddenView({viewId:e,routeId:t,reloading:i}){!i&&this.routes[t]&&this.routes[t].isVolatile&&delete this.routes[t],this.$powerUi.powerTree.allPowerObjsById[e]&&this.$powerUi.powerTree.allPowerObjsById[e].$shared&&this.$powerUi.powerTree.allPowerObjsById[e].$shared.removeElementAndInnersFromPower();const s=document.getElementById(e);s.parentNode.removeChild(s),this.$powerUi.controllers[e]&&(i||this.removeVolatileViews({viewId:e}),delete this.$powerUi.controllers[e],this.$powerUi.controllers.$routeSharedScope[t]&&void 0!==this.$powerUi.controllers.$routeSharedScope[t]._instances&&(this.$powerUi.controllers.$routeSharedScope[t]._instances=this.$powerUi.controllers.$routeSharedScope[t]._instances-1,0===this.$powerUi.controllers.$routeSharedScope[t]._instances&&this.$powerUi.controllers.$routeSharedScope.$waitingToDelete.push(t)))}removeMainView({viewId:e,reloading:t}){this.$powerUi.powerTree&&(t||this.removeVolatileViews({viewId:e}),this.$powerUi.powerTree.allPowerObjsById[e].$shared.removeInnerElementsFromPower())}removeVolatileViews({viewId:e}){if(this.$powerUi.controllers[e]&&this.$powerUi.controllers[e].instance&&this.$powerUi.controllers[e].instance.volatileRouteIds&&this.$powerUi.controllers[e].instance.volatileRouteIds.length)for(const t of this.$powerUi.controllers[e].instance.volatileRouteIds)delete this.routes[t]}loadRoute({routeId:e,paramKeys:t,viewId:i,ctrl:s,title:n}){const r=this.routes[e].viewId||i;if(s){this.$powerUi.controllers[r]={component:s.component,params:s.params};const t=s.params||{};t.$powerUi=this.$powerUi,t.viewId=r,t.routeId=e,t.title=n,this.$powerUi.controllers[r].instance=new s.component(t),this.$powerUi.controllers[r].instance._viewId=r,this.$powerUi.controllers[r].instance._routeId=e}if(this.routes[e].template&&!this.config.noRouterViews){if(this.routes[e].viewId&&!document.getElementById(this.routes[e].viewId))throw new Error(`You defined a custom viewId "${this.routes[e].viewId}" to the route "${this.routes[e].route}" but there is no element on DOM with that id.`);this.routes[e].templateUrl&&!0!==this.routes[e].templateIsCached?this.$powerUi.loadTemplateUrl({template:this.routes[e].template,viewId:r,currentRoutes:this.currentRoutes,routeId:e,routes:this.routes,title:n}):this.$powerUi.loadTemplate({template:this.routes[e].template,viewId:this.routes[e].viewId||i,currentRoutes:this.currentRoutes,routeId:e,routes:this.routes,title:n})}if(this.routes[e].callback)return this.routes[e].callback.call(this,this.routes[e])}loadSecundaryOrHiddenRoute({routeId:e,paramKeys:t,routeViewId:i,ctrl:s,title:n}){s&&(s.params||(s.params={}),this.$powerUi.controllers.$routeSharedScope[e]||(this.$powerUi.controllers.$routeSharedScope[e]={},this.$powerUi.controllers.$routeSharedScope[e]._instances=0),this.$powerUi.controllers.$routeSharedScope[e]._instances=this.$powerUi.controllers.$routeSharedScope[e]._instances+1,s.params.$shared=this.$powerUi.controllers.$routeSharedScope[e]);const r=document.createElement("div"),o=getIdAndCreateIfDontHave(r);return r.id=o,r.classList.add("power-view"),document.getElementById(i).appendChild(r),this.loadRoute({title:n,routeId:e,paramKeys:t,viewId:o,ctrl:this.routes[e].ctrl,title:this.routes[e].title}),o}routeKind(e){return this.routes[e].hidden?"hr":"sr"}openRoute({routeId:e,params:t,target:i,currentRouteId:s,currentViewId:n,title:r}){const o=this.routeKind(e),a=this.getRouteParamKeysWithoutDots(this.routes[e].route);if(a)for(const i of a)if(!t||!t[i])throw`The parameter "${i}" of route "${e}" is missing!`;if(!this.routeExists({routeId:e,params:t}))if("_self"===i){const i=this.getOpenedRoute({routeId:s,viewId:n}),l=this.getOpenedSecundaryOrHiddenRoutesHash({filter:[i.route]})+`?${o}=${this.buildHash({routeId:e,params:t,paramKeys:a})}`;this.navigate({hash:l,title:r})}else if("_blank"===i){const i=this.getOpenedSecundaryOrHiddenRoutesHash({})+`?${o}=${this.buildHash({routeId:e,params:t,paramKeys:a})}`;this.navigate({hash:i,title:r})}else this.navigate({hash:this.buildHash({routeId:e,params:t,paramKeys:a}),title:r})}getOpenedSecundaryOrHiddenRoutesHash({filter:e=[]}){const t=this.extractRouteParts(this.locationHashWithHiddenRoutes());let i=t.path.replace(this.config.rootRoute,"");for(let s of t.secundaryRoutes.concat(t.hiddenRoutes)){const n=t.hiddenRoutes.includes(s)?"hr":"sr";s=s.replace(this.config.rootRoute,""),0!==e.lenght&&e.includes(s)||(i+=`?${n}=${s}`)}return i}navigate({hash:e,title:t}){const i=this.extractRouteParts(e);let s=i.path||"",n="";for(const e of i.secundaryRoutes)s=`${s}?sr=${e.replace(this.config.rootRoute,"")}`;for(const e of i.hiddenRoutes)n=`${n}?hr=${e.replace(this.config.rootRoute,"")}`;this.hiddenLocationHash=encodeURI(n),window.location.hash!==encodeURI(this.config.rootRoute+s)?(window.history.pushState(null,t,window.location.href),window.location.replace(encodeURI(this.config.rootRoute)+encodeURI(s))):this.hashChange()}buildHash({routeId:e,params:t,paramKeys:i}){let s=this.routes[e].route.slice(3,this.routes[e].length);if(t&&i.length)for(const e of i)s=s.replace(`:${e}`,t[e]);return s}routeExists({routeId:e,params:t}){let i=!1;if(e===this.currentRoutes.id){if(!t)return!0;let e=!1;for(const s of Object.keys(t||{})){for(const i of this.currentRoutes.params)s===i.key&&t[s]===i.value&&(e=!0);i=e,e=!1}if(i)return!0}for(const s of this.currentRoutes.secundaryRoutes.concat(this.currentRoutes.hiddenRoutes))if(e===s.id){let e=!1;for(const n of Object.keys(t||{})){for(const i of s.params)n===i.key&&t[n]===i.value&&(e=!0);i=e,e=!1}}return i}setMainRouteState({routeId:e,paramKeys:t,route:i,viewId:s,title:n}){this.currentRoutes.id=e,this.currentRoutes.route=i.replace(this.config.rootRoute,""),this.currentRoutes.viewId=this.routes[e].viewId||s,this.currentRoutes.isMainView=!0,this.currentRoutes.title=n,this.currentRoutes.params=t?this.getRouteParamValues({routeId:e,paramKeys:t}):[]}setSecundaryOrHiddenRouteState({routeId:e,paramKeys:t,route:i,viewId:s,title:n}){const r={title:n,isMainView:!1,params:[],id:"",route:i.replace(this.config.rootRoute,""),viewId:this.routes[e].viewId||s};return r.id=e,t&&(r.params=this.getRouteParamValues({routeId:e,paramKeys:t,route:i})),r}extractRouteParts(e){const t={path:e,secundaryRoutes:[],hiddenRoutes:[]};if(e.includes("?")){const i=e.split("?");t.path=i[0];for(const e of i)if(e.includes("sr="))for(const i of e.split("sr="))i&&t.secundaryRoutes.push(this.config.rootRoute+i);else if(e.includes("hr="))for(const i of e.split("hr="))i&&t.hiddenRoutes.push(this.config.rootRoute+i)}return t}buildRegExPatternToRoute(e,t){let i=new RegExp(`^${this.routes[e].route}$`);if(t){let e=i.toString();e=e.substring(1),e=e.slice(0,-1);for(const i of t)e=e.replace(i,"[^]*");i=new RegExp(e)}return i}getRoute({routeId:e}){return this.routes[e]}getOpenedRoute({routeId:e,viewId:t}){if(this.currentRoutes.id===e&&this.currentRoutes.viewId)return this.currentRoutes;for(const i of this.currentRoutes.secundaryRoutes.concat(this.currentRoutes.hiddenRoutes))if(i.id===e&&i.viewId===t)return i}getRouteParamKeys(e){const t=new RegExp(/:[^\s/]+/g);return e.match(t)}getRouteParamKeysWithoutDots(e){const t=[];for(const i of this.getRouteParamKeys(e)||[])t.push(i.substring(1));return t}getRouteParamValues({routeId:e,paramKeys:t,route:i}){const s=this.routes[e].route.split("/"),n=(i||this.locationHashWithHiddenRoutes()||this.config.rootRoute).split("/"),r=[];for(const e of t)r.push({key:e.substring(1),value:n[s.indexOf(e)]});return r}getParamValue(e){const t=this.currentRoutes.params.find(t=>t.key===e);return t?t.value:null}}class PowerInterpolation{constructor(e={},t){this.config=e,this.$powerUi=t,this.startSymbol=e.interpolateStartSymbol||"{{",this.endSymbol=e.interpolateEndSymbol||"}}"}compile({template:e,scope:t,view:i}){return!t&&i&&(t=!!(i&&i.id&&this.$powerUi.controllers[i.id])&&this.$powerUi.controllers[i.id].instance),this.replaceInterpolation(e,t)}getDatasetResult(e,t){return this.compile({template:`${this.startSymbol} ${this.decodeHtml(e)} ${this.endSymbol}`,scope:t})}standardRegex(){const e=`${this.startSymbol}[^]*?${this.endSymbol}`;return new RegExp(e,"gm")}replaceInterpolation(e,t){const i=(e=this.stripWhiteChars(e)).replace(/<!--[\s\S]*?-->/gm,"").match(this.standardRegex());if(i)for(const s of i){const i=this.getInterpolationValue(s,t);e=e.replace(s,i)}return e.trim()}stripWhiteChars(e){let t=e.replace(/ +(?= )/g,"");return t=t.replace(/[\t\n\r]/g,""),t}stripInterpolation(e){let t=e.replace(this.startSymbol,"");return t=t.replace(this.endSymbol,""),t}replaceWith({entry:e,oldValue:t,newValue:i}){const s=new RegExp(t,"gm"),n=e.match(this.standardRegex());if(n)for(const t of n){let n=t.replace(s,i);e=e.replace(t,n)}return e=this.replaceIdsAndRemoveInterpolationSymbol({entry:e,regexOldValue:s,newValue:i})}replaceIdsAndRemoveInterpolationSymbol({entry:e,regexOldValue:t,newValue:i}){const s=document.createElement("div");s.innerHTML=e;for(const e of s.children){for(const s of e.attributes)(s.name.includes("data-pow")||s.name.includes("data-pwc"))&&(s.value=s.value.replace(t,i));e.id&&(e.id=this.replaceInterpolation(e.id,this.$powerUi)),e.children.length&&(e.innerHTML=this.replaceIdsAndRemoveInterpolationSymbol({entry:e.innerHTML,regexOldValue:t,newValue:i}))}return s.innerHTML}getInterpolationValue(e,t){let i=this.stripWhiteChars(e);return i=this.stripInterpolation(i),this.encodeHtml(this.safeEvaluate(i,t))}safeEvaluate(e,t){let i;try{i=this.$powerUi.safeEval({text:e,scope:t,$powerUi:this.$powerUi})}catch(e){i=""}return void 0===i?"":i}safeString(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}encodeHtml(e){const t=document.createElement("div");return t.innerText=t.textContent=e,e=t.innerHTML}decodeHtml(e){const t=document.createElement("textarea");return t.innerHTML=e,t.value}}class PowerView extends _PowerBasicElementWithEvents{constructor(e){super(e),this.isView=!0}}PowerUi.injectPowerCss({name:"power-view",isMain:!0});class SyntaxTree{constructor({counter:e}){this.currentPriority=0,this.nodes=[],this.tokensListener=new TokensListener({counter:e,syntaxTree:this}),this.validAfter={variable:this.variableValidation,string:this.stringValidation,parentheses:this.parenthesesValidation,dot:this.dotValidation,integer:this.numberValidation,float:this.numberValidation,operator:this.operationValidation,equal:this.equalityValidation,"NOT-equal":this.equalityValidation,"greater-than":this.equalityValidation,"minor-than":this.equalityValidation,"minor-or-equal":this.equalityValidation,"greater-or-equal":this.equalityValidation,object:this.objectValidation,function:this.objectValidation,anonymousFunc:this.objectValidation,dictNode:this.objectValidation,comma:this.commaValidation,AND:this.orAndNotValidation,OR:this.orAndNotValidation,NOT:this.orAndNotValidation,"NOT-NOT":this.orAndNotValidation,"short-hand":this.shortHandValidation,dictDefinition:()=>!0,arrayDefinition:()=>!0}}buildTreeLeaf(e){this.tree=this.checkAndPrioritizeSyntax({nodes:this.nodes,isParameter:e})}shortHandValidation({currentNode:e,isParameter:t}){return!(e.condition[0]&&e.condition[0].expression_nodes&&!e.condition[0].expression_nodes.length)&&(!(e.if[0]&&e.if[0].expression_nodes&&!e.if[0].expression_nodes.length)&&!(e.else[0]&&e.else[0].expression_nodes&&!e.else[0].expression_nodes.length))}firstNodeValidation({node:e,isParameter:t}){return!["dot","anonymousFunc","AND","OR","NOT-equal","minor-or-equal","greater-or-equal","equal","minor-than","greater-than"].includes(e.syntax)&&("operator"!==e.syntax||"+"===e.label||"-"===e.label)}orAndNotValidation({nextNode:e,isParameter:t}){return!!["string","variable","integer","object","float","dictNode","parentheses","NOT","NOT-NOT","function"].includes(e.syntax)||"operator"===e.syntax&&("+"===e.label||"-"===e.label)}commaValidation({nextNode:e,isParameter:t}){return!!["string","variable","integer","object","float","dictNode","parentheses","arrayDefinition","dictDefinition","NOT","NOT-NOT","comma","function","end"].includes(e.syntax)||"operator"===e.syntax&&("+"===e.label||"-"===e.label)}objectValidation({nextNode:e,isParameter:t}){return!!(["operator","anonymousFunc","short-hand","NOT-equal","equal","minor-than","greater-than","minor-or-equal","greater-or-equal","dot","AND","OR","dictNode","end"].includes(e.syntax)||"comma"===e.syntax&&t)}equalityValidation({nextNode:e,currentNode:t,isParameter:i}){return!!["variable","parentheses","function","arrayDefinition","dictDefinition","float","integer","dictNode","object","NOT","NOT-NOT","string"].includes(e.syntax)||("string"===e.syntax&&"+"===t.label||"operator"===e.syntax&&("+"===e.label||"-"===e.label))}operationValidation({nextNode:e,currentNode:t,isParameter:i}){return!!["NOT","NOT-NOT","float","object","integer","variable","dictNode","arrayDefinition","dictDefinition","parentheses","function"].includes(e.syntax)||("string"===e.syntax&&"+"===t.label||"operator"===e.syntax&&("+"===e.label||"-"===e.label))}variableValidation({nextNode:e,isParameter:t}){return!!(["dot","operator","NOT-equal","equal","minor-than","greater-than","minor-or-equal","greater-or-equal","AND","OR","short-hand","end"].includes(e.syntax)||"comma"===e.syntax&&t)}numberValidation({nextNode:e,isParameter:t}){return!!(["operator","NOT-equal","equal","minor-than","greater-than","AND","minor-or-equal","greater-or-equal","OR","short-hand","end"].includes(e.syntax)||"comma"===e.syntax&&t)}stringValidation({nextNode:e,isParameter:t}){return!["NOT","NOT-NOT","string","variable","dictNode","function","parentheses","arrayDefinition","dictDefinition","integer","float","especial","anonymousFunc","dot","dictNode"].includes(e.syntax)&&(e.syntax,!0)}parenthesesValidation({nextNode:e,isParameter:t}){return!!(["anonymousFunc","dot","operator","short-hand","NOT-equal","equal","minor-or-equal","greater-or-equal","minor-than","greater-than","AND","OR","short-hand","end"].includes(e.syntax)||"comma"===e.syntax&&t)}dotValidation({nextNode:e,isParameter:t}){return!!["function","variable","dictNode"].includes(e.syntax)}isNextValidAfterCurrent({currentNode:e,nextNode:t,isParameter:i}){return!!this.validAfter[e.syntax]&&this.validAfter[e.syntax]({currentNode:e,nextNode:t,isParameter:i})}checkAndPrioritizeSyntax({nodes:e,isParameter:t}){let i=[],s=[],n=[],r=!1;if((e=this.filterNodesAndUnifyObjects(e)).push({syntax:"end"}),!e.length)return[];let o=0;const a=e.length-1;let l=!0;if(l=this.firstNodeValidation({node:this.getCurrentNode({index:0,nodes:e})}),!1===l)throw`PowerUI template invalid syntax: "${e[0].label}" starting the expression.`;for(;o<=a&&l;){const a=this.getCurrentNode({index:o,nodes:e});if(l=this.isNextValidAfterCurrent({currentNode:a,nextNode:this.getNextNode({index:o,nodes:e}),isParameter:t}),!1===l&&"end"!==a.syntax)throw`PowerUI template invalid syntax: "${a.label}".`;const h=this.createExpressionGroups({index:o,currentNode:a,previousNode:this.getPreviousNode({index:o,nodes:e}),nextNode:this.getNextNode({index:o,nodes:e}),current_expression_nodes:i,priority_nodes:s,expression_groups:n,doubleOperator:r});s=h.priority_nodes,i=h.current_expression_nodes,n=h.expression_groups,r=h.doubleOperator,o+=1}return n=this.prioritizeExpressionGroups({priority:"equality",expression_groups:n}),n=this.prioritizeExpressionGroups({priority:"AND",expression_groups:n}),n.pop(),n}createExpressionGroups({index:e,currentNode:t,previousNode:i,nextNode:s,current_expression_nodes:n,priority_nodes:r,expression_groups:o,doubleOperator:a}){if("operator"===t.syntax&&0===e?(r.push(t),a=!0):"operator"===t.syntax&&"operator"===i.syntax?(r.push(t),a=!0):["integer","float","string","variable","parentheses","object","short-hand","dictDefinition","arrayDefinition"].includes(t.syntax)?"operator"===s.syntax&&"+"!==s.label&&"-"!==s.label||"operator"===i.syntax&&"+"!==i.label&&"-"!==i.label?r.push(t):a?(r.push(t),a=!1):n.push(t):"operator"===t.syntax&&("+"!==t.label&&"-"!==t.label?r.push(t):(r.length&&(n.push({priority:r}),r=[]),n.push(t))),["NOT-equal","equal","greater-than","minor-than","minor-or-equal","greater-or-equal","OR","AND","end"].includes(t.syntax)){const e=["OR","AND"].includes(t.syntax)?t.syntax:"equality";r.length&&(n.push({priority:r}),r=[]);const i={kind:"expression",expression_nodes:n};o.push(i),n=[],t.kind="end"===t.syntax?"end":e,o.push(t)}return{priority_nodes:r,current_expression_nodes:n,expression_groups:o,doubleOperator:a}}prioritizeExpressionGroups({priority:e,expression_groups:t}){let i=[],s=[],n=!1;for(const r of t)"end"===r.syntax&&s.length?(i.length?i.push({priority:s}):i=s,i.push(r),s=[]):r.kind===e?(n=!0,s.push(r)):!r.priority&&"expression"!==r.kind&&n&&s.length?(i.push({priority:s}),i.push(r),s=[],n=!1):"OR"===r.syntax||"AND"===r.syntax?(i.push({priority:s}),i.push(r),s=[]):s.push(r);return i}getCurrentNode({index:e,nodes:t}){return t[e]}getPreviousNode({index:e,nodes:t}){return t[e-1]||{syntax:"end"}}getNextNode({index:e,nodes:t}){return t[e+1]||{syntax:"end"}}filterNodesAndUnifyObjects(e){const t=[];let i=this.newObject(),s=e.length-1,n=!1;for(;e[s];){if("empty"!==e[s].syntax)if(["function","dictNode","anonymousFunc"].includes(e[s].syntax)){i.parameters.unshift(e[s]);let t=e[s].label;"function"===e[s].syntax&&(t+="()"),i.label=t+i.label,n=!0}else n&&(t.unshift(i),n=!1,i=this.newObject()),t.unshift(e[s]);else n&&(t.unshift(i),n=!1,i=this.newObject());s-=1}return n&&(t.unshift(i),n=!1,i=this.newObject()),t}newObject(){return{syntax:"object",label:"",parameters:[]}}}class PowerLexer{constructor({text:e,tokensTable:t,counter:i,isParameter:s}){this.isParameter=s,this.originalText=String(e),this.syntaxTree=new SyntaxTree({counter:i}),this.tokens=[]}scan(){for(const e of this.originalText){const t=this.convertToToken(e);this.tokens.push(t)}this.tokens.push({name:"end",value:null})}convertToToken(e){for(const t of this.tokensTable)if(t.values.includes(e))return{name:t.name,value:e};return{name:"undefined",value:e}}}class PowerTemplateParser extends PowerLexer{constructor({text:e,tokensTable:t,counter:i,isParameter:s}){super({text:e,tokensTable:t,counter:i||0,isParameter:s}),this.counter=i||0,this.tokensTable=t||[{name:"blank",values:[" ","\t","\n"]},{name:"escape",values:["\\"]},{name:"especial",values:["_","$"]},{name:"quote",values:['"',"`","'"]},{name:"braces",values:["{","}"]},{name:"separator",values:["(",")","[","]"]},{name:"operator",values:["+","-","*","/","%"]},{name:"equal",values:["="]},{name:"minor-than",values:["<"]},{name:"greater-than",values:[">"]},{name:"NOT",values:["!"]},{name:"AND",values:["&"]},{name:"OR",values:["|"]},{name:"comma",values:","},{name:"dot",values:["."]},{name:"short-hand",values:["?",":"]},{name:"number",values:["0","1","2","3","4","5","6","7","8","9"]},{name:"letter",values:["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"]},{name:"end",values:[null]}],this.buildSyntaxTree()}buildSyntaxTree(){this.scan(),this.syntaxTree.buildTreeLeaf(this.isParameter||!1)}scan(){let e=this.counter;for(const t of this.originalText){const i=this.convertToToken(t);this.tokens.push(i),this.syntaxTree.tokensListener.read({token:i,counter:e}),e+=1}const t=this.convertToToken(null);this.tokens.push(t),this.syntaxTree.tokensListener.read({token:t,counter:e})}}class TokensListener{constructor({counter:e,syntaxTree:t}){this.syntaxTree=t,this.currentTokens=[],this.currentLabel="",this.start=e,this.patterns=[{name:"empty",obj:EmptyPattern},{name:"string",obj:StringPattern},{name:"arrayDefinition",obj:ArrayDefinitionPattern},{name:"variable",obj:VariablePattern},{name:"number",obj:NumberPattern},{name:"operator",obj:OperationPattern},{name:"equal",obj:EqualPattern},{name:"minor-than",obj:MinorThanPattern},{name:"greater-than",obj:GreaterThanPattern},{name:"NOT",obj:NotPattern},{name:"AND",obj:AndPattern},{name:"OR",obj:OrPattern},{name:"comma",obj:CommaPattern},{name:"dot",obj:DictPattern},{name:"braces",obj:BracesPattern},{name:"separator",obj:DictPattern},{name:"short-hand",obj:ShortHandPattern},{name:"parentheses",obj:parenthesesPattern}],this.candidates=[],this.checking="firstToken",this.resetCandidates()}read({token:e,counter:t}){for(const i of this.candidates)if(i.instance[this.checking]({token:e,counter:t})){this.currentTokens.push(e),this.currentLabel=this.currentLabel+(e.value||(null===e.value?"":e.value));break}}nextPattern({token:e,counter:t,syntax:i,parameters:s}){this.syntaxTree.nodes.push({syntax:i,label:this.currentLabel,tokens:this.currentTokens,start:this.start,end:t,parameters:s||[]}),this.start=t,this.currentTokens=[],this.currentLabel="",this.checking="firstToken",this.resetCandidates(),this.read({token:e,counter:t})}resetCandidates(){this.candidates=[];for(const e of this.patterns)this.candidates.push({name:e.name,instance:new e.obj(this)})}}class ParserEval{constructor({text:e,nodes:t,scope:i,$powerUi:s}){this.$powerUi=s,this.$scope=i||{},this.nodes=t||new PowerTemplateParser({text:e}).syntaxTree.tree,this.currentValue="",this.operator="",this.doubleOperator="",this.lastNode="",this.currentNode="",this.nextNode="",this.equality="$_not_Setted_$",this.leftExpressionValueToCompare="$_not_Setted_$",this.rightExpressionValueToCompare="$_not_Setted_$",this.evalNodes()}evalNodes(){let e=0;for(let t of this.nodes){if(t.expression_nodes)for(const i of t.expression_nodes)this.currentNode=i,this.nextNode=t.expression_nodes[e+1],"short-hand"===i.syntax?this.evalShortHandExpression(i):"dictDefinition"===i.syntax?this.evalDictDefinition(i):"variable"===i.syntax&&["true","false","null","undefined"].includes(i.label)?this.evalSpecialValues(i.label):this.eval(i),this.lastNode=i;else"equality"===t.kind||["===","!==","==","!=",">=","<=",">","<"].includes(t.label)?(this.leftExpressionValueToCompare=this.currentValue,this.currentValue="",this.equality=t):["OR","AND"].includes(t.syntax)?(this.leftExpressionValueToCompare=this.currentValue,this.currentValue="",this.orAndExpression=t):this.nodes[e+1]&&"OR"===this.nodes[e+1].syntax&&t.priority&&t.priority[0]&&t.priority[0].priority?t.priority.length>1?this.currentValue=this.recursiveEval(t.priority):this.currentValue=this.recursiveEval(t.priority[0].priority):this.nodes[e-1]&&"OR"===this.nodes[e-1].syntax&&t.priority&&t.priority[0]&&t.priority[0].priority?t.priority.length>1?this.currentValue=this.recursiveEval(t.priority):this.currentValue=this.recursiveEval(t.priority[0].priority):this.nodes[e+1]&&"AND"===this.nodes[e+1].syntax&&t.priority?this.currentValue=this.recursiveEval(t.priority):this.nodes[e-1]&&"AND"===this.nodes[e-1].syntax&&t.priority?this.currentValue=this.recursiveEval(t.priority):console.log("NO EXPRESSION_NODES!!",this.currentValue,t,this.nodes);this.equality&&""!==this.currentValue&&"$_not_Setted_$"!==this.leftExpressionValueToCompare?this.evalEquality():this.orAndExpression&&"OR"===this.orAndExpression.syntax&&""!==this.currentValue&&"$_not_Setted_$"!==this.leftExpressionValueToCompare?this.evalOrExpression():this.orAndExpression&&"AND"===this.orAndExpression.syntax&&""!==this.currentValue&&"$_not_Setted_$"!==this.leftExpressionValueToCompare&&this.evalAndExpression(),e+=1}}evalDictDefinition(e){this.currentValue={};for(const t of e.parameters)this.currentValue[this.recursiveEval(t.key)]=this.recursiveEval(t.value)}evalArrayDefinition(e){this.currentValue=[];for(const t of e.parameters)this.currentValue.push(this.recursiveEval(t))}evalSpecialValues(e){"true"===e?this.currentValue=!0:"false"===e?this.currentValue=!1:"null"===e?this.currentValue=null:"undefined"===e&&(this.currentValue=void 0)}evalShortHandExpression(e){const t=this.recursiveEval(e.condition),i=this.recursiveEval(e.if),s=this.recursiveEval(e.else);this.currentValue=t?i:s}evalOrExpression(){this.currentValue=this.leftExpressionValueToCompare||this.currentValue,this.leftExpressionValueToCompare="$_not_Setted_$"}evalAndExpression(){this.currentValue=this.leftExpressionValueToCompare&&this.currentValue,this.leftExpressionValueToCompare="$_not_Setted_$"}evalEquality(){"==="===this.equality.label?this.currentValue=this.leftExpressionValueToCompare===this.currentValue:"=="===this.equality.label?this.currentValue=this.leftExpressionValueToCompare==this.currentValue:"!=="===this.equality.label?this.currentValue=this.leftExpressionValueToCompare!==this.currentValue:"!="===this.equality.label?this.currentValue=this.leftExpressionValueToCompare!=this.currentValue:"<="===this.equality.label?this.currentValue=this.leftExpressionValueToCompare<=this.currentValue:">="===this.equality.label?this.currentValue=this.leftExpressionValueToCompare>=this.currentValue:">"===this.equality.label?this.currentValue=this.leftExpressionValueToCompare>this.currentValue:"<"===this.equality.label&&(this.currentValue=this.leftExpressionValueToCompare<this.currentValue),this.leftExpressionValueToCompare="$_not_Setted_$"}eval(e){let t="";if("float"===e.syntax)t=parseFloat(e.label),""===this.currentValue?this.currentValue=this.adjustForNegative(t):this.currentValue=this.mathOrConcatValues(t);else if("integer"===e.syntax)t=parseInt(e.label),""===this.currentValue?this.currentValue=this.adjustForNegative(t):this.currentValue=this.mathOrConcatValues(t);else if("operator"===e.syntax)this.operator?"-"===this.operator&&"-"===e.label?this.operator="+":"-"===this.operator&&"+"===e.label?this.operator="-":"+"===this.operator&&"-"===e.label?this.operator="-":"+"===this.operator&&"+"===e.label?this.operator="+":"-"===this.doubleOperator&&"-"===e.label?this.doubleOperator="+":"-"===this.doubleOperator&&"+"===e.label?this.doubleOperator="-":"+"===this.doubleOperator&&"-"===e.label?this.doubleOperator="-":"+"===this.doubleOperator&&"+"===e.label?this.doubleOperator="+":this.doubleOperator=e.label:this.operator=e.label;else if(e.priority||"parentheses"===e.syntax){const i=e.priority?[{expression_nodes:e.priority}]:e.parameters;t=this.recursiveEval(i),this.currentValue=this.mathOrConcatValues(t)}else"variable"===e.syntax?(t=this.getOnScope(e.label),""===this.currentValue?this.currentValue=this.adjustForNegative(t):this.currentValue=this.mathOrConcatValues(t)):"string"===e.syntax?(t=this.removeQuotes(e.label),""===this.currentValue?this.currentValue=this.adjustForNegative(t):this.currentValue=this.mathOrConcatValues(t)):"arrayDefinition"===e.syntax?this.evalArrayDefinition(e):"object"===e.syntax?(t=this.evalObject(e),this.currentValue=this.mathOrConcatValues(t)):console.log("NOT NUMBER OR OPERATOR OR PRIORITY OR SHORT-HAND",e);return t}removeQuotes(e){let t="";for(const i of e)['"',"`","'"].includes(i)||(t+=i);return t}evalObject(e){let t="",i="",s="",n=0;for(const r of e.parameters){let e="";if("function"===r.syntax?e=r.label:"dictNode"===r.syntax?e=this.recursiveEval(r.parameters):"anonymousFunc"!==r.syntax&&console.log("NOT FUNCTION or DICTNODE!",r),0===n)t=this.getObjScope(e),n=1;else if(""===t)return;if("anonymousFunc"!==r.syntax)if(""===i&&t)i=t[e];else{if(!i)return i;i=i[e]}if("function"===r.syntax||"anonymousFunc"===r.syntax){const e=[];for(const t of r.parameters[0].expression_nodes)e.push(this.recursiveEval([{expression_nodes:[t]}]));s=i.apply(t||null,e),i=s}}return""!==i&&(s=i,i=""),s}recursiveEval(e){return new ParserEval({nodes:e,scope:this.$scope,$powerUi:this.$powerUi}).currentValue}adjustForNegative(e){return"-"===this.operator&&(e=-e),this.operator="",e}mathOrConcatValues(e){return this.operator&&!1===isNaN(e)&&(Number.isInteger(e)?e=parseInt(e):!1===isNaN(parseFloat(e))&&(e=parseFloat(e))),"-"===this.doubleOperator&&(e=-e,this.doubleOperator=""),"+"===this.operator?e=this.currentValue+e:"-"===this.operator?e=this.currentValue-e:"/"===this.operator?e=this.currentValue/e:"*"===this.operator&&(e=this.currentValue*e),this.operator="",e}getOnScope(e){return void 0!==this.$scope[e]?this.$scope[e]:void 0!==this.$powerUi[e]?this.$powerUi[e]:void 0}getObjScope(e){return void 0!==this.$scope[e]?this.$scope:void 0!==this.$powerUi[e]?this.$powerUi:void 0}}class StringPattern{constructor(e){this.listener=e,this.openQuote=null,this.escape=!1,this.invalid=!1}firstToken({token:e,counter:t}){return!!["quote"].includes(e.name)&&(this.openQuote=e.value,this.listener.candidates=this.listener.candidates.filter(e=>"string"===e.name),this.listener.checking="middleTokens",!0)}middleTokens({token:e,counter:t}){return e.value!==this.openQuote&&"end"!==e.name?("escape"===e.name&&(this.escape=!0),!0):e.value===this.openQuote&&("escape"===e.name?this.escape=!1:(this.openQuote=null,this.listener.checking="endToken"),!0)}endToken({token:e,counter:t}){return!1===this.invalid&&["blank","end","operator","equal","NOT-equal","greater-than","minor-than","greater-or-equal","minor-or-equal","NOT","NOT-NOT","AND","OR","short-hand","comma"].includes(e.name)?(this.listener.nextPattern({syntax:"string",token:e,counter:t}),!1):!0===this.invalid&&["blank","end","operator","equal","NOT-equal","greater-than","minor-than","greater-or-equal","minor-or-equal","NOT","NOT-NOT","AND","OR","short-hand","comma"].includes(e.name)?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,!0)}}class VariablePattern{constructor(e){this.listener=e}firstToken({token:e,counter:t}){return!!["letter","especial"].includes(e.name)&&(this.listener.candidates=this.listener.candidates.filter(e=>"variable"===e.name),this.listener.checking="middleTokens",!0)}middleTokens({token:e,counter:t}){return!!["letter","especial","number"].includes(e.name)||(["blank","end","operator","equal","NOT-equal","greater-than","minor-than","greater-or-equal","minor-or-equal","NOT","NOT-NOT","AND","OR","short-hand","comma"].includes(e.name)?(this.listener.nextPattern({syntax:"variable",token:e,counter:t}),!1):"("===e.value||"["===e.value||"dot"===e.name?(this.listener.checking="firstToken",this.listener.firstNodeLabel=this.listener.currentLabel,this.listener.candidates=[{name:"object",instance:new ObjectPattern(this.listener)}],!0):(this.listener.checking="endToken",!0))}endToken({token:e,counter:t}){return!["blank","end"].includes(e.name)||(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1)}}class BracesPattern{constructor(e){this.listener=e,this.innerObjects=0,this.currentParams="",this.dictDefinition=[],this.currentKey="",this.currentValue=""}firstToken({token:e,counter:t}){return"{"===e.value&&(this.listener.candidates=this.listener.candidates.filter(e=>"braces"===e.name),this.listener.checking="middleTokens",!0)}middleTokens({token:e,counter:t}){if(0!==this.innerObjects||"}"!==e.value)return["blank","escape","especial","quote","equal","minor-than","greater-than","NOT","NOT-NOT","AND","OR","comma","number","letter","operator","dot","separator","undefined","short-hand","braces"].includes(e.name)?(["{","(","["].includes(e.value)?this.innerObjects=this.innerObjects+1:["}",")","]"].includes(e.value)&&(this.innerObjects=this.innerObjects-1),0===this.innerObjects&&(":"===e.value?(this.currentKey=this.currentParams.trim(),this.currentParams="",this.containsQuotes(this.currentKey)||(this.currentKey=`"${this.currentKey}"`),this.currentKey=new PowerTemplateParser({text:this.currentKey,counter:t-this.currentKey.length,isParameter:!0}).syntaxTree.tree):","===e.value&&this.setDictDefinition(t)),(":"!==e.value&&","!==e.value||0!==this.innerObjects)&&(this.currentParams=this.currentParams+e.value),!0):(this.listener.checking="endToken",!0);this.setDictDefinition(t),this.listener.checking="endToken"}endToken({token:e,counter:t}){return!["blank","end"].includes(e.name)||(this.listener.nextPattern({syntax:"dictDefinition",token:e,counter:t,parameters:this.dictDefinition}),!1)}containsQuotes(e){return e.indexOf("'")>=0||e.indexOf('"')>=0||e.indexOf("`")>=0}setDictDefinition(e){""!==this.currentParams&&(this.currentValue=this.currentParams,this.currentParams="",this.currentValue=new PowerTemplateParser({text:this.currentValue,counter:e-this.currentValue.length,isParameter:!0}).syntaxTree.tree,this.dictDefinition.push({kind:"keyValue",key:this.currentKey,value:this.currentValue}))}}class NumberPattern{constructor(e){this.listener=e,this.float=!1}firstToken({token:e,counter:t}){return"number"===e.name&&(this.listener.candidates=this.listener.candidates.filter(e=>"number"===e.name),this.listener.checking="middleTokens",!0)}middleTokens({token:e,counter:t}){return!1===this.float&&"number"===e.name||(!1===this.float&&["blank","end","operator","equal","NOT-equal","greater-than","minor-than","greater-or-equal","minor-or-equal","NOT-NOT","NOT","AND","OR","short-hand","comma"].includes(e.name)?(this.listener.nextPattern({syntax:"integer",token:e,counter:t}),!1):!1===this.float&&"."===e.value?(this.float=!0,!0):!0===this.float&&"number"===e.name||(!0===this.float&&["blank","end","operator","equal","NOT-equal","greater-than","minor-than","greater-or-equal","minor-or-equal","NOT-NOT","NOT","AND","OR","short-hand","comma"].includes(e.name)?(this.listener.nextPattern({syntax:"float",token:e,counter:t}),!1):(this.listener.checking="endToken",!0)))}endToken({token:e,counter:t}){return!["blank","end"].includes(e.name)||(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1)}}class OperationPattern{constructor(e){this.listener=e}firstToken({token:e,counter:t}){return"operator"===e.name&&(this.listener.candidates=this.listener.candidates.filter(e=>"operator"===e.name),this.openOperator=e.value,this.listener.checking="middleTokens",!0)}middleTokens({token:e,counter:t}){return["blank","end","letter","especial","number","quote","operator"].includes(e.name)||"("===e.value?(this.listener.nextPattern({syntax:"operator",token:e,counter:t}),!1):(this.listener.checking="endToken",!0)}endToken({token:e,counter:t}){return!["blank","end"].includes(e.name)||(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1)}}class EqualPattern{constructor(e){this.listener=e,this.one=null,this.two=null,this.three=null,this.invalid=!1}firstToken({token:e,counter:t}){return"equal"===e.name&&(this.listener.candidates=this.listener.candidates.filter(e=>"equal"===e.name),this.listener.checking="middleTokens",this.one=e.value,!0)}middleTokens({token:e,counter:t}){return null===this.two?"equal"===e.name?(this.two=e.value,!0):(this.invalid=!0,this.listener.checking="endToken",!0):"equal"===e.name?(this.three=e.value,this.listener.checking="endToken",!0):["blank","end","letter","especial","number","NOT","NOT-NOT","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"equal",token:e,counter:t}),!1):(this.invalid=!0,this.listener.checking="endToken",!0)}endToken({token:e,counter:t}){return!1===this.invalid&&["blank","end","letter","number","especial","NOT","NOT-NOT","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"equal",token:e,counter:t}),!1):!0!==this.invalid||!["blank","end"].includes(e.name)||(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1)}}class MinorThanPattern{constructor(e){this.listener=e,this.invalid=!1}firstToken({token:e,counter:t}){return"minor-than"===e.name&&(this.listener.candidates=this.listener.candidates.filter(e=>"minor-than"===e.name),this.listener.checking="middleTokens",this.one=e.value,!0)}middleTokens({token:e,counter:t}){return"equal"===e.name?(this.listener.checking="endToken",!0):["blank","end","letter","especial","number","NOT","NOT-NOT","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"minor-than",token:e,counter:t}),!1):(this.invalid=!0,this.listener.checking="endToken",!0)}endToken({token:e,counter:t}){return!1===this.invalid&&["blank","end","letter","number","especial","NOT","NOT-NOT","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"minor-or-equal",token:e,counter:t}),!1):!0===this.invalid&&["blank","end"].includes(e.name)?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,!0)}}class GreaterThanPattern{constructor(e){this.listener=e,this.invalid=!1}firstToken({token:e,counter:t}){return"greater-than"===e.name&&(this.listener.candidates=this.listener.candidates.filter(e=>"greater-than"===e.name),this.listener.checking="middleTokens",this.one=e.value,!0)}middleTokens({token:e,counter:t}){return"equal"===e.name?(this.listener.checking="endToken",!0):["blank","end","letter","especial","number","NOT","NOT-NOT","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"greater-than",token:e,counter:t}),!1):(this.invalid=!0,this.listener.checking="endToken",!0)}endToken({token:e,counter:t}){return!1===this.invalid&&["blank","end","letter","number","especial","NOT","NOT-NOT","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"greater-or-equal",token:e,counter:t}),!1):!0===this.invalid&&["blank","end"].includes(e.name)?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,!0)}}class NotPattern{constructor(e){this.listener=e,this.one=null,this.two=null,this.three=null,this.invalid=!1}firstToken({token:e,counter:t}){return"NOT"===e.name&&(this.listener.candidates=this.listener.candidates.filter(e=>"NOT"===e.name),this.listener.checking="middleTokens",this.one=e.value,!0)}middleTokens({token:e,counter:t}){return null===this.two?"equal"===e.name||"NOT"===e.name?(this.two=e.value,!0):["blank","end","letter","especial","number","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"NOT",token:e,counter:t}),!1):(this.invalid=!0,this.listener.checking="endToken",!0):(this.three=e.value,"="===this.two&&"equal"===e.name?(this.listener.checking="endToken",!0):"="===this.two&&["blank","end","letter","especial","number","NOT","NOT-NOT","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"NOT-equal",token:e,counter:t}),!1):"!"===this.two&&["blank","end","letter","especial","number","quote"].includes(e.name)?(this.listener.checking="endToken",this.listener.nextPattern({syntax:"NOT-NOT",token:e,counter:t}),!1):"!"===this.two&&"NOT"===e.name?(this.listener.checking="endToken",!0):(this.invalid=!0,this.listener.checking="endToken",!0))}endToken({token:e,counter:t}){return!1===this.invalid&&"="===this.three&&["blank","end","letter","number","especial","NOT","NOT-NOT","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"NOT-equal",token:e,counter:t}),!1):!1===this.invalid&&"!"===this.three&&["blank","end","letter","number","especial","quote"].includes(e.name)?void this.listener.nextPattern({syntax:"NOT-NOT",token:e,counter:t}):!0===this.invalid&&["blank","end"].includes(e.name)?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):("!"!==e.value&&(this.invalid=!0),!0)}}class AndPattern{constructor(e){this.listener=e,this.invalid=!1}firstToken({token:e,counter:t}){return"AND"===e.name&&(this.listener.candidates=this.listener.candidates.filter(e=>"AND"===e.name),this.listener.checking="middleTokens",!0)}middleTokens({token:e,counter:t}){return"AND"===e.name?(this.listener.checking="endToken",!0):(this.invalid=!0,this.listener.checking="endToken",!0)}endToken({token:e,counter:t}){return!1===this.invalid&&["blank","end","letter","number","especial","NOT","NOT-NOT","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"AND",token:e,counter:t}),!1):!0===this.invalid&&["blank","end"].includes(e.name)?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,!0)}}class OrPattern{constructor(e){this.listener=e,this.invalid=!1}firstToken({token:e,counter:t}){return"OR"===e.name&&(this.listener.candidates=this.listener.candidates.filter(e=>"OR"===e.name),this.listener.checking="middleTokens",!0)}middleTokens({token:e,counter:t}){return"OR"===e.name?(this.listener.checking="endToken",!0):(this.invalid=!0,this.listener.checking="endToken",!0)}endToken({token:e,counter:t}){return!1===this.invalid&&["blank","end","letter","number","especial","NOT","NOT-NOT","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"OR",token:e,counter:t}),!1):!0===this.invalid&&["blank","end"].includes(e.name)?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,!0)}}class ShortHandPattern{constructor(e){this.listener=e,this.currentParams="",this.shortHand={syntax:"short-hand",condition:[],if:[],else:[],label:""},this.counter=0,this.openShortHand=0,this.needCloseShortHand=0,this.parentheses=0,this.brackets=0}firstToken({token:e,counter:t}){return"short-hand"===e.name&&"?"===e.value&&(this.openShortHand=this.openShortHand+1,this.createConditionNode({token:e,counter:t}),!0)}middleTokens({token:e,counter:t}){if(["blank","escape","especial","quote","equal","minor-than","greater-than","NOT","NOT-NOT","AND","OR","comma","number","letter","operator","dot","separator","undefined"].includes(e.name))return this.currentParams=this.currentParams+e.value,"("===e.value?this.parentheses=this.parentheses+1:"["===e.value?this.brackets=this.brackets+1:")"===e.value?this.parentheses=this.parentheses-1:"]"===e.value&&(this.brackets=this.brackets-1),!0;if("short-hand"===e.name&&":"===e.value)return 0===this.brackets&&0===this.parentheses&&(this.needCloseShortHand=this.needCloseShortHand+1,this.openShortHand===this.needCloseShortHand&&(this.needCloseShortHand=this.needCloseShortHand-1,this.createIfNode({token:e,text:this.currentParams}))),this.currentParams=this.currentParams+e.value,!0;if("short-hand"===e.name&&"?"===e.value){if(0===this.brackets&&0===this.parentheses){if(1===this.openShortHand&&1===this.needCloseShortHand){let i=this.shortHand.label+this.currentParams;return this.listener.syntaxTree.nodes=[{syntax:"temp",label:i}],this.shortHand={syntax:"short-hand",condition:[],if:[],else:[],label:""},this.openShortHand=this.openShortHand-1,this.needCloseShortHand=this.needCloseShortHand-1,this.counter=0,this.currentParams=this.currentParams+e.value,this.createConditionNode({token:e,counter:t}),!0}this.openShortHand=this.openShortHand+1}return this.currentParams=this.currentParams+e.value,!0}return"end"===e.name?(this.createElseNode({token:e}),!1):(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1)}createConditionNode({token:e}){for(const e of this.listener.syntaxTree.nodes)this.shortHand.label=`${this.shortHand.label}${e.label}`;this.shortHand.condition=new PowerTemplateParser({text:this.shortHand.label,counter:this.counter,isParameter:!0}).syntaxTree.tree,this.listener.syntaxTree.nodes=[],this.listener.candidates=this.listener.candidates.filter(e=>"short-hand"===e.name),this.listener.checking="middleTokens",this.counter=this.shortHand.label.length+1,this.currentParams="",this.fullLabel=this.shortHand.label+e.value}createIfNode({token:e,text:t}){this.shortHand.if=new PowerTemplateParser({text:t,counter:this.counter,isParameter:!0}).syntaxTree.tree,this.shortHand.label=this.fullLabel+this.currentParams,this.counter=this.shortHand.label.length+1,this.currentParams=""}createElseNode({token:e}){this.shortHand.else=new PowerTemplateParser({text:this.currentParams,counter:this.counter,isParameter:!0}).syntaxTree.tree,this.shortHand.label=this.shortHand.label+this.currentParams,this.shortHand.start=0,this.shortHand.end=this.shortHand.label.length,this.listener.syntaxTree.nodes.push(this.shortHand),this.openShortHand=this.openShortHand-1,this.needCloseShortHand=this.needCloseShortHand-1}}class CommaPattern{constructor(e){this.listener=e,this.invalid=!1}firstToken({token:e,counter:t}){return"comma"===e.name&&(this.listener.candidates=this.listener.candidates.filter(e=>"comma"===e.name),this.listener.checking="endToken",!0)}endToken({token:e,counter:t}){return!1===this.invalid&&["blank","end","especial","separator","operator","quote","equal","NOT","NOT-NOT","comma","number","letter"].includes(e.name)?(this.listener.nextPattern({syntax:"comma",token:e,counter:t}),!1):!0===this.invalid&&["blank","end"].includes(e.name)?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,!0)}}class DictPattern{constructor(e){this.listener=e,this.invalid=!1}firstToken({token:e,counter:t}){if("dot"===e.name&&0===this.listener.syntaxTree.nodes.length){this.listener.checking="endToken",this.listener.firstNodeLabel=this.listener.currentLabel;const e=new ObjectPattern(this.listener);return e.invalid=!0,this.listener.candidates=[{name:"object",instance:e}],!0}if("dot"===e.name||"["===e.value){this.listener.checking="firstToken",this.listener.firstNodeLabel=this.listener.currentLabel;const e=new ObjectPattern(this.listener);return e.anonymous=!0,this.listener.candidates=[{name:"object",instance:e}],!0}return!1}}class parenthesesPattern{constructor(e){this.listener=e,this.invalid=!1,this.nodes=[],this.currentOpenChar=null,this.currentParams="",this.currentParamsCounter=null,this.innerOpenedParenteses=0,this.anonymous=!1}firstToken({token:e,counter:t}){if(this.currentOpenChar=e.value,"("!==this.currentOpenChar||this.listener.isAnonymousFunc){if(!0===this.listener.isAnonymousFunc){this.listener.checking="firstToken",this.listener.firstNodeLabel=this.listener.currentLabel;const e=new ObjectPattern(this.listener);return e.anonymous=!0,this.listener.candidates=[{name:"object",instance:e}],this.listener.isAnonymousFunc=!1,!0}return!1}return this.listener.candidates=this.listener.candidates.filter(e=>"parentheses"===e.name),this.listener.checking="middleTokens",null===this.currentParamsCounter&&(this.currentParamsCounter=t||null),!0}middleTokens({token:e,counter:t}){return")"===e.value&&0===this.innerOpenedParenteses?(this.listener.checking="endToken",!0):["blank","escape","especial","quote","equal","minor-than","greater-than","NOT","NOT-NOT","AND","OR","comma","short-hand","number","letter","operator","dot","separator","braces","undefined"].includes(e.name)?(this.currentParams=this.currentParams+e.value,null===this.currentParamsCounter&&(this.currentParamsCounter=t||null),"("===e.value?this.innerOpenedParenteses=this.innerOpenedParenteses+1:")"===e.value&&(this.innerOpenedParenteses=this.innerOpenedParenteses-1),!0):this.innerOpenedParenteses>=0&&"end"===e.name?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,this.listener.checking="endToken",!0)}endToken({token:e,counter:t}){if(!1===this.invalid){if(["blank","end","dot","operator"].includes(e.name)){const i=new PowerTemplateParser({text:this.currentParams,counter:this.currentParamsCounter,isParameter:!0}).syntaxTree.tree;return this.listener.nextPattern({syntax:this.anonymous?"anonymousFunc":"parentheses",token:e,counter:t,parameters:i}),!1}if("("===e.value){const e=new PowerTemplateParser({text:this.currentParams,counter:this.currentParamsCounter,isParameter:!0}).syntaxTree.tree;return this.listener.syntaxTree.nodes.push({syntax:this.anonymous?"anonymousFunc":"parentheses",label:this.listener.currentLabel,tokens:this.listener.currentTokens,start:this.listener.start,end:t,parameters:e||[]}),this.listener.start=t,this.listener.currentTokens=[],this.currentParams=[],this.listener.currentLabel="",this.anonymous=!0,this.listener.checking="middleTokens",!0}return this.invalid=!0,!0}return!0===this.invalid&&["blank","end"].includes(e.name)?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,!0)}}class ArrayDefinitionPattern{constructor(e){this.listener=e,this.invalid=!1,this.nodes=[],this.innerOpenedObjects=0,this.currentParams="",this.arrayContent=[],this.currentParamsCounter=null}firstToken({token:e,counter:t}){const i=this.listener.syntaxTree.nodes[this.listener.syntaxTree.nodes.length-1];return!("["!==e.value||i&&"dictNode"===i.syntax)&&(this.listener.candidates=this.listener.candidates.filter(e=>"arrayDefinition"===e.name),this.listener.checking="middleTokens",null===this.currentParamsCounter&&(this.currentParamsCounter=t||null),!0)}middleTokens({token:e,counter:t}){return"]"===e.value&&0===this.innerOpenedObjects?(this.listener.checking="endToken",""!==this.currentParams&&this.setArrayItem(),!0):["blank","escape","especial","quote","equal","minor-than","greater-than","NOT","NOT-NOT","AND","OR","comma","short-hand","number","letter","operator","dot","separator","braces","undefined"].includes(e.name)?(0===this.innerOpenedObjects&&","===e.value?this.setArrayItem():this.currentParams=this.currentParams+e.value,null===this.currentParamsCounter&&(this.currentParamsCounter=t||null),["{","(","["].includes(e.value)?this.innerOpenedObjects=this.innerOpenedObjects+1:["}",")","]"].includes(e.value)&&(this.innerOpenedObjects=this.innerOpenedObjects-1),!0):void 0}endToken({token:e,counter:t}){return!1===this.invalid?["end","blank","equal","minor-than","greater-than","NOT","NOT-NOT","AND","OR","comma","short-hand","operator"].includes(e.name)?(this.listener.nextPattern({syntax:"arrayDefinition",token:e,counter:t,parameters:this.arrayContent}),!1):(this.invalid=!0,!0):!0===this.invalid&&["blank","end"].includes(e.name)?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,!0)}setArrayItem(){const e=new PowerTemplateParser({text:this.currentParams,counter:this.currentParamsCounter,isParameter:!1}).syntaxTree.tree;this.arrayContent.push(e),this.currentParams=""}}class ObjectPattern{constructor(e){this.listener=e,this.invalid=!1,this.nodes=[],this.currentOpenChar=null,this.currentParams="",this.currentParamsCounter=null,this.innerOpenedObjects=0,this.anonymous=!1}firstToken({token:e,counter:t}){if(null===e.value){const i=this.listener.currentTokens[this.listener.currentTokens.length-1];if("("===i.value||"["===i.value||"."===i.value)return this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1}return this.currentOpenChar=this.listener.currentTokens[this.listener.currentTokens.length-1].value,"("===this.currentOpenChar?")"===e.value?(this.listener.checking="endToken",!0):["blank","end","letter","number","especial","NOT","NOT-NOT","quote","undefined"].includes(e.name)||"-"===e.value||"+"===e.value?(this.listener.checking="middleTokens",this.currentParams=this.currentParams+e.value,null===this.currentParamsCounter&&(this.currentParamsCounter=t||null),!0):["(","[","{"].includes(e.value)?(this.innerOpenedObjects=this.innerOpenedObjects+1,this.currentParams=this.currentParams+e.value,this.listener.checking="middleTokens",null===this.currentParamsCounter&&(this.currentParamsCounter=t||null),!0):(this.invalid=!0,this.listener.checking="endToken",!0):"["!==this.currentOpenChar&&"."!==this.currentOpenChar||"separator"===e.name&&"("!==e.value?("dot"===e.name||"separator"===e.name)&&(this.invalid=!0,this.listener.checking="endToken",!0):("."!==this.listener.currentLabel&&"["!==this.listener.currentLabel?(this.listener.firstNodeLabel=this.listener.currentLabel,this.currentParams=`"${this.listener.currentLabel.slice(0,this.listener.currentLabel.length-1)}"`,this.createDictionaryNode({token:e,counter:t}),"."===this.currentOpenChar&&"number"===e.name&&(this.invalid=!0)):this.listener.checking="middleTokens",this.currentParams=this.currentParams+e.value,null===this.currentParamsCounter&&(this.currentParamsCounter=t||null),!0)}middleTokens({token:e,counter:t}){if("("===this.currentOpenChar&&")"===e.value&&0===this.innerOpenedObjects)return this.listener.checking="endToken",!0;if("("===this.currentOpenChar&&["blank","escape","especial","quote","equal","minor-than","greater-than","NOT","NOT-NOT","AND","OR","comma","short-hand","number","letter","operator","dot","separator","braces","undefined"].includes(e.name))return this.currentParams=this.currentParams+e.value,null===this.currentParamsCounter&&(this.currentParamsCounter=t||null),["(","{","["].includes(e.value)?this.innerOpenedObjects=this.innerOpenedObjects+1:[")","}","]"].includes(e.value)&&(this.innerOpenedObjects=this.innerOpenedObjects-1),!0;if("("===this.currentOpenChar&&this.innerOpenedObjects>=0&&"end"===e.name)return this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1;if("["===this.currentOpenChar&&"]"===e.value&&0===this.innerOpenedObjects)return this.invalid=!this.currentParams.length,this.listener.checking="endToken",!0;if("."!==this.currentOpenChar||!["blank","end","operator","dot"].includes(e.name)&&"("!==e.value&&"["!==e.value)return"["===this.currentOpenChar&&["blank","escape","especial","quote","equal","NOT-equal","greater-than","minor-than","greater-or-equal","minor-or-equal","NOT","NOT-NOT","AND","OR","comma","short-hand","number","letter","operator","dot","separator"].includes(e.name)?(this.currentParams=this.currentParams+e.value,null===this.currentParamsCounter&&(this.currentParamsCounter=t||null),"["===e.value?this.innerOpenedObjects=this.innerOpenedObjects+1:"]"===e.value&&(this.innerOpenedObjects=this.innerOpenedObjects-1),!0):"."===this.currentOpenChar&&["especial","number","letter"].includes(e.name)?(this.currentParams=this.currentParams+e.value,null===this.currentParamsCounter&&(this.currentParamsCounter=t||null),!0):"["===this.currentOpenChar&&this.innerOpenedObjects>=0&&"end"===e.name?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,this.listener.checking="endToken",!0);{if(this.listener.currentTokens.length>=2&&"dot"===this.listener.currentTokens[0].name&&"number"===this.listener.currentTokens[1].name||this.listener.syntaxTree.nodes.length&&this.listener.syntaxTree.nodes[this.listener.syntaxTree.nodes.length-1]&&"dictNode"===this.listener.syntaxTree.nodes[this.listener.syntaxTree.nodes.length-1].syntax&&"."===this.listener.syntaxTree.nodes[this.listener.syntaxTree.nodes.length-1].tokens[this.listener.syntaxTree.nodes[this.listener.syntaxTree.nodes.length-1].tokens.length-1].value&&"number"===this.listener.currentTokens[0].name)return this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1;const i=new PowerTemplateParser({text:`"${this.currentParams}"`,counter:this.currentParamsCounter,isParameter:!0}).syntaxTree.tree;return this.listener.currentLabel=this.anonymous?this.listener.currentLabel:this.listener.firstNodeLabel,"("===e.value&&(this.listener.isAnonymousFunc=!0),this.listener.nextPattern({syntax:"dictNode",token:e,counter:t,parameters:i}),!1}}endToken({token:e,counter:t}){if(!1===this.invalid){if(["blank","end","operator","comma","dot"].includes(e.name)){const i=new PowerTemplateParser({text:this.currentParams,counter:this.currentParamsCounter,isParameter:!0}).syntaxTree.tree;return"("===this.currentOpenChar?(this.listener.currentLabel=this.anonymous?this.listener.currentLabel:this.listener.firstNodeLabel,this.listener.nextPattern({syntax:this.anonymous?"anonymousFunc":"function",token:e,counter:t,parameters:i}),!1):"["===this.currentOpenChar||"."===this.currentOpenChar?(this.listener.currentLabel=this.anonymous?this.listener.currentLabel:this.listener.firstNodeLabel,this.listener.nextPattern({syntax:"dictNode",token:e,counter:t,parameters:i}),!1):(this.invalid=!0,!0)}return"("!==this.currentOpenChar||"("!==e.value&&"["!==e.value?"["!==this.currentOpenChar||"["!==e.value&&"("!==e.value?(this.invalid=!0,!0):(this.createDictionaryNode({token:e,counter:t}),this.currentOpenChar=e.value,!0):(this.listener.checking="middleTokens",this.createAnonymousFuncNode({token:e,counter:t}),this.currentOpenChar=e.value,!0)}return!0===this.invalid&&["blank","end"].includes(e.name)?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,!0)}dictHaveInvalidParams(e){return 0===e.length&&(invalid=!0,!0)}createDictionaryNode({token:e,counter:t}){const i=new PowerTemplateParser({text:this.currentParams,counter:this.currentParamsCounter,isParameter:!0}).syntaxTree.tree;if(this.dictHaveInvalidParams(i))return this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1;this.listener.syntaxTree.nodes.push({syntax:"dictNode",label:this.listener.firstNodeLabel?this.listener.firstNodeLabel:this.listener.currentLabel,tokens:this.listener.currentTokens,start:this.listener.start,end:t,parameters:i||[]}),this.listener.start=t,this.listener.currentTokens=[],this.currentParams=[],this.listener.currentLabel="",this.listener.firstNodeLabel="",this.anonymous=!0,this.listener.checking="middleTokens"}createAnonymousFuncNode({token:e,counter:t}){const i=new PowerTemplateParser({text:this.currentParams,counter:this.currentParamsCounter,isParameter:!0}).syntaxTree.tree;this.listener.currentLabel=!0===this.anonymous?this.listener.currentLabel:this.listener.firstNodeLabel,this.listener.syntaxTree.nodes.push({syntax:!0===this.anonymous?"anonymousFunc":"function",label:this.listener.currentLabel,tokens:this.listener.currentTokens,start:this.listener.start,end:t,parameters:i||[]}),this.listener.start=t,this.listener.currentTokens=[],this.currentParams=[],this.listener.currentLabel="",this.listener.firstNodeLabel="",this.anonymous=!0,this.listener.checking="middleTokens"}}class EmptyPattern{constructor(e){this.listener=e}firstToken({token:e,counter:t}){return"blank"===e.name&&(this.listener.candidates=this.listener.candidates.filter(e=>"empty"===e.name),this.listener.checking="middleTokens",!0)}middleTokens({token:e,counter:t}){return"blank"===e.name||(this.listener.nextPattern({syntax:"empty",token:e,counter:t}),!1)}}class PowerWidget extends PowerController{constructor({$powerUi:e}){super({$powerUi:e}),this.isWidget=!0}$buildTemplate({template:e,title:t}){const i=document.createElement("div");return i.innerHTML=this.template({$title:t||null}),i.querySelectorAll("[data-pw-content]")[0].innerHTML=e,e=i.innerHTML}}export{PowerWidget};class PowerDialogBase extends PowerWidget{constructor({$powerUi:e,noEsc:t}){if(super({$powerUi:e}),t)return;const i=this;this._closeWindow=function(){i._cancel()},e._events.Escape.subscribe(this._closeWindow)}_cancel(){this.onCancel?new Promise(this.onCancel.bind(this)).then(this.closeCurrentRoute.bind(this)).catch(()=>this.onCancelError?this.onCancelError():null):this.closeCurrentRoute()}_commit(){this.onCommit?new Promise(this.onCommit.bind(this)).then(this.closeCurrentRoute.bind(this)).catch(()=>this.onCommitError?this.onCommitError():null):this.closeCurrentRoute()}closeCurrentRoute(){const e=document.getElementById(this._viewId);this.$powerUi._events.Escape.unsubscribe(this._closeWindow),e?super.closeCurrentRoute():this.$powerUi._events.Escape.broadcast()}_onViewLoad(e){const t=e.getElementsByClassName("pw-container")[0],i=e.getElementsByClassName("pw-body")[0];t&&(t.scrollTop=this._containerScrollTop||0,t.scrollLeft=this._containerScrollLeft||0),i&&(i.scrollTop=this._bodyScrollTop||0,i.scrollLeft=this._bodyScrollLeft||0)}$buttons(){if(this.commitBt||this.cancelBt){let e="";if(this.commitBt){const t=`<span class="pw-ico fa fa-${this.commitBt.ico?this.commitBt.ico:"check-circle"}"></span>`;e+=`<button\n\t\t\t\t\t\t\t\tclass="${this.commitBt.css?this.commitBt.css:"pw-btn-default"}"\n\t\t\t\t\t\t\t\tdata-pow-event onclick="_commit()">\n\t\t\t\t\t\t\t\t${!1!==this.commitBt.ico?t:""}\n\t\t\t\t\t\t\t\t${this.commitBt.label?this.commitBt.label:"Ok"}\n\t\t\t\t\t\t\t\t</button>`}if(this.cancelBt){const t=`<span class="pw-ico fa fa-${this.cancelBt.ico?this.cancelBt.ico:"times-circle"}"></span>`;e+=`<button\n\t\t\t\t\t\t\t\tclass="${this.cancelBt.css?this.cancelBt.css:"pw-btn-default"}"\n\t\t\t\t\t\t\t\tdata-pow-event onclick="_cancel()">\n\t\t\t\t\t\t\t\t${!1!==this.cancelBt.ico?t:""}\n\t\t\t\t\t\t\t\t${this.cancelBt.label?this.cancelBt.label:"Cancel"}\n\t\t\t\t\t\t\t\t</button>`}return e}return""}template({$title:e}){return this.$title=this.$title||e,`<div class="pw-title-bar">\n\t\t\t\t\t<span class="pw-title-bar-label">${this.$title}</span>\n\t\t\t\t\t<div data-pow-event onclick="_cancel()" class="pw-bt-close fa fa-times"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="pw-body">\n\t\t\t\t\t<div class="pw-container" data-pw-content>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="pw-container">\n\t\t\t\t\t\t${this.$buttons()}\n\t\t\t\t\t</div>\n\t\t\t\t</div>`}}export{PowerDialogBase};class PowerDialog extends PowerDialogBase{constructor({$powerUi:e}){super({$powerUi:e})}template({$title:e}){return this.$title=this.$title||e,`<div class="pw-dialog pw-dialog-container">\n\t\t\t\t\t${super.template({$title:e})}\n\t\t\t\t</div>`}}class PowerAlert extends PowerDialog{constructor({$powerUi:e}){super({$powerUi:e}),this.commitBt=!0}}class PowerConfirm extends PowerDialog{constructor({$powerUi:e}){super({$powerUi:e}),this.commitBt=!0,this.cancelBt=!0}}function wrapFunctionInsideDialog({controller:e,kind:t,params:i}){class s extends PowerAlert{constructor({$powerUi:t}){if(super({$powerUi:t}),this.ctrl=e,i)for(const e of Object.keys(i||{}))this[e]=i[e]}}class n extends PowerConfirm{constructor({$powerUi:t}){if(super({$powerUi:t}),this.ctrl=e,i)for(const e of Object.keys(i||{}))this[e]=i[e]}}class r extends PowerModal{constructor({$powerUi:t}){if(super({$powerUi:t}),this.ctrl=e,i)for(const e of Object.keys(i||{}))this[e]=i[e]}}class o extends PowerWindow{constructor({$powerUi:t}){if(super({$powerUi:t}),this.ctrl=e,i)for(const e of Object.keys(i||{}))this[e]=i[e]}}return"confirm"===t?n:"modal"===t?r:"window"===t?o:s}export{PowerDialog,PowerAlert,PowerConfirm};class PowerModal extends PowerDialogBase{constructor({$powerUi:e}){super({$powerUi:e}),this.isModal=!0}clickOutside(e){e.target.classList.contains("pw-modal-backdrop")&&this._cancel()}template({$title:e}){return document.body&&document.body.classList&&document.body.classList.add("modal-open"),this.$title=this.$title||e,`<div class="pw-modal pw-modal-backdrop${this.$powerUi.touchdevice?" pw-touchdevice":""}" data-pow-event onclick="clickOutside(event)">\n\t\t\t\t\t${super.template({$title:e})}\n\t\t\t\t</div>`}}export{PowerModal};class PowerWindow extends PowerDialogBase{constructor({$powerUi:e}){super({$powerUi:e,noEsc:!0}),this.isWindow=!0}_onViewLoad(e){if(this.currentView=e,this.element=this.currentView.getElementsByClassName("pw-window")[0],this.dragElement(),this._top&&this._left&&(this.element.style.top=this._top,this.element.style.left=this._left),this.bodyEl=this.currentView.getElementsByClassName("pw-body")[0],this.resizableEl=this.currentView.getElementsByClassName("pw-window-resizable")[0],this.titleBarEl=this.currentView.getElementsByClassName("pw-title-bar")[0],this.resizeElement(),this._width&&this._height)this.bodyEl.style.width=this._width,this.bodyEl.style.height=this._bodyHeight,this.resizableEl.style.width=this._width,this.resizableEl.style.height=this._height;else{const e=this.bodyEl.offsetHeight+50+"px",t=this.bodyEl.offsetWidth+50+"px";this.bodyEl.style.height=e,this.resizableEl.style.height=e,this.bodyEl.style.width=t,this.resizableEl.style.width=t}this.resizeWindow(),this.windowsOrder(),super._onViewLoad(this.currentView)}template({$title:e}){return this.$title=this.$title||e,`<div class="pw-window${this.$powerUi.touchdevice?" pw-touchdevice":""}">\n\t\t\t\t\t<div class="pw-window-resizable">\n\t\t\t\t\t\t${super.template({$title:e})}\n\t\t\t\t\t</div>\n\t\t\t\t</div>`}resizeElement(){this.bodyEl.onmousedown=this.resizeMouseDown.bind(this)}resizeMouseDown(){this.windowsOrder(),document.onmouseup=this.closeDragElement.bind(this),document.onmousemove=this.resizeWindow.bind(this)}resizeWindow(){this._width=this.bodyEl.offsetWidth;const e=this.bodyEl.offsetHeight,t=this.titleBarEl.offsetHeight;this._height=e+t,this._width<130&&(this._width=130),this._height<130&&(this._height=130),this._width=`${this._width}px`,this._height=`${this._height}px`,this.resizableEl.style.width=this._width,this.resizableEl.style.height=this._height,this.bodyEl.style.width=this._width,this.bodyEl.style.height=this.resizableEl.offsetHeight-t+"px",this.onResize&&this.onResize()}dragElement(){this.pos1=0,this.pos2=0,this.pos3=0,this.pos4=0;const e=this.currentView.getElementsByClassName("pw-title-bar")[0];e?e.onmousedown=this.dragMouseDown.bind(this):this.element.onmousedown=this.dragMouseDown.bind(this)}dragMouseDown(e){(e=e||window.event).preventDefault(),this.windowsOrder(),this.pos3=e.clientX,this.pos4=e.clientY,document.onmouseup=this.closeDragElement.bind(this),document.onmousemove=this.elementDrag.bind(this)}elementDrag(e){(e=e||window.event).preventDefault(),this.pos1=this.pos3-e.clientX,this.pos2=this.pos4-e.clientY,this.pos3=e.clientX,this.pos4=e.clientY,this.element.style.top=this.element.offsetTop-this.pos2+"px",this.element.style.left=this.element.offsetLeft-this.pos1+"px",this._top=this.element.style.top,this._left=this.element.style.left}closeDragElement(){this.resizeWindow(),this._bodyHeight=window.getComputedStyle(this.bodyEl).height,document.onmouseup=null,document.onmousemove=null}windowsOrder(){const e=this;this.$powerUi._windowsOrderTimeout||(this.$powerUi._windowsOrderInterval=setTimeout((function(){let t=document.getElementsByClassName("pw-window");const i=e.currentView.getElementsByClassName("pw-window")[0];let s=1002;const n={};for(const e of t){let t=parseInt(e.style.zIndex||s);e!==i&&(n[t]=e,t>=s&&(s=t+1))}const r=Object.keys(n).sort((e,t)=>parseInt(e)-parseInt(t));s=1002;for(const e of r)n[e].style.zIndex=s,s+=1;i.style.zIndex=s+1}),10))}}export{PowerWindow};class AccordionModel{constructor(e){this.ctx=e,this.multipleSectionsOpen="true"===e.element.getAttribute("data-multiple-sections-open")}}class AccordionSectionModel{constructor(e){this.ctx=e,this.active=!1}}class AccordionSectionHtmlCtrl{constructor(e){this.ctx=e}toggle(){if(!this.ctx.powerAccordion.model.multipleSectionsOpen)for(const e of Object.keys(this.ctx.powerAccordion.childrenActions||{})){const t=this.ctx.powerAccordion.childrenActions[e];t.targetObj.id!==this.ctx.powerAccordion.id&&t._$pwActive&&this.ctx!==t.targetObj&&(t.toggle({avoidCallAction:!0}),t.targetObj.model.active=!t.targetObj.model.active)}}}class PowerAccordion extends PowerTarget{constructor(e){super(e),this.model=new AccordionModel(this)}init(){this.childrenSections=this.getChildrenByPowerCss("powerAccordionSection"),this.childrenActions=this.getChildrenByPowerCss("powerAction")}}PowerUi.injectPowerCss({name:"power-accordion"});class PowerAccordionSection extends PowerTarget{constructor(e){super(e),this.model=new AccordionSectionModel(this),this.ctrl="htmlCtrl"}init(){this.htmlCtrl=new AccordionSectionHtmlCtrl(this);let e=this.parent;do{"powerAccordion"===e.$powerCss?this.powerAccordion=e:e=e.parent}while(e&&"powerAccordion"!==e.$powerCss)}action(){this[this.ctrl].toggle()}}PowerUi.injectPowerCss({name:"power-accordion-section"});class PowerAction extends PowerTarget{constructor(e){if(super(e),this._target=this.element.dataset.powerTarget,!this._target)throw console.error("power-action selector needs a power element target",this.element),'Missing power-action target. Please define it: data-power-target="power_element_id"'}init(){const e=this.$powerUi.powerTree.allPowerObjsById[this._target];for(const t in e)e[t].powerTarget&&(this.targetObj=e[t]);this.targetObj.powerAction=this,this.subscribe({event:"click",fn:this.toggle})}toggle(e={}){this.targetObj.action&&!e.avoidCallAction&&this.targetObj.action(),this._$pwActive?(this._$pwActive=!1,this.targetObj._$pwActive=!1,this.targetObj.element.classList.remove("power-active"),this.element.classList.remove("power-active")):(this._$pwActive=!0,this.targetObj._$pwActive=!0,this.targetObj.element.classList.add("power-active"),this.element.classList.add("power-active")),this.broadcast("toggle",!0)}ifClickOut(){this._$pwActive?document.removeEventListener("click",this._clickPowerItemOrOutside):(this._clickPowerItemOrOutside=this.clickPowerItemOrOutside.bind(this),document.addEventListener("click",this._clickPowerItemOrOutside))}clickPowerItemOrOutside(e){const t=document.getElementById(this.targetObj.id),i=document.getElementById(this.id);let s=e.target;if(s.classList.contains("power-item")||s.classList.contains("power-brand"))this.toggle();else{do{if(s===t||s===i)return;s=s.parentNode}while(s);this.toggle()}}}PowerUi.injectPowerCss({name:"power-action"});class PowerToggle extends PowerAction{constructor(e){super(e)}}PowerUi.injectPowerCss({name:"power-toggle"});class PowerBrand extends PowerTarget{constructor(e){super(e),this.id=this.element.getAttribute("id")}}PowerUi.injectPowerCss({name:"power-brand"});class PowerDropmenu extends PowerTarget{constructor(e){super(e),this.defaultPosition=this.element.getAttribute("data-power-position")||"bottom-right",this._markRootAndMenuDropmenu()}init(){if(this.childrenPowerActions=this.getChildrenByPowerCss("powerAction"),this.innerPowerActionsWithoutChildren=this.getInnerWithoutChildrenByPowerCss("powerAction"),this.childrenPowerItems=this.getChildrenByPowerCss("powerItem"),this.innerPowerItemsWithoutChildren=this.getInnerWithoutChildrenByPowerCss("powerItem"),this.innerPowerDropmenus=this.getInnerByPowerCss("powerDropmenu"),this.isRootElement&&!this.isMenuElement){defineRootDropmenusPosition(this,this);for(const e of this.innerPowerDropmenus)defineInnerDropmenusPosition(this,e)}}_markRootAndMenuDropmenu(){const e=PowerTree._searchUpDOM(this.element,PowerTree._checkIfhavePowerParentElement);e.conditionResult?(e.powerElement.className.includes("power-dropmenu")?this.isRootElement=!1:this.isRootElement=!0,e.powerElement.className.includes("power-menu")&&(this.isMenuElement=!0)):this.isRootElement=!0}hoverModeOn(){if(this.$powerUi.tmp.dropmenu._mouseIsMovingTo)this.$powerUi.tmp.dropmenu._mouseIsMovingTo.id!==this.id&&this.moveOverPossibleNewTarget(this);else for(const e of this.childrenPowerActions)e.subscribe({event:"mouseenter",fn:this.onMouseEnterAction,action:e,dropmenu:this}),e.subscribe({event:"click",fn:this.onMouseEnterAction,action:e,dropmenu:this})}onMouseEnterAction(e,t,i){if(this.$powerUi.tmp.dropmenu._mouseIsMovingTo)this.$powerUi.tmp.dropmenu._mouseIsMovingTo.id!==i.dropmenu.id&&i.dropmenu.moveOverPossibleNewTarget(this);else if(!i.action._$pwActive){i.action.toggle(),i.dropmenu.onMouseEnterItem(e,t,i,!0);for(const e of i.dropmenu.childrenPowerItems)e.subscribe({event:"mouseenter",fn:i.dropmenu.onMouseEnterItem,action:i.action,dropmenu:i.dropmenu,item:e});i.dropmenu.startWatchMouseMove(e,t,i)}}onMouseEnterItem(e,t,i,s){if(this.$powerUi.tmp.dropmenu._mouseIsMovingTo)this.$powerUi.tmp.dropmenu._mouseIsMovingTo.id!==i.dropmenu.id&&i.dropmenu.moveOverPossibleNewTarget(i.item);else{s||i.action._$pwActive&&i.action.toggle();for(const e of i.dropmenu.innerPowerActionsWithoutChildren)e._$pwActive&&e.toggle();for(const e of i.dropmenu.childrenPowerActions)e._$pwActive&&e.id!==i.action.id&&e.toggle();for(const e of i.dropmenu.childrenPowerItems)e.unsubscribe({event:"mouseenter",fn:i.dropmenu.onMouseEnterItem,action:i.action,dropmenu:i.dropmenu})}}hoverModeOff(){this.stopWatchMouseMove();for(const e of this.childrenPowerActions)e.unsubscribe({event:"mouseenter",fn:this.onMouseEnterAction,action:e,dropmenu:this}),e.unsubscribe({event:"click",fn:this.onMouseEnterAction,action:e,dropmenu:this})}moveOverPossibleNewTarget(e){this.$powerUi.tmp.dropmenu._possibleNewTarget=e}onmousestop(){if(this.$powerUi.tmp.dropmenu._possibleNewTarget&&!this.$powerUi.tmp.dropmenu._possibleNewTarget._$pwActive){const e=this.$powerUi.tmp.dropmenu._possibleNewTarget;setTimeout((function(){e.broadcast("mouseenter")}),10),this.stopWatchMouseMove()}else this.$powerUi.tmp.dropmenu._resetMouseTimeout()}resetMouseTimeout(){clearTimeout(this.$powerUi.tmp.dropmenu.timeout),this.$powerUi.tmp.dropmenu.timeout=setTimeout(this.$powerUi.tmp.dropmenu._onmousestop,120)}startWatchMouseMove(e,t,i){this.$powerUi.tmp.dropmenu._mouseIsMovingTo||(i.action.targetObj.subscribe({event:"mouseenter",fn:this.stopWatchMouseMove,action:i.action,dropmenu:i.dropmenu}),this.$powerUi.tmp.dropmenu._mouseIsMovingTo=i.action.targetObj,this.$powerUi.tmp.dropmenu._onmousestop=this.onmousestop.bind(this),this.$powerUi.tmp.dropmenu._resetMouseTimeout=this.resetMouseTimeout.bind(this),this.$powerUi.tmp.dropmenu.timeout=setTimeout(this.$powerUi.tmp.dropmenu._onmousestop,300),document.addEventListener("mousemove",this.$powerUi.tmp.dropmenu._resetMouseTimeout,!0))}stopWatchMouseMove(){this.$powerUi.tmp.dropmenu._mouseIsMovingTo=!1,this.$powerUi.tmp.dropmenu._possibleNewTarget=!1,clearTimeout(this.$powerUi.tmp.dropmenu.timeout),document.removeEventListener("mousemove",this.$powerUi.tmp.dropmenu._resetMouseTimeout,!0),this.unsubscribe({event:"mouseenter",fn:this.stopWatchMouseMove})}setPositionRightBottom(e){this.element.style.left=this.powerAction.element.offsetLeft+this.powerAction.element.offsetWidth+"px",this.element.style.top=this.powerAction.element.offsetTop+"px"}setPositionBottomRight(e){this.element.style.top=this.powerAction.element.offsetTop+this.powerAction.element.offsetHeight+"px",this.element.style.left=this.powerAction.element.offsetLeft+"px"}setPositionLeftBottom(e){this.element.style.left=this.powerAction.element.offsetLeft-this.element.offsetWidth+"px",this.element.style.top=this.powerAction.element.offsetTop+"px"}setPositionBottomLeft(e){const t=this.powerAction.element.offsetWidth-this.element.offsetWidth;this.element.style.left=this.powerAction.element.offsetLeft+t+"px"}setPositionRightTop(e){this.element.style.left=this.powerAction.element.offsetLeft+this.powerAction.element.offsetWidth+"px",this.element.style.top=this.powerAction.element.offsetTop-(this.element.offsetHeight-this.powerAction.element.offsetHeight)+"px"}setPositionTopRight(e){this.element.style.left=this.powerAction.element.offsetLeft+"px",this.element.style.top=this.powerAction.element.offsetTop-this.element.offsetHeight+"px"}setPositionLeftTop(e){this.element.style.left=this.powerAction.element.offsetLeft-this.element.offsetWidth+"px",this.element.style.top=this.powerAction.element.offsetTop-(this.element.offsetHeight-this.powerAction.element.offsetHeight)+"px"}setPositionTopLeft(e){const t=this.powerAction.element.offsetWidth-this.element.offsetWidth;this.element.style.left=this.powerAction.element.offsetLeft+t+"px",this.element.style.top=this.powerAction.element.offsetTop-this.element.offsetHeight+"px"}ifPositionOutOfScreenChangeDirection(){const e=this.element.getBoundingClientRect(),t={topDown:this.defaultPosition.includes("bottom")?"bottom":"top",leftRight:this.defaultPosition.includes("right")?"right":"left"},i={topDown:0,leftRight:0};e.right>document.defaultView.innerWidth?(t.leftRight="left",i.leftRight++):e.left<0&&(t.leftRight="right",i.leftRight++),e.bottom>document.defaultView.innerHeight?(t.topDown="top",i.topDown++):e.top<0&&(t.topDown="bottom",i.topDown++),(i.topDown>0||i.leftRight>0)&&("top"===t.topDown?"left"===t.leftRight?this.setPositionLeftTop():this.setPositionRightTop():"left"===t.leftRight?this.setPositionLeftBottom():this.setPositionRightBottom(),this.setPositionLimits())}setPositionLimits(){const e=this.element.getBoundingClientRect();e.left<0&&(this.element.style.left="0px"),e.top<0&&(this.element.style.top="0px")}resetDropmenuPosition(){this.element.style.top=null,this.element.style.left=null}toggle(){this.resetDropmenuPosition(),this.element.classList.add("power-hide");const e=this;this._$pwActive?this.$powerUi.touchdevice||this.hoverModeOff():(setTimeout((function(){"bottom-right"===e.defaultPosition?e.setPositionBottomRight():"right-bottom"===e.defaultPosition?e.setPositionRightBottom():"bottom-left"===e.defaultPosition?e.setPositionBottomLeft():"left-bottom"===e.defaultPosition?e.setPositionLeftBottom():"top-right"===e.defaultPosition?e.setPositionTopRight():"right-top"===e.defaultPosition?e.setPositionRightTop():"left-top"===e.defaultPosition?e.setPositionLeftTop():"top-left"===e.defaultPosition?e.setPositionTopLeft():e.setPositionRightBottom(),"fixed"===window.getComputedStyle(e.powerAction.element).position&&(e.element.style.position="fixed",e.element.style.left=window.getComputedStyle(e.powerAction.element).left),e.ifPositionOutOfScreenChangeDirection(),e.element.classList.remove("power-hide")}),50),this.$powerUi.touchdevice||this.hoverModeOn()),this.powerAction.ifClickOut(),this.broadcast("toggle",!0)}action(){this.toggle()}}PowerUi.injectPowerCss({name:"power-dropmenu"});class PowerItem extends PowerTarget{constructor(e){super(e)}}PowerUi.injectPowerCss({name:"power-item"});class PowerMain extends _PowerBasicElementWithEvents{constructor(e){super(e)}}PowerUi.injectPowerCss({name:"power-main",isMain:!0});class PowerMenu extends PowerTarget{constructor(e,t){super(e),this.$powerUi=t,this._$pwActive=!1,this.id=this.element.getAttribute("id"),this.powerTarget=!0,this.defaultPosition=this.element.getAttribute("data-power-position"),this.defaultPosition||(this.element.classList.contains("power-horizontal")?this.defaultPosition="bottom-right":this.defaultPosition="right-bottom")}init(){this.childrenPowerActions=this.getChildrenByPowerCss("powerAction"),this.innerPowerActionsWithoutChildren=this.getInnerWithoutChildrenByPowerCss("powerAction"),this.childrenPowerDropmenus=this.getChildrenByPowerCss("powerDropmenu"),this.innerPowerDropmenus=this.getInnerByPowerCss("powerDropmenu");for(const e of this.innerPowerDropmenus)e.isRootElement?defineRootDropmenusPosition(this,e):defineInnerDropmenusPosition(this,e);for(const e of this.childrenPowerActions)this.$powerUi.touchdevice||(e.subscribe({event:"click",fn:this.hoverModeOn,menu:this}),e.subscribe({event:"toggle",fn:this.maySetHoverModeOff,menu:this}))}hoverModeOn(e,t,i){for(const e of i.menu.childrenPowerActions)e.subscribe({event:"mouseenter",fn:i.menu.onMouseEnterAction,action:e,menu:i.menu})}onMouseEnterAction(e,t,i){i.menu.resetAnyDropdownTmpInfo(),i.action._$pwActive||i.action.toggle();for(const e of i.menu.innerPowerActionsWithoutChildren)e._$pwActive&&e.toggle();for(const e of i.menu.childrenPowerActions)e._$pwActive&&e.id!==i.action.id&&e.toggle()}maySetHoverModeOff(e,t,i){setTimeout((function(){let s=!1;for(const e of i.menu.childrenPowerActions)e._$pwActive&&(s=!0);!1===s&&i.menu.hoverModeOff(e,t,i)}),50)}hoverModeOff(e,t,i){for(const e of i.menu.childrenPowerActions)e.unsubscribe({event:"mouseenter",fn:i.menu.onMouseEnterAction,action:e,menu:i.menu})}resetAnyDropdownTmpInfo(){this.$powerUi.tmp.dropmenu._mouseIsMovingTo=!1,this.$powerUi.tmp.dropmenu._possibleNewTarget=!1,clearTimeout(this.$powerUi.tmp.dropmenu.timeout),document.removeEventListener("mousemove",this.$powerUi.tmp.dropmenu._resetMouseTimeout,!0),this.unsubscribe({event:"mouseenter",fn:this.stopWatchMouseMove})}toggle(){this.powerAction.ifClickOut(),this.powerAction.broadcast("toggle",!0)}action(){this.toggle()}}PowerUi.injectPowerCss({name:"power-menu",isMain:!0});class PowerStatus extends PowerTarget{constructor(e){super(e);const t=this.element.getAttribute("data-power-active"),i=this.element.getAttribute("data-power-inactive");this.activeValues=t?t.split(" "):[],this.inactiveValues=i?i.split(" "):[],this.inactive()}active(){for(const e of this.activeValues)this.element.classList.add(e);for(const e of this.inactiveValues)this.element.classList.remove(e)}inactive(){for(const e of this.inactiveValues)this.element.classList.add(e);for(const e of this.activeValues)this.element.classList.remove(e)}toggle(){this._$pwActive=!this._$pwActive,this._$pwActive?this.active():this.inactive()}init(){let e=!1,t=this.element.parentElement;const i=this.$powerUi.powerTree.allPowerObjsById;for(;!e;){if(t)for(const e of Object.keys(i[t.id]||{}))i[t.id][e].powerTarget&&(this.targetObj=i[t.id][e]);this.targetObj||e?e=!0:t=t.parentElement}this.targetObj&&this.targetObj.subscribe({event:"toggle",fn:this.toggle.bind(this)})}}PowerUi.injectPowerCss({name:"power-status"});