"use strict";function getIdAndCreateIfDontHave(e){let t=e.id;return t||(t=_Unique.domID(e.tagName.toLowerCase())),e.setAttribute("id",t),t}function asDataSet(e){const t=e.split("-").filter(e=>"data"!=e);let i="";for(let e=0;e<t.length;e++)i+=0===e?t[e]:t[e].replace(/\b\w/g,e=>e.toUpperCase());return i}function powerClassAsCamelCase(e){return`${e.split("-")[0]}${e.split("-")[1].charAt(0).toUpperCase()}${e.split("-")[1].slice(1)}`}class SharedScope{constructor({id:e,main:t,view:i,rootCompiler:s,parent:o,ctx:n}){this.id=e,this.tempMainEl=t,this.tempViewEl=i,this.tempRootCompilerEl=s,this.tempParent=o||{node:null,datasetKey:null},this.ctx=n,this.cached={}}get element(){return document.getElementById(this.id)}get main(){return this.tempMainEl?document.getElementById(this.tempMainEl.id):null}get view(){return this.tempViewEl?document.getElementById(this.tempViewEl.id):null}get rootCompiler(){return this.tempRootCompilerEl?document.getElementById(this.tempRootCompilerEl.id):null}get parentNode(){return this.tempParent.node?document.getElementById(this.tempParent.node.id):null}get parentDatasetKey(){return this.tempParent.datasetKey}get parentObj(){if(!this.parentNode)return null;const e=this.parentNode.id,t=this.parentDatasetKey;return this.ctx.allPowerObjsById[e]&&this.ctx.allPowerObjsById[e][t]?this.ctx.allPowerObjsById[e][t]:null}get mainObj(){return this.cached.isMain||this.getTarget(this.main.id,"isMain")}get viewObj(){return this.cached.isView||this.getTarget(this.view.id,"isView")}get rootCompilerObj(){const e="isRootCompiler";return this.cached[e]||this.getTarget(this.rootCompiler.id,e)}getTarget(e,t){if(!e)return!1;if(null!=this.cached[t])return this.cached[t];for(const i of Object.keys(this.ctx.allPowerObjsById[e]||{}))if(this.ctx.allPowerObjsById[e][i][t])return this.cached[t]=this.ctx.allPowerObjsById[e][i],this.cached[t];this.cached[t]=!1}removeInnerElementsFromPower(){const e=this.element.children;for(const t of e)this.removeElementAndInnersFromPower(t);this.element.innerHTML="",delete this.element.dataset.pwhascomp}removeElementAndInnersFromPower(e){if((e=e||this.element).id&&this.ctx.allPowerObjsById[e.id]){this.ctx.removeEventsOfObject(e.id);for(const t of Object.keys(this.ctx.allPowerObjsById[e.id]))"$shared"!==t&&this.ctx.allPowerObjsById[e.id][t].onRemove&&this.ctx.allPowerObjsById[e.id][t].onRemove();delete this.ctx.allPowerObjsById[e.id]}const t=e.children;for(const e of t)this.removeElementAndInnersFromPower(e)}}class _PowerUiBase{constructor(){this._tempScope={}}_createPowerTree(){this.powerTree=new PowerTree(this,_PowerUiBase),this.powerTree._callInit()}}_PowerUiBase._powAttrsConfig=[],_PowerUiBase.injectPow=function(e){e.datasetKey=asDataSet(e.name),_PowerUiBase._powAttrsConfig.push(e)},_PowerUiBase._pwcAttrsConfig=[],_PowerUiBase.injectPwc=function(e){powAttr.datasetKey=asDataSet(powAttr.name),_PowerUiBase._pwcAttrsConfig.push(e)},_PowerUiBase._powerElementsConfig=[],_PowerUiBase.injectPowerCss=function(e){e.datasetKey=asDataSet(e.name),e.isMain?_PowerUiBase._powerElementsConfig.unshift(e):_PowerUiBase._powerElementsConfig.push(e)};const _Unique={n:0,next:()=>++_Unique.n,domID:e=>`_pow${e?"_"+e:"er"}_${_Unique.next()}`,scopeID:()=>`_scope_${_Unique.next()}`,last:()=>_Unique.n};class UEvent{constructor(e){this.observers=[],e&&(UEvent.index[e]=this)}subscribe(e,t){this.observers.push({fn:e,ctx:t,arguments:arguments})}unsubscribe(e,t){this.observers=t?this.observers.filter(e=>e.ctx!==t):this.observers.filter(t=>t.fn!==e)}broadcast(){for(const e of this.observers)e.fn.apply(e.ctx,e.arguments)}popBroadcast(){if(this.observers.length>0){const e=this.observers[this.observers.length-1];e.fn.apply(e.ctx,e.arguments)}}}UEvent.index={};class _PowerBasicElement{constructor(e){this.tempEl=e,this._$pwActive=!1}get id(){return this.element&&this.element.id||null}set id(e){this.element.id=e}get element(){return this.$shared?this.$shared.element:this.tempEl}get $pwMain(){return this.$shared?this.$shared.mainObj:null}get $pwView(){return this.$shared?this.$shared.viewObj:null}get parent(){return this.$shared?this.$shared.parentObj:null}get children(){return this._cachedChildren||this._getChildren()}_getChildren(){this._cachedChildren=[];const e=this.element;for(const t of e.children)if(t.className.includes("power-"))for(const e of Object.keys(this.$powerUi.powerTree.allPowerObjsById[t.id]||{}))e.startsWith("power")&&this._cachedChildren.push(this.$powerUi.powerTree.allPowerObjsById[t.id][e]);return this._cachedChildren}get innerPowerCss(){return this._cachedInnerPowerCss||this._getInnerPowerCss()}_getInnerPowerCss(){return this._cachedInnerPowerCss=this.$powerUi.powerTree._getAllInnerPowerCss(this.element),this._cachedInnerPowerCss}}class _PowerBasicElementWithEvents extends _PowerBasicElement{constructor(e){super(e),this._events={},this._DOMEvents={},this._events_fn={}}toggle(){this._$pwActive=!this._$pwActive,this.broadcast("toggle",!0)}subscribe({event:e,fn:t,useCapture:i=!0,...s}){this.unsubscribe({event:e,fn:t,useCapture:i,params:s});const o=this;this._events[e]||(this._events[e]=new UEvent(this.id),this._DOMEvents[e]||(this._DOMEvents[e]=new CustomEvent(e,{bubbles:i})),this._events_fn[e]=function(t){o._events[e].broadcast(o,t,s)},this.addEventListener(e,this._events_fn[e],i)),this._events[e].subscribe(t,o,s)}unsubscribe({event:e,fn:t,useCapture:i=!0,...s}){this._events[e]&&(this._events[e].unsubscribe(t),0===this._events[e].observers.length&&(delete this._events[e],this.removeEventListener(e,this._events_fn[e],i)))}broadcast(e,t){void 0!==document.body[e]||t?this._DOMEvents[e]&&this.element.dispatchEvent(this._DOMEvents[e]):(this._DOMEvents[e]&&this.element.dispatchEvent(this._DOMEvents[e]),this.dispatch(e))}dispatch(e){this[e]&&this[e]()}addEventListener(e,t,i=!1){this.element.addEventListener(e,t,i)}removeEventListener(e,t,i=!1){this.element&&this.element.removeEventListener(e,t,i)}getChildrenByPowerCss(e){return this.children.filter(t=>t.$powerCss===e)}getInnerByPowerCss(e){return this.innerPowerCss.filter(t=>t.$powerCss===e)}getInnerWithoutChildrenByPowerCss(e){return this.innerPowerCss.filter(t=>t.$powerCss===e&&t.parent.id!==this.id)}}class PowerTarget extends _PowerBasicElementWithEvents{constructor(e){super(e),this.powerTarget=!0}}class PowerTree{constructor(e,t){this.$powerUi=e,this.allPowerObjsById={},this.attrsConfig={};for(const e of _PowerUiBase._powAttrsConfig){e.callback(document.createElement("div")).compile&&(e.isCompiler=!0),this.attrsConfig[e.datasetKey]=e}for(const e of _PowerUiBase._pwcAttrsConfig){e.callback(document.createElement("div")).compile&&(e.isCompiler=!0),this.attrsConfig[e.datasetKey]=e}this.rootDatasetKeys=Object.keys(this.attrsConfig||{}).filter(e=>this.attrsConfig[e].isCompiler),this.mainDatasetKeys=this.getMainDatasetKeys(),this.buildAndInterpolate(document)}removeAllEvents(){for(const e of Object.keys(this.allPowerObjsById||{}))this.removeEventsOfObject(e);UEvent.index={}}removeEventsOfObject(e){for(const t of Object.keys(this.allPowerObjsById[e]||{}))if("$shared"!==t)for(const i of Object.keys(this.allPowerObjsById[e][t]._events))for(const s of this.allPowerObjsById[e][t]._events[i].observers)s.ctx.unsubscribe({event:i,fn:s.fn})}getMainDatasetKeys(){const e=[];for(const t of PowerUi._powerElementsConfig)t.isMain&&e.push(t.datasetKey);for(const t of Object.keys(this.attrsConfig||{}))this.attrsConfig[t].isMain&&e.push(this.attrsConfig[t].datasetKey);return e}datasetIsCompiler(e){for(const t of Object.keys(e||{}))if(this.rootDatasetKeys.includes(t))return!0;return!1}datasetIsMain(e){for(const t of Object.keys(e||{}))if(this.mainDatasetKeys.includes(t))return!0;return!1}buildAndInterpolate(e){this.sweepDOM({entryNode:e,callback:this.buildPowerObjects.bind(this),isInnerCompiler:!1}),this.$powerUi.interpolation.interpolateInOrder();const t=document.getElementsByTagName("BODY")[0];t.innerHTML=this.$powerUi.interpolation.replaceInterpolation(t.innerHTML,this.$powerUi)}buildPowerObjects({currentNode:e,main:t,view:i,isInnerCompiler:s,saved:o,rootCompiler:n,parent:r}){let a=!1,l=[];s=s||!1;let h=r=r||!1;o=o||{pending:[]};const d=t=t||!1,c=i=i||!1;let u=!1,p=!1;if(e.dataset)for(const o of Object.keys(e.dataset||{}))for(const h of["pwc","pow"]){o.startsWith(h)&&(a=this._compile({currentNode:e,datasetKey:o,isInnerCompiler:s,view:i}),a&&!s&&(n=e,p=!0),this.attrsConfig[o]&&this.attrsConfig[o].isMain&&(t=e,u=!0),l.push({datasetKey:o,currentElement:e,main:d,view:c,rootCompiler:s?n:null,isMain:u,isRootCompiler:p,parent:r,originalInnerHTML:a}))}if(e.className&&e.className.includes("power-"))for(const o of PowerUi._powerElementsConfig)e.classList.contains(o.name)&&(o.isMain&&(t=e,u=!0),"powerView"===o.datasetKey&&(i=e),l.push({datasetKey:o.datasetKey,currentElement:e,main:d,view:c,rootCompiler:s?n:null,isMain:u,parent:r}),h={node:e,datasetKey:o.datasetKey});if(!!e.children&&!!e.children.length&&(a||s?this.sweepDOM({entryNode:e,callback:this.buildPowerObjects.bind(this),isInnerCompiler:!0,main:t,view:i,rootCompiler:n,saved:o,parent:h}):this.sweepDOM({entryNode:e,callback:this.buildPowerObjects.bind(this),isInnerCompiler:!1,main:t,view:i,rootCompiler:n,saved:o,parent:h})),a&&!s){e.innerHTML=this.$powerUi.interpolation.compile({template:e.innerHTML,view:i});for(const e of o.pending)this._instanciateObj(e);o.pending=[]}if(l.length>0&&!a||a&&!s){for(const e of l)this._instanciateObj(e);l=[]}else for(const e of l)o.pending.push(e)}getEntryNodeWithParentsAndConfig(e){const t=document.getElementById(e),i=this._getParentElementFromChildElement(t),s=this._getMainElementFromChildElement(t),o=this.datasetIsMain(t.dataset),n=this._getViewElementFromChildElement(t),r=this._getRootCompilerElementFromChildElement(t,this);return{currentNode:t,parent:i,main:s,isMain:o,view:n,isInnerCompiler:r&&this.datasetIsCompiler(t.dataset),rootCompiler:r}}createAndInitObjectsFromCurrentNode({id:e}){const t=this.getEntryNodeWithParentsAndConfig(e);this.buildPowerObjects(t);const i=document.getElementById(e);i.innerHTML.includes("power-view")&&this.$powerUi.interpolation.interpolateInOrder(i);const s=this.$powerUi.controllers[i.id]?this.$powerUi.controllers[i.id].instance:this.$powerUi;i.innerHTML=this.$powerUi.interpolation.replaceInterpolation(i.innerHTML,s),this._callInitForObjectAndInners(document.getElementById(e))}_compile({currentNode:e,datasetKey:t,isInnerCompiler:i,view:s}){let o=!1;if(this.attrsConfig[t]&&this.attrsConfig[t].isCompiler&&!0==!e.getAttribute("data-pwhascomp")){const n=getIdAndCreateIfDontHave(e),r=this.attrsConfig[t].callback(e);r.id=n,r.$powerUi=this.$powerUi,o=!!i||(e.innerHTML||!0),r.compile({view:s}),r.element.setAttribute("data-pwhascomp",!0)}return o}_instanciateObj({currentElement:e,datasetKey:t,main:i,view:s,rootCompiler:o,isMain:n,isRootCompiler:r,parent:a,originalInnerHTML:l}){const h=getIdAndCreateIfDontHave(e),d=this.$powerUi[`_${t}`]?`_${t}`:"powerAttrs";let c;if("powerAttrs"===d){if(!this.attrsConfig[t])return;c=this.attrsConfig[t].callback(document.getElementById(h))}else c=this.$powerUi[d](document.getElementById(h));c.isMain=n||null,c.isRootCompiler=r||null,c.originalInnerHTML=l&&!0!==l?l:"",this._addToObjectsById({powerObject:c,id:h,datasetKey:t,main:i,view:s,rootCompiler:o,parent:a})}_addToObjectsById({powerObject:e,id:t,datasetKey:i,main:s,view:o,rootCompiler:n,parent:r}){if(this.allPowerObjsById[t]){const e=document.querySelectorAll(`[id=${t}]`);if(e.length>1)throw window.console.error("DUPLICATED IDs:",e),`HTML element can't have duplicated IDs: ${t}`}else this.allPowerObjsById[t]={};this.allPowerObjsById[t][i]||(this.allPowerObjsById[t][i]={}),this.allPowerObjsById[t][i]=e,this.allPowerObjsById[t][i].id=t,this.allPowerObjsById[t][i].datasetKey=i,this.allPowerObjsById[t][i].$powerCss=i,this.allPowerObjsById[t][i].$powerUi=this.$powerUi,this.allPowerObjsById[t].$shared||(this.allPowerObjsById[t].$shared=new SharedScope({id:t,main:s,view:o,rootCompiler:n,parent:r,ctx:this})),e.isRootCompiler&&(this.allPowerObjsById[t].$shared.isRootCompiler=e.isRootCompiler,this.allPowerObjsById[t].$shared.originalInnerHTML=e.originalInnerHTML),this.allPowerObjsById[t][i].$shared=this.allPowerObjsById[t].$shared}sweepDOM({entryNode:e,callback:t,isInnerCompiler:i,main:s,view:o,rootCompiler:n,saved:r,parent:a}){const l=!!e&&!!e.nodeType,h=!!e.children&&!!e.children.length;if(l&&h){e.children;for(const l of e.children)t({currentNode:l,callback:t,isInnerCompiler:i,main:s,view:o,rootCompiler:n,saved:r,parent:a})}else t({currentNode:e,callback:t,isInnerCompiler:i,main:s,view:o,rootCompiler:n,saved:r,parent:a})}_getAllInnerPowerCss(e){const t=[];for(const i of _PowerUiBase._powerElementsConfig){const s=e.getElementsByClassName(i.name);for(const e of s){const s=this.allPowerObjsById[e.id][i.datasetKey];t.push(s)}}return t}_getParentElementFromChildElement(e){const t=PowerTree._searchUpDOM(e,PowerTree._checkIfhavePowerParentElement);if(t.conditionResult)return t.powerElement}_getMainElementFromChildElement(e){const t=PowerTree._searchUpDOM(e,this._checkIfIsMainElement);if(t.conditionResult)return t.powerElement}_getViewElementFromChildElement(e){const t=PowerTree._searchUpDOM(e,this._checkIfIsViewElement);if(t.conditionResult)return t.powerElement}_getRootCompilerElementFromChildElement(e,t){const i=PowerTree._searchUpDOM(e,this._checkIfIsCompilerElement,t);if(i.conditionResult)return i.powerElement}_checkIfIsCompilerElement(e,t){let i=!1;return e&&e.dataset&&t.datasetIsCompiler(e.dataset)&&(i=!0),i}_checkIfIsMainElement(e){let t=!1;if(e&&e.className)for(const i of PowerUi._powerElementsConfig.filter(e=>!0===e.isMain))if(e.classList.contains(i.name)){t=!0;break}return t}_checkIfIsViewElement(e){return e&&e.className&&e.classList.contains("power-view")}_callInit(){for(const e of Object.keys(this.allPowerObjsById||{}))this._callInitOfObject(e)}_callInitOfObject(e){for(const t of Object.keys(this.allPowerObjsById[e]||{}))this.allPowerObjsById[e][t].init&&this.allPowerObjsById[e][t].init()}_callInitForObjectAndInners(e){e.id&&this._callInitOfObject(e.id);const t=e?e.children:[];for(const e of t)this._callInitForObjectAndInners(e)}}PowerTree._searchUpDOM=function(e,t,i){let s=e.className.includes("power-")?e:null,o=e.parentElement,n=!1,r=!o;for(;!r;)n=t(o,i),n&&(r=!0),o.className.includes("power-")&&(s=o),o.parentElement&&!r?o=o.parentElement:r=!0;return{powerElement:s,conditionResult:n}},PowerTree._checkIfhavePowerParentElement=function(e){let t=!1;return e.className.includes("power-")&&(t=!0),t};class _pwBasicHover extends _PowerBasicElementWithEvents{constructor(e){super(e),this._$pwActive=!1}init(){this.$_pwDefaultValue||(this.$_pwDefaultValue=this.element[this.$_target]),this.$_pwHoverValue||(this.$_pwHoverValue=this.element.getAttribute(this.$_pwAttrName)||""),this.subscribe({event:"mouseover",fn:this.mouseover}),this.subscribe({event:"mouseout",fn:this.mouseout})}mouseover(){this._$pwActive||(this.element[this.$_target]=this.$_pwHoverValue,this.toggle(),this.$shared._priorityActive=!0)}mouseout(e){this._$pwActive&&(this.element[this.$_target]=this.$_pwDefaultValue||"",this.toggle(),this.$shared._priorityActive=!1)}}class _pwMainBasicHover extends _pwBasicHover{constructor(e,t,i){super(e,t,i)}mouseover(){this._$pwActive||this.$shared._priorityActive||(this.element[this.$_target]=this.$_pwHoverValue,this.toggle())}mouseout(){this._$pwActive&&(this.element[this.$_target]=this.$_pwDefaultValue||"",this.toggle())}addEventListener(e,t,i){this.$pwMain.subscribe({event:e,fn:t,useCapture:i})}removeEventListener(e,t,i){this.$pwMain.unsubscribe({event:e,fn:t,useCapture:i})}}class PowCssHover extends _PowerBasicElementWithEvents{constructor(e){super(e),this._$pwActive=!1,this.$_pwAttrName="data-pow-css-hover"}init(){this.$_pwHoverValues||(this.$_pwHoverValues=this.element.getAttribute(this.$_pwAttrName).split(" ")||[]),this.subscribe({event:"mouseover",fn:this.mouseover}),this.subscribe({event:"mouseout",fn:this.mouseout})}mouseover(){if(!this._$pwActive&&!this.$shared._priorityActive){for(const e of this.$_pwHoverValues)this.element.classList.add(e);this.toggle(),this.$shared._priorityActive=!0}}mouseout(){if(this._$pwActive){for(const e of this.$_pwHoverValues)this.element.classList.remove(e);this.toggle(),this.$shared._priorityActive=!1}}}_PowerUiBase.injectPow({name:"data-pow-css-hover",callback:function(e){return new PowCssHover(e)}});class PowMainCssHover extends PowCssHover{constructor(e){super(e),this.$_pwAttrName="data-pow-main-css-hover"}mouseover(){if(!this._$pwActive&&!this.$shared._priorityActive){for(const e of this.$_pwHoverValues)this.element.classList.add(e);this.toggle()}}mouseout(){if(this._$pwActive){this.toggle();for(const e of this.$_pwHoverValues)this.element.classList.remove(e)}}addEventListener(e,t,i){this.$pwMain.subscribe({event:e,fn:t,useCapture:i})}removeEventListener(e,t,i){this.$pwMain.unsubscribe({event:e,fn:t,useCapture:i})}}_PowerUiBase.injectPow({name:"data-pow-main-css-hover",isMain:!0,callback:function(e){return new PowMainCssHover(e)}});class PowSrcHover extends _pwBasicHover{constructor(e){super(e),this.$_pwAttrName="data-pow-src-hover",this.$_target="src"}}_PowerUiBase.injectPow({name:"data-pow-src-hover",callback:function(e){return new PowSrcHover(e)}});class PowMainSrcHover extends _pwMainBasicHover{constructor(e){super(e),this.$_pwAttrName="data-pow-main-src-hover",this.$_target="src"}}_PowerUiBase.injectPow({name:"data-pow-main-src-hover",isMain:!0,callback:function(e){return new PowMainSrcHover(e)}});class PowCssHoverRemove extends PowCssHover{constructor(e){super(e),this.$_pwAttrName="data-pow-css-hover-remove"}mouseover(){if(!this._$pwActive){for(const e of this.$_pwHoverValues)this.element.classList.remove(e);this.toggle(),this.$shared._priorityActive=!0}}mouseout(){if(this._$pwActive){for(const e of this.$_pwHoverValues)this.element.classList.add(e);this.toggle(),this.$shared._priorityActive=!1}}}_PowerUiBase.injectPow({name:"data-pow-css-hover-remove",callback:function(e){return new PowCssHoverRemove(e)}});class PowMainCssHoverRemove extends PowMainCssHover{constructor(e){super(e),this.$_pwAttrName="data-pow-main-css-hover-remove"}mouseover(){if(!this._$pwActive&&!this.$shared._priorityActive){for(const e of this.$_pwHoverValues)this.element.classList.remove(e);this.toggle()}}mouseout(){if(this._$pwActive&&!this.$shared._priorityActive){for(const e of this.$_pwHoverValues)this.element.classList.add(e);this.toggle()}}}function othersInit(e){e.element.value=e.currentValue,e.subscribe({event:"change",fn:e.onchange})}function othersChange(e){e.currentValue=e.element.value}function checkboxInit(e){const t=e.element;!0===e.currentValue?t.checked="checked":delete t.checked,e.subscribe({event:"change",fn:e.onchange})}function checkboxChange(e){e.currentValue=!e.currentValue}function radioInit(e){const t=e.element;e.currentValue===t.value?t.checked=!0:t.checked=!1,e.subscribe({event:"change",fn:e.onchange})}function radioChange(e){!0===e.element.checked&&(e.currentValue=e.element.value)}function selectMultipleInit(e){const t=e.element;for(const i of t.children)e.currentValue.includes(i.value)?i.selected=!0:i.selected=!1;e.subscribe({event:"change",fn:e.onchange})}function selectOneInit(e){const t=e.element;for(const i of t.children)e.currentValue===i.value?i.selected=!0:i.selected=!1;e.subscribe({event:"change",fn:e.onchange})}function selectMultipleChange(e){const t=e.element;for(const i of t.children)if(i.selected)e.currentValue.includes(i.value)||e.currentValue.push(i.value);else{const t=e.currentValue.indexOf(i.value);t>-1&&e.currentValue.splice(t,1)}}_PowerUiBase.injectPow({name:"data-pow-main-css-hover-remove",isMain:!0,callback:function(e){return new PowMainCssHoverRemove(e)}});class PowBind extends _PowerBasicElementWithEvents{constructor(e){super(e),this._$pwActive=!1,this.originalHTML=e.innerHTML}init(){const e=this.$pwView;this.ctrlScope=!!(e&&e.id&&this.$powerUi.controllers[e.id])&&this.$powerUi.controllers[e.id].instance,this.type=this.element.type,"checkbox"===this.type?checkboxInit(this):"radio"===this.type?radioInit(this):"select-one"===this.type?selectOneInit(this):"select-multiple"===this.type?selectMultipleInit(this):othersInit(this)}onchange(e){"checkbox"===this.type?checkboxChange(this):"radio"===this.type?radioChange(this):"select-multiple"===this.type?selectMultipleChange(this):othersChange(this)}get currentValue(){return this.$powerUi.safeEval({text:this.$powerUi.interpolation.decodeHtml(this.element.dataset.powBind),$powerUi:this.$powerUi,scope:this.ctrlScope})}set currentValue(e){this.$powerUi.setValueOnScope({text:this.$powerUi.interpolation.decodeHtml(this.element.dataset.powBind),$powerUi:this.$powerUi,scope:this.ctrlScope,valueToSet:e})}}_PowerUiBase.injectPow({name:"data-pow-bind",callback:function(e){return new PowBind(e)}});class PowEval extends _PowerBasicElementWithEvents{constructor(e){super(e),this._$pwActive=!1}compile({view:e}){const t=!!(e&&e.id&&this.$powerUi.controllers[e.id])&&this.$powerUi.controllers[e.id].instance;this.element.innerHTML=this.$powerUi.interpolation.getDatasetResult(this.element.dataset.powEval,t)}}_PowerUiBase.injectPow({name:"data-pow-eval",callback:function(e){return new PowEval(e)}});class PowEvent extends _PowerBasicElementWithEvents{constructor(e){super(e),this._$pwActive=!1}compile({view:e}){!!(e&&e.id&&this.$powerUi.controllers[e.id])&&this.$powerUi.controllers[e.id].instance;for(const t of this.element.attributes)if(t.name.includes("on")&&!t.name.includes("data")){const i=t.name.slice(2,t.name.length);this.element.setAttribute(`data-pow-${i}`,this.$powerUi.interpolation.encodeHtml(t.value)),t.value=`window._$dispatchPowerEvent(event, this, '${e.id}', '${i}')`}}}_PowerUiBase.injectPow({name:"data-pow-event",callback:function(e){return new PowEvent(e)}});class PowFor extends _PowerBasicElementWithEvents{constructor(e){super(e),this._$pwActive=!1,this._pwEvaluateValue=""}compile({view:e}){if(!this.element.dataset.powFor)return;const t=this.$powerUi.interpolation.decodeHtml(this.element.dataset.powFor).split(" "),i=`\\b(${t[0]})\\b`,s=t[1];t.shift(),t.shift();let o=t.join(" ");const n=!!(e&&e.id&&this.$powerUi.controllers[e.id])&&this.$powerUi.controllers[e.id].instance;o=this.$powerUi.safeEval({text:o,$powerUi:this.$powerUi,scope:n}),"of"===s?this.forOf(i,o):this.forIn(i,o)}forOf(e,t){let i="",s=0;for(const o of t||[]){const t=_Unique.scopeID();let n=this.$powerUi.interpolation.replaceWith({entry:this.element.innerHTML,oldValue:"\\$pwIndex",newValue:s});s+=1,this.$powerUi._tempScope[t]=o,i+=this.$powerUi.interpolation.replaceWith({entry:n,oldValue:e,newValue:this.$powerUi.interpolation.encodeHtml(`_tempScope['${t}']`)})}this.element.innerHTML=i}forIn(e,t){let i="",s=0;for(const o of Object.keys(t||{})){const n=_Unique.scopeID();let r=this.$powerUi.interpolation.replaceWith({entry:this.element.innerHTML,oldValue:"\\$pwKey",newValue:`'${o}'`});r=this.$powerUi.interpolation.replaceWith({entry:r,oldValue:"\\$pwIndex",newValue:s}),s+=1,this.$powerUi._tempScope[n]=t[o],i+=this.$powerUi.interpolation.replaceWith({entry:r,oldValue:e,newValue:this.$powerUi.interpolation.encodeHtml(`_tempScope['${n}']`)})}this.element.innerHTML=i}}_PowerUiBase.injectPow({name:"data-pow-for",callback:function(e){return new PowFor(e)}});class PowIf extends _PowerBasicElementWithEvents{constructor(e){super(e),this._$pwActive=!1,this.originalHTML=e.innerHTML}compile({view:e}){const t=!!(e&&e.id&&this.$powerUi.controllers[e.id])&&this.$powerUi.controllers[e.id].instance;!1===this.$powerUi.safeEval({text:this.$powerUi.interpolation.decodeHtml(this.element.dataset.powIf),$powerUi:this.$powerUi,scope:t})?(this.element.style.display="none",this.element.innerHTML=""):(this.element.style.display=null,this.element.innerHTML=this.originalHTML)}}function defineInnerDropmenusPosition(e,t){t.defaultPosition||(e.element.classList.contains("pw-bottom")?t.defaultPosition="right-top":e.element.classList.contains("pw-right")?t.defaultPosition="left-bottom":(e.element.classList.contains("pw-left"),t.defaultPosition="right-bottom"))}function defineRootDropmenusPosition(e,t){t.defaultPosition||(e.defaultPosition?t.defaultPosition=e.defaultPosition:e.element.classList.contains("pw-bottom")?t.defaultPosition="top-right":e.element.classList.contains("pw-right")?t.defaultPosition="left-bottom":e.element.classList.contains("pw-left")?t.defaultPosition="right-bottom":t.defaultPosition="bottom-right")}_PowerUiBase.injectPow({name:"data-pow-if",callback:function(e){return new PowIf(e)}});class watchInputUntilThen{constructor(e,t,i){this.element=e,this.condition=t,this.than=i,this.whatch()}whatch(){const e=this;e.interval=setInterval((function(){e.condition(e.element)&&(e.than(e.element),clearInterval(e.interval))}),300)}}class KeyboardManager{constructor(e){document.onkeydown=this.checkKey.bind(this),document.onkeyup=this.checkKey.bind(this),this.$powerUi=e,this.keyModeIsOn=!1}getRootElements(){return this.$powerUi.powerTree.rootElements}setKeyModeOn(){if(!1===this.keyModeIsOn){this.keyModeIsOn=!0,this.createBackDrop();for(const e of this.getRootElements()){"static"===getComputedStyle(e.element).position&&e.element.classList.add("power-keyboard-position"),e.element.classList.add("power-keyboard-mode")}window.console.log("Keyboard mode ON")}}createBackDrop(){this.backdrop=document.createElement("DIV"),this.backdrop.classList.add("power-keyboard-backdrop"),document.body.appendChild(this.backdrop)}removeBackdrop(){document.body.removeChild(this.backdrop)}setKeyModeOff(){if(this.keyModeIsOn){this.removeBackdrop(),this._17=!1,this._48=!1,this._96=!1,this.keyModeIsOn=!1,window.console.log("Keyboard mode OFF");for(const e of this.getRootElements())e.element.classList.remove("power-keyboard-mode"),e.element.classList.remove("power-keyboard-position")}}checkKey(e){27===(e=e||window.event).keyCode&&this.setKeyModeOff(),"keydown"===e.type?this[`_${e.keyCode}`]=!0:this[`_${e.keyCode}`]=!1,this._17&&(this._48||this._96)&&this.setKeyModeOn()}}class ComponentsManager{constructor(e){this.$powerUi=e,this.bars=[],this.observing={},this.startObserver()}observe(e){this.observing[e.id]=e,this.observing[e.id].lastWidth=e.element.offsetWidth,this.observing[e.id].lastHeight=e.element.offsetHeight}stopObserve(e){this.observing[e.id]=null,delete this.observing[e.id]}restartObserver(){this.interval>=500&&(this.interval=300,this.startObserver())}runObserverFewTimes(e){this.interval=e||300,this.startObserver(),this.interval=400}observerInterval(){const e=this;return e.interval=e.interval||10,setInterval((function(){e.runObserver(),clearInterval(e._observerInterval),e.interval=e.interval+25,e.interval<=500&&e.startObserver()}),e.interval)}startObserver(){this.hasChange=!1,clearInterval(this._observerInterval),this._observerInterval=this.observerInterval()}runObserver(){for(const e of Object.keys(this.observing)){const t=this.observing[e]._$pwActive,i=this.observing[e].lastWidth,s=this.observing[e].element.offsetWidth,o=this.observing[e].lastHeight,n=this.observing[e].element.offsetHeight;t||(i&&o&&(i!==s||o!==n)&&(this.hasChange=!0),this.observing[e].isToolbar&&this.observing[e].powerAction.element.offsetLeft>this.observing[e].element.offsetWidth&&(this.hasChange=!0),!this.observing[e].isSplitBar||!this.observing[e].isWindowFixed||"top"!==this.observing[e].barPosition&&"bottom"!==this.observing[e].barPosition||!this.observing[e].adjustBarSizeIfNeeded||this.observing[e]._window&&"pw-bar-break"===this.observing[e]._window.currentBarBreakQuery||this.observing[e].adjustBarSizeIfNeeded()),this.hasChange&&this.observing[e].setStatus&&this.observing[e].setStatus(),this.observing[e].lastWidth=s,this.observing[e].lastHeight=n}this.hasChange&&(this.onBarSizeChange(),this.hasChange=!1)}toggleSmallWindowMode(){const e=document.getElementById("app-container");window.innerWidth<=768||this.$powerUi.touchdevice?(!0!==this.smallWindowMode&&(this.smallWindowMode=!0,this.$powerUi.windowModeChange.broadcast()),this.smallWindowMode=!0,e.classList.add("pw-small-window-mode")):(!0===this.smallWindowMode&&(this.smallWindowMode=!1,this.$powerUi.windowModeChange.broadcast()),this.smallWindowMode=!1,e.classList.remove("pw-small-window-mode"))}onBarSizeChange(){for(const e of this.bars)if(e.bar._$pwActive)return;this._basicRefresh();for(const e of this.$powerUi.dialogs)e.ctrl.isWindow&&(e.ctrl.adjustWindowWithComponents(),e.ctrl.changeWindowBars())}_browserWindowResize(){for(const e of this.bars)if(e.bar._$pwActive)return void e.bar.powerAction.toggle();this._basicRefresh()}_orientationChange(){this._browserWindowResize()}_routeChange(){this._basicRefresh();const e=this;setTimeout((function(){e._basicRefresh(),setTimeout((function(){e._basicRefresh()}),300)}),200)}_basicRefresh(){this.setFixedBarsSizeAndPosition(),this._addMarginToBody(),this._setAppContainerHeight(),this.toggleSmallWindowMode()}powerWindowChange(){this.setFixedBarsSizeAndPosition()}_setAppContainerHeight(){document.getElementById("app-container").style.height=window.innerHeight-this.topTotalHeight-this.bottomTotalHeight+"px"}_addMarginToBody(){const e=document.body;e.style["margin-top"]=this.topTotalHeight+"px",e.style["margin-left"]=this.leftTotalWidth+"px",e.style["margin-right"]=this.rightTotalWidth+"px"}_reorderBars(e){let t=e.length+20;e.sort((function(e,i){return e.bar.priority||(e.bar.priority=t,t+=1),i.bar.priority||(i.bar.priority=t,t+=1),e.bar.priority>i.bar.priority?1:-1}))}getBarsWithPrioritySizes(e){this._reorderBars(e);let t=0,i=0,s=0,o=0;for(const n of e)n.bar._$pwActive&&n.bar.powerAction.toggle(),n.adjusts={},n.adjusts.top=t,n.adjusts.bottom=i,n.adjusts.left=s,n.adjusts.right=o,"top"===n.bar.barPosition?t+=n.bar.element.offsetHeight:"bottom"===n.bar.barPosition?i+=n.bar.element.offsetHeight:"left"===n.bar.barPosition?s+=n.bar.element.offsetWidth:"right"===n.bar.barPosition&&(o+=n.bar.element.offsetWidth);return e}setFixedBarsSizeAndPosition(){const e=this.bars.filter(e=>!0===e.bar.isFixed&&"hidden"!==window.getComputedStyle(e.bar.element).visibility),t={titleBarEl:{offsetHeight:0},defaultBorderSize:0,_currentTop:0,_currentBottom:0,_currentLeft:0,_currentWidth:window.innerWidth,_currentHeight:window.innerHeight};this.setWindowBarsSizeAndPosition(e,t,this,!1)}setWindowBarsSizeAndPosition(e,t,i,s){e=this.getBarsWithPrioritySizes(e),i.topTotalHeight=0,i.bottomTotalHeight=0,i.leftTotalWidth=0,i.rightTotalWidth=0,i.totalHeight=0;let o=1e3+e.length;for(const n of e){if(n.zIndex=o,o-=1,n.bar.element.style.zIndex=o,"top"===n.bar.barPosition&&(i.totalHeight=i.totalHeight+n.bar.element.offsetHeight,i.topTotalHeight=i.topTotalHeight+n.bar.element.offsetHeight,n.bar.element.style.top=t._currentTop+t.defaultBorderSize+t.titleBarEl.offsetHeight+n.adjusts.top+"px",n.bar.element.style.left=t._currentLeft+t.defaultBorderSize+n.adjusts.left+"px",n.bar.element.style.width=null,n.bar.element.style.width=t._currentWidth-(n.adjusts.left+n.adjusts.right+this.$powerUi._offsetComputedAdjustSides(n.bar.element))+"px"),"bottom"===n.bar.barPosition){i.totalHeight=i.totalHeight+n.bar.element.offsetHeight,i.bottomTotalHeight=i.bottomTotalHeight+n.bar.element.offsetHeight,n.bar.element.style.left=t._currentLeft+t.defaultBorderSize+n.adjusts.left+"px",n.bar.element.style.width=null,n.bar.element.style.width=t._currentWidth-(n.adjusts.left+n.adjusts.right+this.$powerUi._offsetComputedAdjustSides(n.bar.element))+"px";const e=-(t._currentBottom+t._currentHeight)+window.innerHeight;n.bar.element.style.bottom=e+n.adjusts.bottom-t.defaultBorderSize+"px"}if("left"===n.bar.barPosition){i.leftTotalWidth=i.leftTotalWidth+n.bar.element.offsetWidth,n.bar.element.style.left=t._currentLeft+t.defaultBorderSize+n.adjusts.left+"px",n.bar.element.style.top=t._currentTop+t.defaultBorderSize+t.titleBarEl.offsetHeight+n.adjusts.top+"px",n.bar.element.style.height=null;const e=t._currentHeight-t.titleBarEl.offsetHeight-(n.adjusts.top+n.adjusts.bottom+this.$powerUi._offsetComputedAdjustTopBottom(n.bar.element))+"px";n.bar.element.style.height=e}if("right"===n.bar.barPosition){i.rightTotalWidth=i.rightTotalWidth+n.bar.element.offsetWidth;const e=-(t._currentLeft+t._currentWidth+t.defaultBorderSize)+window.innerWidth;n.bar.element.style.right=e+n.adjusts.right+"px",n.bar.element.style.top=t._currentTop+t.defaultBorderSize+t.titleBarEl.offsetHeight+n.adjusts.top+"px",n.bar.element.style.height=null;const s=t._currentHeight-t.titleBarEl.offsetHeight-(n.adjusts.top+n.adjusts.bottom+this.$powerUi._offsetComputedAdjustTopBottom(n.bar.element))+"px";n.bar.element.style.height=s}n.bar.isToolbar&&n.bar.setStatus(),s&&this.adjustWindowBody(t)}}setWindowFixedBarsSizeAndPosition(e,t){this.setWindowBarsSizeAndPosition(e,t,t,!0)}adjustWindowBody(e){e.bodyEl.style["margin-top"]=e.topTotalHeight+"px",e.bodyEl.style["margin-left"]=e.leftTotalWidth+"px",e.bodyEl.style.height=e._currentHeight-e.titleBarEl.offsetHeight-e.totalHeight+"px",e.bodyEl.style["min-height"]=e._minHeight-e.totalHeight-e.titleBarEl.offsetHeight+"px",e._dialog.style["min-height"]=e.defaultMinHeight+e.titleBarEl.offsetHeight+e.topTotalHeight+"px",e._minHeight=e.defaultMinHeight+e.titleBarEl.offsetHeight+e.totalHeight;const t=e._currentWidth-(e.rightTotalWidth+e.leftTotalWidth)+"px";e.bodyEl.style.width=t,e.bodyEl.style["min-width"]=t}}class PowerUi extends _PowerUiBase{constructor(e){if(super(),e.devMode){this.devMode=e.devMode;window.location.href.startsWith(e.devMode.target);const t=window.location.href.startsWith(e.devMode.source);this.devMode.child&&window.location.href.indexOf("isEditable")>-1&&(this.devMode.isEditable=!0),window.addEventListener("message",i=>{if(i.origin.startsWith(e.devMode.source)||i.origin.startsWith(e.devMode.target)){if(this.devMode.child&&this.devMode.isEditable&&t)if("addInnerHTML"===i.data.command){const e=document.getElementById(i.data.id);e.innerHTML=e.innerHTML+i.data.value}else if("replaceInnerHTML"===i.data.command){document.getElementById(i.data.id).innerHTML=i.data.value}else if("addClassList"===i.data.command){document.getElementById(i.data.id).classList.add(i.data.value)}else if("removeClassList"===i.data.command){document.getElementById(i.data.id).classList.remove(i.data.value)}else if("reloadRoot"===i.data.command){this.getRouteCtrl("$root").reload()}if(this.devMode.main){const e=this.getRouteCtrl("$root");if(e._$filesByRouteId||(e._$filesByRouteId={}),"loadFile"===i.data.command){if(e._$filesByRouteId[i.data.routeId]||(e._$filesByRouteId[i.data.routeId]={}),!e._$filesByRouteId[i.data.routeId][i.data.fileName]){if(e._$filesByRouteId[i.data.routeId][i.data.fileName]={source:i.data},!e._$selectRouteFilesToEdit||".html"!==i.data.extension&&".htm"!==i.data.extension){if(e._$selectRouteFilesToEdit&&".json"===i.data.extension&&""!==i.data.template){const t=(new DOMParser).parseFromString(i.data.template,"text/html");e._$filesByRouteId[i.data.routeId][i.data.fileName].template=t.body}}else{const t=e._$filesByRouteId[i.data.routeId][i.data.fileName].source,s=(new DOMParser).parseFromString(t.content,"text/html");e._$filesByRouteId[i.data.routeId][i.data.fileName].template=s.body}e._$selectRouteFilesToEdit(i.data)}}else"selectNodeToEdit"===i.data.command&&e._$selectNodeToEdit?e._$selectNodeToEdit(i.data):"setCurrentBody"===i.data.command&&e._$setCurrentBody?e._$setCurrentBody(i.data):"setChildApp"===i.data.command&&e._$setChildApp&&e._$setChildApp(i.data)}}else window.console.log("DANGER",i.origin)})}if(window._$dispatchPowerEvent=this._$dispatchPowerEvent,this.touchdevice=!!(navigator.maxTouchPoints||"ontouchstart"in document.documentElement),this.controllers={},this.dialogs=[],this.JSONById={},this._Unique=_Unique,this.UEvent=UEvent,this.addScopeEventListener(),this.numberOfopenModals=0,this.ctrlWaitingToRun=[],this.config=e,this.waitingViews=0,this.waitingInit=[],this.initAlreadyRun=!1,this._services=e.services||{},this._addPowerServices(),this.onFixedPowerSplitBarChange=new UEvent("onFixedPowerSplitBarChange"),this.onPowerWindowChange=new UEvent("onPowerWindowChange"),this.componentsManager=new ComponentsManager(this),this.interpolation=new PowerInterpolation(e,this),this._events={},this._events.ready=new UEvent,this._events.Escape=new UEvent,this.windowModeChange=new UEvent("windowModeChange"),this.request=new Request({config:e,$powerUi:this}),this.componentsManager.toggleSmallWindowMode(),this.onBrowserWindowResize=new UEvent("onBrowserWindowResize"),this.onBrowserWindowResize.subscribe(this.componentsManager._browserWindowResize.bind(this.componentsManager)),this.touchdevice&&(this.onBrowserOrientationChange=new UEvent("onBrowserOrientationChange"),this.onBrowserOrientationChange.subscribe(this.componentsManager._orientationChange.bind(this.componentsManager)),window.addEventListener("orientationchange",()=>this.onBrowserOrientationChange.broadcast())),window.addEventListener("resize",()=>this.onBrowserWindowResize.broadcast()),this.router=new Router(e,this),this.router.onRouteChange.subscribe(this.componentsManager.runObserver.bind(this.componentsManager)),this.router.onRouteChange.subscribe(this.componentsManager._routeChange.bind(this.componentsManager)),this.onPowerWindowChange.subscribe(this.componentsManager.powerWindowChange.bind(this.componentsManager)),document.addEventListener("keyup",this._keyUp.bind(this),!1),this._events.ready.subscribe(()=>this.onBrowserWindowResize.broadcast()),!document.getElementById("app-container"))throw'Missing element with "app-container" id! Check PowerUi documentation for more detais.'}simpleSweepDOM(e,t,i,s){const o=!!e&&!!e.nodeType,n=!!e.children&&!!e.children.length;if(s=s?s+".":"",s+=i=i||0,o&&(t(e,s),n)){let i=0;for(const o of e.children)this.simpleSweepDOM(o,t,i,s),i+=1}}getCurrentElementCtrl(e){return e.classList&&e.classList.contains("power-view")&&this.controllers[e.id]?this.controllers[e.id].instance:e.parentNode?this.getCurrentElementCtrl(e.parentNode):null}treeTemplate(e){return new PowerTreeTemplate({$powerUi:this,tree:e}).template}treeTemplatePlus(e){return new PowerTreeTemplate({$powerUi:this,tree:e,boilerplate:!0}).template}removeRouteFromHash(e,t,i){const s=this.router.getOpenedRoute({routeId:t,viewId:i}),o=decodeURI(e).split("?");let n=0,r="";for(let e of o)e.includes(s.route)||(e=0!==n?"?"+e:e.replace(this.router.config.rootPath,""),r+=e,n+=1);return r}closeAllSecondaryRoutes(e=!1){const t=this.router.locationHashWithHiddenRoutes();let i=t;for(const e of this.router.currentRoutes.secondaryRoutes){const t=this.controllers[e.viewId]&&this.controllers[e.viewId].instance?this.controllers[e.viewId].instance:null;if(!t)return void(window.location.hash="!/");i=this.removeRouteFromHash(i,t._routeId,t._viewId)}if(!1!==e||t===i)return i;this.router.navigate({hash:i,title:null})}closeAllHiddenRoutes(e=!1){const t=this.router.locationHashWithHiddenRoutes();let i=e||t;for(const e of this.router.currentRoutes.hiddenRoutes){const t=this.controllers[e.viewId]&&this.controllers[e.viewId].instance?this.controllers[e.viewId].instance:null;if(!t)return void(window.location.hash="!/");i=this.removeRouteFromHash(i,t._routeId,t._viewId)}t!==i&&this.router.navigate({hash:i,title:null})}closeAllRoutes(){const e=this.closeAllSecondaryRoutes(!0);this.closeAllHiddenRoutes(e)}getCookie(e){const t=e+"=",i=document.cookie.split(";");for(var s=0;s<i.length;s++){for(var o=i[s];" "==o.charAt(0);)o=o.substring(1,o.length);if(0==o.indexOf(t))return o.substring(t.length,o.length)}return null}setCookie({name:e,value:t,days:i,domain:s,path:o,SameSite:n}){var r="";if(i){var a=new Date;a.setTime(a.getTime()+24*i*60*60*1e3),r=";expires="+a.toUTCString()}document.cookie=e+"="+(t||"")+r+`;${s?"domain="+s+";":""}path=${o||"/"}; SameSite=${n||""};`}removeCookie({name:e,value:t,domain:i,path:s}){document.cookie=`${e}=${t||""};${i?"domain="+i+";":""}Max-Age=-99999999;path=${s||"/"};`}_addService(e,t){this._services[e]=t}_addPowerServices(){this._addService("widget",{component:WidgetService}),this._addService("JSONSchema",{component:JSONSchemaService})}_$dispatchPowerEvent(e,t,i,s){document.dispatchEvent(new CustomEvent("pwScope",{detail:{viewId:i,elementId:t.id,attrName:s,event:e}}))}_keyUp(e){"Escape"!=e.key&&27!=e.keyCode||this._events.Escape.popBroadcast()}addScopeEventListener(){document.removeEventListener("pwScope",this.pwScope.bind(this),!1),document.addEventListener("pwScope",this.pwScope.bind(this),!1)}pwScope(e){const t=this,i=!!(e&&e.detail&&e.detail.viewId&&t.controllers[e.detail.viewId])&&t.controllers[e.detail.viewId].instance;if(!1===i)return;i.event=e.detail.event,i.elementId=e.detail.elementId;const s=!!(e&&e.detail&&e.detail.elementId)&&document.getElementById(e.detail.elementId);i._node=s;const o=!!(e&&e.detail&&e.detail.attrName)&&`data-pow-${e.detail.attrName}`,n=!(!s||!o)&&this.interpolation.decodeHtml(s.getAttribute(o));n&&t.safeEval({text:n,$powerUi:t,scope:i})}safeEval({text:e,scope:t}){return new ParserEval({text:e,scope:t,$powerUi:this}).currentValue}setValueOnScope({text:e,scope:t,valueToSet:i}){new ParserEval({text:e,scope:t,$powerUi:this,valueToSet:i})}getObjectOnScope({text:e,scope:t}){return new ParserEval({text:e,scope:t,$powerUi:this}).currentValue}initAll(){this.initAlreadyRun&&this.powerTree.removeAllEvents(),this._createPowerTree(),this.tmp={dropmenu:{},bar:{}},this.initAlreadyRun=!0;for(const e of this.waitingInit)document.getElementById(e.node.id).style.visibility=null;this.waitingInit=[]}initNodes(){const e=[];for(const t of this.waitingInit)for(const i of this.waitingInit)if(t.viewId!==i.viewId){t.node.contains(i.node)&&e.push(i.viewId)}this.waitingInit=this.waitingInit.filter(t=>!e.includes(t.viewId));for(const e of this.waitingInit)this.powerTree.createAndInitObjectsFromCurrentNode({id:e.node.id}),document.getElementById(e.node.id).style.visibility=null;this.waitingInit=[]}prepareViewToLoad({viewId:e,routeId:t}){const i=document.getElementById(e);return this.waitingInit.push({node:i,viewId:e}),i}loadTemplateUrl({template:e,viewId:t,currentRoutes:i,routeId:s,routes:o,title:n,loadViewInOrder:r,orderedRoutesToOpen:a,routeIndex:l,ctx:h,_resolve:d}){const c=this,u=this.prepareViewToLoad({viewId:t,routeId:s});this.request({url:e,method:"GET",status:"Loading page"}).then((function(i,p){e=p.responseText,c.buildViewTemplateAndMayCallInit({self:c,view:u,template:e,routeId:s,viewId:t,title:n,loadViewInOrder:r,orderedRoutesToOpen:a,routeIndex:l,ctx:h,_resolve:d});const m=o[s];!0!==m.avoidCacheTemplate?(m.template=p.responseText,m.templateIsCached=!0):m.templateIsCached=!1})).catch((function(e,t){window.console.log("ERROR loading templateURL:",e)}))}loadTemplateComponent({template:e,viewId:t,currentRoutes:i,routeId:s,routes:o,title:n,$ctrl:r,loadViewInOrder:a,orderedRoutesToOpen:l,routeIndex:h,ctx:d,_resolve:c}){const u=this,p=this.prepareViewToLoad({viewId:t,routeId:s}),m=new e({$powerUi:this,viewId:t,routeId:s,$ctrl:r});r.$tscope=m.component,o[s].$tscope=m.component,m.template.then((function(i){e=i,u.buildViewTemplateAndMayCallInit({self:u,view:p,template:e,routeId:s,viewId:t,title:n,loadViewInOrder:a,orderedRoutesToOpen:l,routeIndex:h,ctx:d,_resolve:c})})).catch((function(e,t){window.console.log("ERROR loading templateComponent:",e)}))}loadTemplate({template:e,viewId:t,currentRoutes:i,routeId:s,routes:o,title:n,loadViewInOrder:r,orderedRoutesToOpen:a,routeIndex:l,ctx:h,_resolve:d}){const c=this.prepareViewToLoad({viewId:t,routeId:s});o[s].$tscope&&(this.controllers[t].instance.$tscope=o[s].$tscope),this.buildViewTemplateAndMayCallInit({self:this,view:c,template:e,routeId:s,viewId:t,title:n,loadViewInOrder:r,orderedRoutesToOpen:a,routeIndex:l,ctx:h,_resolve:d})}callInitViews(){this.initAlreadyRun?this.initNodes():this.initAll(),this._events.ready.broadcast("ready")}buildViewTemplateAndMayCallInit({self:e,view:t,template:i,routeId:s,viewId:o,title:n,loadViewInOrder:r,orderedRoutesToOpen:a,routeIndex:l,ctx:h,_resolve:d}){e.controllers[o]&&e.controllers[o].instance&&e.controllers[o].instance.isWidget&&(e.controllers[o].instance.init&&e.controllers[o].instance.init(),i=e.controllers[o].instance.$buildTemplate({template:i,title:n})),t.innerHTML=i;const c=e.controllers[o].instance&&e.controllers[o].instance.$tscope?e.controllers[o].instance&&e.controllers[o].instance.$tscope:null,u=document.getElementById(o);if(c&&u){if(c.$classList&&c.$classList.length)for(const e of c.$classList)u.classList.add(e);if(c.$routeClassList)for(const e of Object.keys(c.$routeClassList)){const t=c.$ctrl.getRouteCtrl(e),i=t?t._viewId:null,s=i?document.getElementById(i):null;if(s)for(const t of c.$routeClassList[e])s.classList.add(t)}}a&&r(a,l,h,d)}removeCss(e,t){document.getElementById(e).classList.remove(t)}addCss(e,t){document.getElementById(e).classList.add(t)}onFormError({id:e,msg:t}){const i=document.getElementById(e),s=i.parentNode;s.classList.add("pw-has-error");const o=s.getElementsByClassName("pw-control-helper")||null,n=o?o[0]:null;n&&(n.innerText=t);const r=i.value;new watchInputUntilThen(i,(function(e){let t=!1;return e.value!==r&&(t=!0),t}),(function(e){s&&s.classList.remove("pw-has-error"),n&&(n.innerText="")}))}sanitizeHTML(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}getRouteCtrl(e){for(const t of Object.keys(this.controllers)){const i=this.controllers[t];if(i.instance&&i.instance._routeId===e)return i.instance}return null}getViewCtrl(e){for(const t of Object.keys(this.controllers)){const i=this.controllers[t];if(i.instance&&i.instance._viewId===e)return i.instance}return null}_powerView(e){return new PowerView(e,this)}_powerMenu(e){return new PowerMenu(e,this)}_powerSplitBar(e){return new PowerSplitBar(e,this)}_powerToolbar(e){return new PowerToolbar(e,this)}_powerMain(e){return new PowerMain(e,this)}_powerBrand(e){return new PowerBrand(e,this)}_powerItem(e){return new PowerItem(e,this)}_powerAccordion(e){return new PowerAccordion(e,this)}_powerAccordionSection(e){return new PowerAccordionSection(e,this)}_powerTabs(e){return new PowerTabs(e,this)}_powerTabSection(e){return new PowerTabSection(e,this)}_powerList(e){return new PowerList(e,this)}_powerAction(e){return new PowerAction(e,this)}_powerToggle(e){return new PowerToggle(e,this)}_powerDropmenu(e){return new PowerDropmenu(e,this)}_powerTreeView(e){return new PowerTreeView(e,this)}_powerStatus(e){return new PowerStatus(e,this)}_powerBasicElement(e){return new _PowerBasicElement(e,this)}_offsetComputedStyles(e){return parseInt(e.left.split("px")[0]||0)+parseInt(e["margin-left"].split("px")[0]||0)+parseInt(e["border-left-width"].split("px")[0]||0)}_offsetComputedRootElementStyles(e){return parseInt(e["margin-left"].split("px")[0]||0)}_offsetComputedHeight(e){const t=window.getComputedStyle(e);return parseInt(t.height.split("px")[0]||0)+parseInt(t["margin-top"].split("px")[0]||0)+parseInt(t["border-top-width"].split("px")[0]||0)+parseInt(t["margin-bottom"].split("px")[0]||0)+parseInt(t["border-bottom-width"].split("px")[0]||0)+parseInt(t["padding-top"].split("px")[0]||0)+parseInt(t["padding-bottom"].split("px")[0]||0)}_computedTopBottomPadding(e){const t=window.getComputedStyle(e);return parseInt(t["padding-top"].split("px")[0]||0)+parseInt(t["padding-bottom"].split("px")[0]||0)}_computedTopPadding(e){const t=window.getComputedStyle(e);return parseInt(t["padding-top"].split("px")[0]||0)}_computedLeftRightPadding(e){const t=window.getComputedStyle(e);return parseInt(t["padding-left"].split("px")[0]||0)+parseInt(t["padding-right"].split("px")[0]||0)}_offsetComputedWidth(e){const t=window.getComputedStyle(e);return parseInt(t.width.split("px")[0]||0)-(parseInt(t["padding-left"].split("px")[0]||0)+parseInt(t["padding-right"].split("px")[0]||0))}_offsetComputedAdjustSides(e){const t=window.getComputedStyle(e);return parseInt(t["padding-left"].split("px")[0]||0)+parseInt(t["padding-right"].split("px")[0]||0)+parseInt(t["border-left-width"].split("px")[0]||0)+parseInt(t["border-right-width"].split("px")[0]||0)}_offsetComputedAdjustTopBottom(e){const t=window.getComputedStyle(e);return parseInt(t["padding-top"].split("px")[0]||0)+parseInt(t["padding-bottom"].split("px")[0]||0)+parseInt(t["border-top-width"].split("px")[0]||0)+parseInt(t["border-bottom-width"].split("px")[0]||0)}}export{PowerUi};class PowerScope{constructor({$powerUi:e}){this.$powerUi=e,this._servicesInstances={}}$service(e){return this._servicesInstances[e]?this._servicesInstances[e]:(this._servicesInstances[e]=new this.$powerUi._services[e].component({$powerUi:this.$powerUi,$ctrl:this,params:this.$powerUi._services[e].params}),this._servicesInstances[e])}}export{PowerScope};class PowerServices{constructor({$powerUi:e,$ctrl:t}){this.$powerUi=e,this.$ctrl=t}}class JSONSchemaService extends PowerServices{constructor({$powerUi:e,$ctrl:t}){super({$powerUi:e,$ctrl:t})}cloneObject(e){if("object"==typeof e&&void 0!==e.length){const t=[];for(const i of e)"object"==typeof i?t.push(this.cloneObject(i)):t.push(i);return t}{const t={};for(const i of Object.keys(e))if("object"==typeof e[i]&&void 0!==e[i].length){t[i]=[];for(const s of e[i])"object"==typeof s?t[i].push(this.cloneObject(s)):t[i].push(s)}else if("object"==typeof e[i]){t[i]={};const s=e[i];for(const e of Object.keys(s))"object"==typeof s[e]?t[i][e]=this.cloneObject(s[e]):t[i][e]=s[e]}else t[i]=e[i];return t}}overwriteJSON(e,t){for(const i of Object.keys(t))if(e[i])if("object"==typeof t[i]&&void 0!==t[i].length){let s=0;for(const o of t[i])void 0===e[i][s]?e[i].push(o):e[i][s]="object"==typeof o?this.overwriteJSON(e[i][s],o):o,s+=1}else if("object"==typeof t[i]){const s=t[i];for(const t of Object.keys(s))"object"==typeof s[t]&&void 0!==e[i][t]?e[i][t]=this.overwriteJSON(e[i][t],s[t]):e[i][t]=s[t]}else e[i]=t[i];else e[i]=t[i];return e}registerJSONById(e){this.$powerUi.JSONById[e.$id]||(this.$powerUi.JSONById[e.$id]=e)}getNewJSON(e){const t=this.cloneObject(this.$powerUi.JSONById[e.$ref]);delete t.$id;const i=this.overwriteJSON(t,e);return delete i.$ref,i}validateType(e,t){return typeof t===e||("array"===e&&void 0!==t.length||("any"===e||(void 0!==e.length&&t.length,window.console.log(`JSON type expected to be "${e}" but is "${typeof t}"`,t),!1)))}especialRequired(e,t){const i={html:!0,button:!0,item:!0,status:!0,icon:!0,menu:!0,dropmenu:!0,dropmenubutton:!0,simpleform:!0,tree:!0,accordion:!0,grid:!0};for(const s of Object.keys(e))if(i[s]&&"object"==typeof e[s]&&t===s)return!0}_validateEvents(e,t,i){for(const s of e)if(!1===this._validate(this.gridDef().properties.events,s))return window.console.log(`Failed JSON ${i} event:`,s,e,t),`Failed JSON ${i} event!`;return!0}_validate(e,t){for(const i of Object.keys(e.properties||{}))if(e.properties[i].type&&void 0!==t[i]&&!1===this.validateType(e.properties[i].type,t[i]))return!1;if(e.required)for(const i of e.required)if(!this.especialRequired(t,i)&&!t[i])return window.console.log(`JSON missing required property: "${i}"`,t),!1;return!0}_getEventTmpl(e){if(e){let t="";for(const i of e)t=`${t} ${i.event}="${i.fn}" `;return t=`data-pow-event ${t}`,t}return""}_getIdTmpl(e,t){return e?`id="${e}"`:t?`id="${t}_${this.$powerUi._Unique.next()}"`:""}_getAttrTmpl(e){let t="";if(e)for(const i of e)t=void 0!==i.value?`${t} ${i.name}="${i.value}"`:`${t} ${i.name}`;return t}_getClassTmpl(e){let t="";if(e){for(const i of e)t=t?`${t} ${i}`:i;return`class="${t}"`}return t}_getHtmlBasicTmpl(e,t){return`${this._getIdTmpl(e.id,t)} ${this._getClassTmpl(e.classList)} ${this._getAttrTmpl(e.attrs)} ${this._getEventTmpl(e.events)}${e.title?' title="'+e.title+'"':""}${e.for?' for="'+e.for+'"':""}${e.src?' src="'+e.src+'"':""}${e.cols?' cols="'+e.cols+'"':""}${e.rows?' rows="'+e.rows+'"':""}${e.width?' width="'+e.width+'"':""}${e.height?' height="'+e.height+'"':""}${!0===e.disabled?" disabled":""}${!0===e.selected?" selected":""}${e.bind?' data-pow-bind="'+e.bind+'"':""}${e.value?' value="'+e.value+'"':""}${e.name?' name="'+e.name+'"':""}${e.required?" required":""}`}_getHtmlMoreBasicTmpl(e,t){return`${this._getIdTmpl(e.id,t)} ${this._getClassTmpl(e.classList)} ${this._getAttrTmpl(e.attrs)} ${this._getEventTmpl(e.events)}`}_getInputBasicTmpl(e,t){return`${this._getHtmlBasicTmpl(e,t)} type="${e.type||"text"}"${e.pattern?' pattern="'+e.pattern+'"':""}`}_arrayOfSchemas(e,t,i){let s="",o=0;for(const n of e){const e=i?`${i},${o}`:"";s=`${s}\n\t\t\t\t${this[t](n,e)}`,o+=1}return s}otherJsonKind(e,t){return e.button?this.button(e.button,null,t):e.simpleForm?this.simpleForm(e.simpleForm,t):e.tree?this.tree(e.tree,t):e.dropMenuButton?this.dropMenuButton(e.dropMenuButton,t):e.dropmenu?this.dropmenu(e.dropmenu,null,null,t):e.menu?this.menu(e.menu,t):e.accordion?this.accordion(e.accordion,t):e.icon?this.icon(e.icon,t):e.status?this.status(e.status,t):e.html?this.html(e.html,t):e.grid?this.grid(e.grid,t):null}appendClassList({element:e,json:t}){for(const i of t.classList)e.classList.add(i)}appendIcon({element:e,json:t,mirrored:i,keysPath:s}){const o=document.createElement("div"),n={};"img"===t.icon&&t["icon-src"]?(n.kind="img",n.src=t["icon-src"]):n.icon=t.icon,o.innerHTML=this.icon(n,s);const r=o.childNodes[0];!t["icon-position"]&&!0!==i||"left"===t["icon-position"]?e.insertBefore(r,e.childNodes[0]):e.appendChild(r)}appendStatus({element:e,json:t,mirrored:i,keysPath:s}){const o=document.createElement("div");o.innerHTML=this.status(t,s);const n=o.childNodes[0];n.dataset.powerInactive=!0===i?t.inactive.replace("right","left"):t.inactive,n.dataset.powerActive=t.active,"left"===t.position||!0===i?e.insertBefore(n,e.childNodes[0]):e.appendChild(n)}accordion(e,t){const i=this.cloneObject(e);if(e.length)return this._arrayOfSchemas(e,"accordion",t);if(e.$ref)return this.accordion(this.getNewJSON(e),t);{if(e.$id&&this.registerJSONById(e),!1===this._validate(this.accordionDef(),i))throw window.console.log("Failed JSON accordion:",i),"Failed JSON accordion!";if(!1===this._validate(this.accordionDef().properties.config,i.config))throw window.console.log("Failed JSON accordion config:",i.config),"Failed JSON accordion config!";i.classList||(i.classList=[]),i.classList.push("power-accordion");const s=`${t?' data-is-json="accordion"':""}`;let o=`<div ${this._getHtmlBasicTmpl(i)} data-multiple-sections-open="${!(!i.config||!i.config.multipleSectionsOpen)&&i.config.multipleSectionsOpen}"${s}>`,n=0;for(const e of i.panels){const i=t?`${t},${n}`:"";if(!1===this._validate(this.accordionDef().properties.panels,e))throw window.console.log("Failed JSON accordion panel:",e),"Failed JSON accordion panel!";if(!1===this._validate(this.accordionDef().properties.panels.properties.header,e.header))throw window.console.log("Failed JSON accordion header:",e.header),"Failed JSON accordion header!";if(!1===this._validate(this.accordionDef().properties.panels.properties.section,e.section))throw window.console.log("Failed JSON accordion section:",e.section),"Failed JSON accordion section!";const s={};e.header.icon&&("img"===e.header.icon&&e.header["icon-src"]?(s.kind="img",s.src=e.header["icon-src"]):s.icon=e.header.icon);const r={};e.header.status&&(r.active=e.header.status.active,r.inactive=e.header.status.inactive);const a=e.section.id||this.$powerUi._Unique.next(),l=`${t?' data-panel-index="'+n+'"':""}`,h=`<div\n\t\t\t\tclass="power-action" data-power-target="${a}" ${this._getIdTmpl(e.header.id,!0)}>\n\t\t\t\t\t<div${l}>\n\t\t\t\t\t\t${this.icon(s,i)}\n\t\t\t\t\t\t<span class="pw-label"${i?' data-keys-path="'+i+'"':""}>${e.header.label}</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t${this.status(r,i)}\n\t\t\t\t</div>`;let d=`<div class="power-accordion-section"${l}${i?' data-keys-path="'+i+'"':""} ${this._getIdTmpl(a)}>\n\t\t\t\t\t${e.section.text||""}`;if(e.section.children){let t=0;for(const s of e.section.children){const e=i?`${i},${t}`:"";d+=this.otherJsonKind(s,e),t+=1}}d+="</div>",o=o+h+d,n+=1}return o+"</div>"}}powertabs(e,t){const i=this.cloneObject(e);if(e.length)return this._arrayOfSchemas(e,"powertabs",t);if(e.$ref)return this.powertabs(this.getNewJSON(e),t);{if(e.$id&&this.registerJSONById(e),!1===this._validate(this.powertabsDef(),i))throw window.console.log("Failed JSON powertabs:",i),"Failed JSON powertabs!";i.classList||(i.classList=[]),i.classList.push("power-tabs");const s=`${t?' data-is-json="powertabs"':""}`;let o=`<div ${this._getHtmlBasicTmpl(i)}${s}>`,n=0;for(const e of i.tabs){const i=t?`${t},${n}`:"";if(!1===this._validate(this.powertabsDef().properties.tabs,e))throw window.console.log("Failed JSON tab:",e),"Failed JSON tab!";if(!1===this._validate(this.powertabsDef().properties.tabs.properties.header,e.header))throw window.console.log("Failed JSON tab header:",e.header),"Failed JSON tab header!";if(!1===this._validate(this.powertabsDef().properties.tabs.properties.section,e.section))throw window.console.log("Failed JSON tab section:",e.section),"Failed JSON tab section!";const s={};e.header.icon&&("img"===e.header.icon&&e.header["icon-src"]?(s.kind="img",s.src=e.header["icon-src"]):s.icon=e.header.icon);const r={};e.header.status&&(r.active=e.header.status.active,r.inactive=e.header.status.inactive);const a=e.section.id||this.$powerUi._Unique.next(),l=`${t?' data-tab-index="'+n+'"':""}`,h=`<div\n\t\t\t\tclass="power-action" data-power-target="${a}" ${this._getIdTmpl(e.header.id,!0)}>\n\t\t\t\t\t<div${l}>\n\t\t\t\t\t\t${this.icon(s,i)}\n\t\t\t\t\t\t<span class="pw-label"${i?' data-keys-path="'+i+'"':""}>${e.header.label}</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t${this.status(r)}\n\t\t\t\t</div>`;let d=`<div class="power-tab-section"${l}${i?' data-keys-path="'+i+'"':""} ${this._getIdTmpl(a)}>\n\t\t\t\t\t${e.section.text||""}`;if(e.section.children){let t=0;for(const s of e.section.children){const e=i?`${i},${t}`:"";d+=this.otherJsonKind(s,e),t+=0}}d+="</div>",o=o+h+d,n+=0}return o+"</div>"}}_setBarDropmenuPosition(e){e.dropMenuPosition||(e.orientation&&"horizontal"!==e.orientation?"vertical"===e.orientation&&(!0===e.mirrored||void 0===e.mirrored&&("fixed-right"===e.position||"float-right"===e.position)?e.dropMenuPosition="left-bottom":e.dropMenuPosition="right-bottom"):!0===e.mirrored?void 0===e.position||"fixed-top"===e.position?e.dropMenuPosition="bottom-left":"fixed-bottom"===e.position&&(e.dropMenuPosition="top-left"):void 0===e.position||"fixed-top"===e.position?e.dropMenuPosition="bottom-right":"fixed-bottom"===e.position&&(e.dropMenuPosition="top-right"))}_setBarCssStyles(e,t){if(e.position){if(e.mirrored&&t.classList.add("pw-mirrored"),e.position.includes("fixed")){const i=e.position.includes("window");t.classList.add(i?"pw-bar-window-fixed":"pw-bar-fixed")}"fixed-top"===e.position||"fixed-window-top"===e.position?(t.classList.add("pw-top"),e.orientation&&"horizontal"!==e.orientation||t.classList.add("pw-horizontal")):"fixed-bottom"===e.position||"fixed-window-bottom"===e.position?(t.classList.add("pw-bottom"),e.orientation&&"horizontal"!==e.orientation||t.classList.add("pw-horizontal")):"fixed-left"===e.position||"fixed-window-left"===e.position?(t.classList.add("pw-left"),e.orientation&&"vertical"!==e.orientation||t.classList.add("pw-vertical")):"fixed-right"===e.position||"fixed-window-right"===e.position?(t.classList.add("pw-right"),e.orientation&&"vertical"!==e.orientation||t.classList.add("pw-vertical")):"float-left"===e.position?(t.classList.add("pw-bar-float"),t.classList.add("pw-left")):"float-right"===e.position&&(t.classList.add("pw-bar-float"),t.classList.add("pw-right")),e.ignore&&t.classList.add("pw-ignore"),e.priority&&(t.dataset.pwPriority=e.priority),e.orientation||(t.classList.contains("pw-vertical")?e.orientation="vertical":e.orientation="horizontal")}}_setBarOrientation(e,t){"horizontal"===e.orientation?t.classList.add("pw-horizontal"):"vertical"===e.orientation&&t.classList.add("pw-vertical")}menu(e,t){const i=this.cloneObject(e);if(e.length)return this._arrayOfSchemas(e,"menu",t);if(e.$ref)return this.menu(this.getNewJSON(e),t);{if(e.$id&&this.registerJSONById(e),!1===this._validate(this.menuDef(),i))throw window.console.log("Failed JSON menu:",i),"Failed JSON dropmenu!";if(i.events){const e=this._validateEvents(i.events,i,"menu");if(!0!==e)throw e}i.orientation||(!i.position||i.position.includes("top")||i.position.includes("bottom")?i.orientation="horizontal":i.orientation="vertical"),i.classList||(i.classList=[]),i.classList.push("power-menu pw-bar");const s=document.createElement("div");this._setBarDropmenuPosition(i),s.innerHTML=this._buildbarEl(i,i.mirrored,i.flip,t||"");const o=s.children[0];if(this._setBarCssStyles(i,o),this._setBarOrientation(i,o),i.brand){if(i.brand.events){const e=this._validateEvents(i.brand.events,i.brand,"brand");if(!0!==e)throw e}const e=document.createElement("div");i.brand.classList||(i.brand.classList=[]),i.brand.classList.includes("power-brand")||i.brand.classList.push("power-brand");let s="";i.brand.text?(s="text",i.brand.content=i.brand.text):(s="html",i.brand.content=i.brand.html),e.innerHTML=`<div ${this._getHtmlBasicTmpl(i.brand)}${t?' data-kind="'+s+'"':""}>${i.brand.content}</div>`;const n=e.children[0];o.insertBefore(n,o.childNodes[0])}if(!1!==i.colapse){o.classList.add("pw-colapse");const e=document.createElement("div");e.innerHTML=`<a id="${i.id}-action" class="power-toggle" data-power-target="${i.id}">\n\t\t\t\t\t<i class="pw-icon icon-hamburguer"></i>\n\t\t\t\t</a>`;const t=e.children[0];o.appendChild(t)}return s.innerHTML}}toolbar(e,t){const i=this.cloneObject(e);if(e.length)return this._arrayOfSchemas(e,"toolbar",t);if(e.$ref)return this.toolbar(this.getNewJSON(e),t);{if(e.$id&&this.registerJSONById(e),!1===this._validate(this.toolbarDef(),i))throw window.console.log("Failed JSON toolbar:",i),"Failed JSON toolbar!";if(i.events){const e=this._validateEvents(i.events,i,"toolbar");if(!0!==e)throw e}i.orientation||(!i.position||i.position.includes("top")||i.position.includes("bottom")?i.orientation="horizontal":i.orientation="vertical"),i.classList||(i.classList=[]),i.classList.push("power-toolbar pw-bar pw-icons-bar");const s=document.createElement("div");this._setBarDropmenuPosition(i),s.innerHTML=this._buildbarEl(i,i.mirrored,i.flip,t||"");const o=s.children[0];if(this._setBarCssStyles(i,o),this._setBarOrientation(i,o),!1!==i.colapse){const e=document.createElement("div");e.innerHTML=`<a id="${i.id}-action" class="power-toggle" data-power-target="${i.id}">\n\t\t\t\t\t<i class="pw-icon icon-option-${i.orientation}"></i>\n\t\t\t\t</a>`;const t=e.children[0];o.appendChild(t)}return s.innerHTML}}splitbar(e,t){const i=this.cloneObject(e);if(e.length)return this._arrayOfSchemas(e,"splitbar",t);if(e.$ref)return this.splitbar(this.getNewJSON(e),t);{if(e.$id&&this.registerJSONById(e),!1===this._validate(this.splitbarDef(),i))throw window.console.log("Failed JSON splitbar:",i),"Failed JSON splitbar!";if(i.events){const e=this._validateEvents(i.events,i,"splitbar");if(!0!==e)throw e}i.orientation||(!i.position||i.position.includes("top")||i.position.includes("bottom")?i.orientation="horizontal":i.orientation="vertical"),i.classList||(i.classList=[]),i.classList.push("power-split-bar pw-bar"),!1!==i.resize&&i.classList.push("pw-split");const s=document.createElement("div");s.innerHTML=`<nav ${this._getHtmlBasicTmpl(i)}${t?' data-keys-path="'+t+'"':""} ${i.border?'data-pw-border="'+i.border+'" ':""}><div class="pw-bar-content">${i.content}</div></nav>`;const o=s.children[0];if(this._setBarCssStyles(i,o),this._setBarOrientation(i,o),!1!==i.colapse){o.classList.add("pw-colapse");const e=document.createElement("div");e.innerHTML=`<a id="${i.id}-action" class="power-toggle" data-power-target="${i.id}">\n\t\t\t\t\t<i class="pw-icon icon-hamburguer"></i>\n\t\t\t\t</a>`;const t=e.children[0];o.appendChild(t)}return s.innerHTML}}_buildbarEl(e,t,i,s=""){const o=document.createElement("div");o.innerHTML=`<nav ${this._getHtmlBasicTmpl(e)}${s?' data-keys-path="'+s+'"':""} ${!0===t?" pw-mirrored":""} data-pw-position="${e.dropMenuPosition}"></nav>`;let n=0;for(const r of e.items){const e=document.createElement("div"),a=s?`${s},${n}`:"";i&&r.status&&r.status.active&&(r.status.active.includes("down")?r.status.active=r.status.active.replace("down","up"):r.status.active.includes("up")&&(r.status.active=r.status.active.replace("up","down"))),r.item?e.innerHTML=this.item({item:r.item,mirrored:void 0===r.mirrored?t:r.mirrored,dropmenuId:!!r.dropmenu&&r.dropmenu.id,keysPath:a}):r.button&&r.dropmenu?(void 0!==t&&void 0===r.button.mirrored&&(r.button.mirrored=t),e.innerHTML=this.dropMenuButton(r,a)):r.button&&!r.dropmenu&&(void 0!==t&&void 0===r.button.mirrored?e.innerHTML=this.button(r.button,t,a):e.innerHTML=this.button(r.button,null,a),e.children[0].classList.add("power-item"));const l=e.children[0];if(r.item&&!r.button&&r.status&&this.appendStatus({element:l,json:r.status,mirrored:t,keysPath:a}),o.children[0].appendChild(l),r.button&&r.dropmenu)o.children[0].appendChild(e.children[0]);else if(r.dropmenu&&!r.button){const e=document.createElement("div");e.innerHTML=this.dropmenu(r.dropmenu,t,i,a),o.children[0].appendChild(e.children[0])}n+=1}return o.innerHTML}dropmenu(e,t,i,s){const o=this.cloneObject(e),n=o.position;if(e.length)return this._arrayOfSchemas(e,"dropmenu",s);if(e.$ref)return this.dropmenu(this.getNewJSON(e),t,i,s);{if(e.$id&&this.registerJSONById(e),!1===this._validate(this.dropmenuDef(),o))throw window.console.log("Failed JSON dropmenu:",o),"Failed JSON dropmenu!";if(o.events){const e=this._validateEvents(o.events,o,"dropmenu");if(!0!==e)throw e}const r=document.createElement("div");if(o.classList||(o.classList=[]),o.classList.push("power-dropmenu"),r.innerHTML=`<nav ${this._getHtmlBasicTmpl(o)}${s?' data-keys-path="'+s+'"':""} ${!0===t?" pw-mirrored":""}></nav>`,n){r.children[0].dataset.pwPosition=n}let a=0;for(const e of o.items){const o=document.createElement("div"),n=s?`${s},${a}`:"";i&&e.status&&e.status.active&&(e.status.active.includes("down")?e.status.active=e.status.active.replace("down","up"):e.status.active.includes("up")&&(e.status.active=e.status.active.replace("up","down"))),e.item?o.innerHTML=this.item({item:e.item,mirrored:void 0===e.mirrored?t:e.mirrored,dropmenuId:!!e.dropmenu&&e.dropmenu.id,keysPath:n}):e.button&&e.dropmenu?(void 0!==t&&void 0===e.button.mirrored&&(e.button.mirrored=t),o.innerHTML=this.dropMenuButton(e,n)):e.button&&!e.dropmenu&&(void 0!==t&&void 0===e.button.mirrored?o.innerHTML=this.button(e.button,t,n):o.innerHTML=this.button(e.button,null,n),o.children[0].classList.add("power-item"));const l=o.children[0];if(e.item&&!e.button&&e.status&&this.appendStatus({element:l,json:e.status,mirrored:t,keysPath:n}),r.children[0].appendChild(l),e.button&&e.dropmenu)r.children[0].appendChild(o.children[0]);else if(e.dropmenu&&!e.button){const s=document.createElement("div");s.innerHTML=this.dropmenu(e.dropmenu,t,i,n),r.children[0].appendChild(s.children[0])}a+=1}return r.innerHTML}}item({item:e,mirrored:t,dropmenuId:i,keysPath:s}){const o=this.cloneObject(e);if(e.length)return this._arrayOfSchemas(e,"item",s);if(e.$ref)return this.item(this.getNewJSON(e),t,i,s);{if(e.$id&&this.registerJSONById(e),!1===this._validate(this.itemDef(),o))return window.console.log("Failed JSON item:",o),"Failed JSON item!";if(o.events){const e=this._validateEvents(o.events,o,"item");if(!0!==e)throw e}const n=document.createElement("div");o.classList||(o.classList=[]),o.classList.push(i?"power-action":"power-item");const r=`<span class="pw-label"${s?' data-keys-path="'+s+'"':""}>${o.label}</span>`;n.innerHTML=`<a ${this._getHtmlBasicTmpl(o)} ${i?'data-power-target="'+i+'"':""}>${o.label?r:""}</a>`;const a=n.children[0];return o.icon&&this.appendIcon({element:a,json:o,mirrored:t,keysPath:s}),n.innerHTML}}dropMenuButton(e,t){const i=this.cloneObject(e);if(e.length)return this._arrayOfSchemas(e,"dropMenuButton",t);if(e.$ref)return this.dropMenuButton(this.getNewJSON(e),t);{if(!1===this._validate(this.dropmenubuttonDef(),i))throw window.console.log("Failed JSON dropMenuButton:",i),"Failed JSON dropMenuButton!";e.$id&&this.registerJSONById(e);const s=document.createElement("div");s.innerHTML=this.button(i.button,i.button.mirrored,t);const o=s.children[0];return o.dataset.powerTarget=i.dropmenu.id,o.classList.add("power-action"),i.status&&this.appendStatus({element:o,json:i.status,mirrored:i.button.mirrored,flip:i.button.flip,keysPath:t}),s.innerHTML=s.innerHTML+this.dropmenu(i.dropmenu,i.button.mirrored,i.button.flip,t),s.innerHTML}}button(e,t,i){const s=this.cloneObject(e);if(e.length)return this._arrayOfSchemas(e,"button",i);if(e.$ref)return this.button(this.getNewJSON(e),t,i);{if(e.$id&&this.registerJSONById(e),!1===this._validate(this.itemDef(),s))throw window.console.log("Failed JSON button:",s),"Failed JSON button!";if(s.events){const e=this._validateEvents(s.events,s,"button");if(!0!==e)throw e}const o=document.createElement("div");s.classList||(s.classList=[]),s.type||(s.type="button"),s.classList.push(s.kind?`pw-btn-${s.kind}`:"pw-btn-default"),o.innerHTML=`<button ${this._getInputBasicTmpl(s)}${i?' data-keys-path="'+i+'"':""}><span class="pw-label">${s.label}</span></button>`;const n=o.children[0];return s.icon&&this.appendIcon({element:n,json:s,mirrored:t,keysPath:i}),s.classList&&this.appendClassList({element:n,json:s}),o.innerHTML}}tree(e,t){const i=this.cloneObject(e);if(e.length)return this._arrayOfSchemas(e,"tree",t);if(e.$ref)return this.tree(this.getNewJSON(e),t);{if(e.$id&&this.registerJSONById(e),!1===this._validate(this.treeDef(),i))throw window.console.log("Failed JSON tree:",i),"Failed JSON tree!";if(i.events){const e=this._validateEvents(i.events,i,"tree");if(!0!==e)throw e}i.classList||(i.classList=[]),i.classList.push("power-tree-view");let s=`<nav ${this._getHtmlMoreBasicTmpl(i)} ${i.onClickFile?'data-on-click-file="'+i.onClickFile+'"':""}${t?' data-keys-path="'+t+'"':""}>`,o=0;for(const e of i.nodes){const i=t?`${t},${o}`:"";if(!1===this._validate(this.treeNodeDef(),e))throw window.console.log("Failed JSON tree node:",e),"Failed JSON tree node!";if(e.events){const t=this._validateEvents(e.events,e,"tree node");if(!0!==t)throw t}if(e.classList||(e.classList=[]),"file"===e.kind)e.classList.push("power-item"),s=`${s}\n\t\t\t\t\t<a ${this._getHtmlMoreBasicTmpl(e)} ${e.path?' data-file-path="'+encodeURI(e.path)+'"':""}${i?' data-keys-path="'+i+'"':""} `,s=`${s}>\n\t\t\t\t\t\t<span class="pw-icon ${e.icon||"icon-document-blank"}"></span> <span>${e.fullName}</span></a>`;else if("folder"===e.kind){const t=`list-${this.$powerUi._Unique.next()}`;e.classList.push("power-list"),s=`${s}\n\t\t\t\t\t<a ${this._getHtmlMoreBasicTmpl(e)} data-power-target="${t}"${i?' data-keys-path="'+i+'"':""}>\n\t\t\t\t\t\t<span class="power-status pw-icon" data-power-active="${e.active||"icon-folder-open"}" data-power-inactive="${e.inactive||"icon-folder-close"}"></span> <span>${e.fullName}</span>\n\t\t\t\t\t</a>\n\t\t\t\t\t${this.tree({nodes:e.nodes,id:t},i)}`}o+=1}return s=`${s}\n\t\t\t</nav>`,s}}grid(e,t){const i=this.cloneObject(e);if(e.length)return this._arrayOfSchemas(e,"grid",t);if(e.$ref)return this.grid(this.getNewJSON(e));{if(e.$id&&this.registerJSONById(e),!1===this._validate(this.gridDef(),i))throw window.console.log("Failed JSON grid:",i),"Failed JSON grid!";if(i.events){const e=this._validateEvents(i.events,i,"grid");if(!0!==e)throw e}i.classList||(i.classList=[]),i.classList.push("pw-grid"),i.classList.push(i.kind||"scroll-12"),!0===i.border&&i.classList.push("border"),!0===i.inline&&i.classList.push("inline-grid"),i.gap?i.classList.push(`gap-${i.gap}`):i.classList.push("no-gap");let s=`<div ${this._getHtmlBasicTmpl(i)}>`;i.sizes||(i.sizes=["s-1 m-1 l-1 xl-1"]);let o=0,n=0;for(const e of i.fields){const r=t?`${t},${n}`:"";if(!1===this._validate(this.gridDef().properties.fields,e))throw window.console.log("Failed JSON grid field:",e,i),"Failed JSON grid field!";if(e.events){const t=this._validateEvents(e.events,e,"field");if(!0!==t)throw t}if(e.classList||(e.classList=[]),e.classList.push("pw-col"),e.classList.push(e.size||i.sizes[o]),s=`${s}\n\t<div ${r?'data-keys-path="'+r+'" ':""}${this._getIdTmpl(e.id)} ${this._getClassTmpl(e.classList)}>${e.text||""}`,e.children)for(const t of e.children)s=`${s}\n\t\t${this.otherJsonKind(t,r)}`;s+="</div>",e.size||(o+=1),o>=i.sizes.length&&(o=0),n+=1}return s=`${s}\n</div>`,s}}simpleFormControls({controls:e,template:t,inline:i,keysPath:s=!1}){let o=0;for(const n of e){const e=s?`${s},${o}`:"";if(o+=1,!1===this._validate(this.simpleformcontrolsDef(),n))throw window.console.log("Failed JSON control:",n),"Failed JSON control!";if(n.events){const e=this._validateEvents(n.events,n,"control");if(!0!==e)throw e}n.id||(n.id="input_"+this.$powerUi._Unique.next());const r=n.label?`<label for="${n.id}">${n.label}</label>`:null;let a="";if(n.classList)for(const e of n.classList)a=`${a} ${e}`;n.classList||(n.classList=[]),n.classList.push("pw-field");const l=n.size?n.size:"s-12 m-12 l-12 xl-12";if(t=`${t}\n\t\t\t\t<div ${e?'data-keys-path="'+e+'" ':""} class="${n.controls?"pw-inner-grid":""} pw-col ${l}">`,n.controls)t=`${t}\n\t\t\t\t<div class="pw-grid scroll-12 gap-1 ${!0===n.inline||!0===i?"inline-grid":""}">\n\t\t\t\t\t${this.simpleFormControls({controls:n.controls,template:"",keysPath:e})}\n\t\t\t\t</div>`;else if(n.children){let i=0;for(const s of n.children){const o=e?`${e},${i}`:"";t+=this.otherJsonKind(s,o),i+=1}}else if(n.button)t=`${t}\n\t\t\t\t\t${this.button(n.button,e)}`;else if("submit"===n.type||"reset"===n.type)n.classList.pop(),t=`${t}\n\t\t\t\t<div ${e?'data-keys-path="'+e+'" ':""}class="pw-field-container">\n\t\t\t\t\t<input ${this._getInputBasicTmpl(n)} />\n\t\t\t\t\t<div class="pw-control-helper"></div>\n\t\t\t\t</div>`;else if("select"===n.type){t=`${t}\n\t\t\t\t<div ${e?'data-keys-path="'+e+'" ':""}class="pw-field-container">\n\t\t\t\t\t${r||""}\n\t\t\t\t\t<select ${this._getInputBasicTmpl(n)} ${!0===n.multiple?"multiple":""}>`;let i=0;for(const s of n.list){const o=e?`${e},${i}`:"";t=`${t}<option ${o?'data-keys-path="'+o+'" ':""}value="${s.value}"${!0===s.disabled?" disabled":""}${!0===s.selected?" selected":""}>${s.label}</option>`,i+=1}t=`${t}\n\t\t\t\t\t</select>\n\t\t\t\t\t<div class="pw-control-helper"></div>\n\t\t\t\t</div>`}else t="radio"===n.type||"checkbox"===n.type?`${t}\n\t\t\t\t<div ${e?'data-keys-path="'+e+'" ':""}class="pw-field-container">\n\t\t\t\t\t<input ${this._getInputBasicTmpl(n)} /> ${r||""}\n\t\t\t\t</div>`:"textarea"===n.type?`${t}\n\t\t\t\t<div ${e?'data-keys-path="'+e+'" ':""}class="pw-field-container">\n\t\t\t\t\t${r||""}\n\t\t\t\t\t<textarea ${this._getInputBasicTmpl(n)} ${n.rows?'rows="'+n.rows+'"':""} ${n.cols?'cols="'+n.cols+'"':""}>\n\t\t\t\t\t\t${n.value||""}\n\t\t\t\t\t</textarea>\n\t\t\t\t\t<div class="pw-control-helper"></div>\n\t\t\t\t</div>`:`${t}\n\t\t\t\t<div ${e?'data-keys-path="'+e+'" ':""}class="pw-field-container">\n\t\t\t\t\t${r||""}\n\t\t\t\t\t<input ${this._getInputBasicTmpl(n)} />\n\t\t\t\t\t<div class="pw-control-helper"></div>\n\t\t\t\t</div>`;t=`${t}\n\t\t\t\t</div>`}return t}simpleForm(e,t){const i=this.cloneObject(e);if(e.length)return this._arrayOfSchemas(e,"form",t);if(e.$ref)return this.simpleForm(this.getNewJSON(e),t);{if(e.$id&&this.registerJSONById(e),!1===this._validate(this.simpleformDef(),i))throw window.console.log("Failed JSON form:",i),"Failed JSON form!";if(i.events){const e=this._validateEvents(i.events,i,"form");if(!0!==e)throw e}const s=["pw-vertical-form",`${i.theme||"pw-simple-form"}`,"pw-grid scroll-12","gap-4"];if(!1!==i.inline&&s.push("inline-grid"),i.classList&&i.classList.length)for(const e of i.classList)s.push(e);const o=this._getClassTmpl(s),n=i.type?i.type:"form";let r=`<${n} ${this._getIdTmpl(i.id,"form")}${t?' data-keys-path="'+t+'"':""} ${o}>`;return r=this.simpleFormControls({controls:i.controls,template:r,keysPath:t}),r=`${r}\n\t\t\t</${n}>`,r}}html(e,t){const i=this.cloneObject(e);if(e.length)return this._arrayOfSchemas(e,"html",t);if(e.$ref)return this.html(this.getNewJSON(e),t);{if(e.$id&&this.registerJSONById(e),!1===this._validate(this.htmlDef(),i))return window.console.log("Failed JSON html:",i),"Failed JSON html!";if(i.events){const e=this._validateEvents(i.events,i,"html");if(!0!==e)throw e}if(void 0===i.tagName)return this.otherJsonKind(i,t);const s=i.tagName.toLowerCase();if(["area","base","br","col","embed","hr","img","link","meta","param","source","track","wbr"].includes(s))return`<${s} ${this._getHtmlBasicTmpl(i)}${t?' data-keys-path="'+t+'" ':""} />`;if("input"===s)return`<${s} ${this._getInputBasicTmpl(i)}${t?' data-keys-path="'+t+'" ':""} />`;{let e=`<${s} ${this._getHtmlBasicTmpl(i)} ${!0===i.multiple?"multiple":""}${t?' data-keys-path="'+t+'" ':""}>\n\t\t\t\t\t${i.text||""}`;if(i.children){let s=0;for(const o of i.children){const i=t?`${t},${s}`:"";e=`${e}\n\t\t\t\t\t\t\t${this.html(o,i)}`,s+=1}}return e=`${e}\n\t\t\t\t</${s}>`,e}}}icon(e,t){if(void 0===e.icon&&void 0===e.kind)return"";const i=this.cloneObject(e);if(e.length)return this._arrayOfSchemas(e,"icon");if(e.$ref)return this.icon(this.getNewJSON(e),t);{if(e.$id&&this.registerJSONById(e),!1===this._validate(this.iconDef(),e))return window.console.log("Failed JSON icon:",e),"Failed JSON icon!";let s="";if(i.classList||(i.classList=[]),i.classList.push("pw-icon"),"img"===i.kind&&i.src){const e=i.src;delete i.src,s=`<span ${this._getHtmlBasicTmpl(i)}${t?' data-keys-path="'+t+'"':""}><img src=${e} /></span>`}else i.classList.push(i.icon),s=`<span ${this._getHtmlBasicTmpl(i)}${t?' data-keys-path="'+t+'"':""}></span>`;return s}}status(e,t){if(!e.inactive&&!e.active)return"";const i=this.cloneObject(e);return e.length?this._arrayOfSchemas(e,"status"):e.$ref?this.status(this.getNewJSON(e),t):(e.$id&&this.registerJSONById(e),!1===this._validate(this.statusDef(),e)?(window.console.log("Failed JSON status:",e),"Failed JSON status!"):(i.classList||(i.classList=[]),i.classList.push("pw-icon"),i.classList.push("power-status"),`<span ${this._getHtmlBasicTmpl(i)}${t?' data-keys-path="'+t+'"':""} data-power-inactive="${i.inactive}" data-power-active="${i.active}"></span>`))}accordionDef(){return{$schema:"http://json-schema.org/draft-07/schema#",$id:"#/schema/draft-07/accordion",type:"object",properties:{$id:{type:"string"},$ref:{type:"string"},id:{type:"string"},classList:{type:"array"},config:{type:"object",properties:{multipleSectionsOpen:{type:"boolean"}}},panels:{type:"array",properties:{header:{type:"object",properties:{id:{type:"string"},label:{type:"string"},icon:{type:"string"},"icon-position":{type:"string"},status:{$ref:"#/schema/draft-07/status"}},required:["label","id"]},section:{type:"object",properties:{id:{type:"string"},text:{type:"string"},children:{type:"array",properties:{html:{$ref:"#/schema/draft-07/html"},button:{$ref:"#/schema/draft-07/item"},item:{$ref:"#/schema/draft-07/item"},status:{$ref:"#/schema/draft-07/status"},icon:{$ref:"#/schema/draft-07/icon"},menu:{$ref:"#/schema/draft-07/menu"},dropmenu:{$ref:"#/schema/draft-07/dropmenu"},dropmenubutton:{$ref:"#/schema/draft-07/dropmenubutton"},simpleform:{$ref:"#/schema/draft-07/simpleform"},tree:{$ref:"#/schema/draft-07/tree"},accordion:{$ref:"#/schema/draft-07/accordion"},grid:{$ref:"#/schema/draft-07/grid"}}}},required:["id"]}},required:["header","section"]}},required:["panels"]}}powertabsDef(){return{$schema:"http://json-schema.org/draft-07/schema#",$id:"#/schema/draft-07/powertabs",type:"object",properties:{$id:{type:"string"},$ref:{type:"string"},id:{type:"string"},classList:{type:"array"},tabs:{type:"array",properties:{header:{type:"object",properties:{id:{type:"string"},label:{type:"string"},icon:{type:"string"},"icon-position":{type:"string"},status:{$ref:"#/schema/draft-07/status"}},required:["label","id"]},section:{type:"object",properties:{id:{type:"string"},text:{type:"string"},children:{type:"array",properties:{html:{$ref:"#/schema/draft-07/html"},button:{$ref:"#/schema/draft-07/item"},item:{$ref:"#/schema/draft-07/item"},status:{$ref:"#/schema/draft-07/status"},icon:{$ref:"#/schema/draft-07/icon"},menu:{$ref:"#/schema/draft-07/menu"},dropmenu:{$ref:"#/schema/draft-07/dropmenu"},dropmenubutton:{$ref:"#/schema/draft-07/dropmenubutton"},simpleform:{$ref:"#/schema/draft-07/simpleform"},tree:{$ref:"#/schema/draft-07/tree"},accordion:{$ref:"#/schema/draft-07/accordion"},grid:{$ref:"#/schema/draft-07/grid"}}}},required:["id"]}},required:["header","section"]}},required:["tabs"]}}simpleformcontrolsDef(){return{$schema:"http://json-schema.org/draft-07/schema#",$id:"#/schema/draft-07/simpleformcontrols",type:"array",properties:{$id:{type:"string"},$ref:{type:"string"},classList:{type:"array"},label:{type:"string"},type:{type:"string"},value:{type:"any"},name:{type:"string"},bind:{type:"string"},id:{type:"string"},controls:{$ref:"#/schema/draft-07/simpleformcontrols"},button:{$ref:"#/schema/draft-07/item"},item:{$ref:"#/schema/draft-07/item"},status:{$ref:"#/schema/draft-07/status"},icon:{$ref:"#/schema/draft-07/icon"},menu:{$ref:"#/schema/draft-07/menu"},dropmenu:{$ref:"#/schema/draft-07/dropmenu"},dropmenubutton:{$ref:"#/schema/draft-07/dropmenubutton"},simpleform:{$ref:"#/schema/draft-07/simpleform"},tree:{$ref:"#/schema/draft-07/tree"},html:{$ref:"#/schema/draft-07/html"},accordion:{$ref:"#/schema/draft-07/accordion"},grid:{$ref:"#/schema/draft-07/grid"}}}}simpleformDef(){return{$schema:"http://json-schema.org/draft-07/schema#",$id:"#/schema/draft-07/simpleform",type:"object",properties:{$id:{type:"string"},$ref:{type:"string"},classList:{type:"array"},type:{type:"string"},inline:{type:"boolean"},padding:{type:"boolean"},controls:{$ref:"#/schema/draft-07/simpleformcontrols"}},required:["controls"]}}dropmenuDef(){return{$schema:"http://json-schema.org/draft-07/schema#",$id:"#/schema/draft-07/dropmenu",type:"object",properties:{$id:{type:"string"},$ref:{type:"string"},id:{type:"string"},classList:{type:"array"},items:{type:"array",properties:{button:{$ref:"#/schema/draft-07/item"},item:{$ref:"#/schema/draft-07/item"},status:{$ref:"#/schema/draft-07/status"},dropmenu:{$ref:"#/schema/draft-07/dropmenu"}}}},required:["id","items"]}}menuDef(){return{$schema:"http://json-schema.org/draft-07/schema#",$id:"#/schema/draft-07/menu",type:"object",properties:{$id:{type:"string"},$ref:{type:"string"},id:{type:"string"},classList:{type:"array"},mirrored:{type:"boolean"},dropMenuPosition:{type:"string"},orientation:{type:"string"},position:{type:"string"},priority:{type:"number"},ignore:{type:"boolean"},items:{type:"array",properties:{button:{$ref:"#/schema/draft-07/item"},item:{$ref:"#/schema/draft-07/item"},status:{$ref:"#/schema/draft-07/status"},dropmenu:{$ref:"#/schema/draft-07/dropmenu"}}}},required:["id"]}}toolbarDef(){return{$schema:"http://json-schema.org/draft-07/schema#",$id:"#/schema/draft-07/toolbar",type:"object",properties:{$id:{type:"string"},$ref:{type:"string"},id:{type:"string"},classList:{type:"array"},mirrored:{type:"boolean"},dropMenuPosition:{type:"string"},orientation:{type:"string"},position:{type:"string"},priority:{type:"number"},ignore:{type:"boolean"},items:{type:"array",properties:{button:{$ref:"#/schema/draft-07/item"},item:{$ref:"#/schema/draft-07/item"},status:{$ref:"#/schema/draft-07/status"},dropmenu:{$ref:"#/schema/draft-07/dropmenu"}}}},required:["id"]}}splitbarDef(){return{$schema:"http://json-schema.org/draft-07/schema#",$id:"#/schema/draft-07/splitbar",type:"object",properties:{$id:{type:"string"},$ref:{type:"string"},id:{type:"string"},classList:{type:"array"},orientation:{type:"string"},position:{type:"string"},priority:{type:"number"},border:{type:"number"},ignore:{type:"boolean"},resize:{type:"boolean"},content:{type:"string"}},required:["id","content"]}}itemDef(){return{$schema:"http://json-schema.org/draft-07/schema#",$id:"#/schema/draft-07/item",type:"object",properties:{$id:{type:"string"},$ref:{type:"string"},classList:{type:"array"},label:{type:"string"},id:{type:"string"},icon:{type:"string"},"icon-src":{type:"string"},"icon-position":{type:"string"},kind:{type:"string"},mirrored:{type:"boolean"},events:{type:"array",properties:{event:{type:"string"},fn:{type:"string"}},required:["event","fn"]}}}}treeNodeDef(){return{$schema:"http://json-schema.org/draft-07/schema#",$id:"#/schema/draft-07/treenode",type:"object",properties:{$id:{type:"string"},$ref:{type:"string"},classList:{type:"array"},id:{type:"string"},name:{type:"string"},fullName:{type:"string"},extension:{type:"string"},path:{type:"string"},kind:{type:"string"},events:{type:"array",properties:{event:{type:"string"},fn:{type:"string"}},required:["event","fn"]},nodes:{$ref:"tree"}},required:["name","fullName","path","kind"]}}treeDef(){return{$schema:"http://json-schema.org/draft-07/schema#",$id:"#/schema/draft-07/tree",type:"object",properties:{$id:{type:"string"},$ref:{type:"string"},id:{type:"string"},classList:{type:"array"},events:{type:"array",properties:{event:{type:"string"},fn:{type:"string"}},required:["event","fn"]},nodes:{$ref:"treenode"}},required:["nodes"]}}dropmenubuttonDef(){return{$schema:"http://json-schema.org/draft-07/schema#",$id:"#/schema/draft-07/dropmenubutton",type:"object",properties:{$id:{type:"string"},$ref:{type:"string"},button:{$ref:"#/schema/draft-07/item"},status:{$ref:"#/schema/draft-07/status"},dropmenu:{$ref:"#/schema/draft-07/dropmenu"}},required:["button"]}}statusDef(){return{$schema:"http://json-schema.org/draft-07/schema#",$id:"#/schema/draft-07/status",type:"object",properties:{$id:{type:"string"},$ref:{type:"string"},active:{type:"string"},inactive:{type:"string"},position:{type:"string"},classList:{type:"array"}},required:["active","inactive"]}}iconDef(){return{$schema:"http://json-schema.org/draft-07/schema#",$id:"#/schema/draft-07/icon",type:"object",properties:{$id:{type:"string"},$ref:{type:"string"},icon:{type:"string"},kind:{type:"string"},src:{type:"string"},classList:{type:"array"}}}}htmlDef(){return{$schema:"http://json-schema.org/draft-07/schema#",$id:"#/schema/draft-07/html",type:"object",properties:{$id:{type:"string"},$ref:{type:"string"},classList:{type:"array"},id:{type:"string"},tagName:{type:"string"},multiple:{type:"boolean"},src:{type:"string"},width:{type:"string"},height:{type:"string"},type:{type:"string"},bind:{type:"string"},title:{type:"string"},for:{type:"string"},attrs:{type:"array"},cols:{type:"string"},rows:{type:"string"},value:{type:"any"},name:{type:"string"},required:{type:"boolean"},disabled:{type:"boolean"},pattern:{type:"string"},events:{type:"array",properties:{event:{type:"string"},fn:{type:"string"}},required:["event","fn"]},children:{type:"array",properties:{$id:{type:"string"},$ref:{type:"string"},classList:{type:"array"},id:{type:"string"},tagName:{type:"string"},multiple:{type:"boolean"},src:{type:"string"},width:{type:"string"},height:{type:"string"},type:{type:"string"},bind:{type:"string"},title:{type:"string"},for:{type:"string"},attrs:{type:"array"},cols:{type:"string"},rows:{type:"string"},value:{type:"any"},name:{type:"string"},required:{type:"boolean"},disabled:{type:"boolean"},pattern:{type:"string"},events:{type:"array",properties:{event:{type:"string"},fn:{type:"string"}},required:["event","fn"]},html:{$ref:"#/schema/draft-07/html"},button:{$ref:"#/schema/draft-07/item"},item:{$ref:"#/schema/draft-07/item"},status:{$ref:"#/schema/draft-07/status"},icon:{$ref:"#/schema/draft-07/icon"},menu:{$ref:"#/schema/draft-07/menu"},dropmenu:{$ref:"#/schema/draft-07/dropmenu"},dropmenubutton:{$ref:"#/schema/draft-07/dropmenubutton"},simpleform:{$ref:"#/schema/draft-07/simpleform"},tree:{$ref:"#/schema/draft-07/tree"},accordion:{$ref:"#/schema/draft-07/accordion"},grid:{$ref:"#/schema/draft-07/grid"}}}}}}gridDef(){return{$schema:"http://json-schema.org/draft-07/schema#",$id:"#/schema/draft-07/grid",type:"object",properties:{$id:{type:"string"},$ref:{type:"string"},classList:{type:"array"},id:{type:"string"},kind:{type:"string"},border:{type:"boolean"},gap:{type:"number"},sizes:{type:"array"},fields:{type:"array",properties:{classList:{type:"array"},text:{type:"string"},size:{type:"string"},events:{type:"array",properties:{event:{type:"string"},fn:{type:"string"}},required:["event","fn"]},children:{type:"array",properties:{html:{$ref:"#/schema/draft-07/html"},button:{$ref:"#/schema/draft-07/item"},item:{$ref:"#/schema/draft-07/item"},status:{$ref:"#/schema/draft-07/status"},icon:{$ref:"#/schema/draft-07/icon"},menu:{$ref:"#/schema/draft-07/menu"},dropmenu:{$ref:"#/schema/draft-07/dropmenu"},dropmenubutton:{$ref:"#/schema/draft-07/dropmenubutton"},simpleform:{$ref:"#/schema/draft-07/simpleform"},tree:{$ref:"#/schema/draft-07/tree"},accordion:{$ref:"#/schema/draft-07/accordion"},grid:{$ref:"#/schema/draft-07/grid"}}}}},events:{type:"array",properties:{event:{type:"string"},fn:{type:"string"}},required:["event","fn"]}},required:["fields"]}}$ref(e){const t="#/schema/draft-07/",i={};return i[`${t}item`]=this.itemDef,i[`${t}status`]=this.statusDef,i[`${t}icon`]=this.iconDef,i[`${t}menu`]=this.menuDef,i[`${t}dropmenu`]=this.dropmenuDef,i[`${t}dropmenubutton`]=this.dropmenubuttonDef,i[`${t}simpleform`]=this.simpleformDef,i[`${t}simpleformcontrols`]=this.simpleformcontrolsDef,i[`${t}tree`]=this.treeDef,i[`${t}html`]=this.htmlDef,i[`${t}accordion`]=this.accordionDef,i[`${t}grid`]=this.gridDef,i[e]()}}class WidgetService extends PowerServices{mayAddCtrlParams({params:e,onCommit:t,onCancel:i}){return void 0===e&&(e={}),t&&(e.onCommit=t),i&&(e.onCancel=i),e}alert(e){return e.kind="alert",this.open(e)}confirm(e){return e.kind="confirm",this.open(e)}yesno(e){return e.kind="yesno",this.open(e)}modal(e){return e.kind="modal",this.open(e)}window(e){return e.kind="window",this.open(e)}windowIframe(e){return e.kind="windowIframe",this.open(e)}open({title:e,template:t,ctrl:i,target:s,params:o,controller:n,kind:r,onCommit:a,onCancel:l,templateUrl:h,templateComponent:d,url:c}){let u,p;const m=new Promise((function(e,t){u=e,p=t}));i||n||(n=function(){}),!i&&n&&"function"==typeof n&&(i=wrapFunctionInsideDialog({controller:n,kind:r,params:o=this.mayAddCtrlParams({params:o,onCommit:a,onCancel:l}),resolve:u,reject:p,_promise:m}));const w=`pow_route_${this.$powerUi._Unique.next()}`;return this.$ctrl.volatileRouteIds.push(w),this._open({routeId:w,target:s||"_blank",title:e,template:t,templateUrl:h,templateComponent:d,url:c,ctrl:i,params:o}),m}_open({routeId:e,params:t,target:i,title:s,template:o,ctrl:n,templateUrl:r,templateComponent:a,url:l}){const h={id:e,title:s,route:this.$powerUi.router.config.rootPath+e,template:r||a||o||l,templateUrl:r,templateComponent:a,hidden:!0,ctrl:n,isHidden:!0};this.$powerUi.router.routes[e]=h,this.$powerUi.router.openRoute({routeId:e||this.$ctrl._routeId,currentRouteId:this.$ctrl._routeId,currentViewId:this.$ctrl._viewId,params:t,target:i,title:s||null})}}class PowerController extends PowerScope{constructor({$powerUi:e}){super({$powerUi:e}),this.volatileRouteIds=[],this.onCycleEnds&&this.$powerUi.router.onCycleEnds.subscribe(this.onCycleEnds.bind(this))}_load(e){const t=this;return new Promise((function(i,s){t.load(i,s,e)}))}get router(){return this.$powerUi.router}keepScrollPosition(){const e=document.getElementById(this._viewId),t=e.getElementsByClassName("pw-container")[0],i=e.getElementsByClassName("pw-body")[0];t&&(this._containerScrollTop=t.scrollTop||0,this._containerScrollLeft=t.scrollLeft||0),i&&(this._bodyScrollTop=i.scrollTop||0,this._bodyScrollLeft=i.scrollLeft||0)}refresh(e){this.keepScrollPosition(),this.router.engineCommands.addPendingComand(e||this._routeId,{name:"refresh",value:!0}),this.router.cloneRoutesAndRunEngine()}reload(e){this.keepScrollPosition(),this.router.engineCommands.addPendingComand(e||this._routeId,{name:"reload",value:!0}),this.router.cloneRoutesAndRunEngine()}getRouteCtrl(e){return this.$powerUi.getRouteCtrl(e)}getViewCtrl(e){return this.$powerUi.getViewCtrl(e)}getRouteParam(e){let t=this._routeParams.find(t=>t.key===e),i=t?t.value:null;const s=i?parseInt(i):null;return Number.isNaN(s)?i:s}request(e){const t=this;return new Promise((function(i,s){t.$powerUi.request(e).then((function(e){i(e)})).catch((function(e){s(e)}))}))}openRoute({routeId:e,params:t,target:i,data:s={},commands:o=[]}){const n="root-view"===this._viewId?"main-view":this._viewId,r="$root"===this._routeId?this.$powerUi.controllers["main-view"].instance._routeId:this._routeId,a=this.$powerUi.router.getOpenedRoute({routeId:r,viewId:n});this.router.openRoute({routeId:e||r,currentRouteId:r,currentViewId:n,params:t,target:i,title:a.title||null,data:s,commands:o})}_onViewLoad(){if("main-view"===this._viewId){const e=document.getElementById("app-container");e.scrollTop=this._currentScrollTop||0,e.scrollLeft=this._currentScrollLeft||0}}_onRemoveView(){if("main-view"===this._viewId){const e=document.getElementById("app-container");this._currentScrollTop=e.scrollTop,this._currentScrollLeft=e.scrollLeft}}addCommands(e){this.router.engineCommands.addCommands(e)}closeCurrentRoute({callback:e=null,commands:t=[]}={}){if(this.router.engineIsRunning||this.router.phantomRouter)return void this.router.closePhantomRoute(this._routeId,this);e&&this.router.pendingCallbacks.push(e.bind(this)),t.length&&this.addCommands(t);const i=this.router.getOpenedRoute({routeId:this._routeId,viewId:this._viewId}),s=this.$powerUi.removeRouteFromHash(this.router.locationHashWithHiddenRoutes(),this._routeId,this._viewId);this.router.navigate({hash:s,title:i.title||null})}safeEval(e){return this.$powerUi.safeEval({text:e,scope:this})}getObjectById(e){return this.$powerUi.powerTree.allPowerObjsById[e]||null}getBindById(e){const t=this.getObjectById(e);return t?t.powBind:null}_$postMessage(e,t,i){e.postMessage(t,i)}_$postToIframe(e,t){const i=document.getElementById(e);this._$postMessage(i.contentWindow,t,this.$powerUi.devMode.target)}_$postToMain(e){this._$postMessage(window.parent.window,e,this.$powerUi.devMode.target)}_$selectElementToEdit(e,t){if(!this.$powerUi.devMode.isEditable||!this.$powerUi.devMode.child)return;this.$powerUi._$nodeSelectdToEdit&&this.$powerUi._$nodeSelectdToEdit.classList.remove("pw-selected-to-edit");const i=this._$addSizesInPx(e.target);this.$powerUi._$nodeSelectdToEdit=e.target,this.$powerUi._$nodeSelectdToEdit.classList.add("pw-selected-to-edit"),this._$postToMain({command:"selectNodeToEdit",level:this.$powerUi._$nodeSelectdToEdit.dataset.level,file:t.dataset.file,route:t.dataset.route,sizes:i})}_$addSizesInPx(e){const t={};let i=window.getComputedStyle(e,null);const s=i.fontSize;return t.currentPx=i.getPropertyValue("font-size"),e.style.fontSize="1em",i=window.getComputedStyle(e,null),t.emPx=i.getPropertyValue("font-size"),e.style.fontSize="1rem",i=window.getComputedStyle(e,null),t.remPx=i.getPropertyValue("font-size"),e.style.fontSize="100%",i=window.getComputedStyle(e,null),t.percentagePx=i.getPropertyValue("font-size"),e.style.fontSize=s,e.style.fontSize=null,t}_$createEditableHtml(e,t,i,s){if(!this.$powerUi.devMode.isEditable||!this.$powerUi.devMode.child)return e;e=e.replaceAll("onclick","ondblclick");const o=(new DOMParser).parseFromString(e,"text/html");let n=0;for(const e of o.body.children)e.classList.add("pw-allow-edit-element"),e.dataset.file=t,e.dataset.route=i,e.dataset.powEvent="",e.setAttribute("onclick","_$selectElementToEdit(event, _node)"),s||this.$powerUi.simpleSweepDOM(e,(function(e,t){e.dataset.level=t,e.htmlFor&&(e.dataset.sFor=e.htmlFor,e.removeAttribute("for"))}),n),n+=1;return o}}export{PowerController};class Request{constructor({config:e,$powerUi:t}){this.$powerUi=t,e.authCookie&&(this.$powerUi.authCookie=e.authCookie),e.authToken&&(this.$powerUi.authToken=e.authToken),e.headers&&(this.$powerUi.headers=e.headers);const i=this;return function(e){e.withCredentials=void 0===e.withCredentials||e.withCredentials,e.headers=e.headers||i.$powerUi.headers||{},i.$powerUi.authCookie&&(e.headers.Authorization=`Bearer ${i.$powerUi.getCookie(i.$powerUi.authCookie)}`||null);const t={then:function(e){return this.onsucess=e,this},catch:function(e){return this.onerror=e,this}};return i.ajaxRequest({method:e.method,url:e.url,data:e,onsucess:function(e){if(t.onsucess)try{const s=JSON.parse(e.response);try{s.action&&i.$powerUi.config.serverCommands&&i.$powerUi.config.serverCommands[s.action]&&i.$powerUi.config.serverCommands[s.action].run({response:s,$powerUi:i.$powerUi,$root:i.$powerUi.getRouteCtrl("$root")})}catch(i){return t.onerror(i,s,e)}return t.onsucess(s,e)}catch(i){return t.onsucess(e.response,e)}return t},onerror:function(e){if(t.onerror)try{const s=JSON.parse(e.response);try{if(s.action&&i.$powerUi.config.serverCommands&&i.$powerUi.config.serverCommands[s.action]&&i.$powerUi.config.serverCommands[s.action].run({response:s,$powerUi:i.$powerUi,$root:i.$powerUi.getRouteCtrl("$root")}),s&&s.fields&&s.fields.length>0)for(const e of s.fields)i.$powerUi.onFormError({id:e.id,msg:e.msg})}catch(i){return t.onerror(i,s,e)}return t.onerror(s,e)}catch(i){return t.onerror(e.response,e)}}}),t}}encodedParams(e){var t="";for(var i in e)e.hasOwnProperty(i)&&(t.length>0&&(t+="&"),t+=encodeURI(i+"="+e[i]));return t}ajaxRequest({method:e,url:t,onsucess:i,onerror:s,async:o,data:n}){null==o&&(o=!0);const r=new XMLHttpRequest;return r.open(e,t,o),r.onload=function(){200===r.status&&i?i(r):200!==r.status&&s?s(r):window.console("Request failed.  Returned status of "+r.status)},r.withCredentials=n.withCredentials,r.setRequestHeader("Content-Type","application/json"),n.headers&&n.headers["Content-Type"]&&r.setRequestHeader("Content-Type",n.headers["Content-Type"]),n.headers&&n.headers.Authorization&&r.setRequestHeader("Authorization",n.headers.Authorization),n&&n.body?r.send(JSON.stringify(n.body)):r.send(),r}}function getEmptyRouteObjetc(){return{params:[],id:"",viewId:"",route:"",parentRouteId:null,parentViewId:null,kind:"",secondaryRoutes:[],hiddenRoutes:[],mainChildRoutes:[],secondaryChildRoutes:[],hiddenChildRoutes:[]}}class EngineCommands{constructor(e){this.bootstraping=!0,this.pending={},this.router=e,this.routes={},this.default={close:{runBeforeClose:!0,runOnRemoveCtrl:!0,removeCtrl:!0,runOnRemoveView:!0,removeView:!0},open:{addCtrl:!0,runLoad:!0,runCtrl:!0,addView:!0,runOnViewLoad:!0}},this.command={refresh:{close:{runBeforeClose:!1,runOnRemoveCtrl:!1,removeCtrl:!1,runOnRemoveView:!0,removeView:!0},open:{addCtrl:!1,runLoad:!1,runCtrl:!1,addView:!0,runOnViewLoad:!0}},reload:{close:{runBeforeClose:!0,runOnRemoveCtrl:!0,removeCtrl:!0,runOnRemoveView:!0,removeView:!0},open:{addCtrl:!0,runLoad:!0,runCtrl:!0,addView:!0,runOnViewLoad:!0}}},"root"===this.router.config.routerMode?this.default.close.rootView={refresh:!0}:"parent"===this.router.config.routerMode&&(this.default.close.parentView={refresh:!0})}buildOtherCicleCommands(){this.bootstraping?this.bootstraping=!1:(this.buildPendingCloseCommands(),this.buildPendingOpenCommands(),this.buildPendingListCommands(),this.pending={})}addPendingComand(e,t){this.pending[e]||(this.pending[e]={}),this.pending[e][t.name]=t.value}propagateCommand({currentRouteId:e,sourceRouteId:t}){for(const i of Object.keys(this.pending[t]||{})){const s=this.pending[t][i];this.addPendingComand(e,{name:i,value:s})}}addCommands(e){for(const t of Object.keys(e||{}))for(const i of Object.keys(e[t]||{}))for(const s of Object.keys(e[t][i]||{})){const o={};o.name=s,o.value=e[t][i][s],this.addPendingComand(i,o)}}override(e,t,i){for(const s of Object.keys(this.pending[t]||{}))for(const t of Object.keys(this.command[s][i]||{}))e[t]=this.command[s][i][t]}buildRouteOpenCommands(e,t,i){if(i){const t={};return this.override(t,e,"open"),t}return this.default.open}buildRouteCloseCommands(e,t,i){if(i){const t={};return this.override(t,e,"close"),t}return this.default.close}buildPendingCloseCommands(){this.routesToAdd=[];for(const e of this.router.orderedRoutesToClose)e.parentRouteId&&e.commands.parentView&&!0===e.commands.parentView.refresh&&this.parentCommands(e,0);for(const e of this.routesToAdd)this.router.orderedRoutesToClose.splice(e.index+1,0,e.route_close)}buildPendingOpenCommands(){for(const e of this.routesToAdd){const t=this.router.orderedRoutesToOpen.findIndex(t=>t.parentRouteId===e.route_open.routeId);this.router.orderedRoutesToOpen.splice(t,0,e.route_open)}}buildPendingListCommands(){const e=this.pending.$root;e&&this.rootCommands(e)}overrideCommands(e,t,i){for(const e of Object.keys(i.close||{}))void 0!==t.commands[e]&&!0!==i.close[e]||(t.commands[e]=i.close[e]);for(const t of Object.keys(i.open||{}))void 0!==e.commands[t]&&!0!==i.open[t]||(e.commands[t]=i.open[t])}parentCommands(e,t){let i=this.router.getOpenedRoute({routeId:e.parentRouteId,viewId:e.parentViewId});if(i||"$root"!==e.parentRouteId||(i={id:"$root",viewId:"root-view",params:null,kind:"root",parentRouteId:null,parentViewId:null,powerViewNodeId:"root-view"}),!this.router.orderedRoutesToClose.find(t=>t.routeId===e.parentRouteId)&&i){const s={routeId:i.id,viewId:i.viewId,params:i.params,kind:i.kind,parentRouteId:i.parentRouteId,parentViewId:i.parentViewId,powerViewNodeId:this.router.routes[i.parentRouteId]?this.router.routes[i.parentRouteId].powerViewNodeId:null},o=Object.assign({},s);o.commands={};const n=Object.assign({},s);n.commands={};for(const t of Object.keys(e.commands.parentView||{}))this.command[t]&&this.overrideCommands(o,n,this.command[t]);this.routesToAdd.push({index:t,route_close:n,route_open:o})}t+=1}rootCommands(e){const t={routeId:"$root",viewId:"root-view",paramKeys:null,kind:"root"},i=Object.assign({},t);i.commands={};const s=Object.assign({},t);s.commands={};for(const t of Object.keys(e||{}))this.command[t]&&this.overrideCommands(i,s,this.command[t]);this.router.orderedRoutesToOpen.unshift(i),this.router.orderedRoutesToClose.push(s)}}class Router{constructor(e,t){if(this.config=e||{},this.$powerUi=t,this.routes={},this.routeData={},this.pendingCallbacks=[],this.oldRoutesBkp=getEmptyRouteObjetc(),this.oldRoutes=getEmptyRouteObjetc(),this.currentRoutes=getEmptyRouteObjetc(),this.phantomRouter=null,this.engineCommands=new EngineCommands(this),this.onCycleEnds=new UEvent("onCycleEnds"),this.onRouteChange=new UEvent("onRouteChange"),this.config.rootPath||(this.config.rootPath="#!/"),e.routes)for(const t of e.routes)this.add(t);this.config.phantomMode||(this.initRootScopeAndRunEngine(),window.onhashchange=this.hashChange.bind(this))}getCurrentRouteIds(){const e=[];this.currentRoutes.parentRouteId&&e.push(this.currentRoutes.parentRouteId),e.push(this.currentRoutes.id);for(const t of this.currentRoutes.mainChildRoutes)e.push(t.id);for(const t of this.currentRoutes.hiddenRoutes)e.push(t.id);for(const t of this.currentRoutes.hiddenChildRoutes)e.push(t.id);for(const t of this.currentRoutes.secondaryRoutes)e.push(t.id);for(const t of this.currentRoutes.secondaryChildRoutes)e.push(t.id);return e}add(e){if(e.template=e.templateUrl||e.template||e.templateComponent||e.url||!!e.dynamicUrl&&"dynamicUrl",this.config.routerMainViewId="main-view",this.config.routerSecondaryViewId="secondary-view",!e.id)throw new Error("A route ID must be given");if(!e.ctrl&&"otherwise"!==e.id)throw window.console.log("route missing ctrl:",e),new Error('A route "ctrl" must be given');if("string"!=typeof e.route&&"$root"!==e.id)throw new TypeError("typeof route must be a string");if("/"===e.route&&(e.route=""),"$root"===e.id?e.route="":e.route=this.config.rootPath+(e.route||""),"otherwise"!==e.id||e.template)for(const t of Object.keys(this.routes||{}))if(this.routes[t].route===e.route&&("otherwise"!==t||this.routes[t].template))throw"otherwise"===t||"otherwise"===e.id?new Error(`the route "${e.route||"/"}" already exists, so "${e.id}" can't use it if you use a template. You can remove the template or use another route.`):new Error(`the route "${e.route||"/"}" already exists, so "${e.id}" can't use it.`);if(this.routes[e.id])throw new Error(`the id ${e.id} already exists`);this.routes[e.id]=e}hashChange(e){!0!==this.engineIsRunning?(this.currentUrl=e?e.newURL:window.location.href,this.previousUrl=e?e.oldURL:window.location.href,this.oldRoutesBkp=this.cloneRoutes({source:this.oldRoutes}),this.oldRoutes=this.cloneRoutes({source:this.currentRoutes}),this.currentRoutes=getEmptyRouteObjetc(),this.engine()):this.engineIsRunning=!1}cloneRoutesAndRunEngine(){this.currentUrl=window.location.href,this.previousUrl=window.location.href,this.oldRoutesBkp=this.cloneRoutes({source:this.oldRoutes}),this.oldRoutes=this.cloneRoutes({source:this.currentRoutes}),this.currentRoutes=getEmptyRouteObjetc(),this.engine()}abortCicle(){this.currentRoutes=this.cloneRoutes({source:this.oldRoutes}),this.oldRoutes=this.cloneRoutes({source:this.oldRoutesBkp}),this.clearPhantomRouter(),window.location.href=this.previousUrl,this.engineIsRunning=!1}clearPhantomRouter(){delete this.phantomRouter,this.phantomRouter=null}cloneRouteList(e,t,i){for(const s of t[i]){const t={id:s.id,viewId:s.viewId,route:s.route,parentRouteId:s.parentRouteId,parentViewId:s.parentViewId,kind:s.kind,params:[]};for(const e of s.params)t.params.push({key:e.key,value:e.value});e[i].push(t)}}cloneRoutes({source:e}){const t={params:[],id:e.id,viewId:e.viewId,route:e.route,parentRouteId:e.parentRouteId,parentViewId:e.parentViewId,kind:e.kind,secondaryRoutes:[],hiddenRoutes:[],mainChildRoutes:[],secondaryChildRoutes:[],hiddenChildRoutes:[]};for(const i of e.params)t.params.push({key:i.key,value:i.value});return this.cloneRouteList(t,e,"secondaryRoutes"),this.cloneRouteList(t,e,"hiddenRoutes"),this.cloneRouteList(t,e,"mainChildRoutes"),this.cloneRouteList(t,e,"secondaryChildRoutes"),this.cloneRouteList(t,e,"hiddenChildRoutes"),t}locationHashWithHiddenRoutes(){return decodeURI(window.location.hash+(this.hiddenLocationHash||""))}addSpinnerAndHideContent(e){if(!document.getElementById("_power-spinner")){const e=document.createElement("div");e.classList.add("pw-spinner-backdrop"),e.id="_power-spinner";const t=document.createElement("p");t.classList.add("pw-spinner-label"),t.innerText=this.config.spinnerLabel||"LOADING",e.appendChild(t);const i=document.createElement("div");i.classList.add("pw-spinner"),e.appendChild(i),document.body.appendChild(e)}const t=document.getElementById("app-container");t.classList.add("pw-show-spinner"),t.style.opacity=0}removeSpinnerAndShowContent(e){const t=document.getElementById("_power-spinner");if(t&&t.parentNode.removeChild(t),e){document.getElementById(e).style.visibility="visible"}const i=document.getElementById("app-container");i.classList.remove("pw-show-spinner"),i.style.opacity=1}buildRoutesTree(e){const t={full_path:e,mainRoute:{path:e},secondaryRoutes:[],hiddenRoutes:[]};if(e.includes("?")){const i=e.split("?");t.mainRoute=this.buildPathAndChildRoute(i[0]);for(const e of i)if(e.includes("sr=")){for(const i of e.split("sr="))if(i){const e=this.buildPathAndChildRoute(this.config.rootPath+i);t.secondaryRoutes.push(e)}}else if(e.includes("hr="))for(const i of e.split("hr="))if(i){const e=this.buildPathAndChildRoute(this.config.rootPath+i);t.hiddenRoutes.push(e)}}else t.mainRoute=this.buildPathAndChildRoute(e);return t}buildPathAndChildRoute(e){const t={};let i=t;const s=(e=e.replace(this.config.rootPath,"")).split("&ch=");if(e.includes("&ch="))for(const e of s)e!==s[0]&&(i.childRoute={path:e},i=i.childRoute);return t.path=s[0],t}recursivelyAddChildRoute(e,t,i,s,o,n){const r=`${t}ChildRoutes`;if(e&&e.childRoute){const a=this.matchRouteAndGetIdAndParamKeys(e.childRoute);let l=!1;if(a){n&&(this.engineCommands.propagateCommand({currentRouteId:a.routeId,sourceRouteId:n}),n=a.routeId),l=this.getVewIdIfRouteExists(e.childRoute.path,r);const h=!1===l,d=!1===h&&void 0!==this.engineCommands.pending[a.routeId];(!0===h||d||n)&&(l=l||_Unique.domID("view"),this.orderedRoutesToOpen.push({routeId:a.routeId,viewId:l,paramKeys:a.paramKeys,kind:"child",powerViewNodeId:i,parentRouteId:s,parentViewId:o,commands:this.engineCommands.buildRouteOpenCommands(a.routeId,l,d)})),this.setChildRouteState({routeId:a.routeId,paramKeys:a.paramKeys,route:e.childRoute.path,viewId:l,title:this.routes[a.routeId].title,data:this.routes[a.routeId].data,mainKind:t,parentRouteId:s,parentViewId:o,kind:"child"})}e.childRoute.childRoute&&this.recursivelyAddChildRoute(e.childRoute,t,a.powerViewNodeId,a?a.routeId:null,l||null,n)}}setMainRouteAndAddToOrderedRoutesToLoad(e){const t=this.matchRouteAndGetIdAndParamKeys(e.mainRoute);if(t){let i=!1;this.engineCommands.pending.$root&&(this.engineCommands.propagateCommand({currentRouteId:t.routeId,sourceRouteId:"$root"}),i=t.routeId);const s=!1===(!this.oldRoutes.id||this.oldRoutes.route!==e.mainRoute.path)&&void 0!==this.engineCommands.pending[t.routeId];(i||s||!this.oldRoutes.id||this.oldRoutes.route!==e.mainRoute.path)&&this.orderedRoutesToOpen.push({route:e.mainRoute.path,routeId:t.routeId,viewId:this.config.routerMainViewId,paramKeys:t.paramKeys,kind:"main",parentRouteId:this.hasRoot?"$root":null,parentViewId:this.hasRoot?"root-view":null,powerViewNodeId:"root-view",commands:this.engineCommands.buildRouteOpenCommands(t.routeId,this.config.routerMainViewId,s)}),this.setMainRouteState({routeId:t.routeId,paramKeys:t.paramKeys,route:e.mainRoute.path,viewId:this.config.routerMainViewId,title:this.routes[t.routeId].title,data:this.routes[t.routeId].data,parentRouteId:this.hasRoot?"$root":null,parentViewId:this.hasRoot?"root-view":null,powerViewNodeId:"root-view",kind:"main"}),this.recursivelyAddChildRoute(e.mainRoute,"main",t.powerViewNodeId,t.routeId,"main-view",i)}else{const e=this.routes.otherwise?this.routes.otherwise.route:this.config.rootPath;window.location.replace(encodeURI(e))}}setOtherRoutesAndAddToOrderedRoutesToLoad(e,t,i,s){for(const o of e){const e=this.matchRouteAndGetIdAndParamKeys(o);if(e){let n=!1;this.engineCommands.pending.$root&&(this.engineCommands.propagateCommand({currentRouteId:e.routeId,sourceRouteId:"$root"}),n=e.routeId);let r=this.getVewIdIfRouteExists(o.path,t);const a=!1===(!1===r)&&void 0!==this.engineCommands.pending[e.routeId];(!1===r||a||n)&&(r=r||_Unique.domID("view"),this.orderedRoutesToOpen.push({route:o.path,routeId:e.routeId,viewId:r,paramKeys:e.paramKeys,kind:i,parentRouteId:null,parentViewId:null,commands:this.engineCommands.buildRouteOpenCommands(e.routeId,r,a)})),s({routeId:e.routeId,paramKeys:e.paramKeys,route:o.path,viewId:r,title:this.routes[e.routeId].title,data:this.routes[e.routeId].data,parentRouteId:null,parentViewId:null,kind:i}),this.recursivelyAddChildRoute(o,i,e.powerViewNodeId,e.routeId,r||null,n)}}}setNewRoutesAndbuildOrderedRoutesToLoad(){const e=this.buildRoutesTree(this.locationHashWithHiddenRoutes()||this.config.rootPath);this.setMainRouteAndAddToOrderedRoutesToLoad(e),this.setOtherRoutesAndAddToOrderedRoutesToLoad(e.secondaryRoutes,"secondaryRoutes","secondary",this.setSecondaryRouteState.bind(this)),this.setOtherRoutesAndAddToOrderedRoutesToLoad(e.hiddenRoutes,"hiddenRoutes","hidden",this.setHiddenRouteState.bind(this))}initRootScopeAndRunEngine(){const e=this.$powerUi.config.routes.find(e=>"$root"===e.id),t=this.engineCommands.buildRouteOpenCommands("$root","root-view",!1),i=this.engineCommands.buildRouteCloseCommands("$root","root-view",!1),s=Object.assign(t,i);delete s.parentView,delete s.rootView;const o={routeId:"$root",viewId:"root-view",paramKeys:null,kind:"root",commands:s};e?(this.hasRoot=!0,this.engine(o)):this.engine()}setDefaultCommands(){if(this.engineCommands.default.close.rootView&&this.engineCommands.default.close.rootView.refresh&&this.previousUrl&&this.currentUrl){const e=this.currentUrl.split("?"),t=this.previousUrl.split("?");(e.length<t.length||e.length===t.length&&this.previousUrl!==this.currentUrl)&&this.engineCommands.addPendingComand("$root",{name:"refresh",value:!0})}}async engine(e){this.config.phantomMode?this.removeSpinnerAndShowContent():(this.addSpinnerAndHideContent(),this.setDefaultCommands()),this.engineIsRunning=!0;const t=this.getRoutesToRunOnBeforeClose();if("abort"===await this.resolveWhenListIsPopulated(this.runBeforeCloseInOrder,t,0,this))return void this.abortCicle();if(this.orderedRoutesToOpen=e?[e]:[],this.orderedRoutesToClose=[],this.setNewRoutesAndbuildOrderedRoutesToLoad(),this.buildOrderedRoutesToClose(),this.engineCommands.buildOtherCicleCommands(),this.clearPhantomRouter(),await this.resolveWhenListIsPopulated(this.removeViewInOrder,this.orderedRoutesToClose,0,this),await this.resolveWhenListIsPopulated(this.runOnRemoveCtrlAndRemoveController,this.orderedRoutesToClose,0,this),await this.resolveWhenListIsPopulated(this.initRouteControllerAndRunLoadInOrder,this.orderedRoutesToOpen,0,this),await this.resolveWhenListIsPopulated(this.runControllerInOrder,this.orderedRoutesToOpen,0,this),await this.resolveWhenListIsPopulated(this.loadViewInOrder,this.orderedRoutesToOpen,0,this),await this.resolveWhenListIsPopulated(this.runOnViewLoadInOrder,this.orderedRoutesToOpen,0,this),this.engineIsRunning=!1,this.pendingCallbacks.length){for(const e of this.pendingCallbacks)e();this.pendingCallbacks=[]}this.config.phantomMode||(this.onCycleEnds.broadcast(),this.onCycleEnds.observers=[]);const i=this;setTimeout((function(){if(i.onRouteChange.broadcast(),i.$powerUi.devMode&&i.$powerUi.devMode.child&&i.$powerUi.devMode.isEditable){i.$powerUi.getRouteCtrl("$root")._$postToMain({routeIds:i.getCurrentRouteIds(),command:"setCurrentBody",body:document.getElementsByTagName("BODY")[0].innerHTML})}}),150)}resolveWhenListIsPopulated(e,t,i,s){return new Promise((function(o){e(t,i,s,o)}))}removeViewInOrder(e,t,i,s){const o=e[t];if(!o)return s();if(!0===o.commands.runOnRemoveView&&i.$powerUi.controllers[o.viewId]&&i.$powerUi.controllers[o.viewId].instance&&i.$powerUi.controllers[o.viewId].instance.onRemoveView){const n=i.$powerUi.controllers[o.viewId].instance.onRemoveView();n&&n.then?n.then((function(n){i.$powerUi.controllers[o.viewId].instance._onRemoveView&&i.$powerUi.controllers[o.viewId].instance._onRemoveView(),i.removeView(o.viewId,i),i.callNextLinkWhenReady(i.removeViewInOrder,e,t+1,i,s)})).catch((function(e){s("abort"),e&&window.console.log("Error running onRemoveView: ",o.routeId,e)})):(i.$powerUi.controllers[o.viewId].instance._onRemoveView&&i.$powerUi.controllers[o.viewId].instance._onRemoveView(),i.removeView(o.viewId,i),i.callNextLinkWhenReady(i.removeViewInOrder,e,t+1,i,s))}else i.$powerUi.controllers[o.viewId].instance._onRemoveView&&i.$powerUi.controllers[o.viewId].instance._onRemoveView(),i.removeView(o.viewId,i),i.callNextLinkWhenReady(i.removeViewInOrder,e,t+1,i,s)}callNextLinkWhenReady(e,t,i,s,o){s.phantomRouter?s.phantomRouter.ready.subscribe((function(){e(t,i,s,o)})):e(t,i,s,o)}runBeforeCloseInOrder(e,t,i,s){const o=e[t];if(!o)return s();if(o.onBeforeClose){const n=o.onBeforeClose();n&&n.then?n.then((function(o){i.callNextLinkWhenReady(i.runBeforeCloseInOrder,e,t+1,i,s)})).catch((function(e){s("abort"),e&&window.console.log("Error running onBeforeClose: ",o.routeId,e)})):i.runBeforeCloseInOrder(e,t+1,i,s)}else i.runBeforeCloseInOrder(e,t+1,i,s)}initRouteControllerAndRunLoadInOrder(e,t,i,s){const o=e[t];if(!o)return s();if(o.commands.addCtrl){let e={};i.routeData[o.routeId]?(e=Object.assign(i.routeData[o.routeId],i.routes[o.routeId].data||{}),delete i.routeData[o.routeId]):e=Object.assign({},i.routes[o.routeId].data||{});const t=i.routes[o.routeId].ctrl;i.$powerUi.controllers[o.viewId]={component:t,data:e};const s=i.getOpenedRoute({routeId:o.routeId,viewId:o.viewId});e.$powerUi=i.$powerUi,e.viewId=o.viewId,e.routeId=o.routeId,e.title=i.routes[o.routeId].title,i.$powerUi.controllers[o.viewId].instance=new t(e),i.$powerUi.controllers[o.viewId].instance._viewId=o.viewId,i.$powerUi.controllers[o.viewId].instance._routeId=o.routeId,i.$powerUi.controllers[o.viewId].instance._routeParams=s?s.params:[],i.$powerUi.controllers[o.viewId].instance.$root=i.$powerUi.controllers["root-view"]&&i.$powerUi.controllers["root-view"].instance?i.$powerUi.controllers["root-view"].instance:null}if(o.commands.runLoad&&i.$powerUi.controllers[o.viewId]&&i.$powerUi.controllers[o.viewId].instance&&i.$powerUi.controllers[o.viewId].instance.load){i.$powerUi.controllers[o.viewId].instance._load(i.$powerUi.controllers[o.viewId].data).then((function(){i.initRouteControllerAndRunLoadInOrder(e,t+1,i,s)})).catch((function(e){window.console.log("Error load CTRL: ",e)}))}else i.initRouteControllerAndRunLoadInOrder(e,t+1,i,s)}runControllerInOrder(e,t,i,s){const o=e[t];if(!o)return s();if(o.commands.runCtrl&&i.$powerUi.controllers[o.viewId]&&i.$powerUi.controllers[o.viewId].instance&&i.$powerUi.controllers[o.viewId].instance.ctrl){const n=i.$powerUi.controllers[o.viewId].instance.ctrl(i.$powerUi.controllers[o.viewId].data);n&&n.then?n.then((function(){i.callNextLinkWhenReady(i.runControllerInOrder,e,t+1,i,s)})).catch((function(e){window.console.log("Error running CTRL: ",e)})):i.runControllerInOrder(e,t+1,i,s)}else i.runControllerInOrder(e,t+1,i,s)}runOnRemoveCtrlAndRemoveController(e,t,i,s){const o=e[t];if(!o)return s();if(i.$powerUi.controllers[o.viewId]&&i.$powerUi.controllers[o.viewId].instance){const n=!(!o.commands.runOnRemoveCtrl||!i.$powerUi.controllers[o.viewId].instance.onRemoveCtrl)&&i.$powerUi.controllers[o.viewId].instance.onRemoveCtrl();n&&n.then?n.then((function(){o.commands.runOnRemoveCtrl&&(i.$powerUi.controllers[o.viewId].instance._onRemoveCtrl&&i.$powerUi.controllers[o.viewId].instance._onRemoveCtrl(),i.removeVolatileViews(o.viewId),delete i.$powerUi.controllers[o.viewId]),i.callNextLinkWhenReady(i.runOnRemoveCtrlAndRemoveController,e,t+1,i,s)})).catch((function(e){window.console.log("Error running onRemoveCtrl: ",o.routeId,e)})):(o.commands.runOnRemoveCtrl&&(i.$powerUi.controllers[o.viewId].instance._onRemoveCtrl&&i.$powerUi.controllers[o.viewId].instance._onRemoveCtrl(),i.removeVolatileViews(o.viewId),delete i.$powerUi.controllers[o.viewId]),i.runOnRemoveCtrlAndRemoveController(e,t+1,i,s))}else o.commands.runOnRemoveCtrl&&i.$powerUi.controllers[o.viewId].instance._onRemoveCtrl&&i.$powerUi.controllers[o.viewId].instance._onRemoveCtrl(),i.runOnRemoveCtrlAndRemoveController(e,t+1,i,s)}removeVolatileViews(e){if(this.$powerUi.controllers[e]&&this.$powerUi.controllers[e].instance&&this.$powerUi.controllers[e].instance.volatileRouteIds&&this.$powerUi.controllers[e].instance.volatileRouteIds.length)for(const t of this.$powerUi.controllers[e].instance.volatileRouteIds)delete this.routes[t]}runOnViewLoadInOrder(e,t,i,s){const o=e[t];if(!o)return s();if(o.commands.runOnViewLoad&&i.$powerUi.controllers[o.viewId]&&i.$powerUi.controllers[o.viewId].instance)if(i.$powerUi.controllers[o.viewId].instance.onViewLoad){const n=i.$powerUi.controllers[o.viewId].instance.onViewLoad(i.$powerUi.powerTree.allPowerObjsById[o.viewId].$shared.element);n&&n.then?n.then((function(){i.afterOnViewLoad(i,o),i.runOnViewLoadInOrder(e,t+1,i,s)})).catch((function(e){window.console.log("Error running onViewLoad: ",o.routeId,e)})):(i.afterOnViewLoad(i,o),i.runOnViewLoadInOrder(e,t+1,i,s))}else i.afterOnViewLoad(i,o),i.runOnViewLoadInOrder(e,t+1,i,s);else i.afterOnViewLoad(i,o),i.runOnViewLoadInOrder(e,t+1,i,s)}afterOnViewLoad(e,t){e.$powerUi.controllers[t.viewId].instance._onViewLoad&&e.$powerUi.controllers[t.viewId].instance._onViewLoad(e.$powerUi.powerTree.allPowerObjsById[t.viewId].$shared.element)}removeViewAndRouteViewCss(e,t){const i=t.$powerUi.controllers[e].instance&&t.$powerUi.controllers[e].instance.$tscope?t.$powerUi.controllers[e].instance&&t.$powerUi.controllers[e].instance.$tscope:null,s=document.getElementById(e);if(i&&s){if(i.$classList&&i.$classList.length)for(const e of i.$classList)s.classList.remove(e);if(i.$routeClassList)for(const e of Object.keys(i.$routeClassList||{})){const t=i.$ctrl.getRouteCtrl(e),s=t?t._viewId:null,o=s?document.getElementById(s):null;if(o)for(const t of i.$routeClassList[e])o.classList.remove(t)}}}removeView(e,t){if(!this.$powerUi.powerTree)return;this.removeCustomCssNode(e),this.removeViewAndRouteViewCss(e,t);const i=document.getElementById(e);this.$powerUi.powerTree.allPowerObjsById[e]&&this.$powerUi.powerTree.allPowerObjsById[e].$shared&&("main-view"===e?this.$powerUi.powerTree.allPowerObjsById[e].$shared.removeInnerElementsFromPower():"root-view"===e?this.$powerUi.powerTree.allPowerObjsById[e].$shared.removeInnerElementsFromPower():this.$powerUi.powerTree.allPowerObjsById[e].$shared.removeElementAndInnersFromPower(i)),"main-view"!==e&&"root-view"!==e&&i&&i.parentNode.removeChild(i);const s=document.body.getElementsByClassName("pw-backdrop");s&&0===s.length&&document.body.classList.remove("modal-open")}recursivelyGetChildrenRoutesToRunOnBeforeClose(e,t){const i=this.matchRouteAndGetIdAndParamKeys(e);t.push(i),e.childRoute&&this.recursivelyGetChildrenRoutesToRunOnBeforeClose(e.childRoute,t)}addRouteToRoutesToClose(e,t,i){for(const s of t){if(void 0===i.find(e=>e.routeId===s.id)){const t=this.$powerUi.getRouteCtrl(s.id);t&&t.onBeforeClose&&e.push(t)}}}getRoutesToRunOnBeforeClose(){const e=[],t=this.buildRoutesTree(this.locationHashWithHiddenRoutes()||this.config.rootPath),i=this.matchRouteAndGetIdAndParamKeys(t.mainRoute);if(this.oldRoutes.id!==i.routeId){const t=this.$powerUi.getRouteCtrl(this.oldRoutes.id);t&&t.onBeforeClose&&e.push(t);for(const t of this.oldRoutes.mainChildRoutes){const i=this.$powerUi.getRouteCtrl(t.id);i&&i.onBeforeClose&&e.push(i)}}else if(this.oldRoutes.mainChildRoutes.length){const i=[];this.recursivelyGetChildrenRoutesToRunOnBeforeClose(t.mainRoute.childRoute,i),this.addRouteToRoutesToClose(e,this.oldRoutes.mainChildRoutes,i)}const s=[],o=[];for(const e of t.secondaryRoutes){const t=this.matchRouteAndGetIdAndParamKeys(e);s.push(t),t.childRoute&&this.recursivelyGetChildrenRoutesToRunOnBeforeClose(t.childRoute,o)}this.addRouteToRoutesToClose(e,this.oldRoutes.secondaryRoutes,s),this.oldRoutes.secondaryChildRoutes.length&&this.addRouteToRoutesToClose(e,this.oldRoutes.secondaryChildRoutes,o);const n=[],r=[];for(const e of t.hiddenRoutes){const t=this.matchRouteAndGetIdAndParamKeys(e);n.push(t),t.childRoute&&this.recursivelyGetChildrenRoutesToRunOnBeforeClose(t.childRoute,r)}return this.addRouteToRoutesToClose(e,this.oldRoutes.hiddenRoutes,n),this.oldRoutes.hiddenChildRoutes.length&&this.addRouteToRoutesToClose(e,this.oldRoutes.hiddenChildRoutes,r),e}buildOrderedRoutesToClose(){let e=!1;this.engineCommands.pending.$root&&(this.engineCommands.propagateCommand({currentRouteId:this.oldRoutes.id,sourceRouteId:"$root"}),e=this.oldRoutes.id);const t=!1===(this.oldRoutes.id!==this.currentRoutes.id)&&void 0!==this.engineCommands.pending[this.oldRoutes.id];(e||t||this.oldRoutes.id&&this.oldRoutes.route!==this.currentRoutes.route)&&this.orderedRoutesToClose.unshift({routeId:this.oldRoutes.id,viewId:this.oldRoutes.viewId,params:this.oldRoutes.params,kind:"main",parentRouteId:this.oldRoutes.parentRouteId,parentViewId:this.oldRoutes.parentViewId,powerViewNodeId:"root-view",commands:this.engineCommands.buildRouteCloseCommands(this.oldRoutes.id,this.oldRoutes.viewId,t)}),this.markToRemoveRouteViews("mainChildRoutes","child",e),this.markToRemoveRouteViews("secondaryChildRoutes","child",e),this.markToRemoveRouteViews("secondaryRoutes","secondary",e),this.markToRemoveRouteViews("hiddenChildRoutes","child",e),this.markToRemoveRouteViews("hiddenRoutes","hidden",e)}markToRemoveRouteViews(e,t,i){for(const s of this.oldRoutes[e]){const o=null!==(this.currentRoutes[e].find(e=>e.id===s.id&&e.viewId===s.viewId)||null)&&void 0!==this.engineCommands.pending[s.id];(i||o||!this.currentRoutes[e].find(e=>e.route===s.route))&&this.orderedRoutesToClose.unshift({routeId:s.id,viewId:s.viewId,params:s.params,kind:t,parentRouteId:s.parentRouteId,parentViewId:s.parentViewId,powerViewNodeId:this.routes[s.parentRouteId]?this.routes[s.parentRouteId].powerViewNodeId:null,commands:this.engineCommands.buildRouteCloseCommands(s.id,s.viewId,o)})}}getVewIdIfRouteExists(e,t){const i=this.oldRoutes[t].find(t=>t&&t.route===e),s=this.currentRoutes[t].find(t=>t&&t.route===e);return!(!i&&!s)&&(i?i.viewId:s.viewId)}addNewViewNode(e,t){const i=document.createElement("div");i.id=e,i.classList.add("power-view"),document.getElementById(t).appendChild(i)}loadViewInOrder(e,t,i,s){const o=e[t];if(!o)return i.$powerUi.callInitViews(),i.config.phantomMode||i.removeSpinnerAndShowContent("root-view"),s();o.commands.addView?("secondary"===o.kind||"hidden"===o.kind?i.addNewViewNode(o.viewId,i.config.routerSecondaryViewId):"child"===o.kind&&i.addNewViewNode(o.viewId,o.powerViewNodeId),i.loadRoute({routeId:o.routeId,paramKeys:o.paramKeys,viewId:o.viewId,ctrl:i.routes[o.routeId].ctrl,title:i.routes[o.routeId].title,data:i.routes[o.routeId].data,loadViewInOrder:i.loadViewInOrder,orderedRoutesToOpen:e,routeIndex:t+1,ctx:i,_resolve:s})):i.loadViewInOrder(e,t+1,i,s)}matchRouteAndGetIdAndParamKeys(e){let t=!1;for(const i of Object.keys(this.routes||{}))if("otherwise"!==i){const s=this.getRouteParamKeys(this.routes[i].route);let o=this.buildRegExPatternToRoute(i,s);if((this.config.rootPath+e.path).match(o)){this.routes[i]&&this.routes[i].title&&(document.title=this.routes[i].title),"otherwise"!==i&&(t={routeId:i,paramKeys:s,powerViewNodeId:this.routes[i].powerViewNodeId||null});break}}return t}removeCustomCssNode(e){const t=document.getElementById("_css"+e);if(t){const e=t.parentNode;e&&e.removeChild(t)}}loadRoute({routeId:e,paramKeys:t,viewId:i,ctrl:s,title:o,data:n,loadViewInOrder:r,orderedRoutesToOpen:a,routeIndex:l,ctx:h,_resolve:d}){const c=this.routes[e].viewId||i;if(this.routes[e].template&&!this.config.noRouterViews){if(this.routes[e].viewId&&!document.getElementById(this.routes[e].viewId))throw new Error(`You defined a custom viewId "${this.routes[e].viewId}" to the route "${this.routes[e].route}" but there is no element on DOM with that id.`);if(this.routes[e].templateUrl&&!0!==this.routes[e].templateIsCached)this.$powerUi.loadTemplateUrl({template:this.routes[e].template,viewId:c,currentRoutes:this.currentRoutes,routeId:e,routes:this.routes,title:o,loadViewInOrder:r,orderedRoutesToOpen:a,routeIndex:l,ctx:h,_resolve:d});else if(this.routes[e].templateComponent)this.$powerUi.loadTemplateComponent({template:this.routes[e].templateComponent,viewId:c,currentRoutes:this.currentRoutes,routeId:e,routes:this.routes,title:o,$ctrl:this.$powerUi.controllers[c].instance,loadViewInOrder:r,orderedRoutesToOpen:a,routeIndex:l,ctx:h,_resolve:d});else{if(!0===this.routes[e].dynamicUrl){const t=this.$powerUi.getViewCtrl(c);if(!t.getDynamicUrl)throw`The "${e}" route controller is missing the "getDynamicUrl" method to return the current URL.`;this.routes[e].template=t.getDynamicUrl()}this.$powerUi.loadTemplate({template:this.routes[e].template,viewId:c,currentRoutes:this.currentRoutes,routeId:e,routes:this.routes,title:o,loadViewInOrder:r,orderedRoutesToOpen:a,routeIndex:l,ctx:h,_resolve:d})}}}routeKind(e){return this.routes[e].hidden?"hr":"sr"}buildNewHash(e,t){const i=t.split("&ch="),s=e.split("?"),o=t.split("?");if(s.includes(o[1]))return e;if(!(i.length>1&&e.includes(i[0])))return e+t;{const e=i[0].split("?")[1];let t=0;for(const i of s){if(i.split("&ch=")[0]===e)return s[t]=o[1],s.join("?");t+=1}}}closePhantomRoute(e,t){this.phantomRouter.closePhantomRoute(e,t)}openRoute({routeId:e,params:t,target:i,currentRouteId:s,currentViewId:o,title:n,data:r,commands:a}){const l=this.routeKind(e);if(this.engineIsRunning&&"hr"===l){const l=[this.routes[e]],h=new PhantomRouter({rootPath:window.location.hash,routes:l,phantomMode:!0},this.$powerUi);return this.phantomRouter=h,void h.openRoute({routeId:e,params:t,target:i,currentRouteId:s,currentViewId:o,title:n,data:r,commands:a})}if(this.engineIsRunning&&"hr"!==l){const l=this;this.onCycleEnds.subscribe((function(){l.openRoute({routeId:e,params:t,target:i,currentRouteId:s,currentViewId:o,title:n,data:r,commands:a})}))}const h=this.getRouteParamKeysWithoutDots(this.routes[e].route);if(h)for(const i of h)if(!t||!t[i])throw`The parameter "${i}" of route "${e}" is missing!`;if(!this.routeNotExists({routeId:e,params:t}))if("_self"===i){const i=this.getOpenedRoute({routeId:s,viewId:o}),d=this.getOpenedSecondaryOrHiddenRoutesHash({filter:[i.route]}),c=`?${l}=${this.buildHash({routeId:e,params:t,paramKeys:h})}`,u=this.buildNewHash(d,c);this.navigate({hash:u,title:n,data:r,commands:a,routeId:e})}else if("_blank"===i){const i=this.getOpenedSecondaryOrHiddenRoutesHash({}),s=`?${l}=${this.buildHash({routeId:e,params:t,paramKeys:h})}`,o=this.buildNewHash(i,s);this.navigate({hash:o,title:n,data:r,commands:a,routeId:e})}else if("_single"===i)this.navigate({hash:this.buildHash({routeId:e,params:t,paramKeys:h}),title:n,isMainView:!0,data:r,commands:a,routeId:e});else{const i=this.getOpenedSecondaryRoutesHash(),s=this.buildHash({routeId:e,params:t,paramKeys:h})+i;this.navigate({hash:s,title:n,isMainView:!0,data:r,commands:a,routeId:e})}}getOpenedSecondaryOrHiddenRoutesHash({filter:e=[]}){const t=this.extractRouteParts(this.locationHashWithHiddenRoutes());let i=t.path.replace(this.config.rootPath,"");for(let s of t.secondaryRoutes.concat(t.hiddenRoutes)){const o=t.hiddenRoutes.includes(s)?"hr":"sr";s=s.replace(this.config.rootPath,""),0!==e.lenght&&e.includes(s)||(i+=`?${o}=${s}`)}return i}getOpenedSecondaryRoutesHash(){const e=this.extractRouteParts(window.location.hash);let t="";for(let i of e.secondaryRoutes)i=i.replace(this.config.rootPath,""),t+=`?sr=${i}`;return t}navigate({hash:e,title:t,isMainView:i,data:s={},commands:o=[],routeId:n=null}){const r=this.extractRouteParts(e);let a=r.path||"",l="";for(const e of r.secondaryRoutes)a=`${a}?sr=${e.replace(this.config.rootPath,"")}`;for(const e of r.hiddenRoutes)l=`${l}?hr=${e.replace(this.config.rootPath,"")}`;const h=encodeURI(this.config.rootPath+a);(h+encodeURI(l)||"")!==this.locationHashWithHiddenRoutes()&&(this.hiddenLocationHash=encodeURI(l),n&&(this.routeData[n]=s),o.length&&this.engineCommands.addCommands(o),window.location.hash!==h?(window.history.pushState(null,t,window.location.href),window.location.replace(encodeURI(this.config.rootPath)+encodeURI(a)),i&&window.scrollTo(0,0)):this.hashChange())}buildHash({routeId:e,params:t,paramKeys:i}){let s=this.routes[e].route.slice(3,this.routes[e].length);if(t&&i.length)for(const e of i)t[e]&&(s=s.replace(`:${e}`,t[e]));return this.routes[e].mainRouteId&&(s=`${this.buildHash({routeId:this.routes[e].mainRouteId,params:t,paramKeys:i})}&ch=${s}`),s}routeNotExists({routeId:e,params:t}){let i=!1;if(e===this.currentRoutes.id){if(!t)return!0;let e=!1;for(const s of Object.keys(t||{})){for(const i of this.currentRoutes.params)s===i.key&&t[s]===i.value&&(e=!0);i=e,e=!1}if(i)return!0}for(const s of this.currentRoutes.secondaryRoutes.concat(this.currentRoutes.hiddenRoutes))if(e===s.id){let e=!1;for(const o of Object.keys(t||{})){for(const i of s.params)o===i.key&&t[o]===i.value&&(e=!0);i=e,e=!1}}return i}setMainRouteState({routeId:e,paramKeys:t,route:i,viewId:s,title:o,data:n,parentRouteId:r,parentViewId:a}){this.currentRoutes.id=e,this.currentRoutes.route=i.replace(this.config.rootPath,""),this.currentRoutes.viewId=this.routes[e].viewId||s,this.currentRoutes.isMainView=!0,this.currentRoutes.kind="main",this.currentRoutes.title=o,this.currentRoutes.data=n,this.currentRoutes.parentRouteId=r,this.currentRoutes.parentViewId=a,this.currentRoutes.params=t?this.getRouteParamValues({routeId:e,paramKeys:t,route:i}):[]}setOtherRouteState({routeId:e,paramKeys:t,route:i,viewId:s,title:o,data:n,parentRouteId:r,parentViewId:a,kind:l}){const h={title:o,isMainView:!1,params:[],id:"",route:i.replace(this.config.rootPath,""),viewId:this.routes[e].viewId||s,data:n||null,parentRouteId:r,parentViewId:a,kind:l};return h.id=e,t&&(h.params=this.getRouteParamValues({routeId:e,paramKeys:t,route:i})),h}setSecondaryRouteState(e){this.currentRoutes.secondaryRoutes.push(this.setOtherRouteState(e))}setHiddenRouteState(e){this.currentRoutes.hiddenRoutes.push(this.setOtherRouteState(e))}setChildRouteState(e){"main"===e.mainKind?this.currentRoutes.mainChildRoutes.push(this.setOtherRouteState(e)):"secondary"===e.mainKind?this.currentRoutes.secondaryChildRoutes.push(this.setOtherRouteState(e)):this.currentRoutes.hiddenChildRoutes.push(this.setOtherRouteState(e))}extractRouteParts(e){const t={path:e,secondaryRoutes:[],hiddenRoutes:[]};if(e.includes("?")){const i=e.split("?");t.path=i[0];for(const e of i)if(e.includes("sr="))for(const i of e.split("sr="))i&&t.secondaryRoutes.push(this.config.rootPath+i);else if(e.includes("hr="))for(const i of e.split("hr="))i&&t.hiddenRoutes.push(this.config.rootPath+i)}return t}buildRegExPatternToRoute(e,t){let i=new RegExp(`^${this.routes[e].route}$`);if(t){let e=i.toString();e=e.substring(1),e=e.slice(0,-1);for(const i of t)e=e.replace(i,"[^]*");i=new RegExp(e)}return i}getRoute({routeId:e}){return this.routes[e]}getOpenedRoute({routeId:e,viewId:t}){return this.getRouteOnList({routeId:e,viewId:t,listName:"currentRoutes"})}getOldRoute({routeId:e,viewId:t}){return this.getRouteOnList({routeId:e,viewId:t,listName:"oldRoutes"})}getRouteOnList({routeId:e,viewId:t,listName:i}){if(this[i].id===e&&this[i].viewId)return this[i];for(const s of this[i].mainChildRoutes)if(s.id===e&&s.viewId===t)return s;for(const s of this[i].secondaryRoutes)if(s.id===e&&s.viewId===t)return s;for(const s of this[i].secondaryChildRoutes)if(s.id===e&&s.viewId===t)return s;for(const s of this[i].hiddenRoutes)if(s.id===e&&s.viewId===t)return s;for(const s of this[i].hiddenChildRoutes)if(s.id===e&&s.viewId===t)return s;return null}getRouteParamKeys(e){const t=new RegExp(/:[^\s/]+/g);return e.match(t)}getRouteParamKeysWithoutDots(e){const t=[];for(const i of this.getRouteParamKeys(e)||[])t.push(i.substring(1));return t}getRouteParamValues({routeId:e,paramKeys:t,route:i}){const s=this.routes[e].route.split("/").filter(e=>"#!"!==e),o=(i||this.locationHashWithHiddenRoutes()||this.config.rootPath).split("?")[0].split("/"),n=[];for(const i of t)this.routes[e].route.includes(s[0])&&n.push({key:i.substring(1),value:o[s.indexOf(i)]});return n}getParamValue(e){const t=this.currentRoutes.params.find(t=>t.key===e);return t?t.value:null}}class PhantomRouter extends Router{openRoute({routeId:e,params:t,target:i,currentRouteId:s,currentViewId:o,title:n}){this.ready=new UEvent("phantomRouter");const r={routeId:e,title:n,isMainView:!1,kind:"hidden",params:t,id:e,route:e,viewId:_Unique.domID("view"),data:null},a=this.setOtherRouteState(r);this.currentRoutes.hiddenRoutes=[],this.currentRoutes.hiddenRoutes.push(a),this.routes[e].viewId=r.viewId;const l=this.engineCommands.buildRouteOpenCommands(e,r.viewId,!1),h=this.engineCommands.buildRouteCloseCommands(e,r.viewId,!1),d=Object.assign(l,h);delete d.parentView,delete d.rootView;const c={routeId:e,viewId:r.viewId,paramKeys:"",kind:"hidden",parentRouteId:null,parentViewId:null,commands:d};this.engine(c)}closePhantomRoute(e,t){const i=this.routes[e];this.oldRoutes.hiddenRoutes.push(i),this.engine(),this.ready.broadcast()}}class PowerTemplate extends PowerScope{constructor({$powerUi:e,viewId:t,routeId:i,$ctrl:s}){if(super({$powerUi:e}),this._viewId=t,this._routeId=i,this.$ctrl=s,this.$routeClassList={},this.css){const e=this;new Promise(this.css.bind(this)).then((function(t){e.appendCss(t)})).catch((function(e){window.console.log("Error loading css",e)}))}return{template:this._template(),component:this}}_template(){return new Promise(this.template.bind(this))}_replaceHtmlForEdit(e,t,i,s=!1){if(!this.$powerUi.devMode.isEditable||!this.$powerUi.devMode.child||!i.$ctrl._$createEditableHtml)return e;const o=i.$ctrl._$createEditableHtml(e,t,i._routeId,s);return o&&o.body?o.body.innerHTML:e}_import(e){const t=this;return new Promise((function(i,s){t.$powerUi.request({url:e,body:{},method:"GET",status:"Loading file"}).then((function(s){let o="";if(t.$powerUi.devMode&&t.$powerUi.devMode.child&&t.$powerUi.devMode.isEditable){let n=!1,r="";const a=e.split("/"),l=a[a.length-1];if(".css"===e.slice(-4))n=".css",o=s;else if(".json"===e.slice(-5)){n=".json",o=s;const e=s.$selector||null;if(e){const i=t.$service("JSONSchema")[e](s,!0);r=t._replaceHtmlForEdit(i,l,t,s)}}else".htm"===e.slice(-4)?(n=".htm",o=t._replaceHtmlForEdit(s,l,t)):".html"===e.slice(-5)&&(n=".html",o=t._replaceHtmlForEdit(s,l,t));t.$ctrl._$postToMain({command:"loadFile",extension:n||null,path:e,content:o,template:r,viewId:t._viewId,routeId:t._routeId,fileName:l}),i(r||o)}else".json"===e.slice(-5)&&s.$selector?(o=t.$service("JSONSchema")[s.$selector](s),i(o)):i(s)})).catch((function(e){window.console.log("Error importing file:",e),s(e)}))}))}import(e,t){if("string"==typeof e||e instanceof String)return this._import(e);if(e.length){const i=[];for(const t of e)i.push(this._import(t));return t?new Promise((function(e,s){Promise.all(i).then((function(i){try{let s="";for(const e of i)!0===t?s+=e:s=s+t+e;e(s)}catch(e){window.console.log("Error importing files:",e),s(e)}}))})):Promise.all(i)}throw"Error: import expects a string or array"}request(e){const t=this;return new Promise((function(i,s){t.$powerUi.request(e).then((function(e){i(e)})).catch((function(e){s(e)}))}))}appendCss(e){if(e.length){let t="";for(const i of e)t+=i;e=t}const t=document.getElementsByTagName("head")[0];let i=document.createElement("style");i.innerHTML=e,i.id="_css"+this._viewId,t.appendChild(i)}}export{PowerTemplate};class PowerInterpolation{constructor(e={},t){this.config=e,this.$powerUi=t,this.startSymbol=e.interpolateStartSymbol||"{{",this.endSymbol=e.interpolateEndSymbol||"}}"}compile({template:e,scope:t,view:i}){if(!t&&i&&(t=!!(i&&i.id&&this.$powerUi.controllers[i.id])&&this.$powerUi.controllers[i.id].instance),e.includes("power-view")){const t=document.createElement("div");t.innerHTML=e,this.interpolateInOrder(t),e=t.innerHTML}return this.replaceInterpolation(e,t)}interpolateInOrder(e){const t=e?e.getElementsByClassName("power-view"):document.getElementsByClassName("power-view");let i=t.length-1;for(;i>=0;){const e=t[i];if(this.$powerUi.controllers[e.id]&&this.$powerUi.controllers[e.id].instance){const t=this.$powerUi.controllers[e.id].instance;e.innerHTML=this.replaceInterpolation(e.innerHTML,t)}i-=1}}getDatasetResult(e,t){return this.compile({template:`${this.startSymbol} ${this.decodeHtml(e)} ${this.endSymbol}`,scope:t})}standardRegex(){const e=`${this.startSymbol}[^]*?${this.endSymbol}`;return new RegExp(e,"gm")}replaceInterpolation(e,t){const i=(e=this.stripWhiteChars(e)).replace(/<!--[\s\S]*?-->/gm,"").match(this.standardRegex());if(i)for(const s of i){const i=this.getInterpolationValue(s,t);e=e.replace(s,i)}return e.trim()}stripWhiteChars(e){let t=e.replace(/ +(?= )/g,"");return t=t.replace(/[\t\n\r]/g,""),t}stripInterpolation(e){let t=e.replace(this.startSymbol,"");return t=t.replace(this.endSymbol,""),t}replaceWith({entry:e,oldValue:t,newValue:i}){const s=new RegExp(t,"gm"),o=e.match(this.standardRegex());if(o)for(const t of o){let o="";if(t.includes(".")){const e=t.split(".");e[0]=e[0].replace(s,i),o=e.join(".")}else o=t.replace(s,i);e=e.replace(t,o)}return e=this.replaceIdsAndRemoveInterpolationSymbol({entry:e,regexOldValue:s,newValue:i})}replaceIdsAndRemoveInterpolationSymbol({entry:e,regexOldValue:t,newValue:i}){const s=document.createElement("div");s.innerHTML=e;for(const e of s.children){for(const s of e.attributes)if(s.name.includes("data-pow")||s.name.includes("data-pwc"))if(s.value.includes(".")){const e=s.value.split(".");e[0]=e[0].replace(t,i),s.value=e.join(".")}else s.value=s.value.replace(t,i);else if(e.hasAttribute("data-pow-event")&&s.name.includes("on")&&!s.name.includes("data"))if(s.value.includes(".")){const e=s.value.split(".");e[0]=e[0].replace(t,i),s.value=e.join(".")}else s.value=s.value.replace(t,i);e.id&&(e.id=this.replaceInterpolation(e.id,this.$powerUi)),e.children.length&&(e.innerHTML=this.replaceIdsAndRemoveInterpolationSymbol({entry:e.innerHTML,regexOldValue:t,newValue:i}))}return s.innerHTML}getInterpolationValue(e,t){let i=this.stripWhiteChars(e);return i=this.stripInterpolation(i),this.encodeHtml(this.safeEvaluate(i,t))}safeEvaluate(e,t){let i;try{i=this.$powerUi.safeEval({text:e,scope:t,$powerUi:this.$powerUi})}catch(e){i=""}return void 0===i?"":i}safeString(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}encodeHtml(e){const t=document.createElement("div");return t.innerText=t.textContent=e,e=t.innerHTML}decodeHtml(e){const t=document.createElement("textarea");return t.innerHTML=e,t.value}}class PowerView extends _PowerBasicElementWithEvents{constructor(e){super(e),this.isView=!0}}PowerUi.injectPowerCss({name:"power-view",isMain:!0});class SyntaxTree{constructor({counter:e}){this.currentPriority=0,this.nodes=[],this.tokensListener=new TokensListener({counter:e,syntaxTree:this}),this.validAfter={variable:this.variableValidation,string:this.stringValidation,parentheses:this.parenthesesValidation,dot:this.dotValidation,integer:this.numberValidation,float:this.numberValidation,operator:this.operationValidation,equal:this.equalityValidation,"NOT-equal":this.equalityValidation,"greater-than":this.equalityValidation,"minor-than":this.equalityValidation,"minor-or-equal":this.equalityValidation,"greater-or-equal":this.equalityValidation,object:this.objectValidation,function:this.objectValidation,anonymousFunc:this.objectValidation,dictNode:this.objectValidation,comma:this.commaValidation,AND:this.orAndNotValidation,OR:this.orAndNotValidation,NOT:this.orAndNotValidation,"NOT-NOT":this.orAndNotValidation,"short-hand":this.shortHandValidation,dictDefinition:()=>!0,arrayDefinition:()=>!0}}buildTreeLeaf(e){this.tree=this.checkAndPrioritizeSyntax({nodes:this.nodes,isParameter:e})}shortHandValidation({currentNode:e,isParameter:t}){return!(e.condition[0]&&e.condition[0].expression_nodes&&!e.condition[0].expression_nodes.length)&&(!(e.if[0]&&e.if[0].expression_nodes&&!e.if[0].expression_nodes.length)&&!(e.else[0]&&e.else[0].expression_nodes&&!e.else[0].expression_nodes.length))}firstNodeValidation({node:e,isParameter:t}){return!["dot","anonymousFunc","AND","OR","NOT-equal","minor-or-equal","greater-or-equal","equal","minor-than","greater-than"].includes(e.syntax)&&("operator"!==e.syntax||"+"===e.label||"-"===e.label)}orAndNotValidation({nextNode:e,isParameter:t}){return!!["string","variable","integer","object","float","dictNode","parentheses","NOT","NOT-NOT","function"].includes(e.syntax)||"operator"===e.syntax&&("+"===e.label||"-"===e.label)}commaValidation({nextNode:e,isParameter:t}){return!!["string","variable","integer","object","float","dictNode","parentheses","arrayDefinition","dictDefinition","NOT","NOT-NOT","comma","function","end"].includes(e.syntax)||"operator"===e.syntax&&("+"===e.label||"-"===e.label)}objectValidation({nextNode:e,isParameter:t}){return!!(["operator","anonymousFunc","short-hand","NOT-equal","equal","minor-than","greater-than","minor-or-equal","greater-or-equal","dot","AND","OR","dictNode","end"].includes(e.syntax)||"comma"===e.syntax&&t)}equalityValidation({nextNode:e,currentNode:t,isParameter:i}){return!!["variable","parentheses","function","arrayDefinition","dictDefinition","float","integer","dictNode","object","NOT","NOT-NOT","string"].includes(e.syntax)||("string"===e.syntax&&"+"===t.label||"operator"===e.syntax&&("+"===e.label||"-"===e.label))}operationValidation({nextNode:e,currentNode:t,isParameter:i}){return!!["NOT","NOT-NOT","float","object","integer","variable","dictNode","arrayDefinition","dictDefinition","parentheses","function"].includes(e.syntax)||("string"===e.syntax&&"+"===t.label||"operator"===e.syntax&&("+"===e.label||"-"===e.label))}variableValidation({nextNode:e,isParameter:t}){return!!(["dot","operator","NOT-equal","equal","minor-than","greater-than","minor-or-equal","greater-or-equal","AND","OR","short-hand","end"].includes(e.syntax)||"comma"===e.syntax&&t)}numberValidation({nextNode:e,isParameter:t}){return!!(["operator","NOT-equal","equal","minor-than","greater-than","AND","minor-or-equal","greater-or-equal","OR","short-hand","end"].includes(e.syntax)||"comma"===e.syntax&&t)}stringValidation({nextNode:e,isParameter:t}){return!["NOT","NOT-NOT","string","variable","dictNode","function","parentheses","arrayDefinition","dictDefinition","integer","float","especial","anonymousFunc","dot","dictNode"].includes(e.syntax)&&(e.syntax,!0)}parenthesesValidation({nextNode:e,isParameter:t}){return!!(["anonymousFunc","dot","operator","short-hand","NOT-equal","equal","minor-or-equal","greater-or-equal","minor-than","greater-than","AND","OR","short-hand","end"].includes(e.syntax)||"comma"===e.syntax&&t)}dotValidation({nextNode:e,isParameter:t}){return!!["function","variable","dictNode"].includes(e.syntax)}isNextValidAfterCurrent({currentNode:e,nextNode:t,isParameter:i}){return!!this.validAfter[e.syntax]&&this.validAfter[e.syntax]({currentNode:e,nextNode:t,isParameter:i})}checkAndPrioritizeSyntax({nodes:e,isParameter:t}){let i=[],s=[],o=[],n=!1;if((e=this.filterNodesAndUnifyObjects(e)).push({syntax:"end"}),!e.length)return[];let r=0;const a=e.length-1;let l=!0;if(l=this.firstNodeValidation({node:this.getCurrentNode({index:0,nodes:e})}),!1===l)throw`PowerUI template invalid syntax: "${e[0].label}" starting the expression.`;for(;r<=a&&l;){const a=this.getCurrentNode({index:r,nodes:e});if(l=this.isNextValidAfterCurrent({currentNode:a,nextNode:this.getNextNode({index:r,nodes:e}),isParameter:t}),!1===l&&"end"!==a.syntax)throw`PowerUI template invalid syntax: "${a.label}".`;const h=this.createExpressionGroups({index:r,currentNode:a,previousNode:this.getPreviousNode({index:r,nodes:e}),nextNode:this.getNextNode({index:r,nodes:e}),current_expression_nodes:i,priority_nodes:s,expression_groups:o,doubleOperator:n});s=h.priority_nodes,i=h.current_expression_nodes,o=h.expression_groups,n=h.doubleOperator,r+=1}return o=this.prioritizeExpressionGroups({priority:"equality",expression_groups:o}),o=this.prioritizeExpressionGroups({priority:"AND",expression_groups:o}),o.pop(),o}createExpressionGroups({index:e,currentNode:t,previousNode:i,nextNode:s,current_expression_nodes:o,priority_nodes:n,expression_groups:r,doubleOperator:a}){if("operator"===t.syntax&&0===e?(n.push(t),a=!0):"operator"===t.syntax&&"operator"===i.syntax?(n.push(t),a=!0):["integer","float","string","variable","parentheses","object","short-hand","dictDefinition","arrayDefinition"].includes(t.syntax)?"operator"===s.syntax&&"+"!==s.label&&"-"!==s.label||"operator"===i.syntax&&"+"!==i.label&&"-"!==i.label?n.push(t):a?(n.push(t),a=!1):o.push(t):"operator"===t.syntax&&("+"!==t.label&&"-"!==t.label?n.push(t):(n.length&&(o.push({priority:n}),n=[]),o.push(t))),["NOT-equal","equal","greater-than","minor-than","minor-or-equal","greater-or-equal","OR","AND","end"].includes(t.syntax)){const e=["OR","AND"].includes(t.syntax)?t.syntax:"equality";n.length&&(o.push({priority:n}),n=[]);const i={kind:"expression",expression_nodes:o};r.push(i),o=[],t.kind="end"===t.syntax?"end":e,r.push(t)}return{priority_nodes:n,current_expression_nodes:o,expression_groups:r,doubleOperator:a}}prioritizeExpressionGroups({priority:e,expression_groups:t}){let i=[],s=[],o=!1;for(const n of t)"end"===n.syntax&&s.length?(i.length?i.push({priority:s}):i=s,i.push(n),s=[]):n.kind===e?(o=!0,s.push(n)):!n.priority&&"expression"!==n.kind&&o&&s.length?(i.push({priority:s}),i.push(n),s=[],o=!1):"OR"===n.syntax||"AND"===n.syntax?(i.push({priority:s}),i.push(n),s=[]):s.push(n);return i}getCurrentNode({index:e,nodes:t}){return t[e]}getPreviousNode({index:e,nodes:t}){return t[e-1]||{syntax:"end"}}getNextNode({index:e,nodes:t}){return t[e+1]||{syntax:"end"}}filterNodesAndUnifyObjects(e){const t=[];let i=this.newObject(),s=e.length-1,o=!1;for(;e[s];){if("empty"!==e[s].syntax)if(["function","dictNode","anonymousFunc"].includes(e[s].syntax)){i.parameters.unshift(e[s]);let t=e[s].label;"function"===e[s].syntax&&(t+="()"),i.label=t+i.label,o=!0}else o&&(t.unshift(i),o=!1,i=this.newObject()),t.unshift(e[s]);else o&&(t.unshift(i),o=!1,i=this.newObject());s-=1}return o&&(t.unshift(i),o=!1,i=this.newObject()),t}newObject(){return{syntax:"object",label:"",parameters:[]}}}class PowerLexer{constructor({text:e,tokensTable:t,counter:i,isParameter:s}){this.isParameter=s,this.originalText=String(e),this.syntaxTree=new SyntaxTree({counter:i}),this.tokens=[]}scan(){for(const e of this.originalText){const t=this.convertToToken(e);this.tokens.push(t)}this.tokens.push({name:"end",value:null})}convertToToken(e){for(const t of this.tokensTable)if(t.values.includes(e))return{name:t.name,value:e};return{name:"undefined",value:e}}}class PowerTemplateParser extends PowerLexer{constructor({text:e,tokensTable:t,counter:i,isParameter:s}){super({text:e,tokensTable:t,counter:i||0,isParameter:s}),this.counter=i||0,this.tokensTable=t||[{name:"blank",values:[" ","\t","\n"]},{name:"escape",values:["\\"]},{name:"especial",values:["_","$"]},{name:"quote",values:['"',"`","'"]},{name:"braces",values:["{","}"]},{name:"separator",values:["(",")","[","]"]},{name:"operator",values:["+","-","*","/","%"]},{name:"equal",values:["="]},{name:"minor-than",values:["<"]},{name:"greater-than",values:[">"]},{name:"NOT",values:["!"]},{name:"AND",values:["&"]},{name:"OR",values:["|"]},{name:"comma",values:","},{name:"dot",values:["."]},{name:"short-hand",values:["?",":"]},{name:"number",values:["0","1","2","3","4","5","6","7","8","9"]},{name:"letter",values:["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"]},{name:"end",values:[null]}],this.buildSyntaxTree()}buildSyntaxTree(){this.scan(),this.syntaxTree.buildTreeLeaf(this.isParameter||!1)}scan(){let e=this.counter;for(const t of this.originalText){const i=this.convertToToken(t);this.tokens.push(i),this.syntaxTree.tokensListener.read({token:i,counter:e}),e+=1}const t=this.convertToToken(null);this.tokens.push(t),this.syntaxTree.tokensListener.read({token:t,counter:e})}}class TokensListener{constructor({counter:e,syntaxTree:t}){this.syntaxTree=t,this.currentTokens=[],this.currentLabel="",this.start=e,this.patterns=[{name:"empty",obj:EmptyPattern},{name:"string",obj:StringPattern},{name:"arrayDefinition",obj:ArrayDefinitionPattern},{name:"variable",obj:VariablePattern},{name:"number",obj:NumberPattern},{name:"operator",obj:OperationPattern},{name:"equal",obj:EqualPattern},{name:"minor-than",obj:MinorThanPattern},{name:"greater-than",obj:GreaterThanPattern},{name:"NOT",obj:NotPattern},{name:"AND",obj:AndPattern},{name:"OR",obj:OrPattern},{name:"comma",obj:CommaPattern},{name:"dot",obj:DictPattern},{name:"braces",obj:BracesPattern},{name:"separator",obj:DictPattern},{name:"short-hand",obj:ShortHandPattern},{name:"parentheses",obj:parenthesesPattern}],this.candidates=[],this.checking="firstToken",this.resetCandidates()}read({token:e,counter:t}){for(const i of this.candidates)if(i.instance[this.checking]({token:e,counter:t})){this.currentTokens.push(e),this.currentLabel=this.currentLabel+(e.value||(null===e.value?"":e.value));break}}nextPattern({token:e,counter:t,syntax:i,parameters:s}){this.syntaxTree.nodes.push({syntax:i,label:this.currentLabel,tokens:this.currentTokens,start:this.start,end:t,parameters:s||[]}),this.start=t,this.currentTokens=[],this.currentLabel="",this.checking="firstToken",this.resetCandidates(),this.read({token:e,counter:t})}resetCandidates(){this.candidates=[];for(const e of this.patterns)this.candidates.push({name:e.name,instance:new e.obj(this)})}}class ParserEval{constructor({text:e,nodes:t,scope:i,$powerUi:s,valueToSet:o}){this.$powerUi=s,this.$scope=i||{},this.nodes=t||new PowerTemplateParser({text:e}).syntaxTree.tree,this.currentValue="",this.operator="",this.doubleOperator="",this.lastNode="",this.currentNode="",this.nextNode="",this.equality="$_not_Setted_$",this.leftExpressionValueToCompare="$_not_Setted_$",this.rightExpressionValueToCompare="$_not_Setted_$",this.evalNodes(o)}evalNodes(e){let t=0;for(let i of this.nodes){if(i.expression_nodes)for(const s of i.expression_nodes)this.currentNode=s,this.nextNode=i.expression_nodes[t+1],"short-hand"===s.syntax?this.evalShortHandExpression(s):"dictDefinition"===s.syntax?this.evalDictDefinition(s):"variable"===s.syntax&&["true","false","null","undefined"].includes(s.label)?this.evalSpecialValues(s.label):this.eval(s,e),this.lastNode=s;else"equality"===i.kind||["===","!==","==","!=",">=","<=",">","<"].includes(i.label)?(this.leftExpressionValueToCompare=this.currentValue,this.currentValue="",this.equality=i):["OR","AND"].includes(i.syntax)?(this.leftExpressionValueToCompare=this.currentValue,this.currentValue="",this.orAndExpression=i):this.nodes[t+1]&&"OR"===this.nodes[t+1].syntax&&i.priority&&i.priority[0]&&i.priority[0].priority?i.priority.length>1?this.currentValue=this.recursiveEval(i.priority):this.currentValue=this.recursiveEval(i.priority[0].priority):this.nodes[t-1]&&"OR"===this.nodes[t-1].syntax&&i.priority&&i.priority[0]&&i.priority[0].priority?i.priority.length>1?this.currentValue=this.recursiveEval(i.priority):this.currentValue=this.recursiveEval(i.priority[0].priority):this.nodes[t+1]&&"AND"===this.nodes[t+1].syntax&&i.priority?this.currentValue=this.recursiveEval(i.priority):this.nodes[t-1]&&"AND"===this.nodes[t-1].syntax&&i.priority?this.currentValue=this.recursiveEval(i.priority):console.log("NO EXPRESSION_NODES!!",this.currentValue,i,this.nodes);this.equality&&""!==this.currentValue&&"$_not_Setted_$"!==this.leftExpressionValueToCompare?this.evalEquality():this.orAndExpression&&"OR"===this.orAndExpression.syntax&&""!==this.currentValue&&"$_not_Setted_$"!==this.leftExpressionValueToCompare?this.evalOrExpression():this.orAndExpression&&"AND"===this.orAndExpression.syntax&&""!==this.currentValue&&"$_not_Setted_$"!==this.leftExpressionValueToCompare&&this.evalAndExpression(),t+=1}}evalDictDefinition(e){this.currentValue={};for(const t of e.parameters)this.currentValue[this.recursiveEval(t.key)]=this.recursiveEval(t.value)}evalArrayDefinition(e){this.currentValue=[];for(const t of e.parameters)this.currentValue.push(this.recursiveEval(t))}evalSpecialValues(e){"true"===e?this.currentValue=!0:"false"===e?this.currentValue=!1:"null"===e?this.currentValue=null:"undefined"===e&&(this.currentValue=void 0)}evalShortHandExpression(e){const t=this.recursiveEval(e.condition),i=this.recursiveEval(e.if),s=this.recursiveEval(e.else);this.currentValue=t?i:s}evalOrExpression(){this.currentValue=this.leftExpressionValueToCompare||this.currentValue,this.leftExpressionValueToCompare="$_not_Setted_$"}evalAndExpression(){this.currentValue=this.leftExpressionValueToCompare&&this.currentValue,this.leftExpressionValueToCompare="$_not_Setted_$"}evalEquality(){"==="===this.equality.label?this.currentValue=this.leftExpressionValueToCompare===this.currentValue:"=="===this.equality.label?this.currentValue=this.leftExpressionValueToCompare==this.currentValue:"!=="===this.equality.label?this.currentValue=this.leftExpressionValueToCompare!==this.currentValue:"!="===this.equality.label?this.currentValue=this.leftExpressionValueToCompare!=this.currentValue:"<="===this.equality.label?this.currentValue=this.leftExpressionValueToCompare<=this.currentValue:">="===this.equality.label?this.currentValue=this.leftExpressionValueToCompare>=this.currentValue:">"===this.equality.label?this.currentValue=this.leftExpressionValueToCompare>this.currentValue:"<"===this.equality.label&&(this.currentValue=this.leftExpressionValueToCompare<this.currentValue),this.leftExpressionValueToCompare="$_not_Setted_$"}eval(e,t){let i="";if("float"===e.syntax)i=parseFloat(e.label),""===this.currentValue?this.currentValue=this.adjustForNegative(i):this.currentValue=this.mathOrConcatValues(i);else if("integer"===e.syntax)i=parseInt(e.label),""===this.currentValue?this.currentValue=this.adjustForNegative(i):this.currentValue=this.mathOrConcatValues(i);else if("operator"===e.syntax)this.operator?"-"===this.operator&&"-"===e.label?this.operator="+":"-"===this.operator&&"+"===e.label?this.operator="-":"+"===this.operator&&"-"===e.label?this.operator="-":"+"===this.operator&&"+"===e.label?this.operator="+":"-"===this.doubleOperator&&"-"===e.label?this.doubleOperator="+":"-"===this.doubleOperator&&"+"===e.label?this.doubleOperator="-":"+"===this.doubleOperator&&"-"===e.label?this.doubleOperator="-":"+"===this.doubleOperator&&"+"===e.label?this.doubleOperator="+":this.doubleOperator=e.label:this.operator=e.label;else if(e.priority||"parentheses"===e.syntax){const t=e.priority?[{expression_nodes:e.priority}]:e.parameters;i=this.recursiveEval(t),this.currentValue=this.mathOrConcatValues(i)}else"variable"===e.syntax?(i=this.getOrSetObjectOnScope(e.label,t),""===this.currentValue?this.currentValue=this.adjustForNegative(i):this.currentValue=this.mathOrConcatValues(i)):"string"===e.syntax?(i=this.removeQuotes(e.label),""===this.currentValue?this.currentValue=this.adjustForNegative(i):this.currentValue=this.mathOrConcatValues(i)):"arrayDefinition"===e.syntax?this.evalArrayDefinition(e):"object"===e.syntax?(i=this.evalOrSetObjectOnScope(e,t),this.currentValue=this.mathOrConcatValues(i)):console.log("NOT NUMBER OR OPERATOR OR PRIORITY OR SHORT-HAND",e);return i}removeQuotes(e){let t="";for(const i of e)['"',"`","'"].includes(i)||(t+=i);return t}evalOrSetObjectOnScope(e,t){let i="",s="",o="",n="",r="",a=0;for(const t of e.parameters){let e="";if("function"===t.syntax?e=t.label:"dictNode"===t.syntax?e=this.recursiveEval(t.parameters):"anonymousFunc"!==t.syntax&&console.log("NOT FUNCTION or DICTNODE!",t),0===a)i=this.getObjScope(e),r=i,a=1;else if(""===i)return;if("anonymousFunc"!==t.syntax)if(""===s&&i)s=i[e];else{if(!s)return s;s=s[e]}if("function"===t.syntax||"anonymousFunc"===t.syntax){const e=[];for(const i of t.parameters[0].expression_nodes)e.push(this.recursiveEval([{expression_nodes:[i]}]));o=s.apply(i||null,e),s=o}n=e,"object"==typeof s&&(r=s)}return""!==s&&(o=s,s=""),void 0!==t&&(r[n]=t),o}recursiveEval(e){return new ParserEval({nodes:e,scope:this.$scope,$powerUi:this.$powerUi}).currentValue}adjustForNegative(e){return"-"===this.operator&&(e=-e),this.operator="",e}mathOrConcatValues(e){return this.operator&&!1===isNaN(e)&&(Number.isInteger(e)?e=parseInt(e):!1===isNaN(parseFloat(e))&&(e=parseFloat(e))),"-"===this.doubleOperator&&(e=-e,this.doubleOperator=""),"+"===this.operator?e=this.currentValue+e:"-"===this.operator?e=this.currentValue-e:"/"===this.operator?e=this.currentValue/e:"*"===this.operator&&(e=this.currentValue*e),this.operator="",e}getOrSetObjectOnScope(e,t){return void 0!==this.$scope[e]?(void 0!==t&&(this.$scope[e]=t),this.$scope[e]):this.$scope.$root&&void 0!==this.$scope.$root[e]?(void 0!==t&&(this.$scope.$root[e]=t),this.$scope.$root[e]):void 0!==this.$powerUi[e]?(void 0!==t&&(this.$powerUi[e]=t),this.$powerUi[e]):void 0}getObjScope(e){return void 0!==this.$scope[e]?this.$scope:this.$scope.$root&&void 0!==this.$scope.$root[e]?this.$scope.$root:void 0!==this.$powerUi[e]?this.$powerUi:void 0}}class StringPattern{constructor(e){this.listener=e,this.openQuote=null,this.escape=!1,this.invalid=!1}firstToken({token:e,counter:t}){return!!["quote"].includes(e.name)&&(this.openQuote=e.value,this.listener.candidates=this.listener.candidates.filter(e=>"string"===e.name),this.listener.checking="middleTokens",!0)}middleTokens({token:e,counter:t}){return e.value!==this.openQuote&&"end"!==e.name?("escape"===e.name&&(this.escape=!0),!0):e.value===this.openQuote&&("escape"===e.name?this.escape=!1:(this.openQuote=null,this.listener.checking="endToken"),!0)}endToken({token:e,counter:t}){return!1===this.invalid&&["blank","end","operator","equal","NOT-equal","greater-than","minor-than","greater-or-equal","minor-or-equal","NOT","NOT-NOT","AND","OR","short-hand","comma"].includes(e.name)?(this.listener.nextPattern({syntax:"string",token:e,counter:t}),!1):!0===this.invalid&&["blank","end","operator","equal","NOT-equal","greater-than","minor-than","greater-or-equal","minor-or-equal","NOT","NOT-NOT","AND","OR","short-hand","comma"].includes(e.name)?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,!0)}}class VariablePattern{constructor(e){this.listener=e}firstToken({token:e,counter:t}){return!!["letter","especial"].includes(e.name)&&(this.listener.candidates=this.listener.candidates.filter(e=>"variable"===e.name),this.listener.checking="middleTokens",!0)}middleTokens({token:e,counter:t}){return!!["letter","especial","number"].includes(e.name)||(["blank","end","operator","equal","NOT-equal","greater-than","minor-than","greater-or-equal","minor-or-equal","NOT","NOT-NOT","AND","OR","short-hand","comma"].includes(e.name)?(this.listener.nextPattern({syntax:"variable",token:e,counter:t}),!1):"("===e.value||"["===e.value||"dot"===e.name?(this.listener.checking="firstToken",this.listener.firstNodeLabel=this.listener.currentLabel,this.listener.candidates=[{name:"object",instance:new ObjectPattern(this.listener)}],!0):(this.listener.checking="endToken",!0))}endToken({token:e,counter:t}){return!["blank","end"].includes(e.name)||(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1)}}class BracesPattern{constructor(e){this.listener=e,this.innerObjects=0,this.currentParams="",this.dictDefinition=[],this.currentKey="",this.currentValue=""}firstToken({token:e,counter:t}){return"{"===e.value&&(this.listener.candidates=this.listener.candidates.filter(e=>"braces"===e.name),this.listener.checking="middleTokens",!0)}middleTokens({token:e,counter:t}){if(0!==this.innerObjects||"}"!==e.value)return["blank","escape","especial","quote","equal","minor-than","greater-than","NOT","NOT-NOT","AND","OR","comma","number","letter","operator","dot","separator","undefined","short-hand","braces"].includes(e.name)?(["{","(","["].includes(e.value)?this.innerObjects=this.innerObjects+1:["}",")","]"].includes(e.value)&&(this.innerObjects=this.innerObjects-1),0===this.innerObjects&&(":"===e.value?(this.currentKey=this.currentParams.trim(),this.currentParams="",this.containsQuotes(this.currentKey)||(this.currentKey=`"${this.currentKey}"`),this.currentKey=new PowerTemplateParser({text:this.currentKey,counter:t-this.currentKey.length,isParameter:!0}).syntaxTree.tree):","===e.value&&this.setDictDefinition(t)),(":"!==e.value&&","!==e.value||0!==this.innerObjects)&&(this.currentParams=this.currentParams+e.value),!0):(this.listener.checking="endToken",!0);this.setDictDefinition(t),this.listener.checking="endToken"}endToken({token:e,counter:t}){return!["blank","end"].includes(e.name)||(this.listener.nextPattern({syntax:"dictDefinition",token:e,counter:t,parameters:this.dictDefinition}),!1)}containsQuotes(e){return e.indexOf("'")>=0||e.indexOf('"')>=0||e.indexOf("`")>=0}setDictDefinition(e){""!==this.currentParams&&(this.currentValue=this.currentParams,this.currentParams="",this.currentValue=new PowerTemplateParser({text:this.currentValue,counter:e-this.currentValue.length,isParameter:!0}).syntaxTree.tree,this.dictDefinition.push({kind:"keyValue",key:this.currentKey,value:this.currentValue}))}}class NumberPattern{constructor(e){this.listener=e,this.float=!1}firstToken({token:e,counter:t}){return"number"===e.name&&(this.listener.candidates=this.listener.candidates.filter(e=>"number"===e.name),this.listener.checking="middleTokens",!0)}middleTokens({token:e,counter:t}){return!1===this.float&&"number"===e.name||(!1===this.float&&["blank","end","operator","equal","NOT-equal","greater-than","minor-than","greater-or-equal","minor-or-equal","NOT-NOT","NOT","AND","OR","short-hand","comma"].includes(e.name)?(this.listener.nextPattern({syntax:"integer",token:e,counter:t}),!1):!1===this.float&&"."===e.value?(this.float=!0,!0):!0===this.float&&"number"===e.name||(!0===this.float&&["blank","end","operator","equal","NOT-equal","greater-than","minor-than","greater-or-equal","minor-or-equal","NOT-NOT","NOT","AND","OR","short-hand","comma"].includes(e.name)?(this.listener.nextPattern({syntax:"float",token:e,counter:t}),!1):(this.listener.checking="endToken",!0)))}endToken({token:e,counter:t}){return!["blank","end"].includes(e.name)||(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1)}}class OperationPattern{constructor(e){this.listener=e}firstToken({token:e,counter:t}){return"operator"===e.name&&(this.listener.candidates=this.listener.candidates.filter(e=>"operator"===e.name),this.openOperator=e.value,this.listener.checking="middleTokens",!0)}middleTokens({token:e,counter:t}){return["blank","end","letter","especial","number","quote","operator"].includes(e.name)||"("===e.value?(this.listener.nextPattern({syntax:"operator",token:e,counter:t}),!1):(this.listener.checking="endToken",!0)}endToken({token:e,counter:t}){return!["blank","end"].includes(e.name)||(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1)}}class EqualPattern{constructor(e){this.listener=e,this.one=null,this.two=null,this.three=null,this.invalid=!1}firstToken({token:e,counter:t}){return"equal"===e.name&&(this.listener.candidates=this.listener.candidates.filter(e=>"equal"===e.name),this.listener.checking="middleTokens",this.one=e.value,!0)}middleTokens({token:e,counter:t}){return null===this.two?"equal"===e.name?(this.two=e.value,!0):(this.invalid=!0,this.listener.checking="endToken",!0):"equal"===e.name?(this.three=e.value,this.listener.checking="endToken",!0):["blank","end","letter","especial","number","NOT","NOT-NOT","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"equal",token:e,counter:t}),!1):(this.invalid=!0,this.listener.checking="endToken",!0)}endToken({token:e,counter:t}){return!1===this.invalid&&["blank","end","letter","number","especial","NOT","NOT-NOT","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"equal",token:e,counter:t}),!1):!0!==this.invalid||!["blank","end"].includes(e.name)||(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1)}}class MinorThanPattern{constructor(e){this.listener=e,this.invalid=!1}firstToken({token:e,counter:t}){return"minor-than"===e.name&&(this.listener.candidates=this.listener.candidates.filter(e=>"minor-than"===e.name),this.listener.checking="middleTokens",this.one=e.value,!0)}middleTokens({token:e,counter:t}){return"equal"===e.name?(this.listener.checking="endToken",!0):["blank","end","letter","especial","number","NOT","NOT-NOT","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"minor-than",token:e,counter:t}),!1):(this.invalid=!0,this.listener.checking="endToken",!0)}endToken({token:e,counter:t}){return!1===this.invalid&&["blank","end","letter","number","especial","NOT","NOT-NOT","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"minor-or-equal",token:e,counter:t}),!1):!0===this.invalid&&["blank","end"].includes(e.name)?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,!0)}}class GreaterThanPattern{constructor(e){this.listener=e,this.invalid=!1}firstToken({token:e,counter:t}){return"greater-than"===e.name&&(this.listener.candidates=this.listener.candidates.filter(e=>"greater-than"===e.name),this.listener.checking="middleTokens",this.one=e.value,!0)}middleTokens({token:e,counter:t}){return"equal"===e.name?(this.listener.checking="endToken",!0):["blank","end","letter","especial","number","NOT","NOT-NOT","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"greater-than",token:e,counter:t}),!1):(this.invalid=!0,this.listener.checking="endToken",!0)}endToken({token:e,counter:t}){return!1===this.invalid&&["blank","end","letter","number","especial","NOT","NOT-NOT","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"greater-or-equal",token:e,counter:t}),!1):!0===this.invalid&&["blank","end"].includes(e.name)?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,!0)}}class NotPattern{constructor(e){this.listener=e,this.one=null,this.two=null,this.three=null,this.invalid=!1}firstToken({token:e,counter:t}){return"NOT"===e.name&&(this.listener.candidates=this.listener.candidates.filter(e=>"NOT"===e.name),this.listener.checking="middleTokens",this.one=e.value,!0)}middleTokens({token:e,counter:t}){return null===this.two?"equal"===e.name||"NOT"===e.name?(this.two=e.value,!0):["blank","end","letter","especial","number","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"NOT",token:e,counter:t}),!1):(this.invalid=!0,this.listener.checking="endToken",!0):(this.three=e.value,"="===this.two&&"equal"===e.name?(this.listener.checking="endToken",!0):"="===this.two&&["blank","end","letter","especial","number","NOT","NOT-NOT","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"NOT-equal",token:e,counter:t}),!1):"!"===this.two&&["blank","end","letter","especial","number","quote"].includes(e.name)?(this.listener.checking="endToken",this.listener.nextPattern({syntax:"NOT-NOT",token:e,counter:t}),!1):"!"===this.two&&"NOT"===e.name?(this.listener.checking="endToken",!0):(this.invalid=!0,this.listener.checking="endToken",!0))}endToken({token:e,counter:t}){return!1===this.invalid&&"="===this.three&&["blank","end","letter","number","especial","NOT","NOT-NOT","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"NOT-equal",token:e,counter:t}),!1):!1===this.invalid&&"!"===this.three&&["blank","end","letter","number","especial","quote"].includes(e.name)?void this.listener.nextPattern({syntax:"NOT-NOT",token:e,counter:t}):!0===this.invalid&&["blank","end"].includes(e.name)?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):("!"!==e.value&&(this.invalid=!0),!0)}}class AndPattern{constructor(e){this.listener=e,this.invalid=!1}firstToken({token:e,counter:t}){return"AND"===e.name&&(this.listener.candidates=this.listener.candidates.filter(e=>"AND"===e.name),this.listener.checking="middleTokens",!0)}middleTokens({token:e,counter:t}){return"AND"===e.name?(this.listener.checking="endToken",!0):(this.invalid=!0,this.listener.checking="endToken",!0)}endToken({token:e,counter:t}){return!1===this.invalid&&["blank","end","letter","number","especial","NOT","NOT-NOT","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"AND",token:e,counter:t}),!1):!0===this.invalid&&["blank","end"].includes(e.name)?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,!0)}}class OrPattern{constructor(e){this.listener=e,this.invalid=!1}firstToken({token:e,counter:t}){return"OR"===e.name&&(this.listener.candidates=this.listener.candidates.filter(e=>"OR"===e.name),this.listener.checking="middleTokens",!0)}middleTokens({token:e,counter:t}){return"OR"===e.name?(this.listener.checking="endToken",!0):(this.invalid=!0,this.listener.checking="endToken",!0)}endToken({token:e,counter:t}){return!1===this.invalid&&["blank","end","letter","number","especial","NOT","NOT-NOT","quote"].includes(e.name)?(this.listener.nextPattern({syntax:"OR",token:e,counter:t}),!1):!0===this.invalid&&["blank","end"].includes(e.name)?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,!0)}}class ShortHandPattern{constructor(e){this.listener=e,this.currentParams="",this.shortHand={syntax:"short-hand",condition:[],if:[],else:[],label:""},this.counter=0,this.openShortHand=0,this.needCloseShortHand=0,this.parentheses=0,this.brackets=0}firstToken({token:e,counter:t}){return"short-hand"===e.name&&"?"===e.value&&(this.openShortHand=this.openShortHand+1,this.createConditionNode({token:e,counter:t}),!0)}middleTokens({token:e,counter:t}){if(["blank","escape","especial","quote","equal","minor-than","greater-than","NOT","NOT-NOT","AND","OR","comma","number","letter","operator","dot","separator","undefined"].includes(e.name))return this.currentParams=this.currentParams+e.value,"("===e.value?this.parentheses=this.parentheses+1:"["===e.value?this.brackets=this.brackets+1:")"===e.value?this.parentheses=this.parentheses-1:"]"===e.value&&(this.brackets=this.brackets-1),!0;if("short-hand"===e.name&&":"===e.value)return 0===this.brackets&&0===this.parentheses&&(this.needCloseShortHand=this.needCloseShortHand+1,this.openShortHand===this.needCloseShortHand&&(this.needCloseShortHand=this.needCloseShortHand-1,this.createIfNode({token:e,text:this.currentParams}))),this.currentParams=this.currentParams+e.value,!0;if("short-hand"===e.name&&"?"===e.value){if(0===this.brackets&&0===this.parentheses){if(1===this.openShortHand&&1===this.needCloseShortHand){let i=this.shortHand.label+this.currentParams;return this.listener.syntaxTree.nodes=[{syntax:"temp",label:i}],this.shortHand={syntax:"short-hand",condition:[],if:[],else:[],label:""},this.openShortHand=this.openShortHand-1,this.needCloseShortHand=this.needCloseShortHand-1,this.counter=0,this.currentParams=this.currentParams+e.value,this.createConditionNode({token:e,counter:t}),!0}this.openShortHand=this.openShortHand+1}return this.currentParams=this.currentParams+e.value,!0}return"end"===e.name?(this.createElseNode({token:e}),!1):(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1)}createConditionNode({token:e}){for(const e of this.listener.syntaxTree.nodes)this.shortHand.label=`${this.shortHand.label}${e.label}`;this.shortHand.condition=new PowerTemplateParser({text:this.shortHand.label,counter:this.counter,isParameter:!0}).syntaxTree.tree,this.listener.syntaxTree.nodes=[],this.listener.candidates=this.listener.candidates.filter(e=>"short-hand"===e.name),this.listener.checking="middleTokens",this.counter=this.shortHand.label.length+1,this.currentParams="",this.fullLabel=this.shortHand.label+e.value}createIfNode({token:e,text:t}){this.shortHand.if=new PowerTemplateParser({text:t,counter:this.counter,isParameter:!0}).syntaxTree.tree,this.shortHand.label=this.fullLabel+this.currentParams,this.counter=this.shortHand.label.length+1,this.currentParams=""}createElseNode({token:e}){this.shortHand.else=new PowerTemplateParser({text:this.currentParams,counter:this.counter,isParameter:!0}).syntaxTree.tree,this.shortHand.label=this.shortHand.label+this.currentParams,this.shortHand.start=0,this.shortHand.end=this.shortHand.label.length,this.listener.syntaxTree.nodes.push(this.shortHand),this.openShortHand=this.openShortHand-1,this.needCloseShortHand=this.needCloseShortHand-1}}class CommaPattern{constructor(e){this.listener=e,this.invalid=!1}firstToken({token:e,counter:t}){return"comma"===e.name&&(this.listener.candidates=this.listener.candidates.filter(e=>"comma"===e.name),this.listener.checking="endToken",!0)}endToken({token:e,counter:t}){return!1===this.invalid&&["blank","end","especial","separator","operator","quote","equal","NOT","NOT-NOT","comma","number","letter"].includes(e.name)?(this.listener.nextPattern({syntax:"comma",token:e,counter:t}),!1):!0===this.invalid&&["blank","end"].includes(e.name)?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,!0)}}class DictPattern{constructor(e){this.listener=e,this.invalid=!1}firstToken({token:e,counter:t}){if("dot"===e.name&&0===this.listener.syntaxTree.nodes.length){this.listener.checking="endToken",this.listener.firstNodeLabel=this.listener.currentLabel;const e=new ObjectPattern(this.listener);return e.invalid=!0,this.listener.candidates=[{name:"object",instance:e}],!0}if("dot"===e.name||"["===e.value){this.listener.checking="firstToken",this.listener.firstNodeLabel=this.listener.currentLabel;const e=new ObjectPattern(this.listener);return e.anonymous=!0,this.listener.candidates=[{name:"object",instance:e}],!0}return!1}}class parenthesesPattern{constructor(e){this.listener=e,this.invalid=!1,this.nodes=[],this.currentOpenChar=null,this.currentParams="",this.currentParamsCounter=null,this.innerOpenedParenteses=0,this.anonymous=!1}firstToken({token:e,counter:t}){if(this.currentOpenChar=e.value,"("!==this.currentOpenChar||this.listener.isAnonymousFunc){if(!0===this.listener.isAnonymousFunc){this.listener.checking="firstToken",this.listener.firstNodeLabel=this.listener.currentLabel;const e=new ObjectPattern(this.listener);return e.anonymous=!0,this.listener.candidates=[{name:"object",instance:e}],this.listener.isAnonymousFunc=!1,!0}return!1}return this.listener.candidates=this.listener.candidates.filter(e=>"parentheses"===e.name),this.listener.checking="middleTokens",null===this.currentParamsCounter&&(this.currentParamsCounter=t||null),!0}middleTokens({token:e,counter:t}){return")"===e.value&&0===this.innerOpenedParenteses?(this.listener.checking="endToken",!0):["blank","escape","especial","quote","equal","minor-than","greater-than","NOT","NOT-NOT","AND","OR","comma","short-hand","number","letter","operator","dot","separator","braces","undefined"].includes(e.name)?(this.currentParams=this.currentParams+e.value,null===this.currentParamsCounter&&(this.currentParamsCounter=t||null),"("===e.value?this.innerOpenedParenteses=this.innerOpenedParenteses+1:")"===e.value&&(this.innerOpenedParenteses=this.innerOpenedParenteses-1),!0):this.innerOpenedParenteses>=0&&"end"===e.name?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,this.listener.checking="endToken",!0)}endToken({token:e,counter:t}){if(!1===this.invalid){if(["blank","end","dot","operator"].includes(e.name)){const i=new PowerTemplateParser({text:this.currentParams,counter:this.currentParamsCounter,isParameter:!0}).syntaxTree.tree;return this.listener.nextPattern({syntax:this.anonymous?"anonymousFunc":"parentheses",token:e,counter:t,parameters:i}),!1}if("("===e.value){const e=new PowerTemplateParser({text:this.currentParams,counter:this.currentParamsCounter,isParameter:!0}).syntaxTree.tree;return this.listener.syntaxTree.nodes.push({syntax:this.anonymous?"anonymousFunc":"parentheses",label:this.listener.currentLabel,tokens:this.listener.currentTokens,start:this.listener.start,end:t,parameters:e||[]}),this.listener.start=t,this.listener.currentTokens=[],this.currentParams=[],this.listener.currentLabel="",this.anonymous=!0,this.listener.checking="middleTokens",!0}return this.invalid=!0,!0}return!0===this.invalid&&["blank","end"].includes(e.name)?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,!0)}}class ArrayDefinitionPattern{constructor(e){this.listener=e,this.invalid=!1,this.nodes=[],this.innerOpenedObjects=0,this.currentParams="",this.arrayContent=[],this.currentParamsCounter=null}firstToken({token:e,counter:t}){const i=this.listener.syntaxTree.nodes[this.listener.syntaxTree.nodes.length-1];return!("["!==e.value||i&&"dictNode"===i.syntax)&&(this.listener.candidates=this.listener.candidates.filter(e=>"arrayDefinition"===e.name),this.listener.checking="middleTokens",null===this.currentParamsCounter&&(this.currentParamsCounter=t||null),!0)}middleTokens({token:e,counter:t}){return"]"===e.value&&0===this.innerOpenedObjects?(this.listener.checking="endToken",""!==this.currentParams&&this.setArrayItem(),!0):["blank","escape","especial","quote","equal","minor-than","greater-than","NOT","NOT-NOT","AND","OR","comma","short-hand","number","letter","operator","dot","separator","braces","undefined"].includes(e.name)?(0===this.innerOpenedObjects&&","===e.value?this.setArrayItem():this.currentParams=this.currentParams+e.value,null===this.currentParamsCounter&&(this.currentParamsCounter=t||null),["{","(","["].includes(e.value)?this.innerOpenedObjects=this.innerOpenedObjects+1:["}",")","]"].includes(e.value)&&(this.innerOpenedObjects=this.innerOpenedObjects-1),!0):void 0}endToken({token:e,counter:t}){return!1===this.invalid?["end","blank","equal","minor-than","greater-than","NOT","NOT-NOT","AND","OR","comma","short-hand","operator"].includes(e.name)?(this.listener.nextPattern({syntax:"arrayDefinition",token:e,counter:t,parameters:this.arrayContent}),!1):(this.invalid=!0,!0):!0===this.invalid&&["blank","end"].includes(e.name)?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,!0)}setArrayItem(){const e=new PowerTemplateParser({text:this.currentParams,counter:this.currentParamsCounter,isParameter:!1}).syntaxTree.tree;this.arrayContent.push(e),this.currentParams=""}}class ObjectPattern{constructor(e){this.listener=e,this.invalid=!1,this.nodes=[],this.currentOpenChar=null,this.currentParams="",this.currentParamsCounter=null,this.innerOpenedObjects=0,this.anonymous=!1}firstToken({token:e,counter:t}){if(null===e.value){const i=this.listener.currentTokens[this.listener.currentTokens.length-1];if("("===i.value||"["===i.value||"."===i.value)return this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1}return this.currentOpenChar=this.listener.currentTokens[this.listener.currentTokens.length-1].value,"("===this.currentOpenChar?")"===e.value?(this.listener.checking="endToken",!0):["blank","end","letter","number","especial","NOT","NOT-NOT","quote","undefined"].includes(e.name)||"-"===e.value||"+"===e.value?(this.listener.checking="middleTokens",this.currentParams=this.currentParams+e.value,null===this.currentParamsCounter&&(this.currentParamsCounter=t||null),!0):["(","[","{"].includes(e.value)?(this.innerOpenedObjects=this.innerOpenedObjects+1,this.currentParams=this.currentParams+e.value,this.listener.checking="middleTokens",null===this.currentParamsCounter&&(this.currentParamsCounter=t||null),!0):(this.invalid=!0,this.listener.checking="endToken",!0):"["!==this.currentOpenChar&&"."!==this.currentOpenChar||"separator"===e.name&&"("!==e.value?("dot"===e.name||"separator"===e.name)&&(this.invalid=!0,this.listener.checking="endToken",!0):("."!==this.listener.currentLabel&&"["!==this.listener.currentLabel?(this.listener.firstNodeLabel=this.listener.currentLabel,this.currentParams=`"${this.listener.currentLabel.slice(0,this.listener.currentLabel.length-1)}"`,this.createDictionaryNode({token:e,counter:t}),"."===this.currentOpenChar&&"number"===e.name&&(this.invalid=!0)):this.listener.checking="middleTokens",this.currentParams=this.currentParams+e.value,null===this.currentParamsCounter&&(this.currentParamsCounter=t||null),!0)}middleTokens({token:e,counter:t}){if("("===this.currentOpenChar&&")"===e.value&&0===this.innerOpenedObjects)return this.listener.checking="endToken",!0;if("("===this.currentOpenChar&&["blank","escape","especial","quote","equal","minor-than","greater-than","NOT","NOT-NOT","AND","OR","comma","short-hand","number","letter","operator","dot","separator","braces","undefined"].includes(e.name))return this.currentParams=this.currentParams+e.value,null===this.currentParamsCounter&&(this.currentParamsCounter=t||null),["(","{","["].includes(e.value)?this.innerOpenedObjects=this.innerOpenedObjects+1:[")","}","]"].includes(e.value)&&(this.innerOpenedObjects=this.innerOpenedObjects-1),!0;if("("===this.currentOpenChar&&this.innerOpenedObjects>=0&&"end"===e.name)return this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1;if("["===this.currentOpenChar&&"]"===e.value&&0===this.innerOpenedObjects)return this.invalid=!this.currentParams.length,this.listener.checking="endToken",!0;if("."!==this.currentOpenChar||!["blank","end","operator","dot"].includes(e.name)&&"("!==e.value&&"["!==e.value)return"["===this.currentOpenChar&&["blank","escape","especial","quote","equal","NOT-equal","greater-than","minor-than","greater-or-equal","minor-or-equal","NOT","NOT-NOT","AND","OR","comma","short-hand","number","letter","operator","dot","separator"].includes(e.name)?(this.currentParams=this.currentParams+e.value,null===this.currentParamsCounter&&(this.currentParamsCounter=t||null),"["===e.value?this.innerOpenedObjects=this.innerOpenedObjects+1:"]"===e.value&&(this.innerOpenedObjects=this.innerOpenedObjects-1),!0):"."===this.currentOpenChar&&["especial","number","letter"].includes(e.name)?(this.currentParams=this.currentParams+e.value,null===this.currentParamsCounter&&(this.currentParamsCounter=t||null),!0):"["===this.currentOpenChar&&this.innerOpenedObjects>=0&&"end"===e.name?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,this.listener.checking="endToken",!0);{if(this.listener.currentTokens.length>=2&&"dot"===this.listener.currentTokens[0].name&&"number"===this.listener.currentTokens[1].name||this.listener.syntaxTree.nodes.length&&this.listener.syntaxTree.nodes[this.listener.syntaxTree.nodes.length-1]&&"dictNode"===this.listener.syntaxTree.nodes[this.listener.syntaxTree.nodes.length-1].syntax&&"."===this.listener.syntaxTree.nodes[this.listener.syntaxTree.nodes.length-1].tokens[this.listener.syntaxTree.nodes[this.listener.syntaxTree.nodes.length-1].tokens.length-1].value&&"number"===this.listener.currentTokens[0].name)return this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1;const i=new PowerTemplateParser({text:`"${this.currentParams}"`,counter:this.currentParamsCounter,isParameter:!0}).syntaxTree.tree;return this.listener.currentLabel=this.anonymous?this.listener.currentLabel:this.listener.firstNodeLabel,"("===e.value&&(this.listener.isAnonymousFunc=!0),this.listener.nextPattern({syntax:"dictNode",token:e,counter:t,parameters:i}),!1}}endToken({token:e,counter:t}){if(!1===this.invalid){if(["blank","end","operator","comma","dot"].includes(e.name)){const i=new PowerTemplateParser({text:this.currentParams,counter:this.currentParamsCounter,isParameter:!0}).syntaxTree.tree;return"("===this.currentOpenChar?(this.listener.currentLabel=this.anonymous?this.listener.currentLabel:this.listener.firstNodeLabel,this.listener.nextPattern({syntax:this.anonymous?"anonymousFunc":"function",token:e,counter:t,parameters:i}),!1):"["===this.currentOpenChar||"."===this.currentOpenChar?(this.listener.currentLabel=this.anonymous?this.listener.currentLabel:this.listener.firstNodeLabel,this.listener.nextPattern({syntax:"dictNode",token:e,counter:t,parameters:i}),!1):(this.invalid=!0,!0)}return"("!==this.currentOpenChar||"("!==e.value&&"["!==e.value?"["!==this.currentOpenChar||"["!==e.value&&"("!==e.value?(this.invalid=!0,!0):(this.createDictionaryNode({token:e,counter:t}),this.currentOpenChar=e.value,!0):(this.listener.checking="middleTokens",this.createAnonymousFuncNode({token:e,counter:t}),this.currentOpenChar=e.value,!0)}return!0===this.invalid&&["blank","end"].includes(e.name)?(this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1):(this.invalid=!0,!0)}dictHaveInvalidParams(e){return 0===e.length&&(invalid=!0,!0)}createDictionaryNode({token:e,counter:t}){const i=new PowerTemplateParser({text:this.currentParams,counter:this.currentParamsCounter,isParameter:!0}).syntaxTree.tree;if(this.dictHaveInvalidParams(i))return this.listener.nextPattern({syntax:"invalid",token:e,counter:t}),!1;this.listener.syntaxTree.nodes.push({syntax:"dictNode",label:this.listener.firstNodeLabel?this.listener.firstNodeLabel:this.listener.currentLabel,tokens:this.listener.currentTokens,start:this.listener.start,end:t,parameters:i||[]}),this.listener.start=t,this.listener.currentTokens=[],this.currentParams=[],this.listener.currentLabel="",this.listener.firstNodeLabel="",this.anonymous=!0,this.listener.checking="middleTokens"}createAnonymousFuncNode({token:e,counter:t}){const i=new PowerTemplateParser({text:this.currentParams,counter:this.currentParamsCounter,isParameter:!0}).syntaxTree.tree;this.listener.currentLabel=!0===this.anonymous?this.listener.currentLabel:this.listener.firstNodeLabel,this.listener.syntaxTree.nodes.push({syntax:!0===this.anonymous?"anonymousFunc":"function",label:this.listener.currentLabel,tokens:this.listener.currentTokens,start:this.listener.start,end:t,parameters:i||[]}),this.listener.start=t,this.listener.currentTokens=[],this.currentParams=[],this.listener.currentLabel="",this.listener.firstNodeLabel="",this.anonymous=!0,this.listener.checking="middleTokens"}}class EmptyPattern{constructor(e){this.listener=e}firstToken({token:e,counter:t}){return"blank"===e.name&&(this.listener.candidates=this.listener.candidates.filter(e=>"empty"===e.name),this.listener.checking="middleTokens",!0)}middleTokens({token:e,counter:t}){return"blank"===e.name||(this.listener.nextPattern({syntax:"empty",token:e,counter:t}),!1)}}class PowerWidget extends PowerController{constructor({$powerUi:e}){super({$powerUi:e}),this.isWidget=!0}$buildTemplate({template:e,title:t}){const i=document.createElement("div");return this.addBeforeTemplate&&(e=this.addBeforeTemplate+e),i.innerHTML=this.template({$title:t||null}),this.addAfterTemplate&&(e+=this.addAfterTemplate),i.querySelectorAll("[data-pw-content]")[0].innerHTML=e,e=i.innerHTML}}export{PowerWidget};class PowerDialogBase extends PowerWidget{constructor({$powerUi:e,noEsc:t,promise:i}){super({$powerUi:e});const s=this;i&&(this._promise=new Promise((function(e,t){s._resolve=e,s._reject=t}))),t||(this._closeWindow=function(){s._cancel()})}_cancel(...e){if(this.onCancel&&this._promise){const t=this.onCancel(this._resolve,this._reject,...e)||[],i=this;this._promise.then((function(){i.closeCurrentRoute({commands:t})})).catch((function(e){i.closeCurrentRoute()}))}else if(this.onCancel){const t=this.onCancel(...e)||[];this.closeCurrentRoute({commands:t})}else this.closeCurrentRoute()}_commit(...e){if(this.onCommit&&this._promise){const t=this.onCommit(this._resolve,this._reject,...e)||[],i=this;this._promise.then((function(){i.closeCurrentRoute({commands:t})})).catch((function(e){i.closeCurrentRoute()}))}else if(this.onCommit){const t=this.onCommit(...e)||[];this.closeCurrentRoute({commands:t})}else this.closeCurrentRoute()}closeCurrentRoute({commands:e=[],callback:t=null}={}){document.getElementById(this._viewId)?super.closeCurrentRoute({commands:e,callback:t}):this.$powerUi._events.Escape.broadcast()}_onRemoveView(){this.$powerUi.dialogs=this.$powerUi.dialogs.filter(e=>e.id!==this.dialogId),this.$powerUi.onBrowserWindowResize.unsubscribe(this.browserWindowResize,this),this.$powerUi.touchdevice&&this.$powerUi.onBrowserOrientationChange.unsubscribe(this.orientationChange,this),this.isWindow||this.$powerUi._events.Escape.unsubscribe(this._closeWindow),this._currentScrollTop=this.bodyEl.scrollTop||0,this._currentScrollLeft=this.bodyEl.scrollLeft||0}_onViewLoad(e,t,i){this.isWindow||this.$powerUi._events.Escape.subscribe(this._closeWindow),this.$powerUi.onBrowserWindowResize.subscribe(this.browserWindowResize,this),this.$powerUi.touchdevice&&this.$powerUi.onBrowserOrientationChange.subscribe(this.orientationChange,this),this.isHiddenRoute=this.$powerUi.router.routes[this._routeId].isHidden||!1;const s=this.$powerUi.router.getOpenedRoute({routeId:this._routeId,viewId:this._viewId});this._dialog=e.getElementsByClassName("pw-dialog-container")[0],this.bodyEl=e.getElementsByClassName("pw-body")[0],this.titleBarEl=e.getElementsByClassName("pw-title-bar")[0],s&&(this.dialogId=`dialog_${s.route.replace("/","-")}`,this.zIndex=1999+this.$powerUi.dialogs.length+1,this._dialog.style.zIndex=this.zIndex,this.$powerUi.dialogs.push({id:this.dialogId,ctrl:this})),i||this.setHeightLimits(),t||this.restoreScrollPosition(e)}setHeightLimits(){this.bodyEl.offsetHeight+this.titleBarEl.offsetHeight>window.innerHeight-30?this._setHieghtLimits():(this.bodyEl.style.height=null,this.bodyEl.offsetHeight+this.titleBarEl.offsetHeight>window.innerHeight-30&&this._setHieghtLimits())}_setHieghtLimits(){const e=window.innerHeight-this.titleBarEl.offsetHeight-30+"px";this.bodyEl.style.height=e}browserWindowResize(){this.setHeightLimits()}orientationChange(){this.browserWindowResize()}restoreScrollPosition(e){this.bodyEl.scrollTop=this._currentScrollTop||0,this.bodyEl.scrollLeft=this._currentScrollLeft||0}$buttons(){if(this.commitBt||this.cancelBt){let e="";if(this.commitBt){const t=this.noBt?"Yes":"Ok",i=`<span class="pw-icon ${this.commitBt.icon?this.commitBt.icon:"icon-ok-black"}"></span>`;e+=`<button\n\t\t\t\t\t\t\t\tclass="${this.commitBt.css?this.commitBt.css:"pw-btn-default"}"\n\t\t\t\t\t\t\t\tdata-pow-event onclick="_commit(true)">\n\t\t\t\t\t\t\t\t${!1!==this.commitBt.icon?i:""}\n\t\t\t\t\t\t\t\t<span class="pw-label">\n\t\t\t\t\t\t\t\t\t${this.commitBt.label?this.commitBt.label:t}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</button>`}if(this.noBt){const t=`<span class="pw-icon ${this.noBt.icon?this.noBt.icon:"icon-cancel-black"}"></span>`;e+=`<button\n\t\t\t\t\t\t\t\tclass="${this.noBt.css?this.noBt.css:"pw-btn-default"}"\n\t\t\t\t\t\t\t\tdata-pow-event onclick="_commit(false)">\n\t\t\t\t\t\t\t\t${!1!==this.noBt.icon?t:""}\n\t\t\t\t\t\t\t\t<span class="pw-label">\n\t\t\t\t\t\t\t\t\t${this.noBt.label?this.noBt.label:"No"}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</button>`}if(this.cancelBt){const t=this.noBt?"icon-cancel-simple":"icon-cancel-black",i=`<span class="pw-icon ${this.cancelBt.icon?this.cancelBt.icon:t}"></span>`;e+=`<button\n\t\t\t\t\t\t\t\tclass="${this.cancelBt.css?this.cancelBt.css:"pw-btn-default"}"\n\t\t\t\t\t\t\t\tdata-pow-event onclick="_cancel()">\n\t\t\t\t\t\t\t\t${!1!==this.cancelBt.icon?i:""}\n\t\t\t\t\t\t\t\t<span class="pw-label">\n\t\t\t\t\t\t\t\t\t${this.cancelBt.label?this.cancelBt.label:"Cancel"}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</button>`}return e}return""}template({$title:e}){this.$title=this.$title||e;const t=this.$buttons();return`<div class="pw-title-bar">\n\t\t\t\t\t<span class="pw-title-bar-label">${this.$title}</span>\n\t\t\t\t\t<div data-pow-event onclick="_cancel()" class="pw-bt-dialog-title pw-icon icon-cancel-black"></div>\n\t\t\t\t\t${this.restoreBt?'<div style="display:none;" data-pow-event onclick="restore(event)" class="pw-bt-dialog-title pw-icon icon-windows"></div>':""}\n\t\t\t\t\t${this.maximizeBt?'<div data-pow-event onclick="maximize(event)" class="pw-bt-dialog-title pw-icon icon-maximize"></div>':""}\n\t\t\t\t</div>\n\t\t\t\t<div class="pw-body">\n\t\t\t\t\t<div class="pw-container" data-pw-content>\n\t\t\t\t\t</div>\n\t\t\t\t\t${t?'<div class="pw-container">'+t+"</div>":""}\n\t\t\t\t</div>`}}export{PowerDialogBase};class PowerDialog extends PowerDialogBase{constructor({$powerUi:e,promise:t=!0}){super({$powerUi:e,promise:t})}template({$title:e}){return this.$title=this.$title||e,`<div class="pw-dialog pw-dialog-container pw-backdrop">\n\t\t\t\t\t${super.template({$title:e})}\n\t\t\t\t</div>`}}class PowerAlert extends PowerDialog{constructor({$powerUi:e,promise:t=!0}){super({$powerUi:e,promise:t}),this.commitBt=!0}}class PowerConfirm extends PowerDialog{constructor({$powerUi:e,promise:t=!0}){super({$powerUi:e,promise:t}),this.commitBt=!0,this.cancelBt=!0}}class PowerYesNo extends PowerDialog{constructor({$powerUi:e,promise:t=!0}){super({$powerUi:e,promise:t}),this.commitBt=!0,this.noBt=!0,this.cancelBt=!0}}function wrapFunctionInsideDialog({controller:e,kind:t,params:i,resolve:s,reject:o,_promise:n}){class r extends PowerAlert{constructor({$powerUi:t}){if(super({$powerUi:t,promise:!1}),this.ctrl=e,this._resolve=s,this._reject=o,this._promise=n,i)for(const e of Object.keys(i||{}))this[e]=i[e]}}class a extends PowerConfirm{constructor({$powerUi:t}){if(super({$powerUi:t,promise:!1}),this.ctrl=e,this._resolve=s,this._reject=o,this._promise=n,i)for(const e of Object.keys(i||{}))this[e]=i[e]}}class l extends PowerYesNo{constructor({$powerUi:t}){if(super({$powerUi:t,promise:!1}),this.ctrl=e,this._resolve=s,this._reject=o,this._promise=n,i)for(const e of Object.keys(i||{}))this[e]=i[e]}}class h extends PowerModal{constructor({$powerUi:t}){if(super({$powerUi:t,promise:!1}),this.ctrl=e,this._resolve=s,this._reject=o,this._promise=n,i)for(const e of Object.keys(i||{}))this[e]=i[e]}}class d extends PowerWindow{constructor({$powerUi:t}){if(super({$powerUi:t,promise:!1}),this.ctrl=e,this._resolve=s,this._reject=o,this._promise=n,i)for(const e of Object.keys(i||{}))this[e]=i[e]}}class c extends PowerWindowIframe{constructor({$powerUi:t}){if(super({$powerUi:t,promise:!1}),this.ctrl=e,this._resolve=s,this._reject=o,this._promise=n,i)for(const e of Object.keys(i||{}))this[e]=i[e]}}return"confirm"===t?a:"yesno"===t?l:"modal"===t?h:"window"===t?d:"windowIframe"===t?c:r}export{PowerDialog,PowerAlert,PowerConfirm};class PowerModal extends PowerDialogBase{constructor({$powerUi:e,classList:t,promise:i=!1}){super({$powerUi:e,promise:i}),this.isModal=!0,t&&(this.classList=t)}clickOutside(e){e.target.classList.contains("pw-backdrop")&&this._cancel()}template({$title:e}){document.body&&document.body.classList&&document.body.classList.add("modal-open");let t=" ";if(this.classList)for(const e of this.classList)t=`${t} ${e}`;return this.$title=this.$title||e,`<div class="pw-modal pw-dialog-container pw-backdrop${this.$powerUi.touchdevice?" pw-touchdevice":""}${t}" data-pow-event onclick="clickOutside(event)">\n\t\t\t\t\t${super.template({$title:e})}\n\t\t\t\t</div>`}}export{PowerModal};class PowerTreeTemplate{constructor({$powerUi:e,tree:t,boilerplate:i}){this.boilerplate=i||!1,this.$powerUi=e,this.tree=t,this.template=this.buildTemplate(this.tree)}buildTemplate(e,t){let i=`<nav ${t?'id="'+t+'"':""} class="power-tree-view">`;for(const t of e)if("file"===t.kind)i=this.boilerplate?`${i}\n\t\t\t\t\t<a class="power-item" data-pow-event onclick="_commit({path:'${t.path}'})"><span class="pw-icon icon-document"></span> ${t.fullName}</a>`:`${i}\n\t\t\t\t\t<a class="power-item"><span class="pw-icon icon-document"></span> ${t.fullName}</a>`;else if("folder"===t.kind){const e=`list-${this.$powerUi._Unique.next()}`;i=`${i}\n\t\t\t\t<a class="power-list" data-power-target="${e}">\n\t\t\t\t\t<span class="power-status pw-icon" data-power-active="icon-folder-open" data-power-inactive="icon-folder-close"></span> ${t.fullName}\n\t\t\t\t</a>\n\t\t\t\t${this.buildTemplate(t.content,e)}`}return i=`${i}\n\t\t</nav>`,i}}class PowerWindow extends PowerDialogBase{constructor({$powerUi:e,promise:t=!1}){super({$powerUi:e,noEsc:!0,promise:t}),this.isWindow=!0,this.defaultMinHeight=100,this.defaultMinWidth=250,this.defaultBorderSize=5,this._minWidth=this.defaultMinWidth,this._minHeight=this.defaultMinHeight,this.maximizeBt=!0,this.restoreBt=!0,this.isMaximized=!1,this.topTotalHeight=0,this.bottomTotalHeight=0,this.leftTotalWidth=0,this.rightTotalWidth=0,this.totalHeight=0,this.powerWindowModeChange=new UEvent("powerWindowModeChange"),this.powerWindowStateChange=new UEvent("powerWindowStateChange"),this.onPowerWindowResize=new UEvent("onPowerWindowResize"),this.$powerUi.onFixedPowerSplitBarChange.subscribe(this.onFixedPowerSplitBarChange,this)}_onViewLoad(e){super._onViewLoad(e,!0,!0),this.currentView=e,this.fixedBars={left:[],right:[],top:[],bottom:[]};const t=this.currentView.getElementsByClassName("pw-bar-fixed");for(const e of t)e.classList.contains("pw-left")?this.fixedBars.left.push(e):e.classList.contains("pw-right")?this.fixedBars.right.push(e):e.classList.contains("pw-top")?this.fixedBars.top.push(e):e.classList.contains("pw-bottom")&&this.fixedBars.bottom.push(e);this.windowBars=[],this.windowToolbars=[];const i=this.currentView.getElementsByClassName("pw-bar-window-fixed");for(const e of i){const t=this.$powerUi.componentsManager.bars.find(t=>t.id===e.id);t&&(t.bar._window=this,t.bar.subscribeToPowerWindowModeChange&&t.bar.subscribeToPowerWindowModeChange(),t.bar.subscribeToOnPowerWindowResize&&t.bar.subscribeToOnPowerWindowResize(),this.windowBars.push(t),t.bar.isToolbar&&this.windowToolbars.push(t))}this.isHiddenRoute||(this.loadWindowState(),this.$powerUi.reorder||(this.$powerUi.reorder=!0,this.$powerUi.router.onCycleEnds.subscribe(this.reorderDialogsList.bind(this)))),void 0!==this._top&&void 0!==this._left&&(this._dialog.style.top=this._top+"px",this._dialog.style.left=this._left+"px"),void 0!==this._width&&void 0!==this._height&&(this._dialog.style.width=this._width+"px",this._dialog.style.height=this._height+"px"),this._width=this._dialog.offsetWidth,this._height=this._dialog.offsetHeight,this._top=this._dialog.offsetTop,this._left=this._dialog.offsetLeft,this._lastHeight=0,this._lastwidth=0,this._changeWindowSize=this.changeWindowSize.bind(this),this._onMouseUp=this.onMouseUp.bind(this),this.addDragWindow(),this.maximizeBt=this._dialog.getElementsByClassName("icon-maximize")[0],this.restoreBt=this._dialog.getElementsByClassName("icon-windows")[0],this.bodyEl.style.height=this._height-this.titleBarEl.offsetHeight+"px";let s=parseInt(window.getComputedStyle(this._dialog).getPropertyValue("min-height").replace("px",""));s+=this.titleBarEl.offsetHeight,this._dialog.style["min-height"]=s+"px",this._minHeight=s,this.addOnMouseBorderEvents(),this.setAllWindowElements();const o=this.minTop(),n=this.minLeft();this.topLeftLimits(o+this.defaultBorderSize,n+this.defaultBorderSize),this.isMaximized?this.maximize(null,!0):this.restore(null,!0),this.replaceSizeQueries(),this.restoreScrollPosition(e),this.refreshWindowToolbars(),this._dialog.classList.add("pw-active")}onFixedPowerSplitBarChange(){this.browserWindowResize()}changeWindowBars(){const e=this.$powerUi.componentsManager;!0===this.isMaximized&&!e.smallWindowMode||!1===this.isMaximized&&e.smallWindowMode?(this._currentTop=-this.defaultBorderSize+this._dialog.offsetTop,this._currentBottom=-this.defaultBorderSize+this._dialog.offsetTop,this._currentLeft=-this.defaultBorderSize+this.respectLeft,this._currentWidth=this._dialog.offsetWidth,this._currentHeight=this._dialog.offsetHeight+this.ignoreTop+this.ignoreBottom):!0===this.isMaximized&&e.smallWindowMode?(this._currentTop=-this.defaultBorderSize,this._currentBottom=this._currentTop,this._currentLeft=-this.defaultBorderSize,this._currentWidth=this._dialog.offsetWidth-(this.defaultBorderSize+this.defaultBorderSize),this._currentHeight=this._dialog.offsetHeight-(this.defaultBorderSize+this.defaultBorderSize)):(this._currentTop=this._top,this._currentBottom=this._currentTop,this._currentLeft=this._left,this._currentWidth=this._width,this._currentHeight=this._height),this.$powerUi.componentsManager.setWindowFixedBarsSizeAndPosition(this.windowBars,this)}refreshWindowToolbars(){for(const e of this.windowToolbars)e.bar.setStatus()}adjustWindowWithComponents(){this.respectTop=0,this.ignoreTop=0,this.respectBottom=0,this.ignoreBottom=0,this.respectRight=0,this.respectLeft=0,this.ignoreLeft=0;const e=this.$powerUi.componentsManager,t=e.bars.filter(e=>!0===e.bar.isFixed);for(const e of t)e.bar.ignore||"top"!==e.bar.barPosition?e.bar.ignore&&"top"===e.bar.barPosition?this.ignoreTop=this.ignoreTop+e.bar.element.offsetHeight:e.bar.ignore||"bottom"!==e.bar.barPosition?e.bar.ignore&&"bottom"===e.bar.barPosition?this.ignoreBottom=this.ignoreBottom+e.bar.element.offsetHeight:e.bar.ignore&&"right"===e.bar.barPosition?this.respectRight=this.respectRight+e.bar.element.offsetWidth:e.bar.ignore||"left"!==e.bar.barPosition?e.bar.ignore&&"left"===e.bar.barPosition&&(this.ignoreLeft=this.ignoreLeft+e.bar.element.offsetWidth):this.respectLeft=this.respectLeft+e.bar.element.offsetWidth:this.respectBottom=this.respectBottom+e.bar.element.offsetHeight:this.respectTop=this.respectTop+e.bar.element.offsetHeight;if(this.isMaximized&&!e.smallWindowMode||!this.isMaximized&&e.smallWindowMode){const t=document.getElementById("app-container");this._dialog.style.left=t.offsetLeft-this.ignoreLeft+"px",this._dialog.style.width=t.offsetWidth+this.respectRight+this.ignoreLeft+"px",this._dialog.style["padding-left"]=0,this._dialog.style["padding-right"]=0,this._dialog.offsetTop<this.respectTop&&(this._dialog.style["padding-top"]=0,this._dialog.style.top=this.respectTop+"px",this._dialog.style.height=window.innerHeight-this.respectTop+"px",this.bodyEl.style.height=window.innerHeight-this.respectTop-this.titleBarEl.offsetHeight+"px"),this.respectBottom&&(this._dialog.style.height=window.innerHeight-e.totalHeight+"px",this.bodyEl.style.height=window.innerHeight-this.respectTop-this.respectBottom-this.titleBarEl.offsetHeight+"px",this._dialog.style["padding-bottom"]=0)}else this._dialog.style["padding-top"]=this.defaultBorderSize+"px",this._dialog.style["padding-bottom"]=this.defaultBorderSize+"px",this._dialog.style["padding-left"]=this.defaultBorderSize+"px",this._dialog.style["padding-right"]=this.defaultBorderSize+"px"}_onRemoveCtrl(){delete this.zIndex,this.saveWindowState(),this.removeWindowIsMaximizedFromBody(),this.$powerUi.onFixedPowerSplitBarChange.unsubscribe(this.onFixedPowerSplitBarChange,this)}_onRemoveView(){delete this.currentWindowQuery,delete this.currentBarBreakQuery,super._onRemoveView()}removeWindowIsMaximizedFromBody(){document.body&&document.body.classList&&document.body.classList.remove("window-is-maximized")}saveWindowState(){if(!this.dialogId)return;const e={width:this._width,height:this._height,top:this._top,left:this._left,zIndex:this.zIndex,isMaximized:this.isMaximized};sessionStorage.setItem(this.dialogId,JSON.stringify(e))}loadWindowState(){let e=sessionStorage.getItem(this.dialogId);e&&(e=JSON.parse(e),this._width=e.width,this._height=e.height,this._top=e.top,this._left=e.left,this.zIndex=e.zIndex||this.zIndex,this._dialog.style.zIndex=this.zIndex,this.isMaximized=e.isMaximized||this.isMaximized)}addOnMouseBorderEvents(){this._dialog.onmousemove=this.onMouseMoveBorder.bind(this),this._dialog.onmouseout=this.onMouseOutBorder.bind(this),this._dialog.onmousedown=this.onMouseDownBorder.bind(this)}onMouseMoveBorder(e){if(e.target!==e.currentTarget||this.$powerUi._mouseIsDown||this.$powerUi._dragging)return;e.preventDefault();const t=this.$root?"root-view":this._viewId;this.removeAllCursorClasses(),this.cursorPositionOnWindowBound(e),"top-left"===this._dialog.cursor||"bottom-right"===this._dialog.cursor?this.$powerUi.addCss(t,"window-left-top"):"top-right"===this._dialog.cursor||"bottom-left"===this._dialog.cursor?this.$powerUi.addCss(t,"window-left-bottom"):"top"===this._dialog.cursor||"bottom"===this._dialog.cursor?this.$powerUi.addCss(t,"window-height"):this.$powerUi.addCss(t,"window-width")}cursorPositionOnWindowBound(e){const t=this._dialog.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top,o=this._dialog.offsetWidth,n=this._dialog.offsetHeight;i<=15&&s<=15?this._dialog.cursor="top-left":i<=15&&s>15&&s>=n-15?this._dialog.cursor="bottom-left":i>=o-15&&s<=15?this._dialog.cursor="top-right":i>=o-15&&s>=n-15?this._dialog.cursor="bottom-right":s>15&&s<=n-15&&i<15?this._dialog.cursor="left":s>15&&s<=n-15&&i>=o-15?this._dialog.cursor="right":s<15&&i>15&&i<=o-15?this._dialog.cursor="top":s>=n-15&&i>15&&i<=o-15&&(this._dialog.cursor="bottom")}onMouseOutBorder(){this.$powerUi._mouseIsDown||this.removeAllCursorClasses()}onMouseDownBorder(e){this.setWindowsOrder(!0),e.target===e.currentTarget&&(window.addEventListener("mousemove",this._changeWindowSize),window.addEventListener("mouseup",this._onMouseUp),e.preventDefault(),this.isMaximized&&(this._height=window.innerHeight-(this.defaultBorderSize+this.defaultBorderSize),this._width=window.innerWidth-(this.defaultBorderSize+this.defaultBorderSize),this._top=this.defaultBorderSize,this._left=this.defaultBorderSize,this.setAllWindowElements(),this.restore()),this.$powerUi._mouseIsDown=!0,this.allowResize=!0,this._initialX=e.clientX,this._initialY=e.clientY,this._initialLeft=this._left,this._initialTop=this._top,this._initialOffsetWidth=this._dialog.offsetWidth,this._initialOffsetHeight=this._dialog.offsetHeight)}changeWindowSize(e){if(e.preventDefault(),this.allowResize){const t=this._dialog.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top;"right"===this._dialog.cursor?this.resizeRightBorder(i):"left"===this._dialog.cursor?this.resizeLeftBorder(i):"top"===this._dialog.cursor?this.resizeTopBorder(s):"bottom"===this._dialog.cursor?this.resizeBottomBorder(s):"top-right"===this._dialog.cursor?(this.resizeTopBorder(s),this.resizeRightBorder(i)):"top-left"===this._dialog.cursor?(this.resizeTopBorder(s),this.resizeLeftBorder(i)):"bottom-right"===this._dialog.cursor?(this.resizeBottomBorder(s),this.resizeRightBorder(i)):"bottom-left"===this._dialog.cursor&&(this.resizeBottomBorder(s),this.resizeLeftBorder(i)),this.avoidExceedingLimits(),this.setAllWindowElements(),this.onPowerWindowResize.broadcast()}}topLeftLimits(e,t){this._left<t&&(this._left=t),this._top<e&&(this._top=e)}avoidExceedingLimits(){const e=this.minTop(),t=this.maxBottom(),i=this.minLeft(),s=this.maxRight();let o=0,n=0;this._width<this._minWidth&&(o=this._width-this._minWidth,this._width=this._minWidth),this._height<this._minHeight&&(n=this._height-this._minHeight,this._height=this._minHeight),this.topLeftLimits(e,i),this._width===this._minWidth&&this._dialog.cursor.includes("left")?this._left=this._left+o:this._left<=i&&this._lastWidth<this._width&&this._dialog.cursor.includes("left")&&(this._width=this._lastWidth),this._height===this._minHeight&&this._dialog.cursor.includes("top")?this._top=this._top+n:this._top<=e&&this._lastHeight<this._height&&this._dialog.cursor.includes("top")&&(this._height=this._lastHeight),this._left+this._width+s+(this.defaultBorderSize+this.defaultBorderSize)>window.innerWidth&&(this._width=window.innerWidth-this._left-s-(this.defaultBorderSize+this.defaultBorderSize)),this._top+this._height+t+(this.defaultBorderSize+this.defaultBorderSize)>window.innerHeight&&(this._height=window.innerHeight-this._top-t-(this.defaultBorderSize+this.defaultBorderSize)),this.topLeftLimits(e,i),this._lastHeight=this._height,this._lastWidth=this._width,this._lastTop=this._top,this._lastLeft=this._left}browserWindowResize(){this.isMaximized?this.maximize():this.restore()}orientationChange(){this.browserWindowResize(),this.powerWindowStateChange.broadcast()}_maximizeDialog(){this._dialog.style.top=-this.defaultBorderSize+"px",this._dialog.style.left=-this.defaultBorderSize+"px",this._dialog.style.height=window.innerHeight+"px",this._dialog.style.width=window.innerWidth+"px",this.bodyEl.style.height=window.innerHeight-this.titleBarEl.offsetHeight+"px"}maximize(e,t){e&&e.preventDefault(),this._maximizeDialog(),this.maximizeBt.style.display="none",this.restoreBt.style.display="block",this.isMaximized=!0,this.saveWindowState(),document.body&&document.body.classList&&document.body.classList.add("window-is-maximized"),this.adjustWindowWithComponents(),this.replaceSizeQueries(),this.changeWindowBars(),this.refreshWindowToolbars(),t||(this.powerWindowStateChange.broadcast(),this.$powerUi.onPowerWindowChange.broadcast()),this.$powerUi.componentsManager.restartObserver(),this.replaceSizeQueries(),this.onPowerWindowResize.broadcast()}restore(e,t){e&&e.preventDefault(),this.maximizeBt.style.display="block",this.restoreBt.style.display="none",this.$powerUi.componentsManager.smallWindowMode?this._maximizeDialog():(this._dialog.style.top=this._top+"px",this._dialog.style.left=this._left+"px",this._dialog.style.height=this._height+"px",this._dialog.style.width=this._width+"px",this.bodyEl.style.height=this._height-this.titleBarEl.offsetHeight+"px"),this.isMaximized=!1,this.saveWindowState(),this.removeWindowIsMaximizedFromBody(),this.adjustWindowWithComponents(),this.replaceSizeQueries(),this.changeWindowBars(),this.refreshWindowToolbars(),t||(this.powerWindowStateChange.broadcast(),this.$powerUi.onPowerWindowChange.broadcast()),this.$powerUi.componentsManager.restartObserver(),this.replaceSizeQueries(),this.onPowerWindowResize.broadcast()}setBorderSizes(){this._top=this._top-this.defaultBorderSize,this._left=this._left-this.defaultBorderSize,this._width=this._width-this.defaultBorderSize,this._height=this._height-this.defaultBorderSize}setAllWindowElements(){this._dialog.style.width=this._width+"px",this._dialog.style.height=this._height+"px",this.bodyEl.style.height=this._height-this.titleBarEl.offsetHeight+"px",this._dialog.style.left=this._left+"px",this._dialog.style.top=this._top+"px",this.replaceSizeQueries(),this.saveWindowState(),this.changeWindowBars(),this.refreshWindowToolbars()}replaceSizeQueries(){this.replaceWindowSizeQuery(),this.replaceBarBreakQuery()}resizeRightBorder(e){this._width=this._initialOffsetWidth+this._initialLeft+(e-this._initialX)-10}resizeLeftBorder(e){const t=e-this._initialX;this._left=this._initialLeft+this._left+t,this._width=this._width-(this._initialLeft+t)}resizeTopBorder(e){const t=e-this._initialY;this._top=this._initialTop+this._top+t,this._height=this._height-(this._initialTop+t)}resizeBottomBorder(e){this._height=this._initialOffsetHeight+this._initialTop+(e-this._initialY)-10}onMouseUp(){this._dialog.classList.add("pw-active"),this.allowResize=!1,this.$powerUi._mouseIsDown=!1,this.removeAllCursorClasses(),window.removeEventListener("mousemove",this._changeWindowSize),window.removeEventListener("mouseup",this._onMouseUp),this.onResize&&this.onResize()}removeAllCursorClasses(){const e=this.$root?"root-view":this._viewId;this.$powerUi.removeCss(e,"window-left-top"),this.$powerUi.removeCss(e,"window-left-bottom"),this.$powerUi.removeCss(e,"window-width"),this.$powerUi.removeCss(e,"window-height")}template({$title:e}){return this.$title=this.$title||e,`<div class="pw-window${this.$powerUi.touchdevice?" pw-touchdevice":""} pw-dialog-container">\n\t\t\t\t\t${super.template({$title:e})}\n\t\t\t\t</div>`}replaceWindowSizeQuery(){let e=this.currentWindowQuery,t=this.bodyEl.offsetWidth;e=t<=600?"pw-wsize-tinny":t>=601&&t<=900?"pw-wsize-small":t>=901&&t<=1200?"pw-wsize-medium":t>=1201&&t<=1500?"pw-wsize-large":"pw-wsize-extra-large",this.removeWindowQueries(),this._dialog.classList.add(e),this.currentWindowQuery=e}removeWindowQueries(){this._dialog.classList.remove("pw-wsize-tinny"),this._dialog.classList.remove("pw-wsize-small"),this._dialog.classList.remove("pw-wsize-medium"),this._dialog.classList.remove("pw-wsize-large"),this._dialog.classList.remove("pw-wsize-extra-large")}replaceBarBreakQuery(){let e=this.currentBarBreakQuery,t=this._width;this.isMaximized&&(t=this._dialog.offsetWidth),e=!!(t<=768||this.$powerUi.componentsManager.smallWindowMode)&&"pw-bar-break",this.removeBarBreakQuery(),e&&this._dialog.classList.add(e),this.currentBarBreakQuery=e,this.powerWindowModeChange.broadcast()}removeBarBreakQuery(){this._dialog.classList.remove("pw-bar-break")}addDragWindow(){this.pos1=0,this.pos2=0,this.pos3=0,this.pos4=0;const e=this.currentView.getElementsByClassName("pw-title-bar")[0];e?(e.onmousedown=this.dragMouseDown.bind(this),e.ondblclick=this.onDoubleClickTitle.bind(this)):this._dialog.onmousedown=this.dragMouseDown.bind(this)}onDoubleClickTitle(e){e.preventDefault(),this.isMaximized?this.restore(e):this.maximize(e)}dragMouseDown(e){(e=e||window.event).preventDefault(),this.isMaximized||this.$powerUi.componentsManager.smallWindowMode?this._dialog.classList.add("pw-active"):(this.$powerUi._dragging=!0,this.pos3=e.clientX,this.pos4=e.clientY,this._elementDrag=this.elementDrag.bind(this),this._endDragWindow=this.endDragWindow.bind(this),window.addEventListener("mousemove",this._elementDrag),window.addEventListener("mouseup",this._endDragWindow))}elementDrag(e){(e=e||window.event).preventDefault(),this.pos1=this.pos3-e.clientX,this.pos2=this.pos4-e.clientY,this.pos3=e.clientX,this.pos4=e.clientY,this._top=this._dialog.offsetTop-this.pos2,this._left=this._dialog.offsetLeft-this.pos1,this.avoidDragOutOfScreen(),this._dialog.style.top=this._top+"px",this._dialog.style.left=this._left+"px",this._top=this._dialog.offsetTop,this._left=this._dialog.offsetLeft,this.changeWindowBars()}minTop(){let e=0;for(const t of this.fixedBars.top)e+=t.offsetHeight;return e}maxBottom(){let e=0;for(const t of this.fixedBars.bottom)e+=t.offsetHeight;return e}minLeft(){let e=0;for(const t of this.fixedBars.left)e+=t.offsetWidth;return e}maxRight(){let e=0;for(const t of this.fixedBars.right)e+=t.offsetWidth;return e}avoidDragOutOfScreen(){const e=this.minTop(),t=this.maxBottom(),i=this.minLeft(),s=this.maxRight();this._top+this._height+10>window.innerHeight-t&&(this._top=window.innerHeight-(this._height+t)-10),this._top<e&&(this._top=e),this._left+this._width+10>=window.innerWidth-s&&(this._left=window.innerWidth-(this._width+s)-10),this._left<i&&(this._left=i)}endDragWindow(){this._dialog.classList.add("pw-active"),this._bodyHeight=window.getComputedStyle(this.bodyEl).height,window.removeEventListener("mouseup",this._endDragWindow),window.removeEventListener("mousemove",this._elementDrag),this.$powerUi._dragging=!1,this.$powerUi._mouseIsDown=!1,this.saveWindowState()}setWindowsOrder(e){this.$powerUi.dialogs=this.$powerUi.dialogs.filter(e=>e.id!==this.dialogId);let t=1999;for(const e of this.$powerUi.dialogs)t+=1,e.ctrl.zIndex=t,e.ctrl._dialog.style.zIndex=t,e.ctrl._dialog.classList.remove("pw-active"),e.ctrl.isWindow&&e.ctrl.saveWindowState&&e.ctrl.saveWindowState();this.zIndex=t+1,this._dialog.style.zIndex=this.zIndex,this.$powerUi.dialogs.push({id:this.dialogId,ctrl:this}),!e||this.isMaximized||this.$powerUi.componentsManager.smallWindowMode?this._dialog.classList.add("pw-active"):this._dialog.classList.remove("pw-active"),this.saveWindowState()}reorderDialogsList(){this.$powerUi.reorder=!1,this.$powerUi.dialogs.length<=1||this.$powerUi.dialogs.sort((function(e,t){return e.ctrl.zIndex>t.ctrl.zIndex?1:-1}))}}class PowerWindowIframe extends PowerWindow{constructor({$powerUi:e,promise:t=!0}){super({$powerUi:e,noEsc:!0,promise:t}),this.isWindow=!0}_onViewLoad(e){this.iframe=e.getElementsByTagName("iframe")[0],this.coverIframe=e.getElementsByClassName("pw-cover-iframe")[0],super._onViewLoad(e)}maximize(e){e&&e.preventDefault(),this._dialog.classList.add("pw-active"),super.maximize(e),this.resizeIframeAndCover()}restore(e){e&&e.preventDefault(),this.$powerUi.componentsManager.smallWindowMode&&this._dialog.classList.add("pw-active"),super.restore(e),this.resizeIframeAndCover()}resizeIframeAndCover(){this.iframe.style.height=this._currentHeight-this.titleBarEl.offsetHeight+"px",this.coverIframe.style.height=this.iframe.style.height,this.coverIframe.style.width=this._currentWidth+"px",this.coverIframe.style.top=this.titleBarEl.offsetHeight+this.defaultBorderSize+"px"}setAllWindowElements(){super.setAllWindowElements(),this.resizeIframeAndCover()}template({$title:e,$url:t}){this.$title=this.$title||e;const i=`iframe_${this.$powerUi._Unique.next()}`;return`<div class="pw-window${this.$powerUi.touchdevice?" pw-touchdevice":""} pw-dialog-container">\n\t\t\t\t\t<div class="pw-title-bar">\n\t\t\t\t\t\t<span class="pw-title-bar-label">${this.$title}</span>\n\t\t\t\t\t\t<div data-pow-event onmousedown="_cancel()" class="pw-bt-dialog-title pw-icon icon-cancel-black"></div>\n\t\t\t\t\t\t${this.restoreBt?'<div style="display:none;" data-pow-event onclick="restore(event)" class="pw-bt-dialog-title pw-icon icon-windows"></div>':""}\n\t\t\t\t\t\t${this.maximizeBt?'<div data-pow-event onclick="maximize(event)" class="pw-bt-dialog-title pw-icon icon-maximize"></div>':""}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="pw-body pw-body-iframe">\n\t\t\t\t\t\t<iframe frameBorder="0" name="${i}" id="${i}" data-pw-content src="${t}"></iframe>\n\t\t\t\t\t\t<div class="pw-cover-iframe" data-pow-event onmousedown="dragMouseDown()"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>`}$buildTemplate({template:e,title:t}){return this.template({$title:t||null,$url:e})}}export{PowerWindow,PowerWindowIframe};class _PowerBarsBase extends PowerTarget{constructor(e,t){super(e),this.$powerUi=t,this._$pwActive=!1,this.isBar=!0,this.order=0,this.id=this.element.getAttribute("id"),this.priority=this.element.getAttribute("data-pw-priority"),this.priority=this.priority?parseInt(this.priority):null,this.element.classList.contains("pw-bar-window-fixed")?(this.isWindowFixed=!0,this.isFixed=!1):this.element.classList.contains("pw-bar-fixed")?this.isFixed=!0:this.isFixed=!1,this.element.classList.contains("pw-top")?this.barPosition="top":this.element.classList.contains("pw-bottom")?this.barPosition="bottom":this.element.classList.contains("pw-left")?this.barPosition="left":this.element.classList.contains("pw-right")&&(this.barPosition="right"),this.element.classList.contains("pw-ignore")&&(this.ignore=!0),this.$powerUi.componentsManager.bars.push({id:this.id,bar:this}),(this.isFixed||this.isWindowFixed)&&this.$powerUi.componentsManager.observe(this)}onRemove(){this.$powerUi.componentsManager.bars=this.$powerUi.componentsManager.bars.filter(e=>e.id!==this.id),(this.isFixed||this.isWindowFixed)&&this.$powerUi.componentsManager.stopObserve(this.element)}init(){}}class AccordionModel{constructor(e){this.ctx=e,this.multipleSectionsOpen="true"===e.element.getAttribute("data-multiple-sections-open")}}class AccordionSectionModel{constructor(e){this.ctx=e,this.active=!1}}class AccordionSectionHtmlCtrl{constructor(e){this.ctx=e}toggle(){if(!this.ctx.powerAccordion.model.multipleSectionsOpen)for(const e of Object.keys(this.ctx.powerAccordion.childrenActions||{})){const t=this.ctx.powerAccordion.childrenActions[e];t.targetObj.id!==this.ctx.powerAccordion.id&&t._$pwActive&&this.ctx!==t.targetObj&&(t.toggle({avoidCallAction:!0}),t.targetObj.model.active=!t.targetObj.model.active)}}}class PowerAccordion extends PowerTarget{constructor(e){super(e),this.model=new AccordionModel(this)}init(){this.childrenSections=this.getChildrenByPowerCss("powerAccordionSection"),this.childrenActions=this.getChildrenByPowerCss("powerAction")}}PowerUi.injectPowerCss({name:"power-accordion"});class PowerAccordionSection extends PowerTarget{constructor(e){super(e),this.model=new AccordionSectionModel(this),this.ctrl="htmlCtrl"}init(){this.htmlCtrl=new AccordionSectionHtmlCtrl(this);let e=this.parent;do{"powerAccordion"===e.$powerCss?this.powerAccordion=e:e=e.parent}while(e&&"powerAccordion"!==e.$powerCss)}action(){this[this.ctrl].toggle()}}PowerUi.injectPowerCss({name:"power-accordion-section"});class PowerList extends PowerTarget{constructor(e){if(super(e),this._target=this.element.dataset.powerTarget,!this._target)throw console.error("power-action/power-list/power-toggle selectors needs a power element target",this.element),'Missing power-action/power-list/power-toggle target. Please define it: data-power-target="power_element_id"'}init(){const e=this.$powerUi.powerTree.allPowerObjsById[this._target];for(const t in e)e[t].powerTarget&&(this.targetObj=e[t]);this.subscribe({event:"click",fn:this.toggle})}toggle(){this._$pwActive?(this._$pwActive=!1,this.targetObj._$pwActive=!1,this.targetObj.element.classList.remove("power-active"),this.element.classList.remove("power-active")):(this._$pwActive=!0,this.targetObj._$pwActive=!0,this.targetObj.element.classList.add("power-active"),this.element.classList.add("power-active")),this.broadcast("toggle",!0)}}PowerUi.injectPowerCss({name:"power-list"});class PowerAction extends PowerList{constructor(e){super(e)}init(){super.init(),this.targetObj.powerAction=this}toggle(e={}){this.targetObj.action&&!e.avoidCallAction&&this.targetObj.action(),this._$pwActive?this.$pwMain.isBar&&this.$pwMain.order>0&&(this.$pwMain.order=this.$pwMain.order-1,0===this.$pwMain.order&&this.$pwMain.element.classList.remove("pw-order")):this.$pwMain.isBar&&(0===this.$pwMain.order&&this.$pwMain.element.classList.add("pw-order"),this.$pwMain.order=this.$pwMain.order+1),super.toggle()}ifClickOut(){this._$pwActive?document.removeEventListener("click",this._clickPowerItemOrOutside):(this._clickPowerItemOrOutside=this.clickPowerItemOrOutside.bind(this),document.addEventListener("click",this._clickPowerItemOrOutside))}clickPowerItemOrOutside(e){const t=document.getElementById(this.targetObj.id),i=document.getElementById(this.id);let s=e.target;if(s.classList.contains("power-status")||s.classList.contains("power-action")||s.classList.contains("power-list")||s.classList.contains("power-toggle")||!s.parentNode||!s.parentNode.classList||s.parentNode.classList.contains("power-status")||s.parentNode.classList.contains("power-action")||s.parentNode.classList.contains("power-list")||s.parentNode.classList.contains("power-toggle")){do{if(s===t||s===i)return;s=s.parentNode}while(s);this.toggle()}else this.toggle()}}PowerUi.injectPowerCss({name:"power-action"});class PowerToggle extends PowerAction{constructor(e){super(e)}}PowerUi.injectPowerCss({name:"power-toggle"});class PowerActionsBar extends _PowerBarsBase{constructor(e,t){super(e,t),this.defaultPosition=this.element.getAttribute("data-pw-position"),this.element.classList.contains("pw-horizontal")?this.orientation="horizontal":this.orientation="vertical"}onRemove(){super.onRemove();for(const e of this.childrenPowerActions)this.$powerUi.touchdevice||(e.unsubscribe({event:"click",fn:this.hoverModeOn,bar:this}),e.unsubscribe({event:"toggle",fn:this.maySetHoverModeOff,action:e,bar:this}))}init(){super.init(),this.childrenPowerActions=this.getChildrenByPowerCss("powerAction"),this.childrenPowerItems=this.getChildrenByPowerCss("powerItem"),this.innerPowerActionsWithoutChildren=this.getInnerWithoutChildrenByPowerCss("powerAction"),this.childrenPowerDropmenus=this.getChildrenByPowerCss("powerDropmenu"),this.innerPowerDropmenus=this.getInnerByPowerCss("powerDropmenu");for(const e of this.innerPowerDropmenus)e.isRootElement?defineRootDropmenusPosition(this,e):defineInnerDropmenusPosition(this,e);for(const e of this.childrenPowerActions)this.$powerUi.touchdevice||(e.subscribe({event:"click",fn:this.hoverModeOn,bar:this}),e.subscribe({event:"toggle",fn:this.maySetHoverModeOff,action:e,bar:this}))}hoverModeOn(e,t,i){if(i.bar.$powerUi.tmp.bar._mouseIsMovingTo)i.bar.$powerUi.tmp.bar._mouseIsMovingTo.id!==i.bar.id&&i.bar.moveOverPossibleNewTarget(i.action);else for(const e of i.bar.childrenPowerActions)e.subscribe({event:"mouseenter",fn:i.bar.onMouseEnterAction,action:e,bar:i.bar}),e.subscribe({event:"click",fn:i.bar.onMouseEnterAction,action:e,bar:i.bar})}onMouseEnterAction(e,t,i){if(i.bar.$powerUi.tmp.bar._mouseIsMovingTo)i.bar.$powerUi.tmp.bar._mouseIsMovingTo.id!==i.action.id&&i.bar.moveOverPossibleNewTarget(i.action);else if(!i.action._$pwActive){i.action.toggle(),i.bar.onMouseEnterItem(e,t,i,!0);for(const e of i.bar.childrenPowerItems)e.subscribe({event:"mouseenter",fn:i.bar.onMouseEnterItem,action:i.action,bar:i.bar,item:e});i.bar.startWatchMouseMove(e,t,i)}}onMouseEnterItem(e,t,i,s){if(this.$powerUi.tmp.bar._mouseIsMovingTo)this.$powerUi.tmp.bar._mouseIsMovingTo.id!==i.action.id&&i.bar.moveOverPossibleNewTarget(i.action);else{s||i.action._$pwActive&&i.action.toggle();for(const e of i.bar.innerPowerActionsWithoutChildren)e._$pwActive&&e.toggle();for(const e of i.bar.childrenPowerActions)e._$pwActive&&e.id!==i.action.id&&e.toggle();for(const e of i.bar.childrenPowerItems)e.unsubscribe({event:"mouseenter",fn:i.bar.onMouseEnterItem,action:i.action,bar:i.bar})}}maySetHoverModeOff(e,t,i){setTimeout((function(){let s=!1;for(const e of i.bar.childrenPowerActions)e._$pwActive&&(s=!0);!1===s?i.bar.hoverModeOff(e,t,i):i.bar.startWatchMouseMove(e,t,i)}),50)}hoverModeOff(e,t,i){i.bar.stopWatchMouseMove();for(const e of i.bar.childrenPowerActions)e.unsubscribe({event:"mouseenter",fn:i.bar.onMouseEnterAction,action:e,bar:i.bar}),e.unsubscribe({event:"click",fn:i.bar.onMouseEnterAction,action:e,bar:i.bar})}moveOverPossibleNewTarget(e){this.$powerUi.tmp.bar._possibleNewTarget=e}onmousestop(){if(this.$powerUi.tmp.bar._possibleNewTarget&&!this.$powerUi.tmp.bar._possibleNewTarget._$pwActive){const e=this.$powerUi.tmp.bar._possibleNewTarget;setTimeout((function(){e.broadcast("mouseenter")}),10),this.stopWatchMouseMove()}else this.$powerUi.tmp.bar._resetMouseTimeout()}resetMouseTimeout(){clearTimeout(this.$powerUi.tmp.bar.timeout),this.$powerUi.tmp.bar.timeout=setTimeout(this.$powerUi.tmp.bar._onmousestop,120)}startWatchMouseMove(e,t,i){this.$powerUi.tmp.bar._mouseIsMovingTo||(i.action.targetObj.subscribe({event:"mouseenter",fn:this.stopWatchMouseMove,action:i.action,bar:i.bar}),this.$powerUi.tmp.bar._mouseIsMovingTo=i.action.targetObj,this.$powerUi.tmp.bar._onmousestop=this.onmousestop.bind(this),this.$powerUi.tmp.bar._resetMouseTimeout=this.resetMouseTimeout.bind(this),this.$powerUi.tmp.bar.timeout=setTimeout(this.$powerUi.tmp.bar._onmousestop,300),document.addEventListener("mousemove",this.$powerUi.tmp.bar._resetMouseTimeout,!0))}stopWatchMouseMove(){this.$powerUi.tmp.bar._mouseIsMovingTo=!1,this.$powerUi.tmp.bar._possibleNewTarget=!1,clearTimeout(this.$powerUi.tmp.bar.timeout),document.removeEventListener("mousemove",this.$powerUi.tmp.bar._resetMouseTimeout,!0),this.unsubscribe({event:"mouseenter",fn:this.stopWatchMouseMove})}toggle(){this.powerAction.ifClickOut()}action(){this.toggle()}}class PowerBrand extends PowerTarget{constructor(e){super(e),this.id=this.element.getAttribute("id")}}PowerUi.injectPowerCss({name:"power-brand"});class PowerDropmenu extends PowerTarget{constructor(e){super(e),this.defaultPosition=this.element.getAttribute("data-pw-position"),this._markRootAndMenuDropmenu()}init(){if(this.childrenPowerActions=this.getChildrenByPowerCss("powerAction"),this.innerPowerActionsWithoutChildren=this.getInnerWithoutChildrenByPowerCss("powerAction"),this.childrenPowerItems=this.getChildrenByPowerCss("powerItem"),this.innerPowerItemsWithoutChildren=this.getInnerWithoutChildrenByPowerCss("powerItem"),this.innerPowerDropmenus=this.getInnerByPowerCss("powerDropmenu"),this.isRootElement&&!this.isMenuElement){defineRootDropmenusPosition(this,this);for(const e of this.innerPowerDropmenus)defineInnerDropmenusPosition(this,e)}}_markRootAndMenuDropmenu(){const e=PowerTree._searchUpDOM(this.element,PowerTree._checkIfhavePowerParentElement);e.conditionResult?(e.powerElement.className.includes("power-dropmenu")?this.isRootElement=!1:this.isRootElement=!0,e.powerElement.className.includes("pw-bar")&&(this.isMenuElement=!0)):this.isRootElement=!0}hoverModeOn(){if(this.$powerUi.tmp.dropmenu._mouseIsMovingTo)this.$powerUi.tmp.dropmenu._mouseIsMovingTo.id!==this.id&&this.moveOverPossibleNewTarget(this);else for(const e of this.childrenPowerActions)e.subscribe({event:"mouseenter",fn:this.onMouseEnterAction,action:e,dropmenu:this}),e.subscribe({event:"click",fn:this.onMouseEnterAction,action:e,dropmenu:this})}onMouseEnterAction(e,t,i){if(this.$powerUi.tmp.dropmenu._mouseIsMovingTo)this.$powerUi.tmp.dropmenu._mouseIsMovingTo.id!==i.dropmenu.id&&i.dropmenu.moveOverPossibleNewTarget(this);else if(!i.action._$pwActive){i.action.toggle(),i.dropmenu.onMouseEnterItem(e,t,i,!0);for(const e of i.dropmenu.childrenPowerItems)e.subscribe({event:"mouseenter",fn:i.dropmenu.onMouseEnterItem,action:i.action,dropmenu:i.dropmenu,item:e});i.dropmenu.startWatchMouseMove(e,t,i)}}onMouseEnterItem(e,t,i,s){if(this.$powerUi.tmp.dropmenu._mouseIsMovingTo)this.$powerUi.tmp.dropmenu._mouseIsMovingTo.id!==i.dropmenu.id&&i.dropmenu.moveOverPossibleNewTarget(i.item);else{s||i.action._$pwActive&&i.action.toggle();for(const e of i.dropmenu.innerPowerActionsWithoutChildren)e._$pwActive&&e.toggle();for(const e of i.dropmenu.childrenPowerActions)e._$pwActive&&e.id!==i.action.id&&e.toggle();for(const e of i.dropmenu.childrenPowerItems)e.unsubscribe({event:"mouseenter",fn:i.dropmenu.onMouseEnterItem,action:i.action,dropmenu:i.dropmenu})}}hoverModeOff(){this.stopWatchMouseMove();for(const e of this.childrenPowerActions)e.unsubscribe({event:"mouseenter",fn:this.onMouseEnterAction,action:e,dropmenu:this}),e.unsubscribe({event:"click",fn:this.onMouseEnterAction,action:e,dropmenu:this})}moveOverPossibleNewTarget(e){this.$powerUi.tmp.dropmenu._possibleNewTarget=e}onmousestop(){if(this.$powerUi.tmp.dropmenu._possibleNewTarget&&!this.$powerUi.tmp.dropmenu._possibleNewTarget._$pwActive){const e=this.$powerUi.tmp.dropmenu._possibleNewTarget;setTimeout((function(){e.broadcast("mouseenter")}),10),this.stopWatchMouseMove()}else this.$powerUi.tmp.dropmenu._resetMouseTimeout()}resetMouseTimeout(){clearTimeout(this.$powerUi.tmp.dropmenu.timeout),this.$powerUi.tmp.dropmenu.timeout=setTimeout(this.$powerUi.tmp.dropmenu._onmousestop,120)}startWatchMouseMove(e,t,i){this.$powerUi.tmp.dropmenu._mouseIsMovingTo||(i.action.targetObj.subscribe({event:"mouseenter",fn:this.stopWatchMouseMove,action:i.action,dropmenu:i.dropmenu}),this.$powerUi.tmp.dropmenu._mouseIsMovingTo=i.action.targetObj,this.$powerUi.tmp.dropmenu._onmousestop=this.onmousestop.bind(this),this.$powerUi.tmp.dropmenu._resetMouseTimeout=this.resetMouseTimeout.bind(this),this.$powerUi.tmp.dropmenu.timeout=setTimeout(this.$powerUi.tmp.dropmenu._onmousestop,300),document.addEventListener("mousemove",this.$powerUi.tmp.dropmenu._resetMouseTimeout,!0))}stopWatchMouseMove(){this.$powerUi.tmp.dropmenu._mouseIsMovingTo=!1,this.$powerUi.tmp.dropmenu._possibleNewTarget=!1,clearTimeout(this.$powerUi.tmp.dropmenu.timeout),document.removeEventListener("mousemove",this.$powerUi.tmp.dropmenu._resetMouseTimeout,!0),this.unsubscribe({event:"mouseenter",fn:this.stopWatchMouseMove})}setPositionRightBottom(e){this.element.style.left=this.powerAction.element.offsetLeft+this.powerAction.element.offsetWidth+"px",this.element.style.top=this.powerAction.element.offsetTop+"px"}setPositionBottomRight(e){this.element.style.top=this.powerAction.element.offsetTop+this.powerAction.element.offsetHeight+"px",this.element.style.left=this.powerAction.element.offsetLeft+"px"}setPositionLeftBottom(e){this.element.style.left=this.powerAction.element.offsetLeft-this.element.offsetWidth+"px",this.element.style.top=this.powerAction.element.offsetTop+"px"}setPositionBottomLeft(e){const t=this.powerAction.element.offsetWidth-this.element.offsetWidth;this.element.style.left=this.powerAction.element.offsetLeft+t+"px"}setPositionRightTop(e){this.element.style.left=this.powerAction.element.offsetLeft+this.powerAction.element.offsetWidth+"px",this.element.style.top=this.powerAction.element.offsetTop-(this.element.offsetHeight-this.powerAction.element.offsetHeight)+"px"}setPositionTopRight(e){this.element.style.left=this.powerAction.element.offsetLeft+"px",this.element.style.top=this.powerAction.element.offsetTop-this.element.offsetHeight+"px"}setPositionLeftTop(e){this.element.style.left=this.powerAction.element.offsetLeft-this.element.offsetWidth+"px",this.element.style.top=this.powerAction.element.offsetTop-(this.element.offsetHeight-this.powerAction.element.offsetHeight)+"px"}setPositionTopLeft(e){const t=this.powerAction.element.offsetWidth-this.element.offsetWidth;this.element.style.left=this.powerAction.element.offsetLeft+t+"px",this.element.style.top=this.powerAction.element.offsetTop-this.element.offsetHeight+"px"}ifPositionOutOfScreenChangeDirection(){let e=!1;const t=this.element.getBoundingClientRect(),i={topDown:this.defaultPosition.includes("bottom")?"bottom":"top",leftRight:this.defaultPosition.includes("right")?"right":"left"},s={topDown:0,leftRight:0};t.right>document.defaultView.innerWidth?(i.leftRight="left",s.leftRight++,e=!0):t.left<0&&(i.leftRight="right",s.leftRight++,e=!0),t.bottom>document.defaultView.innerHeight?(i.topDown="top",s.topDown++,e=!0):t.top<0&&(i.topDown="bottom",s.topDown++,e=!0),(s.topDown>0||s.leftRight>0)&&("top"===i.topDown?"left"===i.leftRight?this.setPositionLeftTop():this.setPositionRightTop():"left"===i.leftRight?this.setPositionLeftBottom():this.setPositionRightBottom(),this.setPositionLimits()),e&&this.fixPositionIfInsideFixedElement()}setPositionLimits(){const e=this.element.getBoundingClientRect();e.left<0&&(this.element.style.left="0px"),e.top<0&&(this.element.style.top="0px")}resetDropmenuPosition(){this.element.style.top=null,this.element.style.left=null}toggle(){this.resetDropmenuPosition(),this.element.classList.add("power-hide");const e=this;this._$pwActive?this.$powerUi.touchdevice||this.hoverModeOff():(setTimeout((function(){"bottom-right"===e.defaultPosition?e.setPositionBottomRight():"right-bottom"===e.defaultPosition?e.setPositionRightBottom():"bottom-left"===e.defaultPosition?e.setPositionBottomLeft():"left-bottom"===e.defaultPosition?e.setPositionLeftBottom():"top-right"===e.defaultPosition?e.setPositionTopRight():"right-top"===e.defaultPosition?e.setPositionRightTop():"left-top"===e.defaultPosition?e.setPositionLeftTop():"top-left"===e.defaultPosition?e.setPositionTopLeft():e.setPositionRightBottom(),"fixed"===window.getComputedStyle(e.powerAction.element).position&&(e.element.style.position="fixed",e.element.style.left=window.getComputedStyle(e.powerAction.element).left),e.fixPositionIfInsideFixedElement(),e.ifPositionOutOfScreenChangeDirection(),e.element.classList.remove("power-hide")}),50),this.$powerUi.touchdevice||this.hoverModeOn()),this.powerAction.ifClickOut(),this.broadcast("toggle",!0)}action(){this.toggle()}fixPositionIfInsideFixedElement(){const e=this;let t=0,i=0,s=!1;if(PowerTree._searchUpDOM(e.element,(function(e){return e.classList.contains("power-dropmenu")?(s=!0,!0):(t+=e.scrollTop,i+=e.scrollLeft,"fixed"===window.getComputedStyle(e).getPropertyValue("position")||"app-container"===e.id||void 0)})).conditionResult&&!s){if(t>0){const i=parseInt(window.getComputedStyle(e.element).top.replace("px","")||0);e.element.style.top=i-t+"px"}if(i>0){const t=parseInt(window.getComputedStyle(e.element).left.replace("px","")||0);e.element.style.left=t-i+"px"}}}}PowerUi.injectPowerCss({name:"power-dropmenu"});class PowerItem extends PowerTarget{constructor(e){super(e)}}PowerUi.injectPowerCss({name:"power-item"});class PowerMain extends _PowerBasicElementWithEvents{constructor(e){super(e)}}PowerUi.injectPowerCss({name:"power-main",isMain:!0});class PowerMenu extends PowerActionsBar{constructor(e,t){super(e,t),this.isMenu=!0}onRemove(){super.onRemove()}init(){super.init()}}PowerUi.injectPowerCss({name:"power-menu",isMain:!0});class PowerSplitBar extends _PowerBarsBase{constructor(e,t){super(e,t),this.isSplitBar=!0,this.borderSize=5,this._currentHeight=null,this._currentWidth=null}onRemove(){this.unsubscribe({event:"click",fn:this.onClick,bar:this}),this.pwSplit&&(this.$powerUi.windowModeChange.unsubscribe(this.onWindowModeChange,this,this.id),this.unsubscribe({event:"click",fn:this.onClick,bar:this}),window.removeEventListener("mousemove",this._changeMenuSize),window.removeEventListener("mouseup",this._onMouseUp),this.$powerUi._mouseIsDown=!1,this.pwSplit&&(this.$powerUi.onBrowserWindowResize.unsubscribe(this.onBrowserWindowResize,this),this.isWindowFixed&&this._window&&(this._window.powerWindowModeChange.unsubscribe(this.onPowerWindowModeChange,this),this._window.onPowerWindowResize.unsubscribe(this.onPowerWindowResize,this)))),super.onRemove()}init(){super.init(),this.pwSplit=this.element.classList.contains("pw-split"),this.resizeRight=this.element.classList.contains("pw-left"),this.resizeLeft=this.element.classList.contains("pw-right"),this.resizeTop=this.element.classList.contains("pw-bottom"),this.resizeBottom=this.element.classList.contains("pw-top"),this.pwSplit&&(this._changeMenuSize=this.changeMenuSize.bind(this),this._onMouseUp=this.onMouseUp.bind(this),this.$powerUi.windowModeChange.subscribe(this.onWindowModeChange,this),this.$powerUi.onBrowserWindowResize.subscribe(this.onBrowserWindowResize,this),this.subscribe({event:"click",fn:this.onClick,bar:this}),this.setBorder(),this.addOnMouseBorderEvents())}broadcastFixedBarWhenSizeChange(){this.isFixed&&this.element&&this.$powerUi.onFixedPowerSplitBarChange.broadcast()}subscribeToOnPowerWindowResize(){this._window.onPowerWindowResize.subscribe(this.onPowerWindowResize,this)}subscribeToPowerWindowModeChange(){this._window.powerWindowModeChange.subscribe(this.onPowerWindowModeChange,this)}onPowerWindowModeChange(){this.element&&this._window&&("pw-bar-break"===this._window.currentBarBreakQuery?this.setSmallWindowModeSize():(this.removeStyles(),this.element.style.width=this._currentWidth,this.element.style.height=this._currentHeight))}onPowerWindowResize(){this.adjustBarSizeIfNeeded()}onBrowserWindowResize(){this.onPowerWindowModeChange(),this.adjustBarSizeIfNeeded()}onWindowModeChange(){this.element&&this._window&&(this.$powerUi.componentsManager.smallWindowMode?this.setSmallWindowModeSize():(this.removeStyles(),this.element.style.width=this._currentWidth,this.element.style.height=this._currentHeight))}setSmallWindowModeSize(e){this.removeStyles(e),"top"===this.barPosition?this.setTopColapsedMenuSize():"bottom"===this.barPosition?this.setBottomColapsedMenuSize():"left"===this.barPosition?this.setLeftColapsedMenuSize():"right"===this.barPosition&&this.setRightColapsedMenuSize()}setTopColapsedMenuSize(){if(this.isWindowFixed&&this._window){let e=this._window.bodyEl.offsetHeight+(this.element.offsetTop-this._window._dialog.offsetTop-this._window.defaultBorderSize-this._window.bodyEl.offsetTop+1)+this._window.titleBarEl.offsetHeight+this.element.offsetHeight;(this._window.isMaximized||this.$powerUi.componentsManager.smallWindowMode)&&(e-=this._window.defaultBorderSize),this.element.style["max-height"]=e+"px",this.element.style["min-width"]=this._currentWidth+"px"}}setBottomColapsedMenuSize(){if(this.isWindowFixed&&this._window){let e=this.element.offsetTop-this._window._dialog.offsetTop-this._window.defaultBorderSize-this._window.defaultBorderSize+1;this.element.style["max-height"]=e+"px",this.element.style["min-width"]=this._currentWidth+"px"}}setLeftColapsedMenuSize(){if(this.isWindowFixed&&this._window){const e=this._window.bodyEl.offsetHeight-this._window.defaultBorderSize-1,t=this.element.offsetLeft-this._window._dialog.offsetLeft-this._window.bodyEl.offsetLeft;let i=this._window.bodyEl.offsetWidth-t-this._window.defaultBorderSize-1;this.element.style.height=e+"px",this.element.style["min-height"]=e+"px",this.element.style["max-width"]=i+"px"}else this.element.style.height="100%",this.element.style["max-height"]="100%"}setRightColapsedMenuSize(){if(this.isWindowFixed&&this._window){const e=this._window.bodyEl.offsetHeight-this._window.defaultBorderSize-1,t=this._window._dialog.offsetLeft+this._window.bodyEl.offsetLeft-this.element.offsetLeft;let i=this.element.offsetWidth-t-this._window.defaultBorderSize-1;this.element.style.height=e+"px",this.element.style["min-height"]=e+"px",this.element.style["max-width"]=i+"px"}}onClick(e,t){t.$powerUi.componentsManager.runObserverFewTimes(10),setTimeout((function(){t.adjustBarSizeIfNeeded()}),50)}setBorder(){if(this.defaultBorderSize=this.element.getAttribute("data-pw-border"),this.defaultBorderSize){const e=this.resizeRight?"right":this.resizeLeft?"left":this.resizeTop?"top":this.resizeBottom?"bottom":null;this.borderSize=parseInt(this.defaultBorderSize),this.element.style[`border-${e}-width`]=this.defaultBorderSize+"px"}}cursorPositionOnMenuBound(e){const t=this.element.getBoundingClientRect();this.x=e.clientX-t.left,this.y=e.clientY-t.top,this.width=this.element.offsetWidth,this.height=this.element.offsetHeight,this.resizeRight?this.isOverRightBorder()?this.$powerUi.addCss(this.element.id,"cursor-width"):this.x<this.width-this.borderSize&&this.removeAllCursorClasses():this.resizeLeft?this.isOverLeftBorder()?this.$powerUi.addCss(this.element.id,"cursor-width"):this.x>this.borderSize&&this.removeAllCursorClasses():this.resizeBottom?this.isOverBottomBorder()?this.$powerUi.addCss(this.element.id,"cursor-height"):this.y<this.height-this.borderSize&&this.removeAllCursorClasses():this.resizeTop&&(this.isOverTopBorder()?this.$powerUi.addCss(this.element.id,"cursor-height"):this.y<=this.borderSize==!1&&this.removeAllCursorClasses())}removeAllCursorClasses(){this.$powerUi.removeCss(this.element.id,"cursor-width"),this.$powerUi.removeCss(this.element.id,"cursor-height")}addOnMouseBorderEvents(){this.element.onmouseout=this.onMouseOutBorder.bind(this),this.element.onmousemove=this.onMouseMoveBorder.bind(this),this.element.onmousedown=this.onMouseDownBorder.bind(this),this.element.ondblclick=this.onDoubleClickBorder.bind(this)}onDoubleClickBorder(e){e.preventDefault(),this.$powerUi.componentsManager.smallWindowMode||this._window&&this._window.isMaximized&&this.$powerUi.componentsManager.smallWindowMode||((this.isOverRightBorder()||this.isOverLeftBorder()||this.isOverBottomBorder()||this.isOverTopBorder())&&(this._currentHeight=null,this._currentWidth=null,this.removeStyles(),this.onMouseUp(e)),this.broadcastFixedBarWhenSizeChange(),this.adjustBarSizeIfNeeded(),this.isWindowFixed&&this._window&&this._window.changeWindowBars())}removeStyles(e){if(!this.element||window.innerWidth<768&&this.isFixed&&("top"===this.barPosition||"bottom"===this.barPosition))return this.element.style["max-height"]="50%",void(this.element.style.height=null);e||(this.element.style.width=null),this.element.style["min-width"]=null,this.element.style["max-width"]=null,(!this.isFixed||"left"!==this.barPosition&&"right"!==this.barPosition)&&(this.element.style.height=null,this.element.style["min-height"]=null,this.element.style["max-height"]=null)}onMouseOutBorder(e){this.removeAllCursorClasses()}onMouseMoveBorder(e){e.target!==e.currentTarget||this.$powerUi._mouseIsDown||this.$powerUi._dragging||window.innerWidth<768||this._window&&!1!==this._window.currentBarBreakQuery||(e.preventDefault(),this.cursorPositionOnMenuBound(e))}getBrowserWindowContext(){const e=this.$powerUi.componentsManager;return{_currentWidth:window.innerWidth,_currentHeight:window.innerHeight,rightTotalWidth:e.rightTotalWidth,bottomTotalHeight:e.bottomTotalHeight,leftTotalWidth:e.leftTotalWidth,topTotalHeight:e.topTotalHeight,defaultMinWidth:270,defaultMinHeight:170,defaultBorderSize:0}}getPowerWindowContext(){return{_currentWidth:this._window._currentWidth,_currentHeight:this._window._currentHeight,rightTotalWidth:this._window.rightTotalWidth-this._window._dialog.offsetLeft,bottomTotalHeight:this._window.bottomTotalHeight-(this._window._dialog.offsetTop-this._window.titleBarEl.offsetHeight),leftTotalWidth:this._window.leftTotalWidth+this._window._dialog.offsetLeft,topTotalHeight:this._window.topTotalHeight+this._window._dialog.offsetTop+this._window.bodyEl.offsetTop,defaultMinWidth:this._window.defaultMinWidth+20,defaultMinHeight:this._window.defaultMinHeight+this._window.defaultBorderSize+20,defaultBorderSize:this._window.defaultBorderSize+1}}setInitialValues(){this._initialLeft=this.element.offsetLeft,this._initialTop=this.element.offsetTop,this._initialOffsetWidth=this.element.offsetWidth,this._initialOffsetHeight=this.element.offsetHeight,this._initialRightTotalWidthDiff=this.ctx.rightTotalWidth-this._initialOffsetWidth,this._initialBottomTotalHeightDiff=this.ctx.bottomTotalHeight-this._initialOffsetHeight}onMouseDownBorder(e){e.target===e.currentTarget&&(e.preventDefault(),this.$powerUi._mouseIsDown=!0,window.addEventListener("mousemove",this._changeMenuSize),window.addEventListener("mouseup",this._onMouseUp),this.ctx=!0===this.isWindowFixed&&void 0!==this._window?this.getPowerWindowContext():this.getBrowserWindowContext(),this.allowResize=!0,this._initialX=e.clientX,this._initialY=e.clientY,this.setInitialValues(),this.resizeRight&&this.isOverRightBorder()&&(this.resizingRight=!0),this.resizeLeft&&this.isOverLeftBorder()&&(this.resizingLeft=!0),this.resizeBottom&&this.isOverBottomBorder()&&(this.resizingBottom=!0),this.resizeTop&&this.isOverTopBorder()&&(this.resizingTop=!0))}onMouseUp(e){this.resizingRight=!1,this.resizingLeft=!1,this.resizingBottom=!1,this.allowResize=!1,window.removeEventListener("mousemove",this._changeMenuSize),window.removeEventListener("mouseup",this._onMouseUp),this.$powerUi._mouseIsDown=!1,this.removeAllCursorClasses(),this.$powerUi.componentsManager.runObserver(),this.broadcastFixedBarWhenSizeChange()}changeMenuSize(e){if(!1===this.allowResize)return;this.ctx=!0===this.isWindowFixed&&void 0!==this._window?this.getPowerWindowContext():this.getBrowserWindowContext();const t=this.element.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top;this.resizingRight?this.resizeRightBorder(i):this.resizingLeft?this.resizeLeftBorder(i):this.resizingBottom?this.resizeBottomBorder(s):this.resizingTop&&this.resizeTopBorder(s),!0===this.isWindowFixed&&this.$powerUi.componentsManager.setWindowFixedBarsSizeAndPosition(this._window.windowBars,this._window)}adjustBarSizeIfNeeded(){if(this._window&&"pw-bar-break"===this._window.currentBarBreakQuery)return;if(this.$powerUi.componentsManager.smallWindowMode)return void this.removeStyles();this.ctx=!0===this.isWindowFixed&&void 0!==this._window?this.getPowerWindowContext():this.getBrowserWindowContext(),this.setInitialValues();let e=this.element.style.width;e&&(e=parseInt(e.replace("px","")));let t=this.element.style.height;if(t&&(t=parseInt(t.replace("px",""))),"top"===this.barPosition){if(!t&&this.topHeightIsTooBig(this.element.offsetHeight)&&(t=this.element.offsetHeight),!t||t<50)return;this.isWindowFixed&&(this._lastWindowHeight=this._window._currentHeight),this.setTopMenuSize(t),this.isWindowFixed&&this.element.offsetHeight>this._lastWindowHeight&&(this._currentHeight="50px",this.element.style.height=this._currentHeight)}else if("bottom"===this.barPosition){if(!t&&this.bottomHeightIsTooBig(this.element.offsetHeight)&&(t=this.element.offsetHeight),!t||t<50)return;this.setBottomMenuSize(t)}else if("left"===this.barPosition){if(this.isWindowFixed&&this._window&&(this.element.style.height=this._window.bodyEl.offsetHeight-this._window.defaultBorderSize-1+"px"),!e)return;this.setLeftMenuSize(e)}else if("right"===this.barPosition){if(this.isWindowFixed&&this._window&&(this.element.style.height=this._window.bodyEl.offsetHeight-this._window.defaultBorderSize-1+"px"),!e)return;this.setRightMenuSize(e)}}topHeightIsTooBig(e){let t=0;return this.isFixed&&(t=40),this.ctx._currentHeight-(this.ctx.defaultMinHeight+t)<this._initialTop+e+this.ctx.bottomTotalHeight}setTopMenuSize(e){let t=0;this.isFixed&&(t=40),this.topHeightIsTooBig(e)&&(e=this.ctx._currentHeight-this._initialTop-this.ctx.bottomTotalHeight-(this.ctx.defaultMinHeight+t)-this.ctx.defaultBorderSize),this._currentHeight=e+"px",this.element.style.height=this._currentHeight}bottomHeightIsTooBig(e){return e>this.ctx._currentHeight-(this._initialBottomTotalHeightDiff+this.ctx.topTotalHeight+this.ctx.defaultMinHeight)}setBottomMenuSize(e){let t=this.ctx._currentHeight-(this._initialBottomTotalHeightDiff+this.ctx.topTotalHeight+this.ctx.defaultMinHeight);t<0&&(t=-t),this.bottomHeightIsTooBig(e)&&(e=t),this._currentHeight=e+"px",this.element.style.height=this._currentHeight}setLeftMenuSize(e){e+this.element.offsetLeft>this.ctx._currentWidth-this.ctx.rightTotalWidth-this.ctx.defaultMinWidth&&(e=this.ctx._currentWidth-this.element.offsetLeft-this.ctx.rightTotalWidth-this.ctx.defaultMinWidth),this._currentWidth=e+"px",this.element.style.width=this._currentWidth}setRightMenuSize(e){this.ctx.leftTotalWidth+this.ctx.defaultMinWidth>this.ctx._currentWidth-e-this._initialRightTotalWidthDiff&&(e=this.ctx._currentWidth-this._initialRightTotalWidthDiff-this.ctx.leftTotalWidth-this.ctx.defaultMinWidth),this._currentWidth=e+"px",this.element.style.width=this._currentWidth}isOverRightBorder(){return this.y>0&&this.y<=this.height&&this.x>=this.width-this.borderSize&&this.x<this.width-this.borderSize==!1}resizeRightBorder(e){let t=this._initialOffsetWidth+this._initialLeft+(e-this._initialX)-10;this.setLeftMenuSize(t)}isOverLeftBorder(){return this.y>0&&this.y<=this.height-this.borderSize&&this.x<=this.borderSize==!0}resizeLeftBorder(e){let t=this.element.offsetWidth-e;this.setRightMenuSize(t)}isOverBottomBorder(){return this.y>=this.height-this.borderSize&&this.x>0&&this.x<=this.width}resizeBottomBorder(e){let t=this._initialOffsetHeight+this._initialTop+(e-this._initialY)-10;this.setTopMenuSize(t)}isOverTopBorder(){return this.y>0&&this.y<=this.borderSize&&this.x>0&&this.x<=this.width}resizeTopBorder(e){let t=this.element.offsetHeight-e;this.setBottomMenuSize(t)}toggle(){this.isWindowFixed&&this._window&&"pw-bar-break"===this._window.currentBarBreakQuery&&this.setSmallWindowModeSize(!0),this.powerAction.ifClickOut()}action(){this.toggle()}}PowerUi.injectPowerCss({name:"power-split-bar",isMain:!0});class PowerStatus extends PowerTarget{constructor(e){super(e);const t=this.element.getAttribute("data-power-active"),i=this.element.getAttribute("data-power-inactive");this.activeValues=t?t.split(" "):[],this.inactiveValues=i?i.split(" "):[],this.inactive()}active(){for(const e of this.activeValues)this.element.classList.add(e);for(const e of this.inactiveValues)this.element.classList.remove(e)}inactive(){for(const e of this.inactiveValues)this.element.classList.add(e);for(const e of this.activeValues)this.element.classList.remove(e)}toggle(){this._$pwActive=!this._$pwActive,this._$pwActive?this.active():this.inactive()}init(){let e=!1,t=this.element.parentElement;const i=this.$powerUi.powerTree.allPowerObjsById;for(;!e;){if(t)for(const e of Object.keys(i[t.id]||{}))i[t.id][e].powerTarget&&(this.targetObj=i[t.id][e]);this.targetObj||e?e=!0:t=t.parentElement}this.targetObj&&this.targetObj.subscribe({event:"toggle",fn:this.toggle.bind(this)})}}PowerUi.injectPowerCss({name:"power-status"});class PowerTabs extends PowerTarget{constructor(e){super(e)}init(){this.childrenSections=this.getChildrenByPowerCss("powerTabSection"),this.childrenActions=this.getChildrenByPowerCss("powerAction"),this.childrenActions[0].element.classList.add("power-active"),this.childrenSections[0].element.classList.add("power-active"),this.childrenActions[0]._$pwActive=!0,this.childrenSections[0]._$pwActive=!0}}PowerUi.injectPowerCss({name:"power-tabs"});class PowerTabSection extends PowerTarget{constructor(e){super(e)}init(){let e=this.parent;do{"powerTabs"===e.$powerCss?this.powerTabs=e:e=e.parent}while(e&&"powerTabs"!==e.$powerCss)}action(){if(!0===this._$pwActive)return this.powerAction._$pwActive=!1,void this.powerAction.broadcast("toggle",!0);for(const e of Object.keys(this.powerTabs.childrenActions||{})){const t=this.powerTabs.childrenActions[e];t.targetObj.id!==this.powerTabs.id&&t._$pwActive&&this!==t.targetObj&&(t.toggle({avoidCallAction:!0}),t.targetObj.active=!t.targetObj.active)}}}PowerUi.injectPowerCss({name:"power-tab-section"});class PowerToolbar extends PowerActionsBar{constructor(e,t){super(e,t),this.isToolbar=!0,this.isColapsed=!1}onRemove(){this.powerAction.unsubscribe({event:"toggle",fn:this._setStatus,bar:this}),super.onRemove()}init(){super.init()}getChildrenTotalWidth(){let e=0;for(const t of this.childrenPowerActions)e+=t.element.offsetWidth;for(const t of this.childrenPowerItems)e+=t.element.offsetWidth;return e+=this.powerToggle.offsetWidth,e}getChildrenTotalHeight(){let e=0;for(const t of this.childrenPowerActions)e+=t.element.offsetHeight;for(const t of this.childrenPowerItems)e+=t.element.offsetHeight;return e}_setStatus(e,t,i){i.bar.setStatus.bind(i.bar)()}setStatus(){if(!this.powerToggle){if(!this.powerAction||!this.powerAction.element)throw`Toolbar ${this.id} is missing the "power-toggle" element or it's "data-power-target" attribute value is different from the toolbar id. See documentation for more details.`;this.powerToggle=this.powerAction.element,this.powerAction.subscribe({event:"toggle",fn:this._setStatus,bar:this})}this.barWidth=parseInt(this.element.style.width.replace("px",""))||this.element.offsetWidth,this.barHeight=parseInt(this.element.style.height.replace("px",""))||this.element.offsetHeight,this.toggleWidth=this.powerToggle.offsetWidth,this.toggleHeight=this.powerToggle.offsetHeight,"vertical"===this.orientation?this.VerticalShowAndHiddeItems():this.horizontalShowAndHiddeItems()}VerticalShowAndHiddeItems(){this.getChildrenTotalHeight()>=this.barHeight?!1===this.isColapsed&&(this.element.classList.add("pw-show-toggle"),this.isColapsed=!0):!0===this.isColapsed&&(this.element.classList.remove("pw-show-toggle"),this.isColapsed=!1);let e=0;for(const t of this.element.children){const i=t.classList.contains("power-action");(t.classList.contains("power-item")||i)&&(e+=t.offsetHeight,this._$pwActive||e<this.barHeight-this.toggleHeight?(t.classList.add("pw-force-show"),t.style["margin-top"]=null,t.style["margin-bottom"]=null):(t.classList.remove("pw-force-show"),t.style["margin-top"]=-t.offsetHeight+"px"))}this.setMaxWidthOnActiveVerticalBar()}setMaxWidthOnActiveVerticalBar(){if(!this._$pwActive)return void(this.element.style.width=null);const e=(this.childrenPowerActions[0]||this.childrenPowerItems[0]).element.offsetWidth;let t=e+e,i=!0,s=0;for(;i&&s<30;){s+=1,this.element.style.width=t+"px",i=!1;for(const t of this.childrenPowerActions)t.element.offsetTop>=this.barHeight-e&&(i=!0);for(const t of this.childrenPowerItems)t.element.offsetTop>=this.barHeight-e&&(i=!0);t+=e}s>=30&&(this.element.style.width=null)}horizontalShowAndHiddeItems(){this.getChildrenTotalWidth()>=this.barWidth?!1===this.isColapsed&&(this.element.classList.add("pw-show-toggle"),this.isColapsed=!0):!0===this.isColapsed&&(this.element.classList.remove("pw-show-toggle"),this.isColapsed=!1);let e=0;this.lastTotalChildrenWidth=0;for(const t of this.element.children){const i=t.classList.contains("power-action");(t.classList.contains("power-item")||i)&&(e+=t.offsetWidth,this._$pwActive||e<this.barWidth-this.toggleWidth?(this.lastTotalChildrenWidth=e,t.style["margin-left"]=null,t.style["margin-right"]=null,t.classList.add("pw-force-show")):(t.classList.remove("pw-force-show"),t.style["margin-left"]=-t.offsetWidth+"px"))}}}PowerUi.injectPowerCss({name:"power-toolbar",isMain:!0});class PowerTreeView extends PowerTarget{constructor(e){super(e),e.dataset.onClickFile&&(this.mainNode=!0)}init(){const e=this.$pwView;if(this.ctrlScope=!!(e&&e.id&&this.$powerUi.controllers[e.id])&&this.$powerUi.controllers[e.id].instance,this.mainNode){const e=this.element.getElementsByClassName("power-item");for(const t of e){const e=this.$powerUi.powerTree.allPowerObjsById[t.id];if(e&&e.powerItem){const i=this.$powerUi.getObjectOnScope({text:this.element.dataset.onClickFile,$powerUi:this.$powerUi,scope:this.ctrlScope});e.powerItem.subscribe({fn:i,event:"click",ctx:this.ctrlScope,path:decodeURI(e.powerItem.element.dataset.filePath),element:t})}}}}}PowerUi.injectPowerCss({name:"power-tree-view"});